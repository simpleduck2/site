var _typeLookup=function(){for(var t={},e=["Array","Object","Function","Date","RegExp","Float32Array"],i=0;i<e.length;i++)t["[object "+e[i]+"]"]=e[i].toLowerCase();return t}(),pc={version:"__CURRENT_SDK_VERSION__",revision:"__REVISION__",config:{},common:{},apps:{},data:{},unpack:function(){console.warn("pc.unpack has been deprecated and will be removed shortly. Please update your code.")},makeArray:function(t){var e,i=[],s=t.length;for(e=0;e<s;++e)i.push(t[e]);return i},type:function(t){if(null===t)return"null";var e=typeof t;return"undefined"===e||"number"===e||"string"===e||"boolean"===e?e:_typeLookup[Object.prototype.toString.call(t)]},extend:function(t,e){var i,s;for(i in e)s=e[i],"object"==pc.type(s)?t[i]=pc.extend({},s):"array"==pc.type(s)?t[i]=pc.extend([],s):t[i]=s;return t},isDefined:function(t){return void 0!==t}};
/**
 * @name pc
 * @namespace
 * @description Root namespace for the PlayCanvas Engine
 * @preserve PlayCanvas Engine v__CURRENT_SDK_VERSION__ revision __REVISION__
 * http://playcanvas.com
 * Copyright 2011-2018 PlayCanvas Ltd. All rights reserved.
// #ifdef DEBUG
 * DEBUG BUILD
// #endif
// #ifdef PROFILER
 * PROFILER BUILD
// #endif
 */"undefined"!=typeof exports&&(exports.pc=pc),function(){if("undefined"!=typeof document){var t=function(t){var e=document.createEvent("CustomEvent");e.initCustomEvent("fullscreenchange",!0,!1,null),t.target.dispatchEvent(e)},e=function(t){var e=document.createEvent("CustomEvent");e.initCustomEvent("fullscreenerror",!0,!1,null),t.target.dispatchEvent(e)};document.addEventListener("webkitfullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),document.addEventListener("MSFullscreenChange",t,!1),document.addEventListener("webkitfullscreenerror",e,!1),document.addEventListener("mozfullscreenerror",e,!1),document.addEventListener("MSFullscreenError",e,!1),Element.prototype.mozRequestFullScreen?Element.prototype.requestFullscreen=function(){this.mozRequestFullScreen()}:Element.prototype.requestFullscreen=Element.prototype.requestFullscreen||Element.prototype.webkitRequestFullscreen||Element.prototype.msRequestFullscreen,document.exitFullscreen=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen,document.hasOwnProperty("fullscreenElement")||Object.defineProperty(document,"fullscreenElement",{enumerable:!0,configurable:!1,get:function(){return document.webkitCurrentFullScreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement}}),document.hasOwnProperty("fullscreenEnabled")||Object.defineProperty(document,"fullscreenEnabled",{enumerable:!0,configurable:!1,get:function(){return document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled}})}}(),Math.log2=Math.log2||function(t){return Math.log(t)*Math.LOG2E},"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t,e){"use strict";if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(t),s=1;s<arguments.length;s++){var n=arguments[s];if(null!=n)for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(i[r]=n[r])}return i},writable:!0,configurable:!0}),function(){if("undefined"!=typeof navigator&&"undefined"!=typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var t=function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(t)},e=function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(t)};document.addEventListener("webkitpointerlockchange",t,!1),document.addEventListener("webkitpointerlocklost",t,!1),document.addEventListener("mozpointerlockchange",t,!1),document.addEventListener("mozpointerlocklost",t,!1),document.addEventListener("webkitpointerlockerror",e,!1),document.addEventListener("mozpointerlockerror",e,!1),Element.prototype.mozRequestPointerLock?Element.prototype.requestPointerLock=function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock=Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this,navigator.pointer.lock(this,t,e)}),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock,document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}}(),function(){for(var t=0,e=["ms","moz","webkit","o"],i=0;i<e.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,i){var s=(new Date).getTime(),n=Math.max(0,16-(s-t)),r=window.setTimeout((function(){e(s+n)}),n);return t=s+n,r}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),String.prototype.endsWith||(String.prototype.endsWith=function(t,e){return(void 0===e||e>this.length)&&(e=this.length),this.substring(e-t.length,e)===t}),String.prototype.includes||(String.prototype.includes=function(t,e){"use strict";return"number"!=typeof e&&(e=0),!(e+t.length>this.length)&&-1!==this.indexOf(t,e)}),String.prototype.startsWith||(String.prototype.startsWith=function(t,e){return this.substr(!e||e<0?0:+e,t.length)===t}),pc.extend(pc,function(){var t=Math.ceil(10),e={namesToIds:{},idsToNames:{},nextId:0,isKeywordExist:function(t){return void 0!==this.namesToIds[t]},isKeywordIdExist:function(t){return t>=0&&t<this.nextId},getIdByName:function(t){if(void 0===this.namesToIds[t]){if(this.nextId>=320)return void console.warn("320 keywords limit exceed. "+t+" was not added!");this.namesToIds[t]=this.nextId,this.idsToNames[this.nextId]=t,this.nextId++}return this.namesToIds[t]}},i=function(){return this.bitfield=new Uint32Array(t),this.cardinality=0,this};return pc.extend(i.prototype,{setEnabledKeywords:function(t){this.clear();for(var e=0;e<t.length;e++)this.enableKeyword(t[e])},enableKeyword:function(t){this.enableKeywordId(pc.KeywordsCollection.getIdByName(t))},disableKeyword:function(t){void 0!==pc.KeywordsCollection.namesToIds[t]&&this.disableKeywordId(pc.KeywordsCollection.getIdByName(t))},enableKeywordId:function(t){if(!(t>=pc.KeywordsCollection.nextId||t<0)){var e=Math.floor(t/32),i=1<<t%32;(this.bitfield[e]&i)===i||(this.cardinality++,this.bitfield[e]|=i)}},disableKeywordId:function(t){if(!(t>=pc.KeywordsCollection.nextId||t<0)){var e=Math.floor(t/32),i=1<<t%32;(this.bitfield[e]&i)===i&&(this.cardinality--,this.bitfield[e]&=~i)}},isKeywordEnabled:function(t){return void 0!==pc.KeywordsCollection.namesToIds[t]&&this.isKeywordIdEnabled(pc.KeywordsCollection.getIdByName(t))},isKeywordIdEnabled:function(t){if(t>=pc.KeywordsCollection.nextId||t<0)return!1;var e=Math.floor(t/32),i=1<<t%32;return(this.bitfield[e]&i)===i},subset:function(e){for(var i,s,n=!0,r=0;r<t;r++)i=this.bitfield[r],s=e.bitfield[r],n=n&&(s&i)===i;return n},getEnabledKeywords:function(){for(var t=pc.KeywordsCollection.nextId,e=[],i=0;i<t;i++){var s=pc.KeywordsCollection.idsToNames[i];this.isKeywordEnabled(s)&&e.push(s)}return e},getEnabledKeywordsIds:function(){for(var t=pc.KeywordsCollection.nextId,e=[],i=0;i<t;i++)this.isKeywordEnabled(i)&&e.push(i);return e},merge:function(e){for(var i,s,n=0;n<t;n++)i=this.bitfield[n],s=e.bitfield[n],this.bitfield[n]=i|s;this.updateCardinality()},clear:function(){for(var e=0;e<t;e++)this.bitfield[e]=0;this.cardinality=0},copy:function(e){for(var i=0;i<t;i++)this.bitfield[i]=e.bitfield[i];this.cardinality=e.cardinality},updateCardinality:function(){this.cardinality=0;for(var e=0;e<t;e++){var i=this.bitfield[e];0!==i&&(i=(858993459&(i-=i>>1&1431655765))+(i>>2&858993459),this.cardinality+=16843009*(i+(i>>4)&252645135)>>24)}}}),pc.extend(i,{union:function(e,i,s){void 0===s?s=new pc.KeywordSet:s.clear();for(var n=0;n<t;n++)s.bitfield[n]=e.bitfield[n]|i.bitfield[n];return s.updateCardinality(),s},intersection:function(e,i,s){void 0===s?s=new pc.KeywordSet:s.clear();for(var n=0;n<t;n++)s.bitfield[n]=e.bitfield[n]&i.bitfield[n];return s.updateCardinality(),s},differenceLeft:function(e,i,s){void 0===s?s=new pc.KeywordSet:s.clear();for(var n=0;n<t;n++)s.bitfield[n]=(e.bitfield[n]^i.bitfield[n])&e.bitfield[n];return s.updateCardinality(),s},differenceRight:function(t,e,i){return pc.KeywordSet.differenceLeft(e,t,i)},difference:function(e,i,s){void 0===s?s=new pc.KeywordSet:s.clear();for(var n=0;n<t;n++)s.bitfield[n]=e.bitfield[n]^i.bitfield[n];return s.updateCardinality(),s}}),{KeywordSet:i,KeywordsCollection:e,Keywords:{LIGHTMAP_ON:e.getIdByName("LIGHTMAP_ON"),DIRLIGHTMAP_COMBINED:e.getIdByName("DIRLIGHTMAP_COMBINED"),POINT_COOKIE:e.getIdByName("POINT_COOKIE"),POINT:e.getIdByName("POINT"),SPOT:e.getIdByName("SPOT"),DIRECTIONAL_COOKIE:e.getIdByName("DIRECTIONAL_COOKIE"),DIRECTIONAL:e.getIdByName("DIRECTIONAL"),VERTEXLIGHT_ON:e.getIdByName("VERTEXLIGHT_ON"),LIGHTPROBE_SH:e.getIdByName("LIGHTPROBE_SH"),FOG_LINEAR:e.getIdByName("FOG_LINEAR"),FOG_EXP:e.getIdByName("FOG_EXP"),FOG_EXP2:e.getIdByName("FOG_EXP2")}}}()),Object.assign(pc,function(){var t=function(t,e,i,s){var n=t&&t.length;3===n||4===n?(this.r=t[0],this.g=t[1],this.b=t[2],this.a=void 0!==t[3]?t[3]:1):(this.r=t||0,this.g=e||0,this.b=i||0,this.a=void 0!==s?s:1)};return Object.assign(t.prototype,{clone:function(){return new pc.Color(this.r,this.g,this.b,this.a)},copy:function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},set:function(t,e,i,s){return this.r=t,this.g=e,this.b=i,this.a=void 0===s?1:s,this},setFromArray:function(t,e){return e=e||0,this.r=t[e+0],this.g=t[e+1],this.b=t[e+2],this.a=t[e+3],this},fromString:function(t){var e,i=parseInt(t.replace("#","0x"),16);return t.length>7?e=pc.math.intToBytes32(i):(e=pc.math.intToBytes24(i))[3]=255,this.set(e[0]/255,e[1]/255,e[2]/255,e[3]/255),this},toString:function(t){var e="#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);if(!0===t){var i=Math.round(255*this.a).toString(16);this.a<16/255?e+="0"+i:e+=i}return e}}),{Color:t}}()),pc.guid=function(){var t=0;return{create:function(){return"id:"+t++}}}(),Object.assign(pc,function(){var t=function(){this._isRunning=!1,this._a=0,this._b=0};return Object.assign(t.prototype,{start:function(){this._isRunning=!0,this._a=pc.now()},stop:function(){this._isRunning=!1,this._b=pc.now()},getMilliseconds:function(){return this._b-this._a}}),{Timer:t,_accumulatedTime:0,_pausedTime:0,pause:function(){pc._pausedTime=pc._now()},resume:function(){pc._accumulatedTime+=pc._now()-pc._pausedTime,pc._pausedTime=0},now:function(){return pc._pausedTime||pc._now()-pc._accumulatedTime},_now:window.performance&&window.performance.now&&window.performance.timing?function(){return window.performance.now()}:Date.now}}()),Object.assign(pc,{hashCode:function(t){for(var e=0,i=0,s=t.length;i<s;i++)e=(e<<5)-e+t.charCodeAt(i),e|=0;return e}}),Object.assign(pc,{createURI:function(t){var e="";if((t.authority||t.scheme)&&(t.host||t.hostpath))throw new Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(t.host&&t.hostpath)throw new Error("Can't have 'host' and 'hostpath' option");if(t.path&&t.hostpath)throw new Error("Can't have 'path' and 'hostpath' option");return t.scheme&&(e+=t.scheme+":"),t.authority&&(e+="//"+t.authority),t.host&&(e+=t.host),t.path&&(e+=t.path),t.hostpath&&(e+=t.hostpath),t.query&&(e+="?"+t.query),t.fragment&&(e+="#"+t.fragment),e},URI:function(t){var e=t.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/);this.scheme=e[2],this.authority=e[4],this.path=e[5],this.query=e[7],this.fragment=e[9],this.toString=function(){var t="";return this.scheme&&(t+=this.scheme+":"),this.authority&&(t+="//"+this.authority),t+=this.path,this.query&&(t+="?"+this.query),this.fragment&&(t+="#"+this.fragment),t},this.getQuery=function(){var t,e={};return this.query&&decodeURIComponent(this.query).split("&").forEach((function(i,s,n){t=i.split("="),e[t[0]]=t[1]}),this),e},this.setQuery=function(t){var e="";for(var i in t)t.hasOwnProperty(i)&&(""!==e&&(e+="&"),e+=encodeURIComponent(i)+"="+encodeURIComponent(t[i]));this.query=e}}}),Object.assign(pc,{log:{write:function(t){console.log(t)},open:function(){},info:function(t){console.info("INFO:    "+t)},debug:function(t){console.debug("DEBUG:   "+t)},error:function(t){console.error("ERROR:   "+t)},warning:function(t){console.warn("WARNING: "+t)},alert:function(t){pc.log.write("ALERT:   "+t),alert(t)},assert:function(t,e){!1===t&&pc.log.write("ASSERT:  "+e)}}});var logINFO=pc.log.info,logDEBUG=pc.log.debug,logWARNING=pc.log.warning,logERROR=pc.log.error,logALERT=pc.log.alert,logASSERT=pc.log.assert;pc.path={delimiter:"/",join:function(){var t,e=arguments.length,i=arguments[0];for(t=0;t<e-1;++t){var s=arguments[t],n=arguments[t+1];if(!pc.isDefined(s)||!pc.isDefined(n))throw new Error("undefined argument to pc.path.join");n[0]!==pc.path.delimiter?s&&n&&s[s.length-1]!==pc.path.delimiter&&n[0]!==pc.path.delimiter?i+=pc.path.delimiter+n:i+=n:i=n}return i},normalize:function(t){for(var e=t.startsWith(pc.path.delimiter),i=t.endsWith(pc.path.delimiter),s=t.split("/"),n="",r=[],a=0;a<s.length;a++)""!==s[a]&&"."!==s[a]&&(".."===s[a]&&r.length>0?r=r.slice(0,r.length-2):(a>0&&r.push(pc.path.delimiter),r.push(s[a])));return n=r.join(""),e||n[0]!==pc.path.delimiter||(n=n.slice(1)),i&&n[n.length-1]!==pc.path.delimiter&&(n+=pc.path.delimiter),n},split:function(t){var e=t.split(pc.path.delimiter),i=e.slice(e.length-1)[0];return[e.slice(0,e.length-1).join(pc.path.delimiter),i]},getBasename:function(t){return pc.path.split(t)[1]},getDirectory:function(t){var e=t.split(pc.path.delimiter);return e.slice(0,e.length-1).join(pc.path.delimiter)},getExtension:function(t){var e=t.split("?")[0].split(".").pop();return e!==t?"."+e:""},isRelativePath:function(t){return"/"!==t.charAt(0)&&null===t.match(/:\/\//)},extractPath:function(t){var e=".",i=t.split("/"),s=0;if(i.length>1)for(!1===pc.path.isRelativePath(t)&&(e=""),s=0;s<i.length-1;++s)e+="/"+i[s];return e}},pc.string=function(){var t=55296,e=56319,i=56320,s=57343,n=127462,r=127487,a=127995,o=127999;function h(n,r){var a=n.length;if((r=r||0)<0||r>=a)return null;var o,h=n.charCodeAt(r);return a>1&&h>=t&&h<=e&&(o=n.charCodeAt(r+1))>=i&&o<=s?{code:1024*(h-t)+o-i+65536,long:!0}:{code:h,long:!1}}function c(t,e,i){if(!t)return!1;var s=h(t);if(s){var n=s.code;return n>=e&&n<=i}return!1}function l(i,s){if(s===i.length-1)return 1;if(c(i[s],t,e)){var h=i.substring(s,s+2),l=i.substring(s+2,s+4);return c(l,a,o)||c(h,n,r)&&c(l,n,r)?4:2}return 1}return{ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",format:function(t){var e,i=0,s=pc.makeArray(arguments);for(s.shift(),i=0;i<s.length;i++)e=new RegExp("\\{"+i+"\\}","gi"),t=t.replace(e,s[i]);return t},startsWith:function(t,e){return console.warn("WARNING: startsWith: Function is deprecated. Use String.startsWith instead."),t.startsWith(e)},endsWith:function(t,e){return console.warn("WARNING: endsWith: Function is deprecated. Use String.endsWith instead."),t.endsWith(e)},toBool:function(t,e){if("true"===t)return!0;if(e){if("false"===t)return!1;throw new TypeError("Not a boolean string")}return!1},getCodePoint:function(t,e){var i=h(t,e);return i&&i.code},getCodePoints:function(t){if("string"!=typeof t)throw new TypeError("Not a string");for(var e,i=0,s=[];e=h(t,i);)s.push(e.code),i+=e.long?2:1;return s},getSymbols:function(t){if("string"!=typeof t)throw new TypeError("Not a string");for(var e,i=0,s=t.length,n=[],r=0;i<s;)if(c(e=t[i+(r+=l(t,i+r))],8400,8447)&&(e=t[i+r++]),c(e,65024,65039)&&(e=t[i+r++]),e&&8205===e.charCodeAt(0))e=t[i+r++];else{var a=t.substring(i,i+r);n.push(a),i+=r,r=0}return n},fromCodePoint:function(){for(var t,e,i,s=[],n=0;n<arguments.length;++n)e=(t=Number(arguments[n]))-65536,i=t>65535?[55296+(e>>10),e%1024+56320]:[t],s.push(String.fromCharCode.apply(null,i));return s.join("")}}}(),pc.debug=function(){var t=null,e=null,i=null,s=null;return{display:function(n){for(var r in t||(t=document.createElement("table"),e=document.createElement("tr"),i=document.createElement("td"),s=document.createElement("td"),t.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",t.style.top="0px",t.style.left="0px",t.style.border="thin solid #cccccc",document.body.appendChild(t)),t.innerHTML="",n){var a=e.cloneNode(),o=i.cloneNode(),h=s.cloneNode();o.textContent=r,h.textContent=n[r],a.appendChild(o),a.appendChild(h),t.appendChild(a)}}}}(),pc.events={attach:function(t){var e=pc.events;return t.on=e.on,t.off=e.off,t.fire=e.fire,t.once=e.once,t.hasEvent=e.hasEvent,t.bind=e.on,t.unbind=e.off,t.hasListeners=e.hasListeners,t._callbackActive={},t},on:function(t,e,i){return t&&"string"==typeof t&&e?(this._callbacks||(this._callbacks={}),this._callbacks[t]||(this._callbacks[t]=[]),this._callbackActive||(this._callbackActive={}),this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].push({callback:e,scope:i||this}),this):this},off:function(t,e,i){if(!this._callbacks)return this;if(this._callbackActive)if(t)this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());else for(var s in this._callbackActive)this._callbacks[s]&&this._callbacks[s]===this._callbackActive[s]&&(this._callbackActive[s]=this._callbackActive[s].slice());if(t)if(e){var n=this._callbacks[t];if(!n)return this;for(var r=n.length;r--;)n[r].callback===e&&(i&&n[r].scope!==i||n.splice(r,1))}else this._callbacks[t]&&delete this._callbacks[t];else this._callbacks=null;return this},fire:function(t,e,i,s,n,r,a,o,h){if(!t||!this._callbacks||!this._callbacks[t])return this;var c;this._callbackActive||(this._callbackActive={}),this._callbackActive[t]?(this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),c=this._callbacks[t].slice()):this._callbackActive[t]=this._callbacks[t];for(var l=0;(c||this._callbackActive[t])&&l<(c||this._callbackActive[t]).length;l++){var p=(c||this._callbackActive[t])[l];if(p.callback.call(p.scope,e,i,s,n,r,a,o,h),p.callback.once){var u=this._callbacks[t].indexOf(p);-1!==u&&(this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].splice(u,1))}}return c||(this._callbackActive[t]=null),this},once:function(t,e,i){return e.once=!0,this.on(t,e,i),this},hasEvent:function(t){return this._callbacks&&this._callbacks[t]&&0!==this._callbacks[t].length||!1},hasListeners:function(t){return this._callbacks&&this._callbacks[t]&&this._callbacks[t].length>0}},Object.assign(pc,function(){var t=function(t){this._index={},this._key=t||null};Object.assign(t.prototype,{addItem:function(t){for(var e=t.tags._list,i=0;i<e.length;i++)this.add(e[i],t)},removeItem:function(t){for(var e=t.tags._list,i=0;i<e.length;i++)this.remove(e[i],t)},add:function(t,e){this._index[t]&&-1!==this._index[t].list.indexOf(e)||(this._index[t]||(this._index[t]={list:[]},this._key&&(this._index[t].keys={})),this._index[t].list.push(e),this._key&&(this._index[t].keys[e[this._key]]=e))},remove:function(t,e){if(this._index[t]&&(!this._key||this._index[t].keys[e[this._key]])){var i=this._index[t].indexOf(e);-1!==i&&(this._index[t].list.splice(i,1),this._key&&delete this._index[t].keys[e[this._key]],0===this._index[t].list.length&&delete this._index[t])}},find:function(t){var e,i,s,n,r,a,o,h,c=this,l={},p=[],u=function(t,e){return c._index[t].list.length-c._index[e].list.length};for(e=0;e<t.length;e++){if((r=t[e])instanceof Array){if(0===r.length)continue;if(1!==r.length){for(h=!1,s=0;s<r.length;s++)if(!this._index[r[s]]){h=!0;break}if(h)continue;for(1===(o=(a=r.slice(0).sort(u)).slice(1)).length&&(o=o[0]),i=0;i<this._index[a[0]].list.length;i++)n=this._index[a[0]].list[i],(this._key?!l[n[this._key]]:-1===p.indexOf(n))&&n.tags.has(o)&&(this._key&&(l[n[this._key]]=!0),p.push(n));continue}r=r[0]}if(r&&"string"==typeof r&&this._index[r])for(i=0;i<this._index[r].list.length;i++)n=this._index[r].list[i],this._key?l[n[this._key]]||(l[n[this._key]]=!0,p.push(n)):-1===p.indexOf(n)&&p.push(n)}return p}});var e=function(t){this._index={},this._list=[],this._parent=t,pc.events.attach(this)};return Object.assign(e.prototype,{add:function(){var t=!1,e=this._processArguments(arguments,!0);if(!e.length)return t;for(var i=0;i<e.length;i++)this._index[e[i]]||(t=!0,this._index[e[i]]=!0,this._list.push(e[i]),this.fire("add",e[i],this._parent));return t&&this.fire("change",this._parent),t},remove:function(){var t=!1;if(!this._list.length)return t;var e=this._processArguments(arguments,!0);if(!e.length)return t;for(var i=0;i<e.length;i++)this._index[e[i]]&&(t=!0,delete this._index[e[i]],this._list.splice(this._list.indexOf(e[i]),1),this.fire("remove",e[i],this._parent));return t&&this.fire("change",this._parent),t},clear:function(){if(this._list.length){var t=this._list.slice(0);this._list=[],this._index={};for(var e=0;e<t.length;e++)this.fire("remove",t[e],this._parent);this.fire("change",this._parent)}},has:function(){return!!this._list.length&&this._has(this._processArguments(arguments))},_has:function(t){if(!this._list.length||!t.length)return!1;for(var e=0;e<t.length;e++)if(1===t[e].length){if(this._index[t[e][0]])return!0}else{for(var i=!0,s=0;s<t[e].length;s++)if(!this._index[t[e][s]]){i=!1;break}if(i)return!0}return!1},list:function(){return this._list.slice(0)},_processArguments:function(t,e){var i=[],s=[];if(!t||!t.length)return i;for(var n=0;n<t.length;n++)if(t[n]instanceof Array){e||(s=[]);for(var r=0;r<t[n].length;r++)"string"==typeof t[n][r]&&(e?i.push(t[n][r]):s.push(t[n][r]));!e&&s.length&&i.push(s)}else"string"==typeof t[n]&&(e?i.push(t[n]):i.push([t[n]]));return i}}),Object.defineProperty(e.prototype,"size",{get:function(){return this._list.length}}),{TagsCache:t,Tags:e}}()),Object.assign(pc,function(){var t=function(t,e){this._constructor=t,this._pool=[],this._count=0,this._resize(e)};return Object.assign(t.prototype,{_resize:function(t){if(t>this._pool.length)for(var e=this._pool.length;e<t;e++)this._pool[e]=new this._constructor},allocate:function(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]},freeAll:function(){this._count=0}}),{AllocatePool:t}}()),Object.assign(pc,function(){var t={desktop:!1,mobile:!1,ios:!1,android:!1,windows:!1,cocoonjs:!1,xbox:!1,gamepads:!1,touch:!1},e=navigator.userAgent;return/(windows|mac os|linux|cros)/i.test(e)&&(t.desktop=!0),/xbox/i.test(e)&&(t.xbox=!0),/(windows phone|iemobile|wpdesktop)/i.test(e)?(t.desktop=!1,t.mobile=!0,t.windows=!0):/android/i.test(e)?(t.desktop=!1,t.mobile=!0,t.android=!0):/ip([ao]d|hone)/i.test(e)&&(t.desktop=!1,t.mobile=!0,t.ios=!0),navigator.isCocoonJS&&(t.cocoonjs=!0),t.touch="ontouchstart"in window,t.gamepads="getGamepads"in navigator,{platform:t}}()),Object.assign(pc,function(){var t=function(){this._list=[],this._index={}};return Object.assign(t.prototype,{push:function(t){if(this._index[t.id])throw Error("Key already in index "+t.id);var e=this._list.push(t)-1;this._index[t.id]=e},add:function(t){return!this.has(t)&&(this.push(t),!0)},has:function(t){return void 0!==this._index[t.id]},sort:function(t){this._list.sort(t);for(var e=0;e<this._list.length;e++)this._index[this._list[e].id]=e},remove:function(t){var e=this._index[t.id];return void 0!==e&&(this._index[t.id]=void 0,this._list[e]=this._list[this._list.length-1],this._list.length=this._list.length-1,e===this._list.length||(this._index[this._list[e].id]=e,!0))},list:function(){return this._list},clear:function(){this._list.length=0,this._index={}}}),{IndexedList:t}}()),pc.math={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(t,e,i){return t>=i?i:t<=e?e:t},intToBytes24:function(t){return[t>>16&255,t>>8&255,255&t]},intToBytes32:function(t){return[t>>24&255,t>>16&255,t>>8&255,255&t]},bytesToInt24:function(t,e,i){return t.length&&(i=t[2],e=t[1],t=t[0]),t<<16|e<<8|i},bytesToInt32:function(t,e,i,s){return t.length&&(s=t[3],i=t[2],e=t[1],t=t[0]),(t<<24|e<<16|i<<8|s)>>>32},lerp:function(t,e,i){return t+(e-t)*pc.math.clamp(i,0,1)},lerpAngle:function(t,e,i){return e-t>180&&(e-=360),e-t<-180&&(e+=360),pc.math.lerp(t,e,pc.math.clamp(i,0,1))},powerOfTwo:function(t){return 0!==t&&!(t&t-1)},nextPowerOfTwo:function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},random:function(t,e){var i=e-t;return Math.random()*i+t},smoothstep:function(t,e,i){return i<=t?0:i>=e?1:(i=(i-t)/(e-t))*i*(3-2*i)},smootherstep:function(t,e,i){return i<=t?0:i>=e?1:(i=(i-t)/(e-t))*i*i*(i*(6*i-15)+10)},sign:function(t){return t<0?-1:1}},Object.assign(pc,function(){"use strict";var t,e,i,s,n=function(t,e){t&&2===t.length?(this.x=t[0],this.y=t[1]):(this.x=t||0,this.y=e||0)},r=new n;return Object.assign(n.prototype,{add:function(t){return this.x+=t.x,this.y+=t.y,this},add2:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this},clone:function(){return(new n).copy(this)},copy:function(t){return this.x=t.x,this.y=t.y,this},dot:function(t){return this.x*t.x+this.y*t.y},equals:function(t){return r.copy(this),r.sub(t),r.lengthSq()<999999943962493e-25},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthSq:function(){return this.x*this.x+this.y*this.y},lerp:function(t,e,i){return i=pc.math.clamp(i,0,1),this.x=t.x+i*(e.x-t.x),this.y=t.y+i*(e.y-t.y),this},lerpUnclamped:function(t,e,i){return this.x=t.x+i*(e.x-t.x),this.y=t.y+i*(e.y-t.y),this},mul:function(t){return this.x*=t.x,this.y*=t.y,this},mul2:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this},normalize:function(){var t=this.x*this.x+this.y*this.y;if(t>0){var e=1/Math.sqrt(t);this.x*=e,this.y*=e}return this},scale:function(t){return this.x*=t,this.y*=t,this},set:function(t,e){return this.x=t,this.y=e,this},sub:function(t){return this.x-=t.x,this.y-=t.y,this},sub2:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this},toString:function(){return"["+this.x+", "+this.y+"]"}}),Object.defineProperty(n,"ONE",{get:(t=new n(1,1),t._data=new Float32Array(2),Object.freeze(t),function(){return t})}),Object.defineProperty(n,"RIGHT",{get:(e=new n(1,0),e._data=new Float32Array(2),Object.freeze(e),function(){return e})}),Object.defineProperty(n,"UP",{get:(i=new n(0,1),i._data=new Float32Array(2),Object.freeze(i),function(){return i})}),Object.defineProperty(n,"ZERO",{get:(s=new n(0,0),s._data=new Float32Array(2),Object.freeze(s),function(){return s})}),{Vec2:n}}()),Object.assign(pc,function(){"use strict";var t,e,i,s,n,r,a,o=function(t,e,i){t&&3===t.length?(this.x=t[0],this.y=t[1],this.z=t[2]):(this.x=t||0,this.y=e||0,this.z=i||0)},h=new o;return Object.assign(o.prototype,{add:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},add2:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},clone:function(){return(new o).copy(this)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},cross:function(t,e){var i=t.x,s=t.y,n=t.z,r=e.x,a=e.y,o=e.z;return this.x=s*o-a*n,this.y=n*r-o*i,this.z=i*a-r*s,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},equals:function(t,e=999999943962493e-25){return h.copy(this),h.sub(t),h.lengthSq()<e},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},lerp:function(t,e,i){return i=pc.math.clamp(i,0,1),this.x=t.x+i*(e.x-t.x),this.y=t.y+i*(e.y-t.y),this.z=t.z+i*(e.z-t.z),this},lerpUnclamped:function(t,e,i){return this.x=t.x+i*(e.x-t.x),this.y=t.y+i*(e.y-t.y),this.z=t.z+i*(e.z-t.z),this},mul:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},mul2:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},normalize:function(){var t=this.x*this.x+this.y*this.y+this.z*this.z;if(t>0){var e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e}return this},project:function(t){var e=(this.x*t.x+this.y*t.y+this.z*t.z)/(t.x*t.x+t.y*t.y+t.z*t.z);return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this},scale:function(t){return this.x*=t,this.y*=t,this.z*=t,this},set:function(t,e,i){return this.x=t,this.y=e,this.z=i||0,this},sub:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},sub2:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+"]"}}),Object.defineProperty(o,"BACK",{get:(t=new o(0,0,1),t._data=new Float32Array(3),Object.freeze(t),function(){return t})}),Object.defineProperty(o,"DOWN",{get:(e=new o(0,-1,0),e._data=new Float32Array(3),Object.freeze(e),function(){return e})}),Object.defineProperty(o,"FORWARD",{get:(i=new o(0,0,-1),i._data=new Float32Array(3),Object.freeze(i),function(){return i})}),Object.defineProperty(o,"LEFT",{get:(s=new o(-1,0,0),s._data=new Float32Array(3),Object.freeze(s),function(){return s})}),Object.defineProperty(o,"ONE",{get:(n=new o(1,1,1),n._data=new Float32Array(3),Object.freeze(n),function(){return n})}),Object.defineProperty(o,"RIGHT",{get:(r=new o(1,0,0),r._data=new Float32Array(3),Object.freeze(r),function(){return r})}),Object.defineProperty(o,"UP",{get:function(){var t=new o(0,1,0);return t._data=new Float32Array(3),Object.freeze(t),function(){return t}}()}),Object.defineProperty(o,"ZERO",{get:(a=new o(0,0,0),a._data=new Float32Array(3),Object.freeze(a),function(){return a})}),{Vec3:o}}()),Object.assign(pc,function(){"use strict";var t,e,i=function(t,e,i,s){t&&4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=s||0)},s=new i;return Object.assign(i.prototype,{add:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},add2:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this},clone:function(){return(new i).copy(this)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},equals:function(t){return s.copy(this),s.sub(t),s.lengthSq()<999999943962493e-25},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},lerp:function(t,e,i){return this.x=t.x+i*(e.x-t.x),this.y=t.y+i*(e.y-t.y),this.z=t.z+i*(e.z-t.z),this.w=t.w+i*(e.w-t.w),this},mul:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},mul2:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this.w=t.w*e.w,this},normalize:function(){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;if(t>0){var e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e,this.w*=e}return this},scale:function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},set:function(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this},setFromArray:function(t,e){return e=e||0,this.x=t[e+0],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this},sub:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},sub2:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}}),Object.defineProperty(i,"ONE",{get:(t=new i(1,1,1,1),t._data=new Float32Array(4),Object.freeze(t),function(){return t})}),Object.defineProperty(i,"ZERO",{get:(e=new i(0,0,0,0),e._data=new Float32Array(4),Object.freeze(e),function(){return e})}),{Vec4:i}}()),Object.assign(pc,function(){"use strict";var t,e,i=function(){var t;(t=new Float32Array(9))[0]=t[4]=t[8]=1,this.data=t};return Object.assign(i.prototype,{clone:function(){return(new pc.Mat3).copy(this)},copy:function(t){var e=t.data,i=this.data;return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],this},set:function(t){var e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this},equals:function(t){var e=this.data,i=t.data;return e[0]===i[0]&&e[1]===i[1]&&e[2]===i[2]&&e[3]===i[3]&&e[4]===i[4]&&e[5]===i[5]&&e[6]===i[6]&&e[7]===i[7]&&e[8]===i[8]},isIdentity:function(){var t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&1===t[4]&&0===t[5]&&0===t[6]&&0===t[7]&&1===t[8]},setIdentity:function(){var t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},toString:function(){for(var t="[",e=0;e<9;e++)t+=this.data[e],t+=9!==e?", ":"";return t+="]"},transpose:function(){var t,e=this.data;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}}),Object.defineProperty(i,"IDENTITY",{get:(t=Object.freeze(new i),function(){return t})}),Object.defineProperty(i,"ZERO",{get:(e=Object.freeze((new i).set([0,0,0,0,0,0,0,0,0])),function(){return e})}),{Mat3:i}}()),Object.assign(pc,function(){"use strict";var t,e,i,s,n,r,a=function(){var t=new Float32Array(16);t[0]=t[5]=t[10]=t[15]=1,this.data=t};return Object.assign(a.prototype,{add2:function(t,e){var i=t.data,s=e.data,n=this.data;return n[0]=i[0]+s[0],n[1]=i[1]+s[1],n[2]=i[2]+s[2],n[3]=i[3]+s[3],n[4]=i[4]+s[4],n[5]=i[5]+s[5],n[6]=i[6]+s[6],n[7]=i[7]+s[7],n[8]=i[8]+s[8],n[9]=i[9]+s[9],n[10]=i[10]+s[10],n[11]=i[11]+s[11],n[12]=i[12]+s[12],n[13]=i[13]+s[13],n[14]=i[14]+s[14],n[15]=i[15]+s[15],this},add:function(t){return this.add2(this,t)},clone:function(){return(new pc.Mat4).copy(this)},copy:function(t){var e=t.data,i=this.data;return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],this},equals:function(t){var e=this.data,i=t.data;return e[0]===i[0]&&e[1]===i[1]&&e[2]===i[2]&&e[3]===i[3]&&e[4]===i[4]&&e[5]===i[5]&&e[6]===i[6]&&e[7]===i[7]&&e[8]===i[8]&&e[9]===i[9]&&e[10]===i[10]&&e[11]===i[11]&&e[12]===i[12]&&e[13]===i[13]&&e[14]===i[14]&&e[15]===i[15]},isIdentity:function(){var t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]},mul2:function(t,e){var i,s,n,r,a,o,h,c,l,p,u,d,_,f,m,g,y,E,v,T,b=t.data,A=e.data,S=this.data;return i=b[0],s=b[1],n=b[2],r=b[3],a=b[4],o=b[5],h=b[6],c=b[7],l=b[8],p=b[9],u=b[10],d=b[11],_=b[12],f=b[13],m=b[14],g=b[15],y=A[0],E=A[1],v=A[2],T=A[3],S[0]=i*y+a*E+l*v+_*T,S[1]=s*y+o*E+p*v+f*T,S[2]=n*y+h*E+u*v+m*T,S[3]=r*y+c*E+d*v+g*T,y=A[4],E=A[5],v=A[6],T=A[7],S[4]=i*y+a*E+l*v+_*T,S[5]=s*y+o*E+p*v+f*T,S[6]=n*y+h*E+u*v+m*T,S[7]=r*y+c*E+d*v+g*T,y=A[8],E=A[9],v=A[10],T=A[11],S[8]=i*y+a*E+l*v+_*T,S[9]=s*y+o*E+p*v+f*T,S[10]=n*y+h*E+u*v+m*T,S[11]=r*y+c*E+d*v+g*T,y=A[12],E=A[13],v=A[14],T=A[15],S[12]=i*y+a*E+l*v+_*T,S[13]=s*y+o*E+p*v+f*T,S[14]=n*y+h*E+u*v+m*T,S[15]=r*y+c*E+d*v+g*T,this},mul:function(t){return this.mul2(this,t)},transformPoint:function(t,e){var i,s,n,r;return r=this.data,i=t.x,s=t.y,n=t.z,(e=void 0===e?new pc.Vec3:e).x=i*r[0]+s*r[4]+n*r[8]+r[12],e.y=i*r[1]+s*r[5]+n*r[9]+r[13],e.z=i*r[2]+s*r[6]+n*r[10]+r[14],e},transformVector:function(t,e){var i,s,n,r;return r=this.data,i=t.x,s=t.y,n=t.z,(e=void 0===e?new pc.Vec3:e).x=i*r[0]+s*r[4]+n*r[8],e.y=i*r[1]+s*r[5]+n*r[9],e.z=i*r[2]+s*r[6]+n*r[10],e},transformVec4:function(t,e){var i,s,n,r,a;return a=this.data,i=t.x,s=t.y,n=t.z,r=t.w,(e=void 0===e?new pc.Vec4:e).x=i*a[0]+s*a[4]+n*a[8]+r*a[12],e.y=i*a[1]+s*a[5]+n*a[9]+r*a[13],e.z=i*a[2]+s*a[6]+n*a[10]+r*a[14],e.w=i*a[3]+s*a[7]+n*a[11]+r*a[15],e},setLookAt:(e=new pc.Vec3,i=new pc.Vec3,s=new pc.Vec3,function(t,n,r){if(s.sub2(n,t),s.length()<1e-6)return this.setIdentity();s.normalize(),i.copy(r).normalize(),e.cross(i,s).normalize(),i.cross(s,e);var a=this.data;return a[0]=e.x,a[1]=e.y,a[2]=e.z,a[3]=0,a[4]=i.x,a[5]=i.y,a[6]=i.z,a[7]=0,a[8]=s.x,a[9]=s.y,a[10]=s.z,a[11]=0,a[12]=t.x,a[13]=t.y,a[14]=t.z,a[15]=1,this}),setFrustum:function(t,e,i,s,n,r){var a,o,h,c,l;return a=2*n,o=e-t,h=s-i,c=r-n,(l=this.data)[0]=a/o,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=a/h,l[6]=0,l[7]=0,l[8]=-(e+t)/o,l[9]=-(s+i)/h,l[10]=(-r-n)/c,l[11]=-1,l[12]=0,l[13]=0,l[14]=-a*r/c,l[15]=0,this},setPerspective:function(t,e,i,s,n){var r,a;return n?a=(r=i*Math.tan(t*Math.PI/360))/e:r=(a=i*Math.tan(t*Math.PI/360))*e,this.setFrustum(-r,r,-a,a,i,s)},setOrtho:function(t,e,i,s,n,r){var a=this.data;return a[0]=2/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(s-i),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/(r-n),a[11]=0,a[12]=-(e+t)/(e-t),a[13]=-(s+i)/(s-i),a[14]=-(r+n)/(r-n),a[15]=1,this},setFromAxisAngle:function(t,e){var i,s,n,r,a,o,h,c,l;return e*=pc.math.DEG_TO_RAD,i=t.x,s=t.y,n=t.z,r=Math.cos(e),a=Math.sin(e),h=(o=1-r)*i,c=o*s,(l=this.data)[0]=h*i+r,l[1]=h*s+a*n,l[2]=h*n-a*s,l[3]=0,l[4]=h*s-a*n,l[5]=c*s+r,l[6]=c*n+a*i,l[7]=0,l[8]=h*n+a*s,l[9]=c*n-i*a,l[10]=o*n*n+r,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,this},setTranslate:function(t,e,i){var s=this.data;return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=t,s[13]=e,s[14]=i,s[15]=1,this},setScale:function(t,e,i){var s=this.data;return s[0]=t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=e,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this},invert:function(){var t,e,i,s,n,r,a,o,h,c,l,p,u,d,_,f,m,g,y,E,v,T,b,A,S,R,I,C,M,O,P;return t=(P=this.data)[0],e=P[1],i=P[2],s=P[3],n=P[4],r=P[5],a=P[6],o=P[7],h=P[8],c=P[9],l=P[10],p=P[11],u=P[12],d=P[13],_=P[14],0===(M=(m=t*r-e*n)*(C=l*(f=P[15])-p*_)-(g=t*a-i*n)*(I=c*f-p*d)+(y=t*o-s*n)*(R=c*_-l*d)+(E=e*a-i*r)*(S=h*f-p*u)-(v=e*o-s*r)*(A=h*_-l*u)+(T=i*o-s*a)*(b=h*d-c*u))?this.setIdentity():(O=1/M,P[0]=(r*C-a*I+o*R)*O,P[1]=(-e*C+i*I-s*R)*O,P[2]=(d*T-_*v+f*E)*O,P[3]=(-c*T+l*v-p*E)*O,P[4]=(-n*C+a*S-o*A)*O,P[5]=(t*C-i*S+s*A)*O,P[6]=(-u*T+_*y-f*g)*O,P[7]=(h*T-l*y+p*g)*O,P[8]=(n*I-r*S+o*b)*O,P[9]=(-t*I+e*S-s*b)*O,P[10]=(u*v-d*y+f*m)*O,P[11]=(-h*v+c*y-p*m)*O,P[12]=(-n*R+r*A-a*b)*O,P[13]=(t*R-e*A+i*b)*O,P[14]=(-u*E+d*g-_*m)*O,P[15]=(h*E-c*g+l*m)*O),this},set:function(t){var e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this},setFromArray:function(t,e){e=e||0;for(var i=this.data,s=0;s<16;s++)i[s]=t[e+s];return this},setIdentity:function(){var t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},setTRS:function(t,e,i){var s,n,r,a,o,h,c,l,p,u,d,_,f,m,g,y,E,v,T,b,A,S,R;return s=t.x,n=t.y,r=t.z,a=e.x,o=e.y,h=e.z,c=e.w,l=i.x,p=i.y,u=i.z,m=a*(d=a+a),g=a*(_=o+o),y=a*(f=h+h),E=o*_,v=o*f,T=h*f,b=c*d,A=c*_,S=c*f,(R=this.data)[0]=(1-(E+T))*l,R[1]=(g+S)*l,R[2]=(y-A)*l,R[3]=0,R[4]=(g-S)*p,R[5]=(1-(m+T))*p,R[6]=(v+b)*p,R[7]=0,R[8]=(y+A)*u,R[9]=(v-b)*u,R[10]=(1-(m+E))*u,R[11]=0,R[12]=s,R[13]=n,R[14]=r,R[15]=1,this},transpose:function(){var t,e=this.data;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},invertTo3x3:function(t){var e,i,s,n,r,a,o,h,c,l,p,u,d;l=this.data,p=t.data;var _=l[0],f=l[1],m=l[2],g=l[4],y=l[5],E=l[6],v=l[8],T=l[9],b=l[10];return i=-b*f+m*T,s=E*f-m*y,r=b*_-m*v,a=-E*_+m*g,h=-T*_+f*v,c=y*_-f*g,0===(u=_*(e=b*y-E*T)+f*(n=-b*g+E*v)+m*(o=T*g-y*v))?this:(d=1/u,p[0]=d*e,p[1]=d*i,p[2]=d*s,p[3]=d*n,p[4]=d*r,p[5]=d*a,p[6]=d*o,p[7]=d*h,p[8]=d*c,this)},getTranslation:function(t){return(t=void 0===t?new pc.Vec3:t).set(this.data[12],this.data[13],this.data[14])},getX:function(t){return(t=void 0===t?new pc.Vec3:t).set(this.data[0],this.data[1],this.data[2])},getY:function(t){return(t=void 0===t?new pc.Vec3:t).set(this.data[4],this.data[5],this.data[6])},getZ:function(t){return(t=void 0===t?new pc.Vec3:t).set(this.data[8],this.data[9],this.data[10])},getScale:function(){var t,e,i;return t=new pc.Vec3,e=new pc.Vec3,i=new pc.Vec3,function(s){return s=void 0===s?new pc.Vec3:s,this.getX(t),this.getY(e),this.getZ(i),s.set(t.length(),e.length(),i.length()),s}}(),setFromEulerAngles:function(t,e,i){var s,n,r,a,o,h,c;return t*=pc.math.DEG_TO_RAD,e*=pc.math.DEG_TO_RAD,i*=pc.math.DEG_TO_RAD,s=Math.sin(-t),n=Math.cos(-t),r=Math.sin(-e),a=Math.cos(-e),o=Math.sin(-i),h=Math.cos(-i),(c=this.data)[0]=a*h,c[1]=-a*o,c[2]=r,c[3]=0,c[4]=n*o+h*s*r,c[5]=n*h-s*r*o,c[6]=-a*s,c[7]=0,c[8]=s*o-n*h*r,c[9]=h*s+n*r*o,c[10]=n*a,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this},getEulerAngles:(t=new pc.Vec3,function(e){var i,s,n,r,a,o,h,c;return e=void 0===e?new pc.Vec3:e,this.getScale(t),r=t.x,a=t.y,o=t.z,h=this.data,(s=Math.asin(-h[2]/r))<(c=.5*Math.PI)?s>-c?(i=Math.atan2(h[6]/a,h[10]/o),n=Math.atan2(h[1]/r,h[0]/r)):(n=0,i=-Math.atan2(h[4]/a,h[5]/a)):(n=0,i=Math.atan2(h[4]/a,h[5]/a)),e.set(i,s,n).scale(pc.math.RAD_TO_DEG)}),toString:function(){var t,e;for(e="[",t=0;t<16;t+=1)e+=this.data[t],e+=15!==t?", ":"";return e+="]"}}),Object.defineProperty(a,"IDENTITY",{get:(n=Object.freeze(new a),function(){return n})}),Object.defineProperty(a,"ZERO",{get:(r=Object.freeze((new a).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])),function(){return r})}),{Mat4:a}}()),Object.assign(pc,function(){"use strict";var t,e,i=function(t,e,i,s){t&&4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=void 0===t?0:t,this.y=void 0===e?0:e,this.z=void 0===i?0:i,this.w=void 0===s?1:s)};return Object.assign(i.prototype,{clone:function(){return new pc.Quat(this.x,this.y,this.z,this.w)},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},equals:function(t){return this.dot(t)>.999998986721039},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},negate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this},transformVectorInverse:function(t,e){e=e||new pc.Vec3;var i=2*t.x,s=2*t.y,n=2*t.z,r=this.w*this.w-.5,a=this.x*i+this.y*s+this.z*n;return e.x=i*r-(this.y*n-this.z*s)*this.w+this.x*a,e.y=s*r-(this.z*i-this.x*n)*this.w+this.y*a,e.z=n*r-(this.x*s-this.y*i)*this.w+this.z*a,e},extractAxes:function(t,e,i){var s=this.x,n=this.y,r=this.z,a=this.w,o=s+s,h=n+n,c=r+r,l=o*s,p=h*n,u=c*r,d=o*n,_=o*r,f=o*a,m=h*r,g=h*a,y=c*a;t.set(1-p-u,d+y,_-g),e.set(d-y,1-l-u,m+f),i.set(_+g,m-f,1-l-p)},getAxisAngle:function(t){var e=2*Math.acos(this.w),i=Math.sin(e/2);return 0!==i?(t.x=this.x/i,t.y=this.y/i,t.z=this.z/i,(t.x<0||t.y<0||t.z<0)&&(t.x*=-1,t.y*=-1,t.z*=-1,e*=-1)):(t.x=1,t.y=0,t.z=0),e*pc.math.RAD_TO_DEG},getEulerAngles:function(t){var e,i,s,n,r,a,o,h;return t=void 0===t?new pc.Vec3:t,n=this.x,r=this.y,a=this.z,(h=2*((o=this.w)*r-n*a))<=-.99999?(e=2*Math.atan2(n,o),i=-Math.PI/2,s=0):h>=.99999?(e=2*Math.atan2(n,o),i=Math.PI/2,s=0):(e=Math.atan2(2*(o*n+r*a),1-2*(n*n+r*r)),i=Math.asin(h),s=Math.atan2(2*(o*a+n*r),1-2*(r*r+a*a))),t.set(e,i,s).scale(pc.math.RAD_TO_DEG)},getUnityEulerAngles:function(){var t=new pc.Mat4,e=new pc.Vec3,i=new pc.Vec3(1,0,0),s=new pc.Vec3(0,1,0),n=new pc.Vec3(0,0,1);this.transformVector(i,i),this.transformVector(s,s),this.transformVector(n,n),t.data[0]=i.x,t.data[1]=i.y,t.data[2]=i.z,t.data[4]=s.x,t.data[5]=s.y,t.data[6]=s.z,t.data[8]=n.x,t.data[9]=n.y,t.data[10]=n.z,t.data[15]=1;var r=t.data,a=r[0],o=(r[4],r[8]),h=r[1],c=r[5],l=r[9],p=r[2],u=(r[6],r[10]);return e.x=Math.asin(-pc.math.clamp(l,-1,1)),Math.abs(l)<.99999?(e.y=Math.atan2(o,u),e.z=Math.atan2(h,c)):(e.y=Math.atan2(-p,a),e.z=0),e.scale(pc.math.RAD_TO_DEG),e},invert:function(){return this.conjugate().normalize()},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},mul:function(t){var e,i,s,n,r,a,o,h;return e=this.x,i=this.y,s=this.z,n=this.w,r=t.x,a=t.y,o=t.z,h=t.w,this.x=n*r+e*h+i*o-s*a,this.y=n*a+i*h+s*r-e*o,this.z=n*o+s*h+e*a-i*r,this.w=n*h-e*r-i*a-s*o,this},mul2:function(t,e){var i,s,n,r,a,o,h,c;return i=t.x,s=t.y,n=t.z,r=t.w,a=e.x,o=e.y,h=e.z,c=e.w,this.x=r*a+i*c+s*h-n*o,this.y=r*o+s*c+n*a-i*h,this.z=r*h+n*c+i*o-s*a,this.w=r*c-i*a-s*o-n*h,this},nearest:function(t,e){e=e||new pc.Quat;var i=(this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y)+(this.z-t.z)*(this.z-t.z)+(this.w-t.w)*(this.w-t.w),s=(this.x+t.x)*(this.x+t.x)+(this.y+t.y)*(this.y+t.y)+(this.z+t.z)*(this.z+t.z)+(this.w+t.w)*(this.w+t.w);return e.copy(t),i>s&&(e.x*=-1,e.y*=-1,e.z*=-1,e.w*=-1),e},normalize:function(){var t=this.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},set:function(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this},fromTo:function(t,e){var i=t.length(),s=t.x/i,n=t.y/i,r=t.z/i,a=e.length(),o=e.x/a,h=e.y/a,c=e.z/a;this.w=Math.cos(Math.acos(s*o+n*h+r*c)/2);var l=Math.sqrt(1-this.w*this.w);if(this.x=(n*c-h*r)*l,this.y=(r*o-c*s)*l,this.z=(s*h-o*n)*l,this.lengthSq()<Number.EPSILON){const t=Math.abs(e.x),i=Math.abs(e.y),s=Math.abs(e.z),n=t<i?t<s?pc.Vec3.RIGHT:pc.Vec3.FORWARD:i<s?pc.Vec3.UP:pc.Vec3.FORWARD;this.x=e.y*n.z-n.y*e.z,this.y=e.z*n.x-n.z*e.x,this.z=e.x*n.y-n.x*e.y;const r=1/this.length();this.x*=r,this.y*=r,this.z*=r}return this},setFromAxisAngle:function(t,e){var i,s;return e*=.5*pc.math.DEG_TO_RAD,i=Math.sin(e),s=Math.cos(e),this.x=i*t.x,this.y=i*t.y,this.z=i*t.z,this.w=s,this},setFromEulerAngles:function(t,e,i){var s,n,r,a,o,h,c;return t*=c=.5*pc.math.DEG_TO_RAD,e*=c,i*=c,s=Math.sin(t),n=Math.cos(t),r=Math.sin(e),a=Math.cos(e),o=Math.sin(i),h=Math.cos(i),this.x=s*a*h-n*r*o,this.y=n*r*h+s*a*o,this.z=n*a*o-s*r*h,this.w=n*a*h+s*r*o,this},setFromMat4:function(t){var e,i,s,n,r,a,o,h,c,l,p,u,d,_,f;return e=(t=t.data)[0],i=t[1],s=t[2],n=t[4],r=t[5],a=t[6],o=t[8],h=t[9],c=t[10],d=1/Math.sqrt(e*e+i*i+s*s),_=1/Math.sqrt(n*n+r*r+a*a),f=1/Math.sqrt(o*o+h*h+c*c),i*=d=Number.isFinite(d)?d:1,s*=d,n*=_=Number.isFinite(_)?_:1,a*=_,o*=f=Number.isFinite(f)?f:1,h*=f,(l=(e*=d)+(r*=_)+(c*=f))>=0?(p=Math.sqrt(l+1),this.w=.5*p,p=.5/p,this.x=(a-h)*p,this.y=(o-s)*p,this.z=(i-n)*p):e>r?e>c?(u=e-(r+c)+1,u=Math.sqrt(u),this.x=.5*u,u=.5/u,this.w=(a-h)*u,this.y=(i+n)*u,this.z=(s+o)*u):(u=c-(e+r)+1,u=Math.sqrt(u),this.z=.5*u,u=.5/u,this.w=(i-n)*u,this.x=(o+s)*u,this.y=(h+a)*u):r>c?(u=r-(c+e)+1,u=Math.sqrt(u),this.y=.5*u,u=.5/u,this.w=(o-s)*u,this.z=(a+h)*u,this.x=(n+i)*u):(u=c-(e+r)+1,u=Math.sqrt(u),this.z=.5*u,u=.5/u,this.w=(i-n)*u,this.x=(o+s)*u,this.y=(h+a)*u),this},slerp:function(t,e,i){return i=pc.math.clamp(i,0,1),this.slerpUnclamped(t,e,i)},slerpUnclamped:function(t,e,i){var s,n,r,a,o,h,c,l;s=t.x,n=t.y,r=t.z,a=t.w,o=e.x,h=e.y,c=e.z;var p=a*(l=e.w)+s*o+n*h+r*c;if(p<0&&(l=-l,o=-o,h=-h,c=-c,p=-p),Math.abs(p)>=1)return this.w=a,this.x=s,this.y=n,this.z=r,this;var u=Math.acos(p),d=Math.sqrt(1-p*p);if(Math.abs(d)<.001)return this.w=.5*a+.5*l,this.x=.5*s+.5*o,this.y=.5*n+.5*h,this.z=.5*r+.5*c,this;var _=Math.sin((1-i)*u)/d,f=Math.sin(i*u)/d;return this.w=a*_+l*f,this.x=s*_+o*f,this.y=n*_+h*f,this.z=r*_+c*f,this},transformVector:function(t,e){void 0===e&&(e=new pc.Vec3);var i=t.x,s=t.y,n=t.z,r=this.x,a=this.y,o=this.z,h=this.w,c=h*i+a*n-o*s,l=h*s+o*i-r*n,p=h*n+r*s-a*i,u=-r*i-a*s-o*n;return e.x=c*h+u*-r+l*-o-p*-a,e.y=l*h+u*-a+p*-r-c*-o,e.z=p*h+u*-o+c*-a-l*-r,e},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"},setLookAt:function(t,e){if(t.equals(pc.Vec3.ZERO))return this.copy(pc.Quat.IDENTITY);var i=(new pc.Mat4).setLookAt(pc.Vec3.ZERO,t,e);return this.setFromMat4(i),this}}),Object.defineProperty(i,"IDENTITY",{get:(t=Object.freeze(new i),function(){return t})}),Object.defineProperty(i,"ZERO",{get:(e=Object.freeze(new i(0,0,0,0)),function(){return e})}),{Quat:i}}()),Object.assign(pc,function(){"use strict";var t=function(t){if(this.keys=[],this.type=1,this.tension=.5,t)for(var e=0;e<t.length-1;e+=2)this.keys.push([t[e],t[e+1]]);this.sort()};return Object.assign(t.prototype,{add:function(t,e){for(var i=this.keys,s=i.length,n=0;n<s&&!(i[n][0]>t);n++);var r=[t,e];return this.keys.splice(n,0,r),r},get:function(t){return this.keys[t]},sort:function(){this.keys.sort((function(t,e){return t[0]-e[0]}))},value:function(t){var e,i,s=this.keys;if(!s.length)return 0;if(t<s[0][0])return s[0][1];if(t>s[s.length-1][0])return s[s.length-1][1];var n=0,r=s.length?s[0][1]:0,a=1,o=0;for(e=0,i=s.length;e<i;e++){if(s[e][0]===t)return s[e][1];if(o=s[e][1],t<s[e][0]){a=s[e][0];break}n=s[e][0],r=s[e][1]}var h=a-n,c=0===h?0:(t-n)/h;if(1===this.type)c*=c*(3-2*c);else if(2===this.type||3===this.type){var l=r,p=o,u=l+(l-p),d=p+(p-l),_=a-n,f=_,m=_;return e>0&&e--,e>0&&(u=s[e-1][1],f=s[e][0]-s[e-1][0]),s.length>e+1&&(_=s[e+1][0]-s[e][0]),s.length>e+2&&(m=s[e+2][0]-s[e+1][0],d=s[e+2][1]),u=l+(u-l)*_/f,d=p+(d-p)*_/m,2===this.type?this._interpolateCatmullRom(u,l,p,d,c):this._interpolateCardinal(u,l,p,d,c,this.tension)}return pc.math.lerp(r,o,c)},_interpolateHermite:function(t,e,i,s,n){var r=n*n,a=n*n*n;return t*(2*a-3*r+1)+e*(-2*a+3*r)+i*(a-2*r+n)+s*(a-r)},_interpolateCardinal:function(t,e,i,s,n,r){var a=r*(i-t),o=r*(s-e);return this._interpolateHermite(e,i,a,o,n)},_interpolateCatmullRom:function(t,e,i,s,n){return this._interpolateCardinal(t,e,i,s,n,.5)},closest:function(t){for(var e=this.keys,i=e.length,s=2,n=null,r=0;r<i;r++){var a=Math.abs(t-e[r][0]);if(!(s>=a))break;s=a,n=e[r]}return n},clone:function(){var t=new pc.Curve;return t.keys=pc.extend(t.keys,this.keys),t.type=this.type,t},quantize:function(t){t=Math.max(t,2);for(var e=new Float32Array(t),i=1/(t-1),s=0;s<t;s++){var n=this.value(i*s);e[s]=n}return e}}),Object.defineProperty(t.prototype,"length",{get:function(){return this.keys.length}}),{Curve:t,CURVE_LINEAR:0,CURVE_SMOOTHSTEP:1,CURVE_CATMULL:2,CURVE_CARDINAL:3}}()),Object.assign(pc,function(){"use strict";var t=function(){var t;if(this.curves=[],this._type=pc.CURVE_SMOOTHSTEP,arguments.length>1)for(t=0;t<arguments.length;t++)this.curves.push(new pc.Curve(arguments[t]));else if(0===arguments.length);else{var e=arguments[0];if("number"===pc.type(e))for(t=0;t<e;t++)this.curves.push(new pc.Curve);else for(t=0;t<e.length;t++)this.curves.push(new pc.Curve(e[t]))}};return Object.assign(t.prototype,{get:function(t){return this.curves[t]},value:function(t,e){var i=this.curves.length;(e=e||[]).length=i;for(var s=0;s<i;s++)e[s]=this.curves[s].value(t);return e},clone:function(){var t=new pc.CurveSet;t.curves=[];for(var e=0;e<this.curves.length;e++)t.curves.push(this.curves[e].clone());return t._type=this._type,t},quantize:function(t){t=Math.max(t,2);for(var e=this.curves.length,i=new Float32Array(t*e),s=1/(t-1),n=[],r=0;r<t;r++){var a=this.value(s*r,n);if(1==e)i[r]=a[0];else for(var o=0;o<e;o++)i[r*e+o]=a[o]}return i}}),Object.defineProperty(t.prototype,"length",{get:function(){return this.curves.length}}),Object.defineProperty(t.prototype,"type",{get:function(){return this._type},set:function(t){this._type=t;for(var e=0;e<this.curves.length;e++)this.curves[e].type=t}}),{CurveSet:t}}()),pc.extend(pc,function(){var t=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=1/(4*Math.PI),i=1/(2*Math.PI),s=15/(16*Math.PI),n=5/(64*Math.PI),r=15/(64*Math.PI),a=new pc.Color,o=new pc.Vec3,h=new Float64Array(t),c=function(e){return this.data=new Float64Array(e||t),this};return c.fromArray=function(t){var e=Object.create(c.prototype);return e.data=t,e},pc.extend(c.prototype,{get:function(t,e){return this.data[9*t+e]},set:function(t,e,i){this.data[9*t+e]=i},copy:function(t){for(var e=0;e<this.data.length;e++)this.data[e]=t.data[e]},clear:function(){for(var t=0;t<this.data.length;t++)this.data[t]=0},setFromInterpolation:function(t,e){for(var i=0;i<this.data.length;i++){this.data[i]=0;for(var s=0;s<t.length;s++)this.data[i]+=t[s].data[i]*e[s]}},addCubemap:function(e,i){var s=e.width,n=0,r=this.data;h.set(t),this.data=h;for(var c=0;c<6;c++)for(var l=e._levels[0][c],p=0;p<s;p++)for(var u=0;u<s;u++){var d=p*s+u,_=u/(s-1)*2-1,f=p/(s-1)*2-1,m=1+_*_+f*f,g=4/(Math.sqrt(m)*m);switch(o.set(_,-f,1).normalize(),c){case 0:o.set(o.z,-o.y,-o.x);break;case 1:o.set(-o.z,-o.y,o.x);break;case 2:o.set(o.x,o.z,o.y);break;case 3:o.set(o.x,-o.z,-o.y);break;case 4:o.set(o.x,-o.y,o.z);break;case 5:o.set(-o.x,-o.y,-o.z)}a.set(l[4*d+0]/255,l[4*d+1]/255,l[4*d+2]/255,1),this.addDirectionalLight(o,a,i,g/2.956),n+=g}for(var y=0;y<this.data.length;y++)r[y]+=4*h[y]*Math.PI/n;this.data=r},addAmbientLight:function(t){a.copy(t).toLinear(),this.data[0]+=a.r,this.data[9]+=a.g,this.data[18]+=a.b},addSkyGradient:function(t,e,i){this.addAmbientLight(e),this.addDirectionalLight(pc.Vec3.UP,t,1,1),this.addDirectionalLight(pc.Vec3.DOWN,i,1,1)},addPointLight:function(t,e,i,s){var n=t.length()/s;o.copy(t).normalize();var r=pc.math.clamp(1/(1+25*n*n)*pc.math.clamp(5*(1-n),0,1),0,1);this.addDirectionalLight(o,e,i,r)},addSpotLight:function(t,e,i,s,n){this.addPointLight(t,e,i,s)},addDirectionalLight:function(t,e,i,s){a.copy(e).scale(i).toLinear().scale(2.956*s),this.addLightFromDirection(t,a)},addLightFromDirection:function(t,a){var o=e,h=i*t.y,c=i*t.z,l=i*t.x,p=s*(t.x*t.y),u=s*(t.y*t.z),d=n*(3*t.z*t.z-1),_=s*(t.x*t.z),f=r*(t.x*t.x-t.y*t.y);this.data[0]+=a.r*o,this.data[1]+=a.r*h,this.data[2]+=a.r*c,this.data[3]+=a.r*l,this.data[4]+=a.r*p,this.data[5]+=a.r*u,this.data[6]+=a.r*d,this.data[7]+=a.r*_,this.data[8]+=a.r*f,this.data[9]+=a.g*o,this.data[10]+=a.g*h,this.data[11]+=a.g*c,this.data[12]+=a.g*l,this.data[13]+=a.g*p,this.data[14]+=a.g*u,this.data[15]+=a.g*d,this.data[16]+=a.g*_,this.data[17]+=a.g*f,this.data[18]+=a.b*o,this.data[19]+=a.b*h,this.data[20]+=a.b*c,this.data[21]+=a.b*l,this.data[22]+=a.b*p,this.data[23]+=a.b*u,this.data[24]+=a.b*d,this.data[25]+=a.b*_,this.data[26]+=a.b*f},updateUniforms:function(){this.uniforms||(this.uniforms=[new pc.Vec4,new pc.Vec4,new pc.Vec4,new pc.Vec4,new pc.Vec4,new pc.Vec4,new pc.Vec4]);for(var t=0;t<3;t++)this.uniforms[t].x=this.get(t,3),this.uniforms[t].y=this.get(t,1),this.uniforms[t].z=this.get(t,2),this.uniforms[t].w=this.get(t,0)-this.get(t,6);for(t=0;t<3;t++)this.uniforms[t+3].x=this.get(t,4),this.uniforms[t+3].y=this.get(t,5),this.uniforms[t+3].z=3*this.get(t,6),this.uniforms[t+3].w=this.get(t,7);this.uniforms[6].x=this.get(0,8),this.uniforms[6].y=this.get(1,8),this.uniforms[6].z=this.get(2,8),this.uniforms[6].w=1;for(t=0;t<7;t++)this.uniforms[t].data},isEmpty:function(){for(var t=0;t<this.data.length;t++)if(Math.abs(this.data[t])>=1e-8)return!1;return!0}}),{SphericalHarmonicsL2:c}}()),Object.assign(pc,function(){var t=new pc.Vec3,e=new pc.Vec3,i=new pc.Vec3,s=new pc.Vec3,n=new pc.Vec3,r=function(t,e){this.center=t||new pc.Vec3,this.halfExtents=e||new pc.Vec3,this._min=new pc.Vec3,this._max=new pc.Vec3};return Object.assign(r.prototype,{add:function(t){var e=this.center,i=e.x,s=e.y,n=e.z,r=this.halfExtents,a=r.x,o=r.y,h=r.z,c=i-a,l=i+a,p=s-o,u=s+o,d=n-h,_=n+h,f=t.center,m=f.x,g=f.y,y=f.z,E=t.halfExtents,v=E.x,T=E.y,b=E.z,A=m-v,S=m+v,R=g-T,I=g+T,C=y-b,M=y+b;A<c&&(c=A),S>l&&(l=S),R<p&&(p=R),I>u&&(u=I),C<d&&(d=C),M>_&&(_=M),e.x=.5*(c+l),e.y=.5*(p+u),e.z=.5*(d+_),r.x=.5*(l-c),r.y=.5*(u-p),r.z=.5*(_-d)},copy:function(t){this.center.copy(t.center),this.halfExtents.copy(t.halfExtents),this.type=t.type},clone:function(){return new pc.BoundingBox(this.center.clone(),this.halfExtents.clone())},intersects:function(t){var e=this.getMax(),i=this.getMin(),s=t.getMax(),n=t.getMin();return i.x<=s.x&&e.x>=n.x&&i.y<=s.y&&e.y>=n.y&&i.z<=s.z&&e.z>=n.z},_intersectsRay:function(n,r){var a=t.copy(this.getMin()).sub(n.origin),o=e.copy(this.getMax()).sub(n.origin),h=n.direction;0===h.x?(a.x=a.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,o.x=o.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(a.x/=h.x,o.x/=h.x),0===h.y?(a.y=a.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,o.y=o.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(a.y/=h.y,o.y/=h.y),0===h.z?(a.z=a.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,o.z=o.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(a.z/=h.z,o.z/=h.z);var c=i.set(Math.min(a.x,o.x),Math.min(a.y,o.y),Math.min(a.z,o.z)),l=s.set(Math.max(a.x,o.x),Math.max(a.y,o.y),Math.max(a.z,o.z)),p=Math.min(Math.min(l.x,l.y),l.z),u=Math.max(Math.max(c.x,c.y),c.z),d=p>=u&&u>=0;return d&&r.copy(n.direction).scale(u).add(n.origin),d},_fastIntersectsRay:function(r){var a=t,o=e,h=i,c=s,l=n,p=r.direction;return a.sub2(r.origin,this.center),c.set(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z)),h.mul2(a,p),!(c.x>this.halfExtents.x&&h.x>=0)&&(!(c.y>this.halfExtents.y&&h.y>=0)&&(!(c.z>this.halfExtents.z&&h.z>=0)&&(l.set(Math.abs(p.x),Math.abs(p.y),Math.abs(p.z)),o.cross(p,a),o.set(Math.abs(o.x),Math.abs(o.y),Math.abs(o.z)),!(o.x>this.halfExtents.y*l.z+this.halfExtents.z*l.y)&&(!(o.y>this.halfExtents.x*l.z+this.halfExtents.z*l.x)&&!(o.z>this.halfExtents.x*l.y+this.halfExtents.y*l.x)))))},intersectsRay:function(t,e){return e?this._intersectsRay(t,e):this._fastIntersectsRay(t)},setMinMax:function(t,e){this.center.add2(e,t).scale(.5),this.halfExtents.sub2(e,t).scale(.5)},getMin:function(){return this._min.copy(this.center).sub(this.halfExtents)},getMax:function(){return this._max.copy(this.center).add(this.halfExtents)},containsPoint:function(t){var e=this.getMin(),i=this.getMax();return!(t.x<e.x||t.x>i.x||t.y<e.y||t.y>i.y||t.z<e.z||t.z>i.z)},setFromTransformedAabb:function(t,e,i){var s=this.center,n=this.halfExtents,r=t.center,a=t.halfExtents,o=(e=e.data)[0],h=e[4],c=e[8],l=e[1],p=e[5],u=e[9],d=e[2],_=e[6],f=e[10],m=Math.abs(o),g=Math.abs(h),y=Math.abs(c),E=Math.abs(l),v=Math.abs(p),T=Math.abs(u),b=Math.abs(d),A=Math.abs(_),S=Math.abs(f);if(s.set(e[12]+o*r.x+h*r.y+c*r.z,e[13]+l*r.x+p*r.y+u*r.z,e[14]+d*r.x+_*r.y+f*r.z),n.set(m*a.x+g*a.y+y*a.z,E*a.x+v*a.y+T*a.z,b*a.x+A*a.y+S*a.z),i){var R=e[3],I=e[7],C=e[11],M=e[15],O=Math.abs(R),P=Math.abs(I),x=Math.abs(C),w=Math.abs(M),L=M+R*r.x+I*r.y+C*r.z,F=w+O*a.x+P*a.y+x*a.z;s.scale(1/L),n.scale(1/F)}},compute:function(i,s){s=s||3;for(var n=t.set(i[0],i[1],i[2]),r=e.set(i[0],i[1],i[2]),a=i.length/s,o=1;o<a;o++){var h=i[o*s+0],c=i[o*s+1],l=i[o*s+2];h<n.x&&(n.x=h),c<n.y&&(n.y=c),l<n.z&&(n.z=l),h>r.x&&(r.x=h),c>r.y&&(r.y=c),l>r.z&&(r.z=l)}this.setMinMax(n,r)},expandToPoint:function(t){var e=this.getMin(),i=this.getMax();e.x=Math.min(e.x,t.x),e.y=Math.min(e.y,t.y),e.z=Math.min(e.z,t.z),i.x=Math.max(i.x,t.x),i.y=Math.max(i.y,t.y),i.z=Math.max(i.z,t.z),this.setMinMax(e,i)},intersectsBoundingSphere:function(t){return this._distanceToBoundingSphereSq(t)<=t.radius*t.radius},_distanceToBoundingSphereSq:function(t){for(var e=this.getMin(),i=this.getMax(),s=0,n=["x","y","z"],r=0;r<3;++r){var a=0,o=t.center[n[r]],h=e[n[r]],c=i[n[r]],l=0;o<h&&(a+=(l=h-o)*l),o>c&&(a+=(l=o-c)*l),s+=a}return s}}),{BoundingBox:r}}()),Object.assign(pc,function(){var t=new pc.Vec3,e=new pc.Vec3,i=new pc.Vec3,s=new pc.Vec3;function n(t,e){this.center=t||new pc.Vec3(0,0,0),this.radius=void 0===e?.5:e}return Object.assign(n.prototype,{containsPoint:function(e){var i=t.sub2(e,this.center).lengthSq(),s=this.radius;return i<s*s},compute:function(n){var r,a=n.length/3,o=t,h=e,c=i;for(r=0;r<a;r++)o.set(n[3*r],n[3*r+1],n[3*r+2]),c.addSelf(o),r%100==0&&(c.scale(1/a),h.add(c),c.set(0,0,0));c.scale(1/a),h.add(c),this.center.copy(h);var l=0,p=s;for(r=0;r<a;r++)o.set(n[3*r],n[3*r+1],n[3*r+2]),p.sub2(o,this.center),l=Math.max(p.lengthSq(),l);this.radius=Math.sqrt(l)},intersectsRay:function(i,s){var n=t.copy(i.origin).sub(this.center),r=n.dot(e.copy(i.direction).normalize()),a=n.dot(n)-this.radius*this.radius;if(a>0&&r>0)return null;var o=r*r-a;if(o<0)return!1;var h=Math.abs(-r-Math.sqrt(o));return s&&s.copy(i.direction).scale(h).add(i.origin),!0},intersectsBoundingSphere:function(e){t.sub2(e.center,this.center);var i=e.radius+this.radius;return t.lengthSq()<=i*i}}),{BoundingSphere:n}}()),Object.assign(pc,function(){var t=new pc.Mat4,e=function(t,e){t=t||(new pc.Mat4).setPerspective(90,16/9,.1,1e3),e=e||new pc.Mat4,this.planes=[],this.unityPlanesOrthographic=[],this.unityPlanesPerspective=[];for(var i=0;i<6;i++)this.planes[i]=[];this.unityPlanesOrthographic[0]=this.planes[1],this.unityPlanesOrthographic[1]=this.planes[0],this.unityPlanesOrthographic[2]=this.planes[2],this.unityPlanesOrthographic[3]=this.planes[3],this.unityPlanesOrthographic[4]=this.planes[5],this.unityPlanesOrthographic[5]=this.planes[4],this.unityPlanesPerspective[0]=this.planes[1],this.unityPlanesPerspective[1]=this.planes[0],this.unityPlanesPerspective[2]=this.planes[3],this.unityPlanesPerspective[3]=this.planes[2],this.unityPlanesPerspective[4]=this.planes[5],this.unityPlanesPerspective[5]=this.planes[4],this.update(t,e)};return Object.assign(e.prototype,{update:function(e,i){t.mul2(e,i);var s=t.data;this.planes[0][0]=s[3]-s[0],this.planes[0][1]=s[7]-s[4],this.planes[0][2]=s[11]-s[8],this.planes[0][3]=s[15]-s[12];var n=Math.sqrt(this.planes[0][0]*this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]);this.planes[0][0]/=n,this.planes[0][1]/=n,this.planes[0][2]/=n,this.planes[0][3]/=n,this.planes[1][0]=s[3]+s[0],this.planes[1][1]=s[7]+s[4],this.planes[1][2]=s[11]+s[8],this.planes[1][3]=s[15]+s[12],n=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]),this.planes[1][0]/=n,this.planes[1][1]/=n,this.planes[1][2]/=n,this.planes[1][3]/=n,this.planes[2][0]=s[3]+s[1],this.planes[2][1]=s[7]+s[5],this.planes[2][2]=s[11]+s[9],this.planes[2][3]=s[15]+s[13],n=Math.sqrt(this.planes[2][0]*this.planes[2][0]+this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]),this.planes[2][0]/=n,this.planes[2][1]/=n,this.planes[2][2]/=n,this.planes[2][3]/=n,this.planes[3][0]=s[3]-s[1],this.planes[3][1]=s[7]-s[5],this.planes[3][2]=s[11]-s[9],this.planes[3][3]=s[15]-s[13],n=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+this.planes[3][2]*this.planes[3][2]),this.planes[3][0]/=n,this.planes[3][1]/=n,this.planes[3][2]/=n,this.planes[3][3]/=n,this.planes[4][0]=s[3]-s[2],this.planes[4][1]=s[7]-s[6],this.planes[4][2]=s[11]-s[10],this.planes[4][3]=s[15]-s[14],n=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]),this.planes[4][0]/=n,this.planes[4][1]/=n,this.planes[4][2]/=n,this.planes[4][3]/=n,this.planes[5][0]=s[3]+s[2],this.planes[5][1]=s[7]+s[6],this.planes[5][2]=s[11]+s[10],this.planes[5][3]=s[15]+s[14],n=Math.sqrt(this.planes[5][0]*this.planes[5][0]+this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*this.planes[5][2]),this.planes[5][0]/=n,this.planes[5][1]/=n,this.planes[5][2]/=n,this.planes[5][3]/=n},containsPoint:function(t){for(var e=0;e<6;e++)if(this.planes[e][0]*t.x+this.planes[e][1]*t.y+this.planes[e][2]*t.z+this.planes[e][3]<=0)return!1;return!0},containsSphere:function(t){var e,i,s,n=0,r=t.radius,a=t.center,o=a.x,h=a.y,c=a.z,l=this.planes;for(i=0;i<6;i++){if((e=(s=l[i])[0]*o+s[1]*h+s[2]*c+s[3])<=-r)return 0;e>r&&n++}return 6===n?2:1}}),{Frustum:e}}()),Object.assign(pc,function(){var t=new pc.Vec3,e=function(t,e){this.normal=e||new pc.Vec3(0,0,1),this.point=t||new pc.Vec3(0,0,0)};return Object.assign(e.prototype,{intersectsLine:function(t,e,i){var s=-this.normal.dot(this.point),n=this.normal.dot(t)+s,r=n/(n-(this.normal.dot(e)+s)),a=r>=0&&r<=1;return a&&i&&i.lerp(t,e,r),a},intersectsRay:function(e,i){var s=t.sub2(this.point,e.origin),n=this.normal.dot(s)/this.normal.dot(e.direction),r=n>=0;return r&&i&&i.copy(e.direction).scale(n).add(e.origin),r}}),{Plane:e}}()),Object.assign(pc,{Ray:function(t,e){this.origin=t||new pc.Vec3(0,0,0),this.direction=e||new pc.Vec3(0,0,-1)}}),Object.assign(pc,function(){var t=new pc.Ray,e=new pc.Vec3,i=new pc.BoundingSphere,s=new pc.Mat4,n=function(t,e){this.halfExtents=e||new pc.Vec3(.5,.5,.5),t=t||s.setIdentity(),this._modelTransform=t.clone().invert(),this._worldTransform=t.clone(),this._aabb=new pc.BoundingBox(new pc.Vec3,this.halfExtents)};return Object.assign(n.prototype,{intersectsRay:function(e,i){if(this._modelTransform.transformPoint(e.origin,t.origin),this._modelTransform.transformVector(e.direction,t.direction),i){var n=this._aabb._intersectsRay(t,i);return s.copy(this._modelTransform).invert().transformPoint(i,i),n}return this._aabb._fastIntersectsRay(t)},containsPoint:function(t){return this._modelTransform.transformPoint(t,e),this._aabb.containsPoint(e)},intersectsBoundingSphere:function(t){return this._modelTransform.transformPoint(t.center,i.center),i.radius=t.radius,!!this._aabb.intersectsBoundingSphere(i)}}),Object.defineProperty(n.prototype,"worldTransform",{get:function(){return this._worldTransform},set:function(t){this._worldTransform.copy(t),this._modelTransform.copy(t).invert()}}),{OrientedBox:n}}()),function(){var t={ADDRESS_REPEAT:0,ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BLENDEQUATION_ADD:0,BLENDEQUATION_SUBTRACT:1,BLENDEQUATION_REVERSE_SUBTRACT:2,BLENDEQUATION_MIN:3,BLENDEQUATION_MAX:4,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,BUFFER_GPUDYNAMIC:3,CLEARFLAG_COLOR:1,CLEARFLAG_DEPTH:2,CLEARFLAG_STENCIL:4,CLEARFLAG_USE_SKYBOX:8,CUBEFACE_POSX:0,CUBEFACE_NEGX:1,CUBEFACE_POSY:2,CUBEFACE_NEGY:3,CUBEFACE_POSZ:4,CUBEFACE_NEGZ:5,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,TYPE_INT8:0,TYPE_UINT8:1,TYPE_INT16:2,TYPE_UINT16:3,TYPE_INT32:4,TYPE_UINT32:5,TYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,FUNC_NEVER:0,FUNC_LESS:1,FUNC_EQUAL:2,FUNC_LESSEQUAL:3,FUNC_GREATER:4,FUNC_NOTEQUAL:5,FUNC_GREATEREQUAL:6,FUNC_ALWAYS:7,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_A8:0,PIXELFORMAT_L8:1,PIXELFORMAT_L8_A8:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R5_G5_B5_A1:4,PIXELFORMAT_R4_G4_B4_A4:5,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PIXELFORMAT_DXT1:8,PIXELFORMAT_DXT3:9,PIXELFORMAT_DXT5:10,PIXELFORMAT_RGB16F:11,PIXELFORMAT_RGBA16F:12,PIXELFORMAT_RGB32F:13,PIXELFORMAT_RGBA32F:14,PIXELFORMAT_R32F:15,PIXELFORMAT_DEPTH:16,PIXELFORMAT_DEPTHSTENCIL:17,PIXELFORMAT_111110F:18,PIXELFORMAT_SRGB:19,PIXELFORMAT_SRGBA:20,PIXELFORMAT_ETC1:21,PIXELFORMAT_ETC2_RGB:22,PIXELFORMAT_ETC2_RGBA:23,PIXELFORMAT_PVRTC_2BPP_RGB_1:24,PIXELFORMAT_PVRTC_2BPP_RGBA_1:25,PIXELFORMAT_PVRTC_4BPP_RGB_1:26,PIXELFORMAT_PVRTC_4BPP_RGBA_1:27,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_TANGENT:"TANGENT",SEMANTIC_BLENDWEIGHT:"BLENDWEIGHT",SEMANTIC_BLENDINDICES:"BLENDINDICES",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_TEXCOORD2:"TEXCOORD2",SEMANTIC_TEXCOORD3:"TEXCOORD3",SEMANTIC_TEXCOORD4:"TEXCOORD4",SEMANTIC_TEXCOORD5:"TEXCOORD5",SEMANTIC_TEXCOORD6:"TEXCOORD6",SEMANTIC_TEXCOORD7:"TEXCOORD7",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",SEMANTIC_ATTR4:"ATTR4",SEMANTIC_ATTR5:"ATTR5",SEMANTIC_ATTR6:"ATTR6",SEMANTIC_ATTR7:"ATTR7",SEMANTIC_ATTR8:"ATTR8",SEMANTIC_ATTR9:"ATTR9",SEMANTIC_ATTR10:"ATTR10",SEMANTIC_ATTR11:"ATTR11",SEMANTIC_ATTR12:"ATTR12",SEMANTIC_ATTR13:"ATTR13",SEMANTIC_ATTR14:"ATTR14",SEMANTIC_ATTR15:"ATTR15",SHADERTAG_MATERIAL:1,STENCILOP_KEEP:0,STENCILOP_ZERO:1,STENCILOP_REPLACE:2,STENCILOP_INCREMENT:3,STENCILOP_INCREMENTWRAP:4,STENCILOP_DECREMENT:5,STENCILOP_DECREMENTWRAP:6,STENCILOP_INVERT:7,TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,TEXHINT_NONE:0,TEXHINT_SHADOWMAP:1,TEXHINT_ASSET:2,TEXHINT_LIGHTMAP:3,UNIFORMTYPE_BOOL:0,UNIFORMTYPE_INT:1,UNIFORMTYPE_FLOAT:2,UNIFORMTYPE_VEC2:3,UNIFORMTYPE_VEC3:4,UNIFORMTYPE_VEC4:5,UNIFORMTYPE_IVEC2:6,UNIFORMTYPE_IVEC3:7,UNIFORMTYPE_IVEC4:8,UNIFORMTYPE_BVEC2:9,UNIFORMTYPE_BVEC3:10,UNIFORMTYPE_BVEC4:11,UNIFORMTYPE_MAT2:12,UNIFORMTYPE_MAT3:13,UNIFORMTYPE_MAT4:14,UNIFORMTYPE_TEXTURE2D:15,UNIFORMTYPE_TEXTURECUBE:16,UNIFORMTYPE_FLOATARRAY:17,UNIFORMTYPE_TEXTURE2D_SHADOW:18,UNIFORMTYPE_TEXTURECUBE_SHADOW:19,UNIFORMTYPE_TEXTURE3D:20};Object.assign(pc,t),pc.gfx={},Object.assign(pc.gfx,t)}(),Object.assign(pc,function(){"use strict";var t=function(t){this.name=t,this.value=null,this.previous_value=null,this.versionObject=new pc.VersionedObject};return Object.assign(t.prototype,{setValue:function(t){this.value=t,this.previous_value=null,this.versionObject.increment()},pushValue:function(t){if(this.previous_value)throw new Error("pushValue is limited to storing 1 previous value");var e=this.value;this.setValue(t),this.previous_value=e},popValue:function(){this.setValue(this.previous_value)},getValue:function(t){return this.value}}),{ScopeId:t}}()),Object.assign(pc,function(){"use strict";var t=function(t){this.name=t,this.variables={},this.namespaces={}};return Object.assign(t.prototype,{resolve:function(t){return this.variables.hasOwnProperty(t)||(this.variables[t]=new pc.ScopeId(t)),this.variables[t]},getSubSpace:function(t){return this.namespaces.hasOwnProperty(t)||(this.namespaces[t]=new pc.ScopeSpace(t)),this.namespaces[t]}}),{ScopeSpace:t}}()),Object.assign(pc,function(){"use strict";var t=function(){this.globalId=0,this.revision=0};return Object.assign(t.prototype,{equals:function(t){return this.globalId===t.globalId&&this.revision===t.revision},notequals:function(t){return this.globalId!==t.globalId||this.revision!==t.revision},copy:function(t){this.globalId=t.globalId,this.revision=t.revision},reset:function(){this.globalId=0,this.revision=0}}),{Version:t}}()),Object.assign(pc,function(){"use strict";var t=0,e=function(){t++,this.version=new pc.Version,this.version.globalId=t};return Object.assign(e.prototype,{increment:function(){this.version.revision++}}),{VersionedObject:e}}()),Object.assign(pc,function(){"use strict";function t(t,r){switch(this.index=0,r.dataType){case pc.TYPE_INT8:this.array=new Int8Array(t,r.offset);break;case pc.TYPE_UINT8:this.array=new Uint8Array(t,r.offset);break;case pc.TYPE_INT16:this.array=new Int16Array(t,r.offset);break;case pc.TYPE_UINT16:this.array=new Uint16Array(t,r.offset);break;case pc.TYPE_INT32:this.array=new Int32Array(t,r.offset);break;case pc.TYPE_UINT32:this.array=new Uint32Array(t,r.offset);break;case pc.TYPE_FLOAT32:this.array=new Float32Array(t,r.offset)}switch(r.numComponents){case 1:this.set=e;break;case 2:this.set=i;break;case 3:this.set=s;break;case 4:this.set=n}}function e(t){this.array[this.index]=t}function i(t,e){this.array[this.index]=t,this.array[this.index+1]=e}function s(t,e,i){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=i}function n(t,e,i,s){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=i,this.array[this.index+3]=s}function r(e){this.vertexBuffer=e,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};for(var i=this.vertexBuffer.getFormat(),s=0;s<i.elements.length;s++){var n=i.elements[s];this.accessors[s]=new t(this.buffer,n),this.element[n.name]=this.accessors[s]}}return t.prototype.get=function(t){return this.array[this.index+t]},Object.assign(r.prototype,{next:function(t){void 0===t&&(t=1);for(var e=0,i=this.accessors,s=this.accessors.length,n=this.vertexBuffer.getFormat();e<s;){var r=i[e++];r.index+=t*n.size/r.array.constructor.BYTES_PER_ELEMENT}},end:function(){this.vertexBuffer.unlock()}}),{VertexIterator:r}}()),Object.assign(pc,function(){"use strict";var t=[];t[pc.TYPE_INT8]=1,t[pc.TYPE_UINT8]=1,t[pc.TYPE_INT16]=2,t[pc.TYPE_UINT16]=2,t[pc.TYPE_INT32]=4,t[pc.TYPE_UINT32]=4,t[pc.TYPE_FLOAT32]=4;return{VertexFormat:function(e,i){var s,n,r;for(this.elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.elementMap={},this.size=0,s=0,n=i.length;s<n;s++){var a=i[s];r={name:a.semantic,offset:0,stride:0,stream:-1,scopeId:e.scope.resolve(a.semantic),dataType:a.type,numComponents:a.components,normalize:void 0!==a.normalize&&a.normalize,size:a.components*t[a.type]},this.elements.push(r),this.size+=4*Math.ceil(r.size/4),a.semantic===pc.SEMANTIC_TEXCOORD0?this.hasUv0=!0:a.semantic===pc.SEMANTIC_TEXCOORD1?this.hasUv1=!0:a.semantic===pc.SEMANTIC_COLOR?this.hasColor=!0:a.semantic===pc.SEMANTIC_TANGENT&&(this.hasTangents=!0)}var o=0;for(s=0,n=this.elements.length;s<n;s++)(r=this.elements[s]).offset=o,r.stride=this.size,o+=r.size,this.elementMap[r.name]=r}}}()),Object.assign(pc,function(){"use strict";var t=function(t,e,i,s,n){this.usage=s||pc.BUFFER_STATIC,this.format=e,this.numVertices=i,this.numBytes=e.size*i,t._vram.vb+=this.numBytes,this.device=t,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes)};return Object.defineProperty(t.prototype,"storage",{set:function(t){this._storage=t},get:function(){return this._storage}}),Object.assign(t.prototype,{destroy:function(){this.bufferId&&(this.device._vram.vb-=this.numBytes),this.invalidateBuffer()},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},lock:function(){return this.storage},unlock:function(){var t,e=this.device.gl;switch(this.bufferId||(this.bufferId=e.createBuffer()),this.usage){case pc.BUFFER_STATIC:t=e.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:t=e.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:t=e.STREAM_DRAW;break;case pc.BUFFER_GPUDYNAMIC:t=this.device.webgl2?e.DYNAMIC_COPY:e.STATIC_DRAW}e.bindBuffer(e.ARRAY_BUFFER,this.bufferId),e.bufferData(e.ARRAY_BUFFER,this.storage,t)},setData:function(t){return t.byteLength!==this.numBytes?(console.error("VertexBuffer: wrong initial data size: expected "+this.numBytes+", got "+t.byteLength),!1):(this.storage=t,this.unlock(),!0)}}),{VertexBuffer:t}}()),Object.assign(pc,function(){"use strict";var t=function(t,e,i,s,n){this.usage=s||pc.BUFFER_STATIC,this.format=e,this.numIndices=i,this.device=t;var r,a=this.device.gl;e===pc.INDEXFORMAT_UINT8?(r=1,this.glFormat=a.UNSIGNED_BYTE):e===pc.INDEXFORMAT_UINT16?(r=2,this.glFormat=a.UNSIGNED_SHORT):e===pc.INDEXFORMAT_UINT32&&(r=4,this.glFormat=a.UNSIGNED_INT),this.bytesPerIndex=r,this.numBytes=this.numIndices*r,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),t._vram.ib+=this.numBytes};return Object.assign(t.prototype,{destroy:function(){this.bufferId&&(this.device._vram.ib-=this.numBytes),this.invalidateBuffer()},getFormat:function(){return this.format},getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){var t,e=this.device.gl;switch(this.bufferId||(this.bufferId=e.createBuffer()),this.usage){case pc.BUFFER_STATIC:t=e.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:t=e.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:t=e.STREAM_DRAW;break;case pc.BUFFER_GPUDYNAMIC:t=this.device.webgl2?e.DYNAMIC_COPY:e.STATIC_DRAW}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.bufferId),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.storage,t)},setData:function(t){return t.byteLength!==this.numBytes?(console.error("IndexBuffer: wrong initial data size: expected "+this.numBytes+", got "+t.byteLength),!1):(this.storage=t,this.unlock(),!0)}}),{IndexBuffer:t}}()),Object.assign(pc,function(){"use strict";var t=function(t,e){e=e||pc.BUFFER_GPUDYNAMIC,this.device=t.device;var i=this.device.gl;this._inputBuffer=t,e===pc.BUFFER_GPUDYNAMIC&&t.usage!==e&&(i.bindBuffer(i.ARRAY_BUFFER,t.bufferId),i.bufferData(i.ARRAY_BUFFER,t.storage,i.DYNAMIC_COPY)),this._outputBuffer=new pc.VertexBuffer(t.device,t.format,t.numVertices,e,t.storage)};return t.createShader=function(t,e,i){return pc.shaderChunks.createShaderFromCode(t,e,null,i,!0)},Object.assign(t.prototype,{destroy:function(){this._outputBuffer.destroy()},process:function(t,e){void 0===e&&(e=!0);var i=this.device;if(i.setRenderTarget(null),i.updateBegin(),i.setVertexBuffer(this._inputBuffer,0),i.setRaster(!1),i.setTransformFeedbackBuffer(this._outputBuffer),i.setShader(t),i.draw({type:pc.PRIMITIVE_POINTS,base:0,count:this._inputBuffer.numVertices,indexed:!1}),i.setTransformFeedbackBuffer(null),i.setRaster(!0),i.updateEnd(),e){var s=this._inputBuffer.bufferId;this._inputBuffer.bufferId=this._outputBuffer.bufferId,this._outputBuffer.bufferId=s}}}),Object.defineProperty(t.prototype,"inputBuffer",{get:function(){return this._inputBuffer}}),Object.defineProperty(t.prototype,"outputBuffer",{get:function(){return this._outputBuffer}}),{TransformFeedback:t}}()),Object.assign(pc,function(){"use strict";var t=function(t,e){if(this.device=t,this.name=null,this._width=4,this._height=4,this._depth=1,this._pot=!0,this._format=pc.PIXELFORMAT_R8_G8_B8_A8,this.rgbm=!1,this.intensity=1,this._cubemap=!1,this._volume=!1,this.fixCubemapSeams=!1,this._flipY=!0,this._premultiplyAlpha=!1,this._mipmaps=!0,this._minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR,this._magFilter=pc.FILTER_LINEAR,this._anisotropy=1,this._addressU=pc.ADDRESS_CLAMP_TO_EDGE,this._addressV=pc.ADDRESS_CLAMP_TO_EDGE,this._addressW=pc.ADDRESS_CLAMP_TO_EDGE,this._compareOnRead=!1,this._compareFunc=pc.FUNC_LESS,this._atlas=null,this._rects=null,this.profilerHint=0,this._buffer=null,void 0!==e&&(this.name=e.name,this._width=void 0!==e.width?e.width:this._width,this._height=void 0!==e.height?e.height:this._height,this._pot=pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height),this._format=void 0!==e.format?e.format:this._format,this.rgbm=void 0!==e.rgbm?e.rgbm:this.rgbm,void 0!==e.mipmaps?this._mipmaps=e.mipmaps:this._mipmaps=void 0!==e.autoMipmap?e.autoMipmap:this._mipmaps,this._levels=e.levels,this._atlas=e.atlas,this._rects=e.rects,this._cubemap=void 0!==e.cubemap?e.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==e.fixCubemapSeams?e.fixCubemapSeams:this.fixCubemapSeams,this._minFilter=void 0!==e.minFilter?e.minFilter:this._minFilter,this._magFilter=void 0!==e.magFilter?e.magFilter:this._magFilter,this._anisotropy=void 0!==e.anisotropy?e.anisotropy:this._anisotropy,this._addressU=void 0!==e.addressU?e.addressU:this._addressU,this._addressV=void 0!==e.addressV?e.addressV:this._addressV,this._compareOnRead=void 0!==e.compareOnRead?e.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==e._compareFunc?e._compareFunc:this._compareFunc,this._flipY=void 0!==e.flipY?e.flipY:this._flipY,this._premultiplyAlpha=void 0!==e.premultiplyAlpha?e.premultiplyAlpha:this._premultiplyAlpha,t.webgl2&&(this._depth=void 0!==e.depth?e.depth:this._depth,this._volume=void 0!==e.volume?e.volume:this._volume,this._addressW=void 0!==e.addressW?e.addressW:this._addressW),this.profilerHint=void 0!==e.profilerHint?e.profilerHint:this.profilerHint),this._compressed=this._format===pc.PIXELFORMAT_DXT1||this._format===pc.PIXELFORMAT_DXT3||this._format===pc.PIXELFORMAT_DXT5||this._format>=pc.PIXELFORMAT_ETC1,this._invalid=!1,this._lockedLevel=-1,!this._levels)if(this._cubemap)this._levels=[[null,null,null,null,null,null]];else{const t=this.createBuffer(this._format,this._width,this._height);this._levels=[t]}this.dirtyAll(),this._gpuSize=0};Object.defineProperty(t.prototype,"minFilter",{get:function(){return this._minFilter},set:function(t){this._minFilter!==t&&(this._minFilter=t,this._parameterFlags|=1)}}),Object.defineProperty(t.prototype,"magFilter",{get:function(){return this._magFilter},set:function(t){this._magFilter!==t&&(this._magFilter=t,this._parameterFlags|=2)}}),Object.defineProperty(t.prototype,"addressU",{get:function(){return this._addressU},set:function(t){this._addressU!==t&&(this._addressU=t,this._parameterFlags|=4)}}),Object.defineProperty(t.prototype,"addressV",{get:function(){return this._addressV},set:function(t){this._addressV!==t&&(this._addressV=t,this._parameterFlags|=8)}}),Object.defineProperty(t.prototype,"addressW",{get:function(){return this._addressW},set:function(t){this.device.webgl2&&(this._volume?t!==this._addressW&&(this._addressW=t,this._parameterFlags|=16):console.warn("pc.Texture#addressW: Can't set W addressing mode for a non-3D texture."))}}),Object.defineProperty(t.prototype,"compareOnRead",{get:function(){return this._compareOnRead},set:function(t){this._compareOnRead!==t&&(this._compareOnRead=t,this._parameterFlags|=32)}}),Object.defineProperty(t.prototype,"compareFunc",{get:function(){return this._compareFunc},set:function(t){this._compareFunc!==t&&(this._compareFunc=t,this._parameterFlags|=64)}}),Object.defineProperty(t.prototype,"anisotropy",{get:function(){return this._anisotropy},set:function(t){this._anisotropy!==t&&(this._anisotropy=t,this._parameterFlags|=128)}}),Object.defineProperty(t.prototype,"autoMipmap",{get:function(){return this._mipmaps},set:function(t){this._mipmaps=t}}),Object.defineProperty(t.prototype,"mipmaps",{get:function(){return this._mipmaps},set:function(t){this._mipmaps!==t&&(this._mipmaps=t,this._minFilterDirty=!0,t&&(this._needsMipmapsUpload=!0))}}),Object.defineProperty(t.prototype,"width",{get:function(){return this._width}}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height}}),Object.defineProperty(t.prototype,"depth",{get:function(){return this._depth}}),Object.defineProperty(t.prototype,"format",{get:function(){return this._format}}),Object.defineProperty(t.prototype,"cubemap",{get:function(){return this._cubemap}});var e=null;return Object.defineProperty(t.prototype,"gpuSize",{get:function(){e||((e=[])[pc.PIXELFORMAT_A8]=1,e[pc.PIXELFORMAT_L8]=1,e[pc.PIXELFORMAT_L8_A8]=1,e[pc.PIXELFORMAT_R5_G6_B5]=2,e[pc.PIXELFORMAT_R5_G5_B5_A1]=2,e[pc.PIXELFORMAT_R4_G4_B4_A4]=2,e[pc.PIXELFORMAT_R8_G8_B8]=4,e[pc.PIXELFORMAT_R8_G8_B8_A8]=4,e[pc.PIXELFORMAT_RGB16F]=8,e[pc.PIXELFORMAT_RGBA16F]=8,e[pc.PIXELFORMAT_RGB32F]=16,e[pc.PIXELFORMAT_RGBA32F]=16,e[pc.PIXELFORMAT_R32F]=4,e[pc.PIXELFORMAT_DEPTH]=4,e[pc.PIXELFORMAT_DEPTHSTENCIL]=4,e[pc.PIXELFORMAT_111110F]=4,e[pc.PIXELFORMAT_SRGB]=4,e[pc.PIXELFORMAT_SRGBA]=4);var t=1;!this._pot||!this._mipmaps&&this._minFilter!==pc.FILTER_NEAREST_MIPMAP_NEAREST&&this._minFilter!==pc.FILTER_NEAREST_MIPMAP_LINEAR&&this._minFilter!==pc.FILTER_LINEAR_MIPMAP_NEAREST&&this._minFilter!==pc.FILTER_LINEAR_MIPMAP_LINEAR||this._compressed&&1===this._levels.length||(t=Math.round(Math.log2(Math.max(this._width,this._height))+1));for(var i=this._width,s=this._height,n=this._depth,r=0,a=0;a<t;a++){if(this._compressed)if(this._format===pc.PIXELFORMAT_ETC1)r+=Math.floor((i+3)/4)*Math.floor((s+3)/4)*8*n;else if(this._format===pc.PIXELFORMAT_PVRTC_2BPP_RGB_1||this._format===pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1)r+=Math.max(i,16)*Math.max(s,8)/4*n;else if(this._format===pc.PIXELFORMAT_PVRTC_4BPP_RGB_1||this._format===pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1)r+=Math.max(i,8)*Math.max(s,8)/2*n;else{var o=this._format===pc.PIXELFORMAT_DXT1?8:16;r+=Math.floor((i+4-1)/4)*Math.floor((s+4-1)/4)*o*n}else r+=i*s*n*e[this._format];i=Math.max(.5*i,1),s=Math.max(.5*s,1),n=Math.max(.5*n,1)}return this._cubemap&&(r*=6),r}}),Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume}}),Object.defineProperty(t.prototype,"flipY",{get:function(){return this._flipY},set:function(t){this._flipY!==t&&(this._flipY=t,this._needsUpload=!0)}}),Object.defineProperty(t.prototype,"premultiplyAlpha",{get:function(){return this._premultiplyAlpha},set:function(t){this._premultiplyAlpha!==t&&(this._premultiplyAlpha=t,this._needsUpload=!0)}}),Object.assign(t.prototype,{destroy:function(){this.device&&this.device.destroyTexture(this),this.device=null,this._levels=null},dirtyAll:function(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255},lock:function(t){if(void 0===(t=t||{level:0,face:0,mode:pc.TEXTURELOCK_WRITE}).level&&(t.level=0),void 0===t.face&&(t.face=0),void 0===t.mode&&(t.mode=pc.TEXTURELOCK_WRITE),this._lockedLevel=t.level,null===this._levels[t.level])switch(this._format){case pc.PIXELFORMAT_A8:case pc.PIXELFORMAT_L8:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth);break;case pc.PIXELFORMAT_L8_A8:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case pc.PIXELFORMAT_R5_G6_B5:case pc.PIXELFORMAT_R5_G5_B5_A1:case pc.PIXELFORMAT_R4_G4_B4_A4:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth);break;case pc.PIXELFORMAT_R8_G8_B8:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case pc.PIXELFORMAT_R8_G8_B8_A8:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case pc.PIXELFORMAT_DXT1:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case pc.PIXELFORMAT_DXT3:case pc.PIXELFORMAT_DXT5:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case pc.PIXELFORMAT_RGB16F:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case pc.PIXELFORMAT_RGB32F:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*3);break;case pc.PIXELFORMAT_RGBA16F:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case pc.PIXELFORMAT_RGBA32F:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[t.level]},setSource:function(t){var e,i,s,n=!1;if(this._cubemap){if(t[0]){for(i=t[0].width||0,s=t[0].height||0,e=0;e<6;e++)if(!(t[e]&&t[e].width===i&&t[e].height===s&&(t[e]instanceof HTMLImageElement||t[e]instanceof HTMLCanvasElement||t[e]instanceof HTMLVideoElement))){n=!0;break}}else n=!0;if(!n)for(e=0;e<6;e++)this._levels[0][e]!==t[e]&&(this._levelsUpdated[0][e]=!0)}else t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||(n=!0),n||(t!==this._levels[0]&&(this._levelsUpdated[0]=!0),i=t.width,s=t.height);if(n)if(this._width=4,this._height=4,this._pot=!0,this._cubemap)for(e=0;e<6;e++)this._levels[0][e]=null,this._levelsUpdated[0][e]=!0;else this._levels[0]=null,this._levelsUpdated[0]=!0;else this._width=i,this._height=s,this._pot=pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height),this._levels[0]=t;this._invalid===n&&n||(this._invalid=n,this.upload())},getSource:function(){return this._levels[0]},unlock:function(){-1===this._lockedLevel&&console.log("pc.Texture#unlock: Attempting to unlock a texture that is not locked."),this.upload(),this._lockedLevel=-1},upload:function(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps},getDds:function(){this.format!==pc.PIXELFORMAT_R8_G8_B8_A8&&console.error("This format is not implemented yet");for(var t,e,i=128,s=0;this._levels[s];){var n;if(this.cubemap)for(e=0;e<6;e++){if(!this._levels[s][e])return void console.error("No level data for mip "+s+", face "+e);if(!(n=this._levels[s][e].length))return void console.error("No byte array for mip "+s+", face "+e);i+=n}else{if(!(n=this._levels[s].length))return void console.error("No byte array for mip "+s);i+=n}i+=this._levels[s].length,s++}var r=new ArrayBuffer(i),a=new Uint32Array(r,0,32),o=528391;this._levels.length>1&&(o|=131072);var h=4096;this._levels.length>1&&(h|=4194304),(this._levels.length>1||this.cubemap)&&(h|=8);var c=this.cubemap?65024:0;for(a[0]=542327876,a[1]=124,a[2]=o,a[3]=this.height,a[4]=this.width,a[5]=this.width*this.height*4,a[6]=0,a[7]=this._levels.length,s=0;s<11;s++)a[8+s]=0;a[19]=32,a[20]=65,a[21]=0,a[22]=32,a[23]=16711680,a[24]=65280,a[25]=255,a[26]=4278190080,a[27]=h,a[28]=c,a[29]=0,a[30]=0,a[31]=0;var l,p,u=128;if(this.cubemap)for(e=0;e<6;e++)for(s=0;s<this._levels.length;s++){for(l=this._levels[s][e],p=new Uint8Array(r,u,l.length),t=0;t<l.length;t++)p[t]=l[t];u+=l.length}else for(s=0;s<this._levels.length;s++){for(l=this._levels[s],p=new Uint8Array(r,u,l.length),t=0;t<l.length;t++)p[t]=l[t];u+=l.length}return r},clone:function(){var t={name:this.name,width:this._width,height:this._height,addressU:this._addressU,addressV:this._addressV,mipmaps:this._mipmaps,minFilter:this._minFilter,magFilter:this._magFilter,autoMipmap:this._mipmaps,rgbm:this.rgbm,anisotropy:this._anisotropy,format:this._format},e=new pc.Texture(this.device,t);return e.setSource(this._levels[0]),e},createBuffer:function(t,e,i){switch(t){case pc.PIXELFORMAT_R8_G8_B8:return new Uint8Array(3*e*i);case pc.PIXELFORMAT_R8_G8_B8_A8:return new Uint8Array(4*e*i)}return null}}),{Texture:t}}()),Object.assign(pc,function(){"use strict";var t={depth:!0,face:0},e=function(e){var i=arguments[1],s=arguments[2];if(e instanceof pc.GraphicsDevice?(this._colorBuffer=i,e=s):this._colorBuffer=e.colorBuffer,this._glFrameBuffer=null,this._glDepthBuffer=null,e=void 0!==e?e:t,this._depthBuffer=e.depthBuffer,this._face=void 0!==e.face?e.face:0,this._depthBuffer){var n=this._depthBuffer._format;n===pc.PIXELFORMAT_DEPTH?(this._depth=!0,this._stencil=!1):n===pc.PIXELFORMAT_DEPTHSTENCIL?(this._depth=!0,this._stencil=!0):(console.warn("Incorrect depthBuffer format. Must be pc.PIXELFORMAT_DEPTH or pc.PIXELFORMAT_DEPTHSTENCIL"),this._depth=!1,this._stencil=!1)}else this._depth=void 0===e.depth||e.depth,this._stencil=void 0!==e.stencil&&e.stencil;this._samples=void 0!==e.samples?e.samples:1,this.autoResolve=void 0===e.autoResolve||e.autoResolve,this._glResolveFrameBuffer=null,this._glMsaaColorBuffer=null,this._glMsaaDepthBuffer=null};return Object.assign(e.prototype,{destroy:function(){if(this._device){var t=this._device,e=t.targets.indexOf(this);-1!==e&&t.targets.splice(e,1);var i=t.gl;this._glFrameBuffer&&(i.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(i.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(i.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffer&&(i.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null),this._glMsaaDepthBuffer&&(i.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}},resolve:function(t,e){if(this._device&&this._device.webgl2){var i=this._device.gl;void 0===t&&(t=!0),void 0===e&&this._depthBuffer&&(e=!0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._glFrameBuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer),i.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(t?i.COLOR_BUFFER_BIT:0)|(e?i.DEPTH_BUFFER_BIT:0),i.NEAREST),i.bindFramebuffer(i.FRAMEBUFFER,this._glFrameBuffer)}},copy:function(t,e,i){if(!this._device){if(!t._device)return console.error("Render targets are not initialized"),!1;this._device=t._device}return this._device.copyRenderTarget(t,this,e,i)}}),Object.defineProperty(e.prototype,"colorBuffer",{get:function(){return this._colorBuffer}}),Object.defineProperty(e.prototype,"depthBuffer",{get:function(){return this._depthBuffer}}),Object.defineProperty(e.prototype,"face",{get:function(){return this._face}}),Object.defineProperty(e.prototype,"width",{get:function(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}}),Object.defineProperty(e.prototype,"height",{get:function(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}}),{RenderTarget:e}}()),Object.assign(pc,function(){"use strict";return{ShaderInput:function(t,e,i,s){this.locationId=s,this.scopeId=t.scope.resolve(e),this.version=new pc.Version,i===pc.UNIFORMTYPE_FLOAT&&"[0]"===e.substr(e.length-3)&&(i=pc.UNIFORMTYPE_FLOATARRAY),this.dataType=i,this.dataType===pc.UNIFORMTYPE_VEC2?this.value=[null,null]:this.dataType===pc.UNIFORMTYPE_VEC3?this.value=[null,null,null]:this.value=[null,null,null,null],this.array=[]}}}()),Object.assign(pc,function(){"use strict";var t=function(t,e){this.device=t,this.definition=e,this.attributes=[],this.uniforms=[],this.samplers=[],this._keywords=[],this._supportsKeywords=!1,this._globalKeywordsVersion=0,this.ready=!1,this._refCount=0,this.device.createShader(this)};return Object.assign(t.prototype,{destroy:function(){this.device.destroyShader(this)}}),{Shader:t}}()),Object.assign(pc,function(){"use strict";var t=function(t){this._device=t,this._cache={},this._generators={},this._isClearingCache=!1};return t.prototype.register=function(t,e){this.isRegistered(t)||(this._generators[t]=e)},t.prototype.unregister=function(t){this.isRegistered(t)&&delete this._generators[t]},t.prototype.isRegistered=function(t){return void 0!==this._generators[t]},t.prototype.getProgram=function(t,e){var i=this._generators[t];if(void 0===i)return console.warn("ProgramLibrary#getProgram: No program library functions registered for: "+t),null;var s=this._device,n=i.generateKey(e),r=this._cache[n];if(!r){var a=i.createShaderDefinition(s,e);r=this._cache[n]=new pc.Shader(s,a)}return r},t.prototype.clearCache=function(){var t=this._cache;for(var e in this._isClearingCache=!0,t)t.hasOwnProperty(e)&&t[e].destroy();this._cache={},this._isClearingCache=!1},t.prototype.removeFromCache=function(t){if(!this._isClearingCache){var e=this._cache;for(var i in e)if(e.hasOwnProperty(i)&&e[i]===t){delete e[i];break}}},{ProgramLibrary:t}}()),Object.assign(pc,function(){"use strict";var t=new Float32Array([1,1,1,1]),e=new Float32Array([0,0,0,0]),i=new Float32Array([0,0,0,1]),s=new Float32Array([1,0,0,1]),n=new Float32Array([0,0,1,1]),r={};r[pc.SEMANTIC_POSITION]=0,r[pc.SEMANTIC_NORMAL]=1,r[pc.SEMANTIC_TANGENT]=2,r[pc.SEMANTIC_BLENDWEIGHT]=3,r[pc.SEMANTIC_BLENDINDICES]=4,r[pc.SEMANTIC_COLOR]=5,r[pc.SEMANTIC_TEXCOORD0]=6,r[pc.SEMANTIC_TEXCOORD1]=7,r[pc.SEMANTIC_TEXCOORD2]=8,r[pc.SEMANTIC_TEXCOORD3]=9,r[pc.SEMANTIC_TEXCOORD4]=10,r[pc.SEMANTIC_TEXCOORD5]=11,r[pc.SEMANTIC_TEXCOORD6]=12,r[pc.SEMANTIC_TEXCOORD7]=13,r[pc.SEMANTIC_ATTR0]=14,r[pc.SEMANTIC_ATTR1]=15,r[pc.SEMANTIC_ATTR2]=16,r[pc.SEMANTIC_ATTR3]=17,r[pc.SEMANTIC_ATTR4]=18,r[pc.SEMANTIC_ATTR5]=19,r[pc.SEMANTIC_ATTR6]=20,r[pc.SEMANTIC_ATTR7]=21,r[pc.SEMANTIC_ATTR8]=22,r[pc.SEMANTIC_ATTR9]=23,r[pc.SEMANTIC_ATTR10]=24,r[pc.SEMANTIC_ATTR11]=25,r[pc.SEMANTIC_ATTR12]=26,r[pc.SEMANTIC_ATTR13]=27,r[pc.SEMANTIC_ATTR14]=28,r[pc.SEMANTIC_ATTR15]=29;var a={};a[pc.UNIFORMTYPE_BOOL]=0,a[pc.UNIFORMTYPE_INT]=0,a[pc.UNIFORMTYPE_FLOAT]=0,a[pc.UNIFORMTYPE_VEC2]=new Float32Array([0,0]),a[pc.UNIFORMTYPE_VEC3]=new Float32Array([0,0,0]),a[pc.UNIFORMTYPE_VEC4]=new Float32Array([0,0,0,0]),a[pc.UNIFORMTYPE_IVEC2]=new Int32Array([0,0]),a[pc.UNIFORMTYPE_IVEC3]=new Int32Array([0,0,0]),a[pc.UNIFORMTYPE_IVEC4]=new Int32Array([0,0,0,0]),a[pc.UNIFORMTYPE_BVEC2]=0,a[pc.UNIFORMTYPE_BVEC3]=0,a[pc.UNIFORMTYPE_BVEC4]=0,a[pc.UNIFORMTYPE_MAT2]=new Float32Array([0,0,0,0]),a[pc.UNIFORMTYPE_MAT3]=new Float32Array([0,0,0,0,0,0,0,0,0]),a[pc.UNIFORMTYPE_MAT4]=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),a[pc.UNIFORMTYPE_TEXTURE2D]=null,a[pc.UNIFORMTYPE_TEXTURECUBE]=null,a[pc.UNIFORMTYPE_FLOATARRAY]=new Float32Array([0,0,0,0]),a[pc.UNIFORMTYPE_TEXTURE2D_SHADOW]=null,a[pc.UNIFORMTYPE_TEXTURECUBE_SHADOW]=null;var o=function(t,e){var i=t.width,s=t.height;if(i>e||s>e){var n=e/Math.max(i,s),r=Math.floor(i*n),a=Math.floor(s*n);console.warn("Image dimensions larger than max supported texture size of "+e+". Resizing from "+i+", "+s+" to "+r+", "+a+".");var o=document.createElement("canvas");return o.width=r,o.height=a,o.getContext("2d").drawImage(t,0,0,i,s,0,0,r,a),o}return t};function h(t,e){var i=!0,s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,null);var n=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE&&(i=!1),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(s),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(n),i}var c=function(t,e){var i;this.canvas=t,this.shader=null,this.indexBuffer=null,this.vertexBuffers=[],this.vbOffsets=[],this._enableAutoInstancing=!1,this.autoInstancingMaxObjects=16384,this.attributesInvalidated=!0,this.boundBuffer=null,this.boundElementBuffer=null,this.instancedAttribs={},this.enabledAttributes={},this.attributePointers={},this.transformFeedbackBuffer=null,this.activeFramebuffer=null,this.textureUnit=0,this.textureUnits=[],this._maxPixelRatio=2,this.renderTarget=null,this.feedback=null,this._width=0,this._height=0,this.updateClientRect(),this.vertexShaderCache={},this.fragmentShaderCache={},this.shaders=[],this.buffers=[],this.textures=[],this.targets=[],this.contextLost=!1,this._contextLostHandler=function(t){t.preventDefault(),this.contextLost=!0,console.log("pc.GraphicsDevice: WebGL context lost."),this.fire("devicelost")}.bind(this),this._contextRestoredHandler=function(){console.log("pc.GraphicsDevice: WebGL context restored."),this.initializeContext(),this.contextLost=!1,this.fire("devicerestored")}.bind(this),t.addEventListener("webglcontextlost",this._contextLostHandler,!1),t.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1);var s,n,r,a,o,c=!(!e||void 0===e.preferWebGl2)&&e.preferWebGl2,l=c?["webgl2","experimental-webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"],p=null;for((e=e||{}).stencil=!0,e.antialias=!e.disableAntiAliasing&&window.devicePixelRatio<2,e.alpha=!1,i=0;i<l.length;i++){try{p=t.getContext(l[i],e)}catch(t){}if(p){this.webgl2=c&&i<2;break}}if(!p)throw new Error("WebGL not supported");for(p.blendColor(0,0,0,0),this.gl=p,this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),i=0;i<this.maxCombinedTextures;i++)this.textureUnits.push([null,null,null]);for(var u in this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH},this.glAddress=[p.REPEAT,p.CLAMP_TO_EDGE,p.MIRRORED_REPEAT],this.glBlendEquation=[p.FUNC_ADD,p.FUNC_SUBTRACT,p.FUNC_REVERSE_SUBTRACT,this.webgl2?p.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:p.FUNC_ADD,this.webgl2?p.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:p.FUNC_ADD],this.glBlendFunction=[p.ZERO,p.ONE,p.SRC_COLOR,p.ONE_MINUS_SRC_COLOR,p.DST_COLOR,p.ONE_MINUS_DST_COLOR,p.SRC_ALPHA,p.SRC_ALPHA_SATURATE,p.ONE_MINUS_SRC_ALPHA,p.DST_ALPHA,p.ONE_MINUS_DST_ALPHA],this.glComparison=[p.NEVER,p.LESS,p.EQUAL,p.LEQUAL,p.GREATER,p.NOTEQUAL,p.GEQUAL,p.ALWAYS],this.glStencilOp=[p.KEEP,p.ZERO,p.REPLACE,p.INCR,p.INCR_WRAP,p.DECR,p.DECR_WRAP,p.INVERT],this.glClearFlag=[0,p.COLOR_BUFFER_BIT,p.DEPTH_BUFFER_BIT,p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT,p.STENCIL_BUFFER_BIT,p.STENCIL_BUFFER_BIT|p.COLOR_BUFFER_BIT,p.STENCIL_BUFFER_BIT|p.DEPTH_BUFFER_BIT,p.STENCIL_BUFFER_BIT|p.COLOR_BUFFER_BIT|p.DEPTH_BUFFER_BIT],this.glCull=[0,p.BACK,p.FRONT,p.FRONT_AND_BACK],this.glFilter=[p.NEAREST,p.LINEAR,p.NEAREST_MIPMAP_NEAREST,p.NEAREST_MIPMAP_LINEAR,p.LINEAR_MIPMAP_NEAREST,p.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[p.POINTS,p.LINES,p.LINE_LOOP,p.LINE_STRIP,p.TRIANGLES,p.TRIANGLE_STRIP,p.TRIANGLE_FAN],this.glType=[p.BYTE,p.UNSIGNED_BYTE,p.SHORT,p.UNSIGNED_SHORT,p.INT,p.UNSIGNED_INT,p.FLOAT],this.pcUniformType={},this.pcUniformType[p.BOOL]=pc.UNIFORMTYPE_BOOL,this.pcUniformType[p.INT]=pc.UNIFORMTYPE_INT,this.pcUniformType[p.FLOAT]=pc.UNIFORMTYPE_FLOAT,this.pcUniformType[p.FLOAT_VEC2]=pc.UNIFORMTYPE_VEC2,this.pcUniformType[p.FLOAT_VEC3]=pc.UNIFORMTYPE_VEC3,this.pcUniformType[p.FLOAT_VEC4]=pc.UNIFORMTYPE_VEC4,this.pcUniformType[p.INT_VEC2]=pc.UNIFORMTYPE_IVEC2,this.pcUniformType[p.INT_VEC3]=pc.UNIFORMTYPE_IVEC3,this.pcUniformType[p.INT_VEC4]=pc.UNIFORMTYPE_IVEC4,this.pcUniformType[p.BOOL_VEC2]=pc.UNIFORMTYPE_BVEC2,this.pcUniformType[p.BOOL_VEC3]=pc.UNIFORMTYPE_BVEC3,this.pcUniformType[p.BOOL_VEC4]=pc.UNIFORMTYPE_BVEC4,this.pcUniformType[p.FLOAT_MAT2]=pc.UNIFORMTYPE_MAT2,this.pcUniformType[p.FLOAT_MAT3]=pc.UNIFORMTYPE_MAT3,this.pcUniformType[p.FLOAT_MAT4]=pc.UNIFORMTYPE_MAT4,this.pcUniformType[p.SAMPLER_2D]=pc.UNIFORMTYPE_TEXTURE2D,this.pcUniformType[p.SAMPLER_CUBE]=pc.UNIFORMTYPE_TEXTURECUBE,this.webgl2&&(this.pcUniformType[p.SAMPLER_2D_SHADOW]=pc.UNIFORMTYPE_TEXTURE2D_SHADOW,this.pcUniformType[p.SAMPLER_CUBE_SHADOW]=pc.UNIFORMTYPE_TEXTURECUBE_SHADOW,this.pcUniformType[p.SAMPLER_3D]=pc.UNIFORMTYPE_TEXTURE3D),this.targetToSlot={},this.targetToSlot[p.TEXTURE_2D]=0,this.targetToSlot[p.TEXTURE_CUBE_MAP]=1,this.targetToSlot[p.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[pc.UNIFORMTYPE_BOOL]=function(t,e){t.value!==e&&(p.uniform1i(t.locationId,e),t.value=e)},this.commitFunction[pc.UNIFORMTYPE_INT]=this.commitFunction[pc.UNIFORMTYPE_BOOL],this.commitFunction[pc.UNIFORMTYPE_FLOAT]=function(t,e){t.value!==e&&(p.uniform1f(t.locationId,e),t.value=e)},this.commitFunction[pc.UNIFORMTYPE_VEC2]=function(t,e){o=t.value,s=e[0],n=e[1],o[0]===s&&o[1]===n||(o[0]=s,o[1]=n,p.uniform2fv(t.locationId,o))},this.commitFunction[pc.UNIFORMTYPE_VEC3]=function(t,e){o=t.value,s=e[0],n=e[1],r=e[2],o[0]===s&&o[1]===n&&o[2]===r||(o[0]=s,o[1]=n,o[2]=r,p.uniform3fv(t.locationId,o))},this.commitFunction[pc.UNIFORMTYPE_VEC4]=function(t,e){o=t.value,s=e[0],n=e[1],r=e[2],a=e[3],(e.length>4||o[0]!==s||o[1]!==n||o[2]!==r||o[3]!==a)&&(p.uniform4fv(t.locationId,e),o[0]=s,o[1]=n,o[2]=r,o[3]=a)},this.commitFunction[pc.UNIFORMTYPE_IVEC2]=function(t,e){o=t.value,s=e[0],n=e[1],o[0]===s&&o[1]===n||(p.uniform2iv(t.locationId,e),o[0]=s,o[1]=n)},this.commitFunction[pc.UNIFORMTYPE_BVEC2]=this.commitFunction[pc.UNIFORMTYPE_IVEC2],this.commitFunction[pc.UNIFORMTYPE_IVEC3]=function(t,e){o=t.value,s=e[0],n=e[1],r=e[2],o[0]===s&&o[1]===n&&o[2]===r||(p.uniform3iv(t.locationId,e),o[0]=s,o[1]=n,o[2]=r)},this.commitFunction[pc.UNIFORMTYPE_BVEC3]=this.commitFunction[pc.UNIFORMTYPE_IVEC3],this.commitFunction[pc.UNIFORMTYPE_IVEC4]=function(t,e){o=t.value,s=e[0],n=e[1],r=e[2],a=e[3],o[0]===s&&o[1]===n&&o[2]===r&&o[3]===a||(p.uniform4iv(t.locationId,e),o[0]=s,o[1]=n,o[2]=r,o[3]=a)},this.commitFunction[pc.UNIFORMTYPE_BVEC4]=this.commitFunction[pc.UNIFORMTYPE_IVEC4],this.commitFunction[pc.UNIFORMTYPE_MAT2]=function(t,e){p.uniformMatrix2fv(t.locationId,!1,e)},this.commitFunction[pc.UNIFORMTYPE_MAT3]=function(t,e){p.uniformMatrix3fv(t.locationId,!1,e)},this.commitFunction[pc.UNIFORMTYPE_MAT4]=function(t,e){p.uniformMatrix4fv(t.locationId,!1,e)},this.commitFunction[pc.UNIFORMTYPE_FLOATARRAY]=function(t,e){p.uniform1fv(t.locationId,e)},this.scope=new pc.ScopeSpace("Device"),this.programLib=new pc.ProgramLibrary(this),pc.programlib)this.programLib.register(u,pc.programlib[u]);pc.events.attach(this),this.supportsBoneTextures=this.extTextureFloat&&this.maxVertexTextures>0,this.useTexCubeLod=this.extTextureLod&&this.maxTextures<16;var d=this.vertexUniformsCount;for(d-=16,d-=8,d-=1,d-=16,this.boneLimit=Math.floor(d/4),this.boneLimit=Math.min(this.boneLimit,128),"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34),"Apple A8 GPU"===this.unmaskedRenderer&&(this.forceCpuParticles=!0),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[],i=pc.PRIMITIVE_POINTS;i<=pc.PRIMITIVE_TRIFAN;i++)this._primsPerFrame[i]=0;this._renderTargetCreationTime=0,this._vram={texShadow:0,texAsset:0,texLightmap:0,tex:0,vb:0,ib:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.constantTexSource=this.scope.resolve("source"),this.extTextureFloat?this.webgl2?this.textureFloatRenderable=!!this.extColorBufferFloat:this.textureFloatRenderable=h(p,p.FLOAT):this.textureFloatRenderable=!1,this.extTextureHalfFloat?this.webgl2?this.textureHalfFloatRenderable=!!this.extColorBufferFloat:this.textureHalfFloatRenderable=h(p,this.extTextureHalfFloat.HALF_FLOAT_OES):this.textureHalfFloatRenderable=!1,this.textureFloatHighPrecision=function(t){if(!t.textureFloatRenderable)return!1;var e=t.gl,i=pc.shaderChunks,s=i.createShaderFromCode(t,i.fullscreenQuadVS,i.precisionTestPS,"ptest1"),n=i.createShaderFromCode(t,i.fullscreenQuadVS,i.precisionTest2PS,"ptest2"),r=new pc.Texture(t,{format:pc.PIXELFORMAT_RGBA32F,width:1,height:1,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST}),a=new pc.RenderTarget(t,r,{depth:!1});pc.drawQuadWithShader(t,a,s);var o=new pc.Texture(t,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:1,height:1,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST}),h=new pc.RenderTarget(t,o,{depth:!1});t.constantTexSource.setValue(r),pc.drawQuadWithShader(t,h,n),e.bindFramebuffer(e.FRAMEBUFFER,h._glFrameBuffer);var c=new Uint8Array(4);e.readPixels(0,0,1,1,e.RGBA,e.UNSIGNED_BYTE,c),e.bindFramebuffer(e.FRAMEBUFFER,t.activeFramebuffer);var l=c[0]/255/16777216+c[1]/255/65536+c[2]/255/256+c[3]/255;return r.destroy(),a.destroy(),o.destroy(),h.destroy(),0===l}(this),this.initializeGrabPassTexture(),this.activeDrawCall=null};return Object.assign(c.prototype,{getPrecision:function(){var t=this.gl,e="highp";if(t.getShaderPrecisionFormat){var i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),s=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),n=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),r=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),a=i.precision>0&&n.precision>0,o=s.precision>0&&r.precision>0;a||(o?(e="mediump",console.warn("WARNING: highp not supported, using mediump")):(e="lowp",console.warn("WARNING: highp and mediump not supported, using lowp")))}return e},initializeExtensions:function(){var t,e=this.gl,i=e.getSupportedExtensions(),s=function(){for(var t=null,s=0;s<arguments.length;s++)-1!==i.indexOf(arguments[s])&&(t=e.getExtension(arguments[s]));return t};this.webgl2?(this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.extTextureHalfFloatLinear=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=s("EXT_color_buffer_float")):(this.extBlendMinmax=s("EXT_blend_minmax"),this.extDrawBuffers=s("EXT_draw_buffers"),this.extInstancing=s("ANGLE_instanced_arrays"),this.extInstancing&&(t=this.extInstancing,e.drawArraysInstanced=t.drawArraysInstancedANGLE.bind(t),e.drawElementsInstanced=t.drawElementsInstancedANGLE.bind(t),e.vertexAttribDivisor=t.vertexAttribDivisorANGLE.bind(t)),this.extStandardDerivatives=s("OES_standard_derivatives"),this.extTextureFloat=s("OES_texture_float"),this.extTextureHalfFloat=s("OES_texture_half_float"),this.extTextureHalfFloatLinear=s("OES_texture_half_float_linear"),this.extTextureLod=s("EXT_shader_texture_lod"),this.extUintElement=s("OES_element_index_uint"),this.extVertexArrayObject=s("OES_vertex_array_object"),this.extVertexArrayObject&&(t=this.extVertexArrayObject,e.createVertexArray=t.createVertexArrayOES.bind(t),e.deleteVertexArray=t.deleteVertexArrayOES.bind(t),e.isVertexArray=t.isVertexArrayOES.bind(t),e.bindVertexArray=t.bindVertexArrayOES.bind(t)),this.extColorBufferFloat=null),this.extDebugRendererInfo=s("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=s("OES_texture_float_linear"),this.extTextureFilterAnisotropic=s("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=s("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=s("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=s("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=s("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extParallelShaderCompile=s("KHR_parallel_shader_compile")},initializeCapabilities:function(){var t,e=this.gl;this.maxPrecision=this.precision=this.getPrecision();var i=e.getContextAttributes();this.supportsMsaa=i.antialias,this.supportsStencil=i.stencil,this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxCubeMapSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this.maxTextures=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=e.getParameter(e.MAX_DRAW_BUFFERS),this.maxColorAttachments=e.getParameter(e.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=e.getParameter(e.MAX_3D_TEXTURE_SIZE)):(t=this.extDrawBuffers,this.maxDrawBuffers=t?e.getParameter(t.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=t?e.getParameter(t.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1),t=this.extDebugRendererInfo,this.unmaskedRenderer=t?e.getParameter(t.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=t?e.getParameter(t.UNMASKED_VENDOR_WEBGL):"",t=this.extTextureFilterAnisotropic,this.maxAnisotropy=t?e.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},initializeRenderState:function(){var t=this.gl;this.blending=!1,t.disable(t.BLEND),this.blendSrc=pc.BLENDMODE_ONE,this.blendDst=pc.BLENDMODE_ZERO,this.blendSrcAlpha=pc.BLENDMODE_ONE,this.blendDstAlpha=pc.BLENDMODE_ZERO,this.separateAlphaBlend=!1,this.blendEquation=pc.BLENDEQUATION_ADD,this.blendAlphaEquation=pc.BLENDEQUATION_ADD,this.separateAlphaEquation=!1,t.blendFunc(t.ONE,t.ZERO),t.blendEquation(t.FUNC_ADD),this.writeRed=!0,this.writeGreen=!0,this.writeBlue=!0,this.writeAlpha=!0,t.colorMask(!0,!0,!0,!0),this.cullMode=pc.CULLFACE_BACK,t.enable(t.CULL_FACE),t.cullFace(t.BACK),this.depthTest=!0,t.enable(t.DEPTH_TEST),this.depthFunc=pc.FUNC_LESSEQUAL,t.depthFunc(t.LEQUAL),this.depthWrite=!0,t.depthMask(!0),this.stencil=!1,t.disable(t.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=pc.FUNC_ALWAYS,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,t.stencilFunc(t.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=pc.STENCILOP_KEEP,this.stencilZfailFront=this.stencilZfailBack=pc.STENCILOP_KEEP,this.stencilZpassFront=this.stencilZpassBack=pc.STENCILOP_KEEP,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,t.disable(t.POLYGON_OFFSET_FILL),this.clearDepth=1,t.clearDepth(1),this.clearRed=0,this.clearBlue=0,this.clearGreen=0,this.clearAlpha=0,t.clearColor(0,0,0,0),this.clearStencil=0,t.clearStencil(0),this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.webgl2?t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST):this.extStandardDerivatives&&t.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,t.NICEST),t.enable(t.SCISSOR_TEST),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),this.unpackFlipY=!1,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),this.depthRange=new pc.Vec2(0,1),t.depthRange(this.depthRange.x,this.depthRange.y)},initializeContext:function(){var t,e;for(this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),t=0,e=this.shaders.length;t<e;t++)this.compileAndLinkShader(this.shaders[t]);for(this.shader=null,t=0,e=this.buffers.length;t<e;t++)this.buffers[t].bufferId=void 0,this.buffers[t].unlock();for(this.boundBuffer=null,this.boundElementBuffer=null,this.indexBuffer=null,this.attributesInvalidated=!0,this.enabledAttributes={},this.vertexBuffers=[],t=0,e=this.textures.length;t<e;t++){var i=this.textures[t];this.destroyTexture(i),i.dirtyAll()}for(this.textureUnit=0,this.textureUnits.length=0,t=0;t<this.maxCombinedTextures;t++)this.textureUnits.push([null,null,null]);for(t=0,e=this.targets.length;t<e;t++)this.targets[t]._glFrameBuffer=void 0,this.targets[t]._glDepthBuffer=void 0,this.targets[t]._glResolveFrameBuffer=void 0,this.targets[t]._glMsaaColorBuffer=void 0,this.targets[t]._glMsaaDepthBuffer=void 0;this.renderTarget=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null},initializeGrabPassTexture:function(){if(!this.grabPassTexture){var t=new pc.Texture(this,{format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!1});t.minFilter=pc.FILTER_LINEAR,t.magFilter=pc.FILTER_LINEAR,t.addressU=pc.ADDRESS_CLAMP_TO_EDGE,t.addressV=pc.ADDRESS_CLAMP_TO_EDGE,t.name="texture_grabPass",t.setSource(this.canvas);var e=this.scope.resolve(t.name);e.setValue(t),this.grabPassTextureId=e,this.grabPassTexture=t}},updateClientRect:function(){this.clientRect=this.canvas.getBoundingClientRect()},setViewport:function(t,e,i,s){this.vx===t&&this.vy===e&&this.vw===i&&this.vh===s||(this.gl.viewport(t,e,i,s),this.vx=t,this.vy=e,this.vw=i,this.vh=s)},setDepthRange:function(t,e){this.depthRange.x===t&&this.depthRange.y===e||(this.depthRange.set(t,e),this.gl.depthRange(t,e))},setScissor:function(t,e,i,s){this.sx===t&&this.sy===e&&this.sw===i&&this.sh===s||(this.gl.scissor(t,e,i,s),this.sx=t,this.sy=e,this.sw=i,this.sh=s)},getProgramLibrary:function(){return this.programLib},setProgramLibrary:function(t){this.programLib=t},setFramebuffer:function(t){this.activeFramebuffer!==t&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.activeFramebuffer=t)},_checkFbo:function(){var t=this.gl;switch(t.checkFramebufferStatus(t.FRAMEBUFFER)){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case t.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED");break;case t.FRAMEBUFFER_COMPLETE:}},copyRenderTarget:function(t,e,i,s){var n=this.gl;if(!this.webgl2&&s)return console.error("Depth is not copyable on WebGL 1.0"),!1;if(i)if(e){if(!t._colorBuffer||!e._colorBuffer)return console.error("Can't copy color buffer, because one of the render targets doesn't have it"),!1;if(t._colorBuffer._format!==e._colorBuffer._format)return console.error("Can't copy render targets of different color formats"),!1}else if(!t._colorBuffer)return console.error("Can't copy empty color buffer to backbuffer"),!1;if(s){if(!t._depthBuffer||!e._depthBuffer)return console.error("Can't copy depth buffer, because one of the render targets doesn't have it"),!1;if(t._depthBuffer._format!==e._depthBuffer._format)return console.error("Can't copy render targets of different depth formats"),!1}if(this.webgl2&&e){var r=this.renderTarget;this.renderTarget=e,this.updateBegin(),n.bindFramebuffer(n.READ_FRAMEBUFFER,t?t._glFrameBuffer:null),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,e._glFrameBuffer);var a=t?t.width:e.width,o=t?t.height:e.height;n.blitFramebuffer(0,0,a,o,0,0,a,o,(i?n.COLOR_BUFFER_BIT:0)|(s?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=r,n.bindFramebuffer(n.FRAMEBUFFER,r?r._glFrameBuffer:null)}else{if(!this._copyShader){var h=pc.shaderChunks;this._copyShader=h.createShaderFromCode(this,h.fullscreenQuadVS,h.outputTex2DPS,"outputTex2D")}this.constantTexSource.setValue(t._colorBuffer),pc.drawQuadWithShader(this,e,this._copyShader)}return!0},updateBegin:function(){var t=this.gl;this.boundBuffer=null,this.boundElementBuffer=null;var e=this.renderTarget;if(e)if(e._glFrameBuffer){this.setFramebuffer(e._glFrameBuffer),(i=e._colorBuffer)&&(this.setViewport(0,0,i._width,i._height),this.setScissor(0,0,i._width,i._height))}else{var i,s=pc.now();this.fire("fbo:create",{timestamp:s,target:this}),e._device=this,e._glFrameBuffer=t.createFramebuffer(),this.setFramebuffer(e._glFrameBuffer),(i=e._colorBuffer)&&(i._glTexture||(i._width=Math.min(i.width,this.maxRenderBufferSize),i._height=Math.min(i.height,this.maxRenderBufferSize),this.setTexture(i,0)),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,i._cubemap?t.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:t.TEXTURE_2D,i._glTexture,0));var n=e._depthBuffer;if(n&&this.webgl2)n._glTexture||(n._width=Math.min(n.width,this.maxRenderBufferSize),n._height=Math.min(n.height,this.maxRenderBufferSize),this.setTexture(n,0)),e._stencil?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,n._cubemap?t.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:t.TEXTURE_2D,e._depthBuffer._glTexture,0):t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,n._cubemap?t.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:t.TEXTURE_2D,e._depthBuffer._glTexture,0);else if(e._depth){e._samples>1&&this.webgl2||(e._glDepthBuffer||(e._glDepthBuffer=t.createRenderbuffer()),t.bindRenderbuffer(t.RENDERBUFFER,e._glDepthBuffer),e._stencil?(t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,e._glDepthBuffer)):(t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e._glDepthBuffer)),t.bindRenderbuffer(t.RENDERBUFFER,null))}this._checkFbo(),this.webgl2&&e._samples>1&&(e._glResolveFrameBuffer=e._glFrameBuffer,e._glFrameBuffer=t.createFramebuffer(),this.setFramebuffer(e._glFrameBuffer),i&&(e._glMsaaColorBuffer||(e._glMsaaColorBuffer=t.createRenderbuffer()),t.bindRenderbuffer(t.RENDERBUFFER,e._glMsaaColorBuffer),t.renderbufferStorageMultisample(t.RENDERBUFFER,e._samples,i._glInternalFormat,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,e._glMsaaColorBuffer)),e._depth&&(e._glMsaaDepthBuffer||(e._glMsaaDepthBuffer=t.createRenderbuffer()),t.bindRenderbuffer(t.RENDERBUFFER,e._glMsaaDepthBuffer),e._stencil?(t.renderbufferStorageMultisample(t.RENDERBUFFER,e._samples,t.DEPTH24_STENCIL8,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,e._glMsaaDepthBuffer)):(t.renderbufferStorageMultisample(t.RENDERBUFFER,e._samples,t.DEPTH_COMPONENT32F,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e._glMsaaDepthBuffer))),this._checkFbo()),this.targets.push(e),this._renderTargetCreationTime+=pc.now()-s}else this.setFramebuffer(null)},updateEnd:function(){var t=this.gl,e=this.renderTarget;if(e){var i=e._colorBuffer;i&&i._glTexture&&i.mipmaps&&i._pot&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(i),t.generateMipmap(i._glTarget)),this.webgl2&&e._samples>1&&e.autoResolve&&e.resolve()}},initializeTexture:function(t){var e,i=this.gl;switch(t._glTexture=i.createTexture(),t._levels&&t._levels[0]&&"VIDEO"===t._levels[0].tagName&&(t._needsUpdate=!0),t._glTarget=t._cubemap?i.TEXTURE_CUBE_MAP:t._volume?i.TEXTURE_3D:i.TEXTURE_2D,t._format){case pc.PIXELFORMAT_A8:t._glFormat=i.ALPHA,t._glInternalFormat=i.ALPHA,t._glPixelType=i.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8:t._glFormat=i.LUMINANCE,t._glInternalFormat=i.LUMINANCE,t._glPixelType=i.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8_A8:t._glFormat=i.LUMINANCE_ALPHA,t._glInternalFormat=i.LUMINANCE_ALPHA,t._glPixelType=i.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R5_G6_B5:t._glFormat=i.RGB,t._glInternalFormat=i.RGB,t._glPixelType=i.UNSIGNED_SHORT_5_6_5;break;case pc.PIXELFORMAT_R5_G5_B5_A1:t._glFormat=i.RGBA,t._glInternalFormat=i.RGBA,t._glPixelType=i.UNSIGNED_SHORT_5_5_5_1;break;case pc.PIXELFORMAT_R4_G4_B4_A4:t._glFormat=i.RGBA,t._glInternalFormat=i.RGBA,t._glPixelType=i.UNSIGNED_SHORT_4_4_4_4;break;case pc.PIXELFORMAT_R8_G8_B8:t._glFormat=i.RGB,t._glInternalFormat=this.webgl2?i.RGB8:i.RGB,t._glPixelType=i.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R8_G8_B8_A8:t._glFormat=i.RGBA,t._glInternalFormat=this.webgl2?i.RGBA8:i.RGBA,t._glPixelType=i.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_DXT1:e=this.extCompressedTextureS3TC,t._glFormat=i.RGB,t._glInternalFormat=e.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case pc.PIXELFORMAT_DXT3:e=this.extCompressedTextureS3TC,t._glFormat=i.RGBA,t._glInternalFormat=e.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case pc.PIXELFORMAT_DXT5:e=this.extCompressedTextureS3TC,t._glFormat=i.RGBA,t._glInternalFormat=e.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case pc.PIXELFORMAT_ETC1:e=this.extCompressedTextureETC1,t._glFormat=i.RGB,t._glInternalFormat=e.COMPRESSED_RGB_ETC1_WEBGL;break;case pc.PIXELFORMAT_PVRTC_2BPP_RGB_1:e=this.extCompressedTexturePVRTC,t._glFormat=i.RGB,t._glInternalFormat=e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1:e=this.extCompressedTexturePVRTC,t._glFormat=i.RGBA,t._glInternalFormat=e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case pc.PIXELFORMAT_PVRTC_4BPP_RGB_1:e=this.extCompressedTexturePVRTC,t._glFormat=i.RGB,t._glInternalFormat=e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1:e=this.extCompressedTexturePVRTC,t._glFormat=i.RGBA,t._glInternalFormat=e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case pc.PIXELFORMAT_ETC2_RGB:e=this.extCompressedTextureETC,t._glFormat=i.RGB,t._glInternalFormat=e.COMPRESSED_RGB8_ETC2;break;case pc.PIXELFORMAT_ETC2_RGBA:e=this.extCompressedTextureETC,t._glFormat=i.RGBA,t._glInternalFormat=e.COMPRESSED_RGBA8_ETC2_EAC;break;case pc.PIXELFORMAT_RGB16F:e=this.extTextureHalfFloat,t._glFormat=i.RGB,this.webgl2?(t._glInternalFormat=i.RGB16F,t._glPixelType=i.HALF_FLOAT):(t._glInternalFormat=i.RGB,t._glPixelType=e.HALF_FLOAT_OES);break;case pc.PIXELFORMAT_RGBA16F:e=this.extTextureHalfFloat,t._glFormat=i.RGBA,this.webgl2?(t._glInternalFormat=i.RGBA16F,t._glPixelType=i.HALF_FLOAT):(t._glInternalFormat=i.RGBA,t._glPixelType=e.HALF_FLOAT_OES);break;case pc.PIXELFORMAT_RGB32F:t._glFormat=i.RGB,this.webgl2?t._glInternalFormat=i.RGB32F:t._glInternalFormat=i.RGB,t._glPixelType=i.FLOAT;break;case pc.PIXELFORMAT_RGBA32F:t._glFormat=i.RGBA,this.webgl2?t._glInternalFormat=i.RGBA32F:t._glInternalFormat=i.RGBA,t._glPixelType=i.FLOAT;break;case pc.PIXELFORMAT_R32F:t._glFormat=i.RED,t._glInternalFormat=i.R32F,t._glPixelType=i.FLOAT;break;case pc.PIXELFORMAT_DEPTH:this.webgl2?(t._glFormat=i.DEPTH_COMPONENT,t._glInternalFormat=i.DEPTH_COMPONENT32F,t._glPixelType=i.FLOAT):(t._glFormat=i.DEPTH_COMPONENT,t._glInternalFormat=i.DEPTH_COMPONENT,t._glPixelType=i.UNSIGNED_SHORT);break;case pc.PIXELFORMAT_DEPTHSTENCIL:t._glFormat=i.DEPTH_STENCIL,t._glInternalFormat=i.DEPTH24_STENCIL8,t._glPixelType=i.UNSIGNED_INT_24_8;break;case pc.PIXELFORMAT_111110F:t._glFormat=i.RGB,t._glInternalFormat=i.R11F_G11F_B10F,t._glPixelType=i.FLOAT;break;case pc.PIXELFORMAT_SRGB:t._glFormat=i.RGB,t._glInternalFormat=i.SRGB8,t._glPixelType=i.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_SRGBA:t._glFormat=i.RGBA,t._glInternalFormat=i.SRGB8_ALPHA8,t._glPixelType=i.UNSIGNED_BYTE}this.textures.push(t)},destroyTexture:function(t){if(t._glTexture){var e=this.textures.indexOf(t);for(var i in-1!==e&&this.textures.splice(e,1),this.scope.variables){var s=this.scope.variables[i];s.value===t&&(s.value=null)}for(var n=0;n<this.textureUnits.length;n++)for(var r=this.textureUnits[n],a=0;a<r.length;a++)r[a]===t._glTexture&&(r[a]=null);this.gl.deleteTexture(t._glTexture),delete t._glTexture,delete t._glTarget,delete t._glFormat,delete t._glInternalFormat,delete t._glPixelType,this._vram.tex-=t._gpuSize,t.profilerHint===pc.TEXHINT_SHADOWMAP?this._vram.texShadow-=t._gpuSize:t.profilerHint===pc.TEXHINT_ASSET?this._vram.texAsset-=t._gpuSize:t.profilerHint===pc.TEXHINT_LIGHTMAP&&(this._vram.texLightmap-=t._gpuSize)}},setUnpackFlipY:function(t){if(this.unpackFlipY!==t){this.unpackFlipY=t;var e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t)}},setUnpackPremultiplyAlpha:function(t){if(this.unpackPremultiplyAlpha!==t){this.unpackPremultiplyAlpha=t;var e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t)}},uploadCubemapFromAtlas:function(t){var e=t._atlas,i=this.gl,s=this.textureUnits[0],n=s?s[0]:null;e._glTexture||(this.setTexture(e,0),this.uploadTexture(e));var r=this.activeFramebuffer,a=i.createFramebuffer();this.setFramebuffer(a),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,e._glTexture,0),t._needsUpload=!1,t._needsMipmapsUpload=!1,this.setTexture(t,0);for(var o=0;o<t._rects.length;o+=4){var h=t._rects[o+0]*e._width,c=t._rects[o+1]*e._height,l=t._rects[o+2]*e._width-h,p=t._rects[o+3]*e._height-c,u=o/4|0,d=u/6|0,_=u%6|0;i.copyTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+_,d,t._glInternalFormat,h,c,l,p,0)}t._mipmaps&&24===t._rects.length&&i.generateMipmap(t._glTarget),this.setFramebuffer(r),n&&(i.bindTexture(i.TEXTURE_2D,n),this.textureUnits[0][0]=n)},uploadTexture:function(t){var e=this.gl;if(t._needsUpload||!(t._needsMipmapsUpload&&t._mipmapsUploaded||!t._pot)){var i,s,n=0;for(t._cubemap&&t._atlas&&t._rects&&this.uploadCubemapFromAtlas(t);t._levels[n]||0===n;)if(t._needsUpload||0!==n){if(n&&(!t._needsMipmapsUpload||!t._mipmaps))break;var r;if(i=t._levels[n],1!=n||t._compressed||(e.generateMipmap(t._glTarget),t._mipmapsUploaded=!0),t._cubemap){if(i[0]instanceof HTMLCanvasElement||i[0]instanceof HTMLImageElement||i[0]instanceof HTMLVideoElement){for(r=0;r<6;r++)if(t._levelsUpdated[0][r]){var a=i[r];a instanceof HTMLImageElement&&(a.width>this.maxCubeMapSize||a.height>this.maxCubeMapSize)&&(a=o(a,this.maxCubeMapSize),0===n&&(t.width=a.width,t.height=a.height)),this.setUnpackFlipY(t._flipY),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+r,n,t._glInternalFormat,t._glFormat,t._glPixelType,a)}}else for(this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s=1/Math.pow(2,n),r=0;r<6;r++)if(t._levelsUpdated[0][r]){var h=i[r];t._compressed?e.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+r,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,h):(this.setUnpackFlipY(t._flipY),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+r,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,t._glFormat,t._glPixelType,h))}}else t._volume?(s=1/Math.pow(2,n),t._compressed?e.compressedTexImage3D(e.TEXTURE_3D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),Math.max(t._depth*s,1),0,i):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage3D(e.TEXTURE_3D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),Math.max(t._depth*s,1),0,t._glFormat,t._glPixelType,i))):(i instanceof HTMLCanvasElement||i instanceof HTMLImageElement||i instanceof HTMLVideoElement?(i instanceof HTMLImageElement&&(i.width>this.maxTextureSize||i.height>this.maxTextureSize)&&(i=o(i,this.maxTextureSize),0===n&&(t.width=i.width,t.height=i.height)),this.setUnpackFlipY(t._flipY),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_2D,n,t._glInternalFormat,t._glFormat,t._glPixelType,i)):(s=1/Math.pow(2,n),t._compressed?e.compressedTexImage2D(e.TEXTURE_2D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,i):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_2D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,t._glFormat,t._glPixelType,i))),t._mipmapsUploaded=0!==n);n++}else n++;if(t._needsUpload)if(t._cubemap)for(var c=0;c<6;c++)t._levelsUpdated[0][c]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&t._mipmaps&&t._needsMipmapsUpload&&t._pot&&1===t._levels.length&&(e.generateMipmap(t._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&(this._vram.tex-=t._gpuSize,t.profilerHint===pc.TEXHINT_SHADOWMAP?this._vram.texShadow-=t._gpuSize:t.profilerHint===pc.TEXHINT_ASSET?this._vram.texAsset-=t._gpuSize:t.profilerHint===pc.TEXHINT_LIGHTMAP&&(this._vram.texLightmap-=t._gpuSize)),t._gpuSize=t.gpuSize,this._vram.tex+=t._gpuSize,t.profilerHint===pc.TEXHINT_SHADOWMAP?this._vram.texShadow+=t._gpuSize:t.profilerHint===pc.TEXHINT_ASSET?this._vram.texAsset+=t._gpuSize:t.profilerHint===pc.TEXHINT_LIGHTMAP&&(this._vram.texLightmap+=t._gpuSize)}},activeTexture:function(t){this.textureUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.textureUnit=t)},bindTexture:function(t){var e=t._glTarget,i=t._glTexture,s=this.textureUnit,n=this.targetToSlot[e];this.textureUnits[s][n]!==i&&(this.gl.bindTexture(e,i),this.textureUnits[s][n]=i)},bindTextureOnUnit:function(t,e){var i=t._glTarget,s=t._glTexture,n=this.targetToSlot[i];this.textureUnits[e][n]!==s&&(this.activeTexture(e),this.gl.bindTexture(i,s),this.textureUnits[e][n]=s)},setTextureParameters:function(t){var e=this.gl,i=t._parameterFlags,s=t._glTarget;if(1&i){var n=t._minFilter;(!t._pot||!t._mipmaps||t._compressed&&1===t._levels.length)&&(n===pc.FILTER_NEAREST_MIPMAP_NEAREST||n===pc.FILTER_NEAREST_MIPMAP_LINEAR?n=pc.FILTER_NEAREST:n!==pc.FILTER_LINEAR_MIPMAP_NEAREST&&n!==pc.FILTER_LINEAR_MIPMAP_LINEAR||(n=pc.FILTER_LINEAR)),e.texParameteri(s,e.TEXTURE_MIN_FILTER,this.glFilter[n])}if(2&i&&e.texParameteri(s,e.TEXTURE_MAG_FILTER,this.glFilter[t._magFilter]),4&i&&(this.webgl2?e.texParameteri(s,e.TEXTURE_WRAP_S,this.glAddress[t._addressU]):e.texParameteri(s,e.TEXTURE_WRAP_S,this.glAddress[t._pot?t._addressU:pc.ADDRESS_CLAMP_TO_EDGE])),8&i&&(this.webgl2?e.texParameteri(s,e.TEXTURE_WRAP_T,this.glAddress[t._addressV]):e.texParameteri(s,e.TEXTURE_WRAP_T,this.glAddress[t._pot?t._addressV:pc.ADDRESS_CLAMP_TO_EDGE])),16&i&&this.webgl2&&e.texParameteri(s,e.TEXTURE_WRAP_R,this.glAddress[t._addressW]),32&i&&this.webgl2&&e.texParameteri(s,e.TEXTURE_COMPARE_MODE,t._compareOnRead?e.COMPARE_REF_TO_TEXTURE:e.NONE),64&i&&this.webgl2&&e.texParameteri(s,e.TEXTURE_COMPARE_FUNC,this.glComparison[t._compareFunc]),128&i){var r=this.extTextureFilterAnisotropic;r&&e.texParameterf(s,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(t._anisotropy),this.maxAnisotropy)))}},setTexture:function(t,e){t._glTexture||this.initializeTexture(t),t._parameterFlags>0||t._needsUpload||t._needsMipmapsUpload?(this.activeTexture(e),this.bindTexture(t),t._parameterFlags&&(this.setTextureParameters(t),t._parameterFlags=0),(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadTexture(t),t!==this.grabPassTexture&&(t.markUploaded(),t._needsMipmapsUpload=!1))):this.bindTextureOnUnit(t,e)},setBuffers:function(r,a,o){a=a||[];var h,c,l,p,u,d,_=this.gl,f=this.shader.attributes;if(this.attributesInvalidated){for(var m=0,g=f.length;m<g;m++){d=(h=f[m]).locationId,c=h.scopeId.value;var y="TEXCOORD1"===h.scopeId.name&&this.activeDrawCall&&(this.activeDrawCall._shaderDefs&pc.SHADERDEF_LMUV0)>0;if(null===c||c.const||(l=this.vertexBuffers[c.stream],p=this.vbOffsets[c.stream]||0,!l||l.format.elementMap[c.name]||y||(_.disableVertexAttribArray(h.locationId),this.enabledAttributes[h.locationId]=!1,c=null)),null==c)_.disableVertexAttribArray(d),this.enabledAttributes[d]=!1,"POSITION"==h.scopeId.name?_.vertexAttrib4fv(d,i):"COLOR"==h.scopeId.name?_.vertexAttrib4fv(d,t):"TANGENT"==h.scopeId.name?_.vertexAttrib4fv(d,s):"NORMAL"==h.scopeId.name?_.vertexAttrib4fv(d,n):_.vertexAttrib4fv(d,e);else{if(void 0===l)continue;var E;if(u=l.bufferId,this.boundBuffer!==u&&(_.bindBuffer(_.ARRAY_BUFFER,u),this.attributePointers={},this.boundBuffer=u),this.enabledAttributes[d]||(_.enableVertexAttribArray(d),this.enabledAttributes[d]=!0),y)for(var v=0;v<f.length;v++){var T=f[v].scopeId;if("TEXCOORD0"===T.name){E=T.value;break}}else E=c;var b=(E.numComponents<<24)+(E.dataType<<21)+(E.normalize?1<<20:0)+(E.stride<<10)+(E.offset+p<<0);this.attributePointers[d]!==b&&(_.vertexAttribPointer(d,E.numComponents,this.glType[E.dataType],E.normalize,E.stride,E.offset+p),this.attributePointers[d]=b),1===c.stream&&r>0?this.instancedAttribs[d]||(_.vertexAttribDivisor(d,1),this.instancedAttribs[d]=!0):this.instancedAttribs[d]&&(_.vertexAttribDivisor(d,0),this.instancedAttribs[d]=!1)}}this.attributesInvalidated=!1}for(m=0,g=f.length;m<g;m++){var A=a[(h=f[m]).scopeId.name];A&&(d=h.locationId,this.enabledAttributes[h.locationId]=!1,_.disableVertexAttribArray(h.locationId),_.vertexAttrib4fv(h.locationId,A))}u=this.indexBuffer?this.indexBuffer.bufferId:null,this.boundElementBuffer!==u&&(_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,u),this.boundElementBuffer=u)},draw:function(t,e,i,s,n){var r,o,h,c,l,p,u,d,_,f,m,g,y=this.gl,E=this.shader,v=E.samplers,T=E.uniforms;if(0!==e){this.activeDrawCall=n,e>0&&(this.boundBuffer=null,this.attributesInvalidated=!0),this.setBuffers(e,s);var b=0;for(r=0,h=v.length;r<h;r++)if(p=(l=v[r]).scopeId.value,c=l.scopeId.name,null==p&&(p=i[l.scopeId.name]||a[l.dataType]),l.meta||(l.meta={hdr:this.scope.resolve(c+"_HDR"),texels:this.scope.resolve(c+"_TexelSize")}),p instanceof pc.Texture)u=p,this.setTexture(u,b),u.rgbm?l.meta.hdr.setValue([5*u.intensity,1,0,1]):l.meta.hdr.setValue([1*u.intensity,1,0,0]),l.meta.texels.setValue([1/u.width,1/u.height,u.width,u.height]),this.renderTarget&&this.renderTarget._samples<2&&(this.renderTarget.colorBuffer&&this.renderTarget.colorBuffer===u?console.error("Trying to bind current color buffer as a texture"):this.renderTarget.depthBuffer&&this.renderTarget.depthBuffer===u&&console.error("Trying to bind current depth buffer as a texture")),l.slot!==b&&(y.uniform1i(l.locationId,b),l.slot=b),b++;else{for(l.array.length=0,d=p.length,o=0;o<d;o++)u=p[o],this.setTexture(u,b),l.array[o]=b,b++;y.uniform1iv(l.locationId,l.array)}for(r=0,h=T.length;r<h;r++)f=(_=T[r]).scopeId,m=_.version,g=f.versionObject.version,m.globalId===g.globalId&&m.revision===g.revision||(m.globalId=g.globalId,m.revision=g.revision,null==f.value?this.commitFunction[_.dataType](_,i[f.name]||a[_.dataType]):this.commitFunction[_.dataType](_,f.value));this.webgl2&&this.transformFeedbackBuffer&&(y.bindBufferBase(y.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),y.beginTransformFeedback(y.POINTS));var A=this.glPrimitive[t.type],S=t.count;if(t.indexed){var R=this.indexBuffer,I=R.glFormat,C=t.base*R.bytesPerIndex;e>0?y.drawElementsInstanced(A,S,I,C,e):y.drawElements(A,S,I,C)}else{var M=t.base;e>0?y.drawArraysInstanced(A,M,S,e):y.drawArrays(A,M,S)}this.webgl2&&this.transformFeedbackBuffer&&(y.endTransformFeedback(),y.bindBufferBase(y.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++,this._primsPerFrame[t.type]+=t.count*(e>0?e:1),this.activeDrawCall=null}},clear:function(t){var e=this.defaultClearOptions,i=pc.CLEARFLAG_COLOR|pc.CLEARFLAG_STENCIL|pc.CLEARFLAG_DEPTH,s=null==(t=t||e).flags?e.flags:t.flags;if(0!==s){var n=this.gl;if(s&pc.CLEARFLAG_COLOR){var r=null==t.color?e.color:t.color;this.setClearColor(r[0],r[1],r[2],r[3])}if(s&pc.CLEARFLAG_DEPTH){var a=null==t.depth?e.depth:t.depth;this.setClearDepth(a),this.depthWrite||n.depthMask(!0)}if(s&pc.CLEARFLAG_STENCIL){var o=null==t.stencil?e.stencil:t.stencil;this.setClearStencil(o)}n.clear(this.glClearFlag[s&i]),s&pc.CLEARFLAG_DEPTH&&(this.depthWrite||n.depthMask(!1))}},readPixels:function(t,e,i,s,n){var r=this.gl;r.readPixels(t,e,i,s,r.RGBA,r.UNSIGNED_BYTE,n)},setClearDepth:function(t){t!==this.clearDepth&&(this.gl.clearDepth(t),this.clearDepth=t)},setClearColor:function(t,e,i,s){t===this.clearRed&&e===this.clearGreen&&i===this.clearBlue&&s===this.clearAlpha||(this.gl.clearColor(t,e,i,s),this.clearRed=t,this.clearGreen=e,this.clearBlue=i,this.clearAlpha=s)},setClearStencil:function(t){t!==this.clearStencil&&(this.gl.clearStencil(t),this.clearStencil=t)},setRenderTarget:function(t){this.renderTarget=t},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(t){if(this.depthTest!==t){var e=this.gl;t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this.depthTest=t}},setDepthFunc:function(t){this.depthFunc!==t&&(this.gl.depthFunc(this.glComparison[t]),this.depthFunc=t)},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(t){this.depthWrite!==t&&(this.gl.depthMask(t),this.depthWrite=t)},setColorWrite:function(t,e,i,s){this.writeRed===t&&this.writeGreen===e&&this.writeBlue===i&&this.writeAlpha===s||(this.gl.colorMask(t,e,i,s),this.writeRed=t,this.writeGreen=e,this.writeBlue=i,this.writeAlpha=s)},setAlphaToCoverage:function(t){this.webgl2&&this.alphaToCoverage!==t&&(this.alphaToCoverage=t,t?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))},setTransformFeedbackBuffer:function(t){if(this.transformFeedbackBuffer!==t&&(this.transformFeedbackBuffer=t,this.webgl2)){var e=this.gl;t?(this.feedback||(this.feedback=e.createTransformFeedback()),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,this.feedback)):e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null)}},setRaster:function(t){this.raster!==t&&(this.raster=t,this.webgl2&&(t?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))},setDepthBias:function(t){this.depthBiasEnabled!==t&&(this.depthBiasEnabled=t,t?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))},setDepthBiasValues:function(t,e){this.gl.polygonOffset(e,t)},getBlending:function(){return this.blending},setBlending:function(t){if(this.blending!==t){var e=this.gl;t?e.enable(e.BLEND):e.disable(e.BLEND),this.blending=t}},setStencilTest:function(t){if(this.stencil!==t){var e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.stencil=t}},setStencilFunc:function(t,e,i){this.stencilFuncFront===t&&this.stencilRefFront===e&&this.stencilMaskFront===i&&this.stencilFuncBack===t&&this.stencilRefBack===e&&this.stencilMaskBack===i||(this.gl.stencilFunc(this.glComparison[t],e,i),this.stencilFuncFront=this.stencilFuncBack=t,this.stencilRefFront=this.stencilRefBack=e,this.stencilMaskFront=this.stencilMaskBack=i)},setStencilFuncFront:function(t,e,i){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==i){var s=this.gl;s.stencilFuncSeparate(s.FRONT,this.glComparison[t],e,i),this.stencilFuncFront=t,this.stencilRefFront=e,this.stencilMaskFront=i}},setStencilFuncBack:function(t,e,i){if(this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==i){var s=this.gl;s.stencilFuncSeparate(s.BACK,this.glComparison[t],e,i),this.stencilFuncBack=t,this.stencilRefBack=e,this.stencilMaskBack=i}},setStencilOperation:function(t,e,i,s){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===i&&this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===i||(this.gl.stencilOp(this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailFront=this.stencilFailBack=t,this.stencilZfailFront=this.stencilZfailBack=e,this.stencilZpassFront=this.stencilZpassBack=i),this.stencilWriteMaskFront===s&&this.stencilWriteMaskBack===s||(this.gl.stencilMask(s),this.stencilWriteMaskFront=s,this.stencilWriteMaskBack=s)},setStencilOperationFront:function(t,e,i,s){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===i||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailFront=t,this.stencilZfailFront=e,this.stencilZpassFront=i),this.stencilWriteMaskFront!==s&&(this.gl.stencilMaskSeparate(this.gl.FRONT,s),this.stencilWriteMaskFront=s)},setStencilOperationBack:function(t,e,i,s){this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===i||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailBack=t,this.stencilZfailBack=e,this.stencilZpassBack=i),this.stencilWriteMaskBack!==s&&(this.gl.stencilMaskSeparate(this.gl.BACK,s),this.stencilWriteMaskBack=s)},setBlendFunction:function(t,e){(this.blendSrc!==t||this.blendDst!==e||this.separateAlphaBlend)&&(this.gl.blendFunc(this.glBlendFunction[t],this.glBlendFunction[e]),this.blendSrc=t,this.blendDst=e,this.separateAlphaBlend=!1)},setBlendFunctionSeparate:function(t,e,i,s){this.blendSrc===t&&this.blendDst===e&&this.blendSrcAlpha===i&&this.blendDstAlpha===s&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[t],this.glBlendFunction[e],this.glBlendFunction[i],this.glBlendFunction[s]),this.blendSrc=t,this.blendDst=e,this.blendSrcAlpha=i,this.blendDstAlpha=s,this.separateAlphaBlend=!0)},setBlendEquation:function(t){(this.blendEquation!==t||this.separateAlphaEquation)&&(this.gl.blendEquation(this.glBlendEquation[t]),this.blendEquation=t,this.separateAlphaEquation=!1)},setBlendEquationSeparate:function(t,e){this.blendEquation===t&&this.blendAlphaEquation===e&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[t],this.glBlendEquation[e]),this.blendEquation=t,this.blendAlphaEquation=e,this.separateAlphaEquation=!0)},setCullMode:function(t){if(this.cullMode!==t){if(t===pc.CULLFACE_NONE)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===pc.CULLFACE_NONE&&this.gl.enable(this.gl.CULL_FACE);var e=this.glCull[t];this.cullFace!==e&&(this.gl.cullFace(e),this.cullFace=e)}this.cullMode=t}},getCullMode:function(){return this.cullMode},setIndexBuffer:function(t){this.indexBuffer=t},setVertexBuffer:function(t,e,i){if(null!=t&&(this.vertexBuffers[e]!==t||this.vbOffsets[e]!==i)){this.vertexBuffers[e]=t,this.vbOffsets[e]=i;for(var s=0,n=t.getFormat().elements,r=n.length;s<r;){var a=n[s++];a.stream=e,a.scopeId.setValue(a)}this.attributesInvalidated=!0}},compileShaderSource:function(t,e){var i=this.gl,s=e?this.vertexShaderCache[t]:this.fragmentShaderCache[t];if(!s){var n=pc.now();this.fire("shader:compile:start",{timestamp:n,target:this}),s=i.createShader(e?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(s,t),i.compileShader(s);var r=pc.now();this.fire("shader:compile:end",{timestamp:r,target:this}),this._shaderStats.compileTime+=r-n,e?(this.vertexShaderCache[t]=s,this._shaderStats.vsCompiled++):(this.fragmentShaderCache[t]=s,this._shaderStats.fsCompiled++)}return s},compileAndLinkShader:function(t){var e=this.gl,i=t.definition,s=this.compileShaderSource(i.vshader,!0),n=this.compileShaderSource(i.fshader,!1),a=e.createProgram();if(e.attachShader(a,s),e.attachShader(a,n),this.webgl2&&i.useTransformFeedback){var o=i.attributes,h=[];for(var c in o)o.hasOwnProperty(c)&&h.push("out_"+c);e.transformFeedbackVaryings(a,h,e.INTERLEAVED_ATTRIBS)}for(var l in i.attributes){var p=i.attributes[l],u=r[p];e.bindAttribLocation(a,u,l)}e.linkProgram(a),t._glVertexShader=s,t._glFragmentShader=n,t._glProgram=a,t._globalKeywordsVersion=pc.Shader._globalKeywordsVersion,t.ready=!1,this._shaderStats.linked++,i.tag===pc.SHADERTAG_MATERIAL&&this._shaderStats.materialShaders++},createShader:function(t){this.compileAndLinkShader(t),this.shaders.push(t)},destroyShader:function(t){var e=this.shaders.indexOf(t);-1!==e&&this.shaders.splice(e,1),t._glProgram&&(this.gl.deleteProgram(t._glProgram),t._glProgram=null,this.removeShaderFromCache(t))},_addLineNumbers:function(t){for(var e=t.split("\n"),i=0,s=e.length;i<s;i++)e[i]=i+1+":\t"+e[i];return e.join("\n")},postLink:function(t){var e,i,s,n,r=this.gl,a=t._glVertexShader,o=t._glFragmentShader,h=t._glProgram,c=t.definition,l=pc.now();if(this.fire("shader:link:start",{timestamp:l,target:this}),!r.getShaderParameter(a,r.COMPILE_STATUS))return console.error("Failed to compile vertex shader:\n\n"+this._addLineNumbers(c.vshader)+"\n\n"+r.getShaderInfoLog(a)),!1;if(!r.getShaderParameter(o,r.COMPILE_STATUS))return console.error("Failed to compile fragment shader:\n\n"+this._addLineNumbers(c.fshader)+"\n\n"+r.getShaderInfoLog(o)),!1;if(!r.getProgramParameter(h,r.LINK_STATUS))return console.error("Failed to link shader program. Error: "+r.getProgramInfoLog(h)),!1;e=0;for(var p=r.getProgramParameter(h,r.ACTIVE_ATTRIBUTES);e<p;)i=r.getActiveAttrib(h,e++),s=r.getAttribLocation(h,i.name),void 0===c.attributes[i.name]&&console.error('Vertex shader attribute "'+i.name+'" is not mapped to a semantic in shader definition.'),n=new pc.ShaderInput(this,c.attributes[i.name],this.pcUniformType[i.type],s),t.attributes.push(n);t.samplers=[],t.uniforms=[],e=0;for(var u=r.getProgramParameter(h,r.ACTIVE_UNIFORMS);e<u;)i=r.getActiveUniform(h,e++),s=r.getUniformLocation(h,i.name),n=new pc.ShaderInput(this,i.name,this.pcUniformType[i.type],s),i.type===r.SAMPLER_2D||i.type===r.SAMPLER_CUBE||this.webgl2&&(i.type===r.SAMPLER_2D_SHADOW||i.type===r.SAMPLER_CUBE_SHADOW||i.type===r.SAMPLER_3D)?t.samplers.push(n):t.uniforms.push(n);t.ready=!0;var d=pc.now();return this.fire("shader:link:end",{timestamp:d,target:this}),this._shaderStats.compileTime+=d-l,!0},setShader:function(t){if(t!==this.shader){if(t.needsCompilation&&this.compileAndLinkShader(t),!t.ready){if(!this.postLink(t))return!1;t.uniformsUsage=this.getUniformsInUse(t.uniforms)}this.shader=t,this.gl.useProgram(t._glProgram),this._shaderSwitchesPerFrame++,this.attributesInvalidated=!0}return!0},getHdrFormat:function(){return this.textureHalfFloatRenderable?pc.PIXELFORMAT_RGB16F:this.textureFloatRenderable?pc.PIXELFORMAT_RGB32F:pc.PIXELFORMAT_R8_G8_B8_A8},getBoneLimit:function(){return this.boneLimit},setBoneLimit:function(t){this.boneLimit=t},resizeCanvas:function(t,e){this._width=t,this._height=e;var i=Math.min(this._maxPixelRatio,window.devicePixelRatio);t*=i,e*=i,this.canvas.width=t,this.canvas.height=e,this.fire("resizecanvas",t,e)},setResolution:function(t,e){this._width=t,this._height=e,this.canvas.width=t,this.canvas.height=e,this.fire("resizecanvas",t,e)},clearShaderCache:function(){var t,e=this.gl;for(t in this.fragmentShaderCache)e.deleteShader(this.fragmentShaderCache[t]),delete this.fragmentShaderCache[t];for(t in this.vertexShaderCache)e.deleteShader(this.vertexShaderCache[t]),delete this.vertexShaderCache[t];this.programLib.clearCache()},removeShaderFromCache:function(t){this.programLib.removeFromCache(t)},destroy:function(){var t=this.gl;this.grabPassTexture.destroy(),this.webgl2&&this.feedback&&t.deleteTransformFeedback(this.feedback),this.clearShaderCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.canvas=null,this.gl=null}}),Object.defineProperty(c.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||this.canvas.width}}),Object.defineProperty(c.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}}),Object.defineProperty(c.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},set:function(t){t?this.gl.canvas.requestFullscreen():document.exitFullscreen()}}),Object.defineProperty(c.prototype,"enableAutoInstancing",{get:function(){return this._enableAutoInstancing},set:function(t){this._enableAutoInstancing=t&&this.extInstancing}}),Object.defineProperty(c.prototype,"maxPixelRatio",{get:function(){return this._maxPixelRatio},set:function(t){this._maxPixelRatio=t,this.resizeCanvas(this._width,this._height)}}),{GraphicsDevice:c,ShaderAttributeSlots:r,UniformDefaultValues:a}}()),Object.assign(pc,function(){"use strict";var t={},e={vertex_position:pc.SEMANTIC_POSITION,vertex_normal:pc.SEMANTIC_NORMAL,vertex_tangent:pc.SEMANTIC_TANGENT,vertex_texCoord0:pc.SEMANTIC_TEXCOORD0,vertex_texCoord1:pc.SEMANTIC_TEXCOORD1,vertex_texCoord2:pc.SEMANTIC_TEXCOORD2,vertex_texCoord3:pc.SEMANTIC_TEXCOORD3,vertex_texCoord4:pc.SEMANTIC_TEXCOORD4,vertex_texCoord5:pc.SEMANTIC_TEXCOORD5,vertex_texCoord6:pc.SEMANTIC_TEXCOORD6,vertex_texCoord7:pc.SEMANTIC_TEXCOORD7,vertex_color:pc.SEMANTIC_COLOR,vertex_boneIndices:pc.SEMANTIC_BLENDINDICES,vertex_boneWeights:pc.SEMANTIC_BLENDWEIGHT};return t.collectAttribs=function(t){for(var i={},s=0,n=t.indexOf("attribute");n>=0&&!(n>0&&"/"===t[n-1]);){var r=t.indexOf(";",n),a=t.lastIndexOf(" ",r),o=t.substr(a+1,r-(a+1)),h=e[o];void 0!==h?i[o]=h:(i[o]="ATTR"+s,s++),n=t.indexOf("attribute",n+1)}return i},t.createShader=function(e,i,s,n){var r=t[i],a=pc.programlib.precisionCode(e)+"\n"+t[s];a=pc.ensureExtensionsInTheBeginning(a);var o=this.collectAttribs(r);return e.webgl2&&(r=pc.programlib.versionCode(e)+this.gles3VS+r,a=pc.programlib.versionCode(e)+this.gles3PS+a),new pc.Shader(e,{attributes:o,vshader:r,fshader:a,useTransformFeedback:n})},t.createShaderFromCode=function(t,e,i,s,n){var r=t.programLib._cache,a=r[s];if(void 0!==a)return a;i=pc.programlib.precisionCode(t)+"\n"+(i||pc.programlib.dummyFragmentCode()),i=pc.ensureExtensionsInTheBeginning(i);var o=this.collectAttribs(e);return t.webgl2&&(e=pc.programlib.versionCode(t)+this.gles3VS+e,i=pc.programlib.versionCode(t)+this.gles3PS+i),r[s]=new pc.Shader(t,{attributes:o,vshader:e,fshader:i,useTransformFeedback:n}),r[s]},{shaderChunks:t}}()),Object.assign(pc,function(){"use strict";var t=null,e={type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1};return{drawQuadWithShader:function(i,s,n,r,a,o){if(null===t){var h=new pc.VertexFormat(i,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.TYPE_FLOAT32}]);t=new pc.VertexBuffer(i,h,4);var c=new pc.VertexIterator(t);c.element[pc.SEMANTIC_POSITION].set(-1,-1),c.next(),c.element[pc.SEMANTIC_POSITION].set(1,-1),c.next(),c.element[pc.SEMANTIC_POSITION].set(-1,1),c.next(),c.element[pc.SEMANTIC_POSITION].set(1,1),c.end()}var l,p,u,d,_,f,m,g,y=i.renderTarget;i.setRenderTarget(s),i.updateBegin(),r?(l=r.x,p=r.y,u=r.z,d=r.w):(u=s?s.width:i.width,d=s?s.height:i.height,l=0,p=0),a?(_=a.x,f=a.y,m=a.z,g=a.w):(_=l,f=p,m=u,g=d),i.setViewport(l,p,u,d),i.setScissor(_,f,m,g);var E=i.getDepthTest(),v=i.getDepthWrite(),T=i.getCullMode();i.setDepthTest(!1),i.setDepthWrite(!1),i.setCullMode(pc.CULLFACE_NONE),o||i.setBlending(!1),i.setVertexBuffer(t,0),i.setShader(n),i.draw(e,1,{}),i.setDepthTest(E),i.setDepthWrite(v),i.setCullMode(T),i.updateEnd(),i.setRenderTarget(y),i.updateBegin()},destroyPostEffectQuad:function(){t&&(t.destroy(),t=null)}}}()),Object.assign(pc,function(){"use strict";function t(t,e,i){var s=e._colorBuffer;if(s.format==pc.PIXELFORMAT_R8_G8_B8_A8){var n=new Uint8Array(s.width*s.height*4),r=t.gl;t.setFramebuffer(e._glFrameBuffer),r.readPixels(0,0,s.width,s.height,r.RGBA,r.UNSIGNED_BYTE,n),s._levels||(s._levels=[]),s._levels[0]||(s._levels[0]=[]),s._levels[0][i]=n}}function e(t,e){return Math.atan2(t*e,Math.sqrt(t*t+e*e+1))}function i(t,i,s){var n=2*(t+.5)/s-1,r=2*(i+.5)/s-1,a=1/s,o=(n*=1-1/s)-a,h=(r*=1-1/s)-a,c=n+a,l=r+a,p=e(o,h)-e(o,l)-e(c,h)+e(c,l);return 0===t&&0===i||t===s-1&&0===i||0===t&&i===s-1||t===s-1&&i===s-1?p/=3:0!==t&&0!==i&&t!==s-1&&i!==s-1||(p*=.5),p}return{prefilterCubemap:function(e){var i=e.device,s=e.sourceCubemap,n=e.method,r=e.samples,a=e.cpuSync;if(!a||s._levels[0]){var o,h,c,l,p,u,d=pc.shaderChunks,_=s.rgbm,f=d.createShaderFromCode(i,d.fullscreenQuadVS,d.rgbmPS+d.prefilterCubemapPS.replace(/\$METHOD/g,0===n?"cos":"phong").replace(/\$NUMSAMPLES/g,r).replace(/\$textureCube/g,_?"textureCubeRGBM":"textureCube"),"prefilter"+n+r+_),m=d.createShaderFromCode(i,d.fullscreenQuadVS,d.outputCubemapPS,"outputCubemap"),g=i.scope.resolve("source"),y=i.scope.resolve("params"),E=new pc.Vec4,v=s.width,T=s.format,b=[[],e.filteredFixed,e.filteredRgbm,e.filteredFixedRgbm],A=0===n?[.9,.85,.7,.4,.25]:[512,128,32,8,2],S=[64,32,16,8,4],R=T===pc.PIXELFORMAT_R8_G8_B8,I=!1;if(a&&(I=s._levels[0][0]instanceof HTMLImageElement),(R||I)&&a){for(T=pc.PIXELFORMAT_R8_G8_B8_A8,p=new pc.Texture(i,{cubemap:!0,rgbm:_,format:T,width:v,height:v,mipmaps:!1}),c=0;c<6;c++)o=new pc.RenderTarget(i,p,{face:c,depth:!1}),E.x=c,E.y=0,g.setValue(s),y.setValue(E.data),pc.drawQuadWithShader(i,o,m),t(i,o,c);s=p}if(v>128){var C=Math.round(Math.log2(128)),M=Math.round(Math.log2(v))-C;for(h=0;h<M;h++){v=.5*s.width;var O=0===n?1:Math.pow(2,Math.round(Math.log2(A[0])+2*(M-h)));for(p=new pc.Texture(i,{cubemap:!0,rgbm:_,format:T,width:v,height:v,mipmaps:!1}),c=0;c<6;c++)o=new pc.RenderTarget(i,p,{face:c,depth:!1}),E.x=c,E.y=O,E.z=v,E.w=_?3:0,g.setValue(s),y.setValue(E.data),pc.drawQuadWithShader(i,o,m),h===M-1&&a&&t(i,o,c);s=p}}e.sourceCubemap=s;var P=null;if(!_&&e.filteredFixedRgbm){for(p=new pc.Texture(i,{cubemap:!0,rgbm:!0,format:pc.PIXELFORMAT_R8_G8_B8_A8,width:v,height:v,mipmaps:!1}),c=0;c<6;c++)o=new pc.RenderTarget(i,p,{face:c,depth:!1}),E.x=c,E.w=2,g.setValue(s),y.setValue(E.data),pc.drawQuadWithShader(i,o,m),t(i,o,c);P=p}var x,w=0===n?1:2048,L=0===n?0:-1;for(b[L]=[],h=0;h<5;h++)for(l=L;l<b.length;l++)null!=b[l]&&(b[l][h]=new pc.Texture(i,{cubemap:!0,rgbm:!(l<2)||_,format:l<2?T:pc.PIXELFORMAT_R8_G8_B8_A8,fixCubemapSeams:1===l||3===l,width:S[h],height:S[h],mipmaps:!1}));for(l=L;l<b.length;l++)if(null!=b[l]){if(l>1&&_){b[l]=b[l-2];continue}for(h=0;h<5;h++)for(c=0;c<6;c++)o=new pc.RenderTarget(i,b[l][h],{face:c,depth:!1}),E.x=c,E.y=l<0?w:A[h],E.z=S[h],E.w=_?3:l,g.setValue(0===h?s:0===n?b[0][h-1]:b[-1][h-1]),y.setValue(E.data),pc.drawQuadWithShader(i,o,f),a&&t(i,o,c)}if(e.filtered=b[0],a&&e.singleFilteredFixed){for(x=[s,e.filteredFixed[0],e.filteredFixed[1],e.filteredFixed[2],e.filteredFixed[3],e.filteredFixed[4],e.filteredFixed[5]],u=new pc.Texture(i,{cubemap:!0,rgbm:_,fixCubemapSeams:!0,format:T,width:128,height:128,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE}),h=0;h<6;h++)u._levels[h]=x[h]._levels[0];u.upload(),u._prefilteredMips=!0,e.singleFilteredFixed=u}if(a&&e.singleFilteredFixedRgbm&&e.filteredFixedRgbm){for(x=[P,e.filteredFixedRgbm[0],e.filteredFixedRgbm[1],e.filteredFixedRgbm[2],e.filteredFixedRgbm[3],e.filteredFixedRgbm[4],e.filteredFixedRgbm[5]],u=new pc.Texture(i,{cubemap:!0,rgbm:!0,fixCubemapSeams:!0,format:pc.PIXELFORMAT_R8_G8_B8_A8,width:128,height:128,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE}),h=0;h<6;h++)u._levels[h]=x[h]._levels[0];u.upload(),u._prefilteredMips=!0,e.singleFilteredFixedRgbm=u}}else console.error("ERROR: prefilter: cubemap must have _levels")},shFromCubemap:function(t,e){var s,n,r,a=t.width;if(t.format==pc.PIXELFORMAT_R8_G8_B8_A8){if(t._levels[0]){if(!t._levels[0][0].length){if(!(t._levels[0][0]instanceof HTMLImageElement))return void console.error("ERROR: SH: cubemap must be composed of arrays or images");var o=pc.Application.getApplication().graphicsDevice,h=o.gl,c=pc.shaderChunks,l=c.createShaderFromCode(o,c.fullscreenQuadVS,c.fullscreenQuadPS,"fsQuadSimple"),p=o.scope.resolve("source");for(s=0;s<6;s++){var u=t._levels[0][s],d=new pc.Texture(o,{cubemap:!1,rgbm:!1,format:t.format,width:a,height:a,mipmaps:!1});d._levels[0]=u,d.upload();var _=new pc.Texture(o,{cubemap:!1,rgbm:!1,format:t.format,width:a,height:a,mipmaps:!1}),f=new pc.RenderTarget(o,_,{depth:!1});p.setValue(d),pc.drawQuadWithShader(o,f,l);var m=new Uint8Array(a*a*4);h.bindFramebuffer(h.FRAMEBUFFER,f._glFrameBuffer),h.readPixels(0,0,d.width,d.height,h.RGBA,h.UNSIGNED_BYTE,m),t._levels[0][s]=m}}var g=[];for(r=0;r<a;r++)for(n=0;n<a;n++){var y=n/(a-1)*2-1,E=r/(a-1)*2-1;g[r*a+n]=new pc.Vec3(y,E,1).normalize()}var v,T,b,A,S,R,I,C,M,O,P,x,w,L,F=new Float32Array(27),D=0;for(s=0;s<6;s++)for(r=0;r<a;r++)for(n=0;n<a;n++)for(v=r*a+n,O=4*(S=i(n,r,a))/17,P=8*S/17,x=15*S/17,w=5*S/68,L=15*S/68,R=g[v],0==s?(I=R.z,C=-R.y,M=-R.x):1==s?(I=-R.z,C=-R.y,M=R.x):2==s?(I=R.x,C=R.z,M=R.y):3==s?(I=R.x,C=-R.z,M=-R.y):4==s?(I=R.x,C=-R.y,M=R.z):5==s&&(I=-R.x,C=-R.y,M=-R.z),e||(I=-I),b=t._levels[0][s][4*v+3]/255,T=0;T<3;T++)A=t._levels[0][s][4*v+T]/255,t.rgbm?(A*=8*b,A*=A):A=Math.pow(A,2.2),F[0+T]+=A*O,F[3+T]+=A*P*I,F[6+T]+=A*P*C,F[9+T]+=A*P*M,F[12+T]+=A*x*I*M,F[15+T]+=A*x*M*C,F[18+T]+=A*x*C*I,F[21+T]+=A*w*(3*M*M-1),F[24+T]+=A*L*(I*I-C*C),D+=S;for(T=0;T<F.length;T++)F[T]*=4*Math.PI/D;return F}console.error("ERROR: SH: cubemap must be synced to CPU")}else console.error("ERROR: SH: cubemap must be RGBA8")}}}()),Object.assign(pc,function(){"use strict";var t=2;function e(t,e){t.x=.5*pc.math.clamp(e-2,0,1);var i=e-6*t.x,s=1-t.x;return t.y=Math.min(.5*i,.75)*s+t.x,t.z=(1-.5*pc.math.clamp(i,0,1))*s,t.w=.5*t.z,1/t.z}return{paraboloidFromCubemap:function(e,i,s,n){var r=pc.shaderChunks,a=r.createShaderFromCode(e,r.fullscreenQuadVS,(i.fixCubemapSeams?r.fixCubemapSeamsStretchPS:r.fixCubemapSeamsNonePS)+r.genParaboloidPS,"genParaboloid"),o=e.scope.resolve("source"),h=e.scope.resolve("params"),c=new pc.Vec4,l=i.width,p=i.rgbm,u=i.format;l=Math.max(l,8)*t;var d=new pc.Texture(e,{rgbm:p,format:u,width:2*l,height:l,mipmaps:!1}),_=new pc.RenderTarget(e,d,{depth:!1});return c.x=s,c.y=n?-1:1,o.setValue(i),h.setValue(c.data),pc.drawQuadWithShader(e,_,a),d},generateDpAtlas:function(i,s,n){var r,a;a=new pc.Vec4;for(var o,h=new pc.Vec4,c=2*s[0].width*t,l=pc.shaderChunks,p=l.createShaderFromCode(i,l.fullscreenQuadVS,l.dpAtlasQuadPS,"dpAtlasQuad"),u=i.scope.resolve("source"),d=i.scope.resolve("params"),_=new pc.Texture(i,{rgbm:s[0].rgbm,format:s[0].format,width:c,height:c,mipmaps:!1}),f=new pc.RenderTarget(i,_,{depth:!1}),m=(c+2)/c-1,g=0;g<6;g++)r=pc.paraboloidFromCubemap(i,s[g],g,n),u.setValue(r),o=e(a,g),h.x=o*m,h.y=2*h.x,h.x+=1,h.y+=1,d.setValue(h.data),a.x*=c,a.y*=c,a.z*=c,a.w*=c,pc.drawQuadWithShader(i,f,p,a);return _}}}()),pc.shaderChunks.convolveLastMipOfCubemapPS="#extension GL_EXT_shader_texture_lod : enable\nhighp vec4 sampleCubeLod(highp samplerCube sampler, highp vec3 coord, mediump float lod) {\n#if defined(GL_EXT_shader_texture_lod)\n\treturn textureCubeLodEXT( sampler, coord, lod );\n#else\n\treturn textureCube( sampler, coord, lod );\n#endif\n}\nuniform highp samplerCube _Cubemap_; \nuniform highp float _Level_; \nvoid main() { \n\t// just sample all directions (+X, -X etc) and average the result\n\tgl_FragColor = vec4(( \n\t\tsampleCubeLod( _Cubemap_, vec3( 1.0, 0.0, 0.0 ),  _Level_ ) + \n\t\tsampleCubeLod( _Cubemap_, vec3( -1.0, 0.0, 0.0 ), _Level_ ) + \n\t\tsampleCubeLod( _Cubemap_, vec3( 0.0, 1.0, 0.0 ),  _Level_ ) + \n\t\tsampleCubeLod( _Cubemap_, vec3( 0.0, -1.0, 0.0 ), _Level_ ) + \n\t\tsampleCubeLod( _Cubemap_, vec3( 0.0, 0.0, 1.0 ),  _Level_ ) +\n\t    sampleCubeLod( _Cubemap_, vec3( 0.0, 0.0, -1.0 ), _Level_ ) \n\t) * 0.1666666667); \n}",pc.shaderChunks.convolveLastMipOfCubemapVS="attribute vec2 vertex_position; \nvoid main() { \n\tgl_Position = vec4( vertex_position, 0.5, 1.0 ); \n}",pc.shaderChunks.fullscreenQuadPS="varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n",pc.shaderChunks.fullscreenQuadVS="attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    vUv0 = vertex_position.xy*0.5+0.5;\n}\n",pc.shaderChunks.gles3PS="#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n",pc.shaderChunks.gles3VS="#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",pc.programlib={gammaCode:function(t){return t===pc.GAMMA_SRGB||t===pc.GAMMA_SRGBFAST?pc.shaderChunks.gamma2_2PS:t===pc.GAMMA_SRGBHDR?"#define HDR\n"+pc.shaderChunks.gamma2_2PS:pc.shaderChunks.gamma1_0PS},tonemapCode:function(t){return t===pc.TONEMAP_FILMIC?pc.shaderChunks.tonemappingFilmicPS:t===pc.TONEMAP_LINEAR?pc.shaderChunks.tonemappingLinearPS:t===pc.TONEMAP_HEJL?pc.shaderChunks.tonemappingHejlPS:t===pc.TONEMAP_ACES?pc.shaderChunks.tonemappingAcesPS:t===pc.TONEMAP_ACES2?pc.shaderChunks.tonemappingAces2PS:pc.shaderChunks.tonemappingNonePS},fogCode:function(t){return"linear"===t?pc.shaderChunks.fogLinearPS:"exp"===t?pc.shaderChunks.fogExpPS:"exp2"===t?pc.shaderChunks.fogExp2PS:pc.shaderChunks.fogNonePS},skinCode:function(t,e){return e||(e=pc.shaderChunks),t.supportsBoneTextures?e.skinTexVS:"#define BONE_LIMIT "+t.getBoneLimit()+"\n"+e.skinConstVS},precisionCode:function(t){var e="precision "+t.precision+" float;\n";return t.webgl2&&(e+="#ifdef GL2\nprecision "+t.precision+" sampler2DShadow;\n#endif\n"),e},versionCode:function(t){return t.webgl2?"#version 300 es\n":""},dummyFragmentCode:function(){return"void main(void) {gl_FragColor = vec4(0.0);}"},begin:function(){return"void main(void)\n{\n"},end:function(){return"}\n"}},Object.assign(pc,function(){var t={type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1},e=function(t){this.device=t,this.shader=null,this.depthMap=null,this.vertexBuffer=pc.createFullscreenQuad(t),this.needsDepthBuffer=!1};return Object.assign(e.prototype,{render:function(t,e,i){}}),{PostEffect:e,createFullscreenQuad:function(t){var e=new pc.VertexFormat(t,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.TYPE_FLOAT32}]),i=new pc.VertexBuffer(t,e,4),s=new pc.VertexIterator(i);return s.element[pc.SEMANTIC_POSITION].set(-1,-1),s.next(),s.element[pc.SEMANTIC_POSITION].set(1,-1),s.next(),s.element[pc.SEMANTIC_POSITION].set(-1,1),s.next(),s.element[pc.SEMANTIC_POSITION].set(1,1),s.end(),i},drawFullscreenQuad:function(e,i,s,n,r){e.setRenderTarget(i),e.updateBegin();var a=null!==i?i.width:e.width,o=null!==i?i.height:e.height,h=0,c=0;r&&(h=r.x*a,c=r.y*o,a*=r.z,o*=r.w),e.setViewport(h,c,a,o),e.setScissor(h,c,a,o);var l=e.getBlending(),p=e.getDepthTest(),u=e.getDepthWrite(),d=e.getCullMode(),_=e.writeRed,f=e.writeGreen,m=e.writeBlue,g=e.writeAlpha;e.setBlending(!1),e.setDepthTest(!1),e.setDepthWrite(!1),e.setCullMode(pc.CULLFACE_BACK),e.setColorWrite(!0,!0,!0,!0),e.setVertexBuffer(s,0),e.setShader(n),e.draw(t),e.setBlending(l),e.setDepthTest(p),e.setDepthWrite(u),e.setCullMode(d),e.setColorWrite(_,f,m,g),e.updateEnd()}}}()),function(){var t={BLEND_SUBTRACTIVE:0,BLEND_ADDITIVE:1,BLEND_NORMAL:2,BLEND_NONE:3,BLEND_PREMULTIPLIED:4,BLEND_MULTIPLICATIVE:5,BLEND_ADDITIVEALPHA:6,BLEND_MULTIPLICATIVE2X:7,BLEND_SCREEN:8,BLEND_MIN:9,BLEND_MAX:10,FOG_NONE:"none",FOG_LINEAR:"linear",FOG_EXP:"exp",FOG_EXP2:"exp2",FRESNEL_NONE:0,FRESNEL_SCHLICK:2,LAYER_HUD:0,LAYER_GIZMO:1,LAYER_FX:2,LAYER_WORLD:15,LAYERID_WORLD:0,LAYERID_DEPTH:1,LAYERID_SKYBOX:2,LAYERID_IMMEDIATE:3,LAYERID_UI:4,LIGHTTYPE_DIRECTIONAL:0,LIGHTTYPE_POINT:1,LIGHTTYPE_SPOT:2,LIGHTFALLOFF_LINEAR:0,LIGHTFALLOFF_INVERSESQUARED:1,SHADOW_PCF3:0,SHADOW_DEPTH:0,SHADOW_VSM8:1,SHADOW_VSM16:2,SHADOW_VSM32:3,SHADOW_PCF5:4,BLUR_BOX:0,BLUR_GAUSSIAN:1,PARTICLESORT_NONE:0,PARTICLESORT_DISTANCE:1,PARTICLESORT_NEWER_FIRST:2,PARTICLESORT_OLDER_FIRST:3,PARTICLEMODE_GPU:0,PARTICLEMODE_CPU:1,EMITTERSHAPE_BOX:0,EMITTERSHAPE_SPHERE:1,PROJECTION_PERSPECTIVE:0,PROJECTION_ORTHOGRAPHIC:1,RENDERSTYLE_SOLID:0,RENDERSTYLE_WIREFRAME:1,RENDERSTYLE_POINTS:2,CUBEPROJ_NONE:0,CUBEPROJ_BOX:1,SPECULAR_PHONG:0,SPECULAR_BLINN:1,GAMMA_NONE:0,GAMMA_SRGB:1,GAMMA_SRGBFAST:2,GAMMA_SRGBHDR:3,TONEMAP_LINEAR:0,TONEMAP_FILMIC:1,TONEMAP_HEJL:2,TONEMAP_ACES:3,TONEMAP_ACES2:4,SPECOCC_NONE:0,SPECOCC_AO:1,SPECOCC_GLOSSDEPENDENT:2,SHADERDEF_NOSHADOW:1,SHADERDEF_SKIN:2,SHADERDEF_UV0:4,SHADERDEF_UV1:8,SHADERDEF_VCOLOR:16,SHADERDEF_INSTANCING:32,SHADERDEF_LM:64,SHADERDEF_DIRLM:128,SHADERDEF_SCREENSPACE:256,SHADERDEF_TANGENTS:512,SHADERDEF_LMUV0:1024,SHADERDEF_LM_DLDR:2048,SHADERDEF_LM_BAKED_AMBIENT:4096,SHADERDEF_LIGHTPROBES:8192,SHADERDEF_BLEND_REFLECTION_PROBES:16384,SHADERDEF_RENDERTYPE_BACKGROUND:32768,SHADERDEF_PARTICLES_INSTANCING:65536,SHADERDEF_UI_MASK:1<<17,SHADERDEF_REVERT_STENCIL:1<<18,MASK_DYNAMIC:1,MASK_BAKED:2,MASK_LIGHTMAP:4,LINEBATCH_WORLD:0,LINEBATCH_OVERLAY:1,LINEBATCH_GIZMO:2,LINEBATCH_SCREEN:3,SHADOWUPDATE_NONE:0,SHADOWUPDATE_THISFRAME:1,SHADOWUPDATE_REALTIME:2,SORTKEY_FORWARD:0,SORTKEY_DEPTH:1,SHADER_FORWARD:0,SHADER_FORWARDHDR:1,SHADER_DEPTH:2,SHADER_SHADOW:3,SHADER_PICK:18,BAKE_COLOR:0,BAKE_COLORDIR:1,VIEW_CENTER:0,VIEW_LEFT:1,VIEW_RIGHT:2,SORTMODE_NONE:0,SORTMODE_MANUAL:1,SORTMODE_MATERIALMESH:2,SORTMODE_BACK2FRONT:3,SORTMODE_FRONT2BACK:4,SORTMODE_CUSTOM:5,COMPUPDATED_INSTANCES:1,COMPUPDATED_LIGHTS:2,COMPUPDATED_CAMERAS:4,COMPUPDATED_BLEND:8,ASPECT_AUTO:0,ASPECT_MANUAL:1,ORIENTATION_HORIZONTAL:0,ORIENTATION_VERTICAL:1};Object.assign(pc,t),pc.scene={},Object.assign(pc.scene,t)}(),Object.assign(pc,function(){var t=function(){this.root=null,this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},this._statsUpdated=!1,this.meshInstancesCount=0,this._meshInstances=new Array(1e3),this._renderers=new Set,this._cameras=new pc.IndexedList,this._lights=new pc.IndexedList,this._overlayScreensDirty=!1,this._overlayScreens=new pc.IndexedList,this._worldScreens=new pc.IndexedList,this.activeUiMasks={},this.dirtyEntities=[],this.dirtyEntitiesForRemove=[],pc.events.attach(this)};return t.prototype.addDirty=function(t){for(var e=0;e<this.dirtyEntities.length;e++){var i=this.dirtyEntities[e];t.isParentOf(i)&&this.dirtyEntitiesForRemove.push(i)}this.dirtyEntities.push(t);for(e=0;e<this.dirtyEntitiesForRemove.length;e++){var s=this.dirtyEntitiesForRemove[e],n=this.dirtyEntities.indexOf(s);this.dirtyEntities[n]=this.dirtyEntities[this.dirtyEntities.length-1],this.dirtyEntities.length-=1}this.dirtyEntitiesForRemove.length=0},t.prototype.syncHierarchy=function(t){for(var e=0;e<this.dirtyEntities.length;e++)this.dirtyEntities[e].syncHierarchy();this.dirtyEntities.length=0},t.prototype.destroy=function(){this.root=null,this.defaultMaterial.destroy(),this.defaultMaterial=null,this.off()},t.prototype.addRenderer=function(t){this._renderers.add(t)},t.prototype.removeRenderer=function(t){this._renderers.delete(t)},t.prototype.getMeshInstances=function(){for(let t=0;t<this.meshInstancesCount;t++)this._meshInstances[t]=null;this.meshInstancesCount=0;for(let t of this._renderers){const e=t.getMeshInstancesForRender();for(let t=0;t<e.length;t++)this._meshInstances.length===this.meshInstancesCount?this._meshInstances.push(e[t]):this._meshInstances[this.meshInstancesCount]=e[t],this.meshInstancesCount++}return this._meshInstances},t.prototype.getMeshInstancesCached=function(){return this._meshInstances},t.prototype.addCamera=function(t){this._cameras.has(t)||this._cameras.push(t)},t.prototype.removeCamera=function(t){this._cameras.remove(t)},t.prototype.addLight=function(t){this._lights.has(t)||this._lights.push(t)},t.prototype.removeLight=function(t){this._lights.remove(t)},t.prototype.addScreen=function(t){var e=t.screenType===pc.SCREEN_TYPE_SCREEN?this._overlayScreens:this._worldScreens;e.has(t)||(e.push(t),e==this._overlayScreens&&(this._overlayScreensDirty=!0))},t.prototype.removeScreen=function(t){var e=t.screenType===pc.SCREEN_TYPE_SCREEN?this._overlayScreens:this._worldScreens;e.has(t)&&e.remove(t)},Object.defineProperty(t.prototype,"overlayScreens",{get:function(){return this._overlayScreensDirty&&(this._overlayScreensDirty=!1,this._overlayScreens.sort(pc.SortUtils.sortOverlayCanvases)),this._overlayScreens.list()}}),Object.defineProperty(t.prototype,"worldScreens",{get:function(){return this._worldScreens.list()}}),{Scene:t}}()),pc.extend(pc,function(){var t=/void\s+main\s*\(\s*(void)?\s*\)\s*{/,e="attribute\\s+(highp\\s*|lowp\\s*|mediump\\s*)?vec[2|3|4]\\s+",i=/\s*vec(2|3|4)\s*/,s=/uniform mat4 matrix_viewProjection;/,n=/texture2D\s*\(\s*unity_Lightmap\s*,/,r="  ",a="attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nmat4 skinnedMatrix;\n\nmat4 getSkinnedModelMatrix() {\n    return (\n    getBoneMatrix( vertex_boneIndices.x ) * vertex_boneWeights.x +\n    getBoneMatrix( vertex_boneIndices.y ) * vertex_boneWeights.y +\n    getBoneMatrix( vertex_boneIndices.z ) * vertex_boneWeights.z +\n    getBoneMatrix( vertex_boneIndices.w ) * vertex_boneWeights.w );\n}\n\nvec4 get_POSITION( vec4 pos )\n{\n    return skinnedMatrix * pos;\n}\n\nvec4 get_NORMAL( vec4 normal )\n{\n    return skinnedMatrix * normal;\n}\n\nvec4 get_TANGENT( vec4 tangent )\n{\n    return skinnedMatrix * tangent;\n}\n",o=function(t,e,i,s){return t.substring(0,e)+s+t.substring(e+i)},h=function(t,e,i,s){var n=t,r=e[0].search(i);return r+=e.index,n=o(n,r,i.length,s)},c=function(t,e){var i=t;return i=o(i,e.index,e[0].length,"")},l=function(t,s,n,a,o){var c=t,l=new RegExp(e+n+"\\s*;"),p=c.match(l);if(null!=p){var u=p[0].match(i)[0].trim();c=h(c,p,"attribute","");var d="_patched_"+s;if(o.defines+="attribute "+u+" "+d+";\n","vec4"===u)o.main+=r+n+" = get_"+s+"( "+d+" );\n";else{var _="",f="";"vec2"===u?(_=".xy",f=", 0, 0"):"vec3"===u&&(_=".xyz",f=", 0"),o.main+=r+n+" = get_"+s+"( vec4( "+d+f+") )"+_+";\n"}}return c},p=function(t,i,s){var n=null;for(var r in i)if(i[r]===s){var a=new RegExp(e+r+"\\s*;");if(null!=t.match(a)){n=r;break}}return n},u=function(t,e,i,s){for(var n=t,r=0;r<e.length;r++){var a=e[r],o=p(n,i,a);if(null!==o){n=l(n,a,o,0,s)}}return n},d=function(t,e){var i=t.match("\\s*#version [0-9]+\\s*");if(null==i)return t;var s=i[0].trim(),n=c(t,i);return e.defines=s+"\n\n"+e.defines,n};function _(t,e){this.baseShader=t,this.patchShader=e,this.defines="",this.main="",this.getMain=function(){return"void main() {\n"+this.main+r+"_main(); // Initial main function call\n}\n"},this.combine=function(){return"\n// Patched defines\n"+this.defines+"\n// Patch shader\n"+this.patchShader+"\n\n// Base shader\n"+this.baseShader+"\n\n// Partched main\n"+this.getMain()}}var f=/^#extension.*$/gm;return{ShaderPatches:{patchParticlesVertexShader:function(e,i){var n=new _(e,"// Instancing attributes\nattribute vec3 instancing_translation;\nattribute vec4 instancing_rotation;\nattribute vec3 instancing_scale;\nattribute vec4 instancing_color;\nattribute vec4 instancing_st;\n\n// Uniforms\nuniform highp mat4 matrix_viewInverse;\nuniform highp mat4 matrix_viewProjection;\nuniform highp mat4 matrix_modelRotation;\nuniform highp mat4 matrix_modelTranslation;\nuniform highp mat4 matrix_modelRotationInverse;\nuniform highp vec3 system_scale;\nuniform int renderer_alignment;\nuniform float worldSimulationSpace;\n\n// Quaternion multiplication\n// http://mathworld.wolfram.com/Quaternion.html\nvec4 quaternion_multiply( vec4 lhs, vec4 rhs ) {\n    return vec4(\n    rhs.xyz * lhs.w + lhs.xyz * rhs.w + cross( lhs.xyz, rhs.xyz ),\n    lhs.w * rhs.w - dot( lhs.xyz, rhs.xyz )\n    );\n}\n\n// Vector rotation with a quaternion\n// http://mathworld.wolfram.com/Quaternion.html\nvec3 quaternion_rotate_vector( vec3 vector, vec4 quaternion ) {\n    vec4 quaternion_conjugate = quaternion * vec4( -1, -1, -1, 1 );\n    return quaternion_multiply( quaternion, quaternion_multiply( vec4( vector, 0 ), quaternion_conjugate ) ).xyz;\n}\n\nmat4 transpose( mat4 m ) {\n    return mat4(\n    m[ 0 ][ 0 ], m[ 1 ][ 0 ], m[ 2 ][ 0 ], m[ 3 ][ 0 ],\n    m[ 0 ][ 1 ], m[ 1 ][ 1 ], m[ 2 ][ 1 ], m[ 3 ][ 1 ],\n    m[ 0 ][ 2 ], m[ 1 ][ 2 ], m[ 2 ][ 2 ], m[ 3 ][ 2 ],\n    m[ 0 ][ 3 ], m[ 1 ][ 3 ], m[ 2 ][ 3 ], m[ 3 ][ 3 ]);\n}\n\nmat4 getFacingAlignmentRotation( vec4 particlePosition ) {\n    vec3 eye = matrix_viewInverse[ 3 ].xyz;\n    vec3 pivot = particlePosition.xyz;\n\n    // Find desired rotation between two vectors\n    vec4 cameraZ = vec4( normalize( pivot - eye ), 0 );\n    vec4 cameraY = matrix_viewInverse * vec4( 0, 1, 0, 0 );\n    vec4 cameraX = vec4( cross(cameraY.xyz, cameraZ.xyz), 0 );\n    cameraY = vec4( cross(cameraZ.xyz, cameraX.xyz), 0 );\n\n    mat4 extraRotation = mat4( 0.0 );\n    extraRotation[ 0 ] = cameraX;\n    extraRotation[ 1 ] = cameraY;\n    extraRotation[ 2 ] = cameraZ;\n    extraRotation[ 3 ][ 3 ] = 1.0;\n\n    return extraRotation;\n}\n\n// Applies rotation, then scale, then translate to the\n// vertex coordinates.\n\n#define VIEW_ALIGNMENT      0\n#define WORLD_ALIGNMENT     1\n#define LOCAL_ALIGNMENT     2\n#define FACING_ALIGNMENT    3\n\nmat4 alignment_rotation;\nmat4 simulationSpace_rotation;\nmat4 simulationSpace_translation;\n\nvec4 transform_vertex( vec4 vertex, mat4 matrix_scale ) {\n    vec4 v = matrix_scale * vertex;\n    v = vec4( quaternion_rotate_vector( v.xyz, instancing_rotation ), 1.0 );\n    v = alignment_rotation * v;\n\n    v += vec4( instancing_translation, 0 );\n\n    v = simulationSpace_rotation * v;\n    v = simulationSpace_translation * v;\n\n    return v;\n}\n\n\nvec4 get_POSITION( vec4 position ) {\n    if ( worldSimulationSpace > 0.0 ) {\n        simulationSpace_rotation = mat4( 1.0 );\n        simulationSpace_translation = mat4( 1.0 );\n    } else {\n        simulationSpace_rotation = matrix_modelRotation;\n        simulationSpace_translation = mat4( 1.0 );\n        simulationSpace_translation[ 3 ] = matrix_modelTranslation[ 3 ];\n    }\n\n    if ( LOCAL_ALIGNMENT == renderer_alignment ) {\n        // local alignment means rotation starts with hierarchy rotation\n        alignment_rotation = matrix_modelRotation;\n    } else if ( WORLD_ALIGNMENT ==  renderer_alignment ) {\n        // world alignment means rotation starts with E\n        alignment_rotation = mat4( 1.0 );\n    } else if ( ( VIEW_ALIGNMENT == renderer_alignment ) || ( FACING_ALIGNMENT == renderer_alignment ) ) {\n        // view alignment means rotation starts with camera rotation\n        // Assume scales are 0\n        alignment_rotation = matrix_viewInverse;\n        alignment_rotation[ 3 ] = vec4( 0, 0, 0, 1 );\n    }\n\n    alignment_rotation = transpose( simulationSpace_rotation ) * alignment_rotation;\n\n    mat4 scale;\n    scale[ 0 ] = vec4( system_scale.x * instancing_scale.x, 0, 0, 0 );\n    scale[ 1 ] = vec4( 0, system_scale.y * instancing_scale.y, 0, 0 );\n    scale[ 2 ] = vec4( 0, 0, system_scale.z * instancing_scale.z, 0 );\n    scale[ 3 ] = vec4( 0, 0, 0, 1 );\n\n    vec4 vertex = vec4( position.xyz, 1 );\n    vec4 vertexPosition = transform_vertex( vertex, scale );\n\n    if ( FACING_ALIGNMENT == renderer_alignment ) {\n        vec4 pivot_vertex = vec4( 0, 0, 0, 1 );\n        vec4 pivot = transform_vertex( pivot_vertex, scale );\n\n        alignment_rotation = transpose( simulationSpace_rotation ) * getFacingAlignmentRotation( pivot );\n        vertexPosition = transform_vertex( vertex, scale );\n    }\n\n    return vertexPosition;\n}\n\nvec4 get_COLOR( vec4 color ) {\n    return color * instancing_color;\n}\n\nvec4 get_TEXCOORD0( vec4 texcoord ) {\n    return vec4( ( texcoord.xy + instancing_st.zw ) * instancing_st.xy, texcoord.zw );\n}\n\nvec4 get_NORMAL( vec4 normal ) {\n    normal = vec4( quaternion_rotate_vector( normal.xyz, instancing_rotation ), 0 );\n    normal = alignment_rotation * normal;\n    normal = simulationSpace_rotation * normal;\n    return normal;\n}\n\nvec4 get_TANGENT( vec4 tangent ) {\n    tangent = vec4( quaternion_rotate_vector( tangent.xyz, instancing_rotation ), 0 );\n    tangent = alignment_rotation * tangent;\n    tangent = simulationSpace_rotation * tangent;\n    return tangent;\n}");n.baseShader=function(t){var e=new RegExp(s),i=t.match(e);return null===i?t:c(t,i)}(n.baseShader);var r=[pc.SEMANTIC_POSITION,pc.SEMANTIC_COLOR,pc.SEMANTIC_TEXCOORD0,pc.SEMANTIC_NORMAL,pc.SEMANTIC_TANGENT];n.baseShader=d(n.baseShader,n),n.baseShader=u(n.baseShader,r,i,n);var a=new RegExp(t),o=n.baseShader.match(a);return null===o?(console.error("Shader patching error. Main function not found\n"+e),null):(n.baseShader=h(n.baseShader,o,"main","_main"),n.combine())},patchSkinningVertexShader:function(e,i){var s,n=pc.Application.getApplication().graphicsDevice;n.supportsBoneTextures?s=new _(e,"uniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i)\n{\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n    y = dy * (y + 0.5);\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n    mat4 bone = mat4(v1, v2, v3, v4);\n    return bone;\n}\n\n"+a):(s=new _(e,"// #define BONE_LIMIT 128 // will be added in code\nuniform mat4 matrix_pose[BONE_LIMIT];\nmat4 getBoneMatrix(const in float i) {\n    mat4 bone = matrix_pose[int(i)];\n    return bone;\n}\n\n"+a)).defines+="#define BONE_LIMIT "+n.getBoneLimit()+"\n",s.main+=r+"skinnedMatrix = getSkinnedModelMatrix();\n";var o=[pc.SEMANTIC_POSITION,pc.SEMANTIC_NORMAL,pc.SEMANTIC_TANGENT];s.baseShader=d(s.baseShader,s),s.baseShader=u(s.baseShader,o,i,s);var c=new RegExp(t),l=s.baseShader.match(c);return null===l?(console.error("Shader patching error. Main function not found\n"+e),null):(s.baseShader=h(s.baseShader,l,"main","_main"),s.combine())},patchTexture2DLightmap:function(e){var i=new RegExp(n),s=e.match(i);if(!s)return e;return e=function(e,i){var s=e.match(t);return null==s?e:function(t,e,i){return t.substring(0,e)+i+t.substring(e)}(e,s.index,i)}(e=h(e,s,"texture2D","texture2D_LM"),"// Patched method to support RGBm decoding\nuniform mediump vec4 unity_Lightmap_HDR;\nmediump vec4 texture2D_LM( sampler2D texture, mediump vec2 uv ) {\n    mediump vec4 rgbmColor = texture2D( texture, uv );    mediump vec4 color = vec4( rgbmColor.rgb * ( rgbmColor.w * unity_Lightmap_HDR.x ), rgbmColor.w );    return color;\n}\n\n")}},ensureExtensionsInTheBeginning:function(t){var e=new RegExp(f),i=t.match(e);return i?(t=t.replace(e,""),t=i[0]+"\n"+t):t},_createMissingShader:function(t,e){return console.error('Shader "'+t+'" with id #'+e+" is replaced as missing shader."),new pc.Shader(pc.Application.getApplication().graphicsDevice,{attributes:{_glesVertex:pc.SEMANTIC_POSITION,_glesNormal:pc.SEMANTIC_NORMAL,_glesTangent:pc.SEMANTIC_TANGENT,_glesMultiTexCoord0:pc.SEMANTIC_TEXCOORD0,_glesMultiTexCoord1:pc.SEMANTIC_TEXCOORD1,_glesMultiTexCoord2:pc.SEMANTIC_TEXCOORD2,_glesMultiTexCoord3:pc.SEMANTIC_TEXCOORD3,_glesColor:pc.SEMANTIC_COLOR},vshader:"// This is a VP stub for shader #"+e+" \n attribute vec3 _glesVertex; varying highp vec2 xlv_TEXCOORD0; uniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvoid main() { gl_Position = matrix_viewProjection * matrix_model * vec4(_glesVertex, 1.0); }",fshader:"// This is a FP stub for shader #"+e+" \n uniform sampler2D _MainTex; void main(void) { gl_FragColor = vec4(1, 0, 0.5, 1); }"})}}}()),pc.extend(pc,function(){var t,e;return{SortUtils:{genericSort:function(t,e,i){var s=t._material,n=e._material;if(!s||!n)return 0;if(s.renderQueue!==n.renderQueue)return s.renderQueue-n.renderQueue;if(t.sortingLayerIndex!==e.sortingLayerIndex)return t.sortingLayerIndex-e.sortingLayerIndex;if(t.sortingOrder!==e.sortingOrder)return t.sortingOrder-e.sortingOrder;if(t.drawOrder!==e.drawOrder)return t.drawOrder-e.drawOrder;i=s.renderQueue>2500?-1:1;return t.zdist&&e.zdist&&t.zdist!==e.zdist?(t.zdist-e.zdist)*i:s.id!==n.id?s.id-n.id:t.mesh.id-e.mesh.id},uiElementsSort:function(t,e,i){return t.drawOrder-e.drawOrder},calculateSortDistances:function(t,e,i){for(var s=0;s<t.length;s++){var n=t[s];if(!n.command){var r=n.aabb.center;n.zdist=(r.x-e.x)*i.x+(r.y-e.y)*i.y+(r.z-e.z)*i.z}}},autoInstancingSort:function(t,e){var i=t._material,s=e._material;if(!i||!s)return 0;if(i.renderQueue!==s.renderQueue)return i.renderQueue-s.renderQueue;if(t.sortingLayerIndex!==e.sortingLayerIndex)return t.sortingLayerIndex-e.sortingLayerIndex;if(t.sortingOrder!==e.sortingOrder)return t.sortingOrder-e.sortingOrder;if(t.drawOrder!==e.drawOrder)return t.drawOrder-e.drawOrder;var n=i.renderQueue>2500?-1:1;return i.renderQueue<=2500&&i.enableAutoInstancing!==s.enableAutoInstancing?i.enableAutoInstancing?-1:1:(i.renderQueue<=2500&&i.enableAutoInstancing&&s.enableAutoInstancing&&(n=0),0!==n&&t.zdist&&e.zdist&&t.zdist!==e.zdist?(t.zdist-e.zdist)*n:i.id!==s.id?i.id-s.id:t.mesh.id-e.mesh.id)},depthSortCompare:function(i,s){return t=i._key[pc.SORTKEY_DEPTH],e=s._key[pc.SORTKEY_DEPTH],t===e&&i.mesh&&s.mesh?s.mesh.id-i.mesh.id:e-t},lightCompare:function(t,e){return t.key-e.key},cameraCompare:function(t,e){return t.priority-e.priority},sortOverlayCanvases:function(t,e){return t.sortingOrder!==e.sortingOrder?t.sortingOrder-e.sortingOrder:t.$id-e.$id}}}}()),pc.extend(pc,function(){var t={},e=function(t,e){return Math.exp(-t*t/(2*e*e))},i=function(t){t>25&&(t=25);var i,s,n,r,a=(t-1)/6;for(r=.5*(t-1),s=new Array(t),n=0,i=0;i<t;++i)s[i]=e(i-r,a),n+=s[i];for(i=0;i<t;++i)s[i]/=n;return s};return{Gauss:{gauss:e,gaussWeights:function(e){var s=t[e];return void 0===s?(s=i(e),t[e]=s,s):s},calculateGaussWeights:i}}}()),pc.extend(pc,function(){var t=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3],e=(new pc.Vec3,3),i=[pc.STENCILOP_KEEP,pc.STENCILOP_ZERO,pc.STENCILOP_REPLACE,pc.STENCILOP_INCREMENT,pc.STENCILOP_INCREMENT,pc.STENCILOP_DECREMENT,pc.STENCILOP_INVERT,pc.STENCILOP_INCREMENTWRAP,pc.STENCILOP_DECREMENTWRAP],s=[pc.CULLFACE_NONE,pc.CULLFACE_FRONT,pc.CULLFACE_BACK],n=[pc.BLENDMODE_ZERO,pc.BLENDMODE_ONE,pc.BLENDMODE_DST_COLOR,pc.BLENDMODE_SRC_COLOR,pc.BLENDMODE_ONE_MINUS_DST_COLOR,pc.BLENDMODE_SRC_ALPHA,pc.BLENDMODE_ONE_MINUS_SRC_COLOR,pc.BLENDMODE_DST_ALPHA,pc.BLENDMODE_ONE_MINUS_DST_ALPHA,pc.BLENDMODE_SRC_ALPHA_SATURATE,pc.BLENDMODE_ONE_MINUS_SRC_ALPHA],r=function(t,e){return e._priority-t._priority},a=new pc.Vec3,o=[];return{RenderingUtils:{_getFrustumPoints:function(t,e,i){var s,n,r=t._nearClip,a=t._fov*Math.PI/180,o=t._aspect,h=t._projection;return s=(n=h===pc.PROJECTION_PERSPECTIVE?Math.tan(a/2)*r:t._orthoHeight)*o,i[0].x=s,i[0].y=-n,i[0].z=-r,i[1].x=s,i[1].y=n,i[1].z=-r,i[2].x=-s,i[2].y=n,i[2].z=-r,i[3].x=-s,i[3].y=-n,i[3].z=-r,h===pc.PROJECTION_PERSPECTIVE&&(s=(n=Math.tan(a/2)*e)*o),i[4].x=s,i[4].y=-n,i[4].z=-e,i[5].x=s,i[5].y=n,i[5].z=-e,i[6].x=-s,i[6].y=n,i[6].z=-e,i[7].x=-s,i[7].y=-n,i[7].z=-e,i},pointLightRotations:[(new pc.Quat).setFromEulerAngles(0,90,180),(new pc.Quat).setFromEulerAngles(0,-90,180),(new pc.Quat).setFromEulerAngles(90,0,0),(new pc.Quat).setFromEulerAngles(-90,0,0),(new pc.Quat).setFromEulerAngles(0,180,180),(new pc.Quat).setFromEulerAngles(0,0,180)],opacityMapChannelIDs:{r:1,g:2,b:3,a:4},_getZFromAABBSimple:function(e,i,s,n,r,a,o){t[0].x=t[1].x=t[2].x=t[3].x=i.x,t[1].y=t[3].y=t[7].y=t[5].y=i.y,t[2].z=t[3].z=t[6].z=t[7].z=i.z,t[4].x=t[5].x=t[6].x=t[7].x=s.x,t[0].y=t[2].y=t[4].y=t[6].y=s.y,t[0].z=t[1].z=t[4].z=t[5].z=s.z;for(var h,c=Number.MAX_VALUE,l=Number.MIN_VALUE,p=0;p<8;++p)e.transformPoint(t[p],t[p]),(h=t[p].z)<c&&(c=h),h>l&&(l=h);return{min:c,max:l}},getLightsData:function(t,i,s){if(s.reset(),o.length=0,0!==i.length){var n=-1,h=t.node,c=1<<h.cullingLayer,l=h.getPosition(),p=t.aabb,u=p.getMax(),d=p.getMin(),_=(u.x-d.x)*(u.y-d.y)*(u.z-d.z);e=UnityEngine.RenderSettings._pixelLightCount;for(var f=0;f<i.length;f++){if(0!=((b=i[f])._cullingMask&c)&&0!=(b._mask&pc.MASK_DYNAMIC)){var m=b._aabb.getMax(),g=b._aabb.getMin(),y=Math.max(0,Math.min(u.x,m.x)-Math.max(d.x,g.x))*Math.max(0,Math.min(u.y,m.y)-Math.max(d.y,g.y))*Math.max(0,Math.min(u.z,m.z)-Math.max(d.z,g.z));if(0===_)y=b._aabb.intersects(p)?1:0;else if(y<=0)continue;if(b._type===pc.LIGHTTYPE_DIRECTIONAL&&!b._cookie&&b._renderMode!==UnityEngine.LightRenderMode.ForceVertex){var E=s.mainLight;null===E?s.mainLight=b:E._luminance<b._luminance?s.mainLight=b:E._luminance===b._luminance&&b._renderMode===UnityEngine.LightRenderMode.ForcePixel&&E._renderMode!==UnityEngine.LightRenderMode.ForcePixel&&(s.mainLight=b)}if(b._effectiveLuminance=b._luminance,b._type!==pc.LIGHTTYPE_DIRECTIONAL){a.sub2(b._position,l),b._directionToLight.copy(a);var v=a.length()/b.attenuationEnd;b._effectiveLuminance*=pc.math.clamp(1/(1+25*v*v)*pc.math.clamp(5*(1-v),0,1),0,1),b._range=v}o.push(b),b===s.mainLight&&(n=o.length-1),b._priority=y/(0===_?1:_),b._renderMode===UnityEngine.LightRenderMode.ForcePixel&&(b._priority+=1e4),b._renderMode===UnityEngine.LightRenderMode.Auto&&(b._priority+=100)}}n>=0&&(o[n]=o[o.length-1],o.length=o.length-1),o.sort(r);var T=0;for(T=0;T<o.length;T++){var b=o[T];if(s.pixelLights.length>=e)break;if(b._renderMode===UnityEngine.LightRenderMode.ForceVertex)break;s.pixelLights.push(b)}for(;T<o.length;T++){if(!((b=o[T])._effectiveLuminance<1e-4)){if(s.vertexLights.length>=4)break;b._type===pc.LIGHTTYPE_DIRECTIONAL?s.otherLights.push(b):s.vertexLights.push(b)}}for(;T<o.length;T++)s.otherLights.push(b);s.combineAllLights()}},unityCompareFunctionToPlaycanvas:function(t){return t-1},unityStencilOpToPlaycanvas:function(t){return i[t]},unityBlendModeToPlaycanvas:function(t){return n[t]},unityCullModeToPlaycanvas:function(t){return s[t]},unityBlendOpToPlaycanvas:function(t){return t<=UnityEngine.Rendering.BlendOp.Max?t:null}}}}()),pc.extend(pc,function(){var t=[{},{},{},{},{}],e={},i=function(t,e){return e===pc.SHADOW_VSM32?pc.PIXELFORMAT_RGBA32F:e===pc.SHADOW_VSM16?pc.PIXELFORMAT_RGBA16F:e===pc.SHADOW_PCF5?pc.PIXELFORMAT_DEPTH:e===pc.SHADOW_PCF3&&t.webgl2?pc.PIXELFORMAT_DEPTH:pc.PIXELFORMAT_R8_G8_B8_A8},s=function(t,e){return e!==pc.SHADOW_PCF3||t.webgl2?e===pc.SHADOW_VSM32?t.extTextureFloatLinear?pc.FILTER_LINEAR:pc.FILTER_NEAREST:e===pc.SHADOW_VSM16?t.extTextureHalfFloatLinear?pc.FILTER_LINEAR:pc.FILTER_NEAREST:pc.FILTER_LINEAR:pc.FILTER_NEAREST},n=function(t,e,n,r){var a=i(t,r),o=s(t,r),h=new pc.Texture(t,{profilerHint:pc.TEXHINT_SHADOWMAP,format:a,width:e,height:n,mipmaps:!1,minFilter:o,magFilter:o,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE});return r===pc.SHADOW_PCF5||r===pc.SHADOW_PCF3&&t.webgl2?(h.compareOnRead=!0,h.compareFunc=pc.FUNC_LESS,new pc.RenderTarget({depthBuffer:h})):new pc.RenderTarget({colorBuffer:h,depth:!0})},r=function(t,e){for(var i,s=new pc.Texture(t,{profilerHint:pc.TEXHINT_SHADOWMAP,format:pc.PIXELFORMAT_R8_G8_B8_A8,width:e,height:e,cubemap:!0,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE}),n=[],r=0;r<6;r++)i=new pc.RenderTarget({colorBuffer:s,face:r,depth:!0}),n.push(i);return n},a=function(e,i,s,r){r||(r=0);var a=1e4*r+i,o=t[s][a];return o||(o=n(e,i,i,s||pc.SHADOW_PCF3),t[s][a]=o),o};return{ShadowMapping:{createShadowCamera:function(t,e,i){var s=pc.CLEARFLAG_DEPTH,n=e===pc.SHADOW_PCF5||e===pc.SHADOW_PCF3&&t.webgl2;i===pc.LIGHTTYPE_POINT&&(n=!1),n||(s|=pc.CLEARFLAG_COLOR);var r=new pc.Camera;return e>=pc.SHADOW_VSM8&&e<=pc.SHADOW_VSM32?(r.clearColor[0]=0,r.clearColor[1]=0,r.clearColor[2]=0,r.clearColor[3]=0):(r.clearColor[0]=1,r.clearColor[1]=1,r.clearColor[2]=1,r.clearColor[3]=1),r.clearDepth=1,r.clearFlags=s,r.clearStencil=null,r._node=new pc.GraphNode,r},createShadowMap:n,createShadowCubeMap:r,createShadowBuffer:function(t,i){var s;i._type===pc.LIGHTTYPE_POINT?(i._shadowType>pc.SHADOW_PCF3&&(i._shadowType=pc.SHADOW_PCF3),i._cacheShadowMap?(s=e[i._shadowResolution])||(s=r(t,i._shadowResolution),e[i._shadowResolution]=s):s=r(t,i._shadowResolution),i._shadowCamera.renderTarget=s[0],i._shadowCubeMap=s):(s=i._cacheShadowMap?a(t,i._shadowResolution,i._shadowType):n(t,i._shadowResolution,i._shadowResolution,i._shadowType),i._shadowCamera.renderTarget=s),i._isCachedShadowMap=i._cacheShadowMap},getShadowFormat:i,getShadowFiltering:s,getShadowMapFromCache:a,getDepthKey:function(t){var e=t.material,i=t.skinInstance?10:0,s=0;if(e.opacityMap){var n=e.opacityMapChannel;n&&(s=pc.RenderingUtils.opacityMapChannelIDs[n])}return i+s}}}}()),pc.extend(pc,function(){var t=new Float32Array(2),e={x:1,y:1,z:0,w:0};return{Vsm:{doVsm:function(i,s,n,r,a){var o=r.renderTarget,h=pc.ShadowMapping.getShadowMapFromCache(i,a._shadowResolution,a._shadowType,1),c=a._shadowType===pc.SHADOW_VSM8,l=a.vsmBlurMode,p=(c?s.blurPackedVsmShader:s.blurVsmShader)[l][n];if(!p){s.blurVsmWeights[n]=pc.Gauss.gaussWeights(n);var u=pc.shaderChunks.fullscreenQuadVS,d="#define SAMPLES "+n+"\n";d+=c?s.blurPackedVsmShaderCode[l]:s.blurVsmShaderCode[l];var _="blurVsm"+l+n+c;p=pc.shaderChunks.createShaderFromCode(s.device,u,d,_),c?s.blurPackedVsmShader[l][n]=p:s.blurVsmShader[l][n]=p}e.z=a._shadowResolution-2,e.w=e.z,s.sourceId.setValue(o.colorBuffer),t[0]=1/a._shadowResolution,t[1]=0,s.pixelOffsetId.setValue(t),l===pc.BLUR_GAUSSIAN&&s.weightId.setValue(s.blurVsmWeights[n]),pc.drawQuadWithShader(i,h,p,null,e),s.sourceId.setValue(h.colorBuffer),t[1]=t[0],t[0]=0,s.pixelOffsetId.setValue(t),pc.drawQuadWithShader(i,o,p,null,e)}}}}()),pc.extend(pc,function(){var t={radius:null,center:null},e=function(e,i){return t.center=i.center,t.radius=i.halfExtents.length(),e.containsSphere(t)};return{Culling:{cull:function(t,i,s,n){for(var r=pc.now(),a=0,o=0,h=0,c=void 0===t.cullingMask?4294967295:t.cullingMask,l=[],p=t.frustum,u=0;u<s;u++){if((_=i[u]).material&&(_._mesh._refCount!==-1/0&&_.visible))if(!_.command&&_.cull){var d=_.node.cullingLayer||0;d<0||0!=(1<<d&c)&&(l[h++]=_,_.visibleThisFrame=!0)}else l[h++]=_,_.visibleThisFrame=!0}if(!t.frustumCulling)return n.length=0,n.concat(l),h;for(u=0;u<l.length;u++){var _,f=!0;(_=l[u]).cull&&(f=e(p,_.aabb),a++),f?(n[o++]=_,_.visibleThisFrame=!0):_.visibleThisFrame=!1}return this._cullTime+=pc.now()-r,this._numDrawCallsCulled+=a,o},cullUi:function(t,i,s){for(var n=pc.now(),r=0,a=0,o=0,h=i.length,c=[],l=t.frustum,p=0;p<h;p++){(u=i[p])&&(u.material&&(u._mesh&&u._mesh._refCount===-1/0||u.visible&&(!u.command&&u.cull,c[o++]=u,u.visibleThisFrame=!0)))}if(!t.frustumCulling)return s.length=0,s.concat(c),o;for(p=0;p<c.length;p++){var u,d=!0,_=!(u=c[p])._nearestScreen;u.cull&&_&&(d=e(l,u.aabb),r++),d?(s[a++]=u,u.visibleThisFrame=!0):u.visibleThisFrame=!1}return this._cullTime+=pc.now()-n,this._numDrawCallsCulled+=r,a},reset:function(t,e){for(var i=0;i<e;i++)t[i].visibleThisFrame=!1},isAABBVisibleInFrustum:e}}}()),pc.extend(pc,function(){var t=new pc.Vec3,e=function(){this.mainLight=null,this.pixelLights=[],this.vertexLights=[],this.otherLights=[],this.allLights=[]};return Object.assign(e.prototype,{reset:function(){this.mainLight=null,this.pixelLights.length=0,this.vertexLights.length=0,this.otherLights.length=0,this.allLights.length=0},addOtherLights:function(e){for(var i=0;i<this.otherLights.length;i++){var s=this.otherLights[i];t.copy(s._directionToLight),s._type===pc.LIGHTTYPE_DIRECTIONAL?e.addDirectionalLight(t,s._color,s._intensity,1):s._type===pc.LIGHTTYPE_POINT&&e.addPointLight(t,s._color,s._intensity,s.attenuationEnd),s._type===pc.LIGHTTYPE_SPOT&&e.addSpotLight(t,s._color,s._intensity,s.attenuationEnd,s._outerConeAngle)}},combineAllLights:function(){this.allLights.length=0,this.mainLight&&this.allLights.push(this.mainLight);for(var t=0;t<this.pixelLights.length;t++)this.allLights.push(this.pixelLights[t]);for(t=0;t<this.vertexLights.length;t++)this.allLights.push(this.vertexLights[t]);for(t=0;t<this.otherLights.length;t++)this.allLights.push(this.otherLights[t])},toString:function(){return"{ "+(this.mainLight?this.mainLight._node.name:"<NONE>")+", Pixel = ["+this.pixelLights.map(t=>t._node.name).join(", ")+"], Vertex = ["+this.vertexLights.map(t=>t._node.name).join(", ")+"], SH = ["+this.otherLights.map(t=>t._node.name).join(", ")+"] }"}}),{LightData:e}}()),pc.extend(pc,function(){var t=new pc.LightData,e=new pc.KeywordSet,i=new pc.SphericalHarmonicsL2,s=new Float32Array([0,0,0,0]),n=new Float32Array(4),r=(new Float32Array(16),new Float32Array(4)),a=new Float32Array(4),o=new Float32Array(4),h=new Float32Array(4),c=new Float32Array(16),l=new Float32Array(16),p=new Float32Array(4),u=new Float32Array(4),d=new pc.KeywordSet,_=[],f=[],m=[],g=[],y=[],E=[],v={},T={},b={},A=null,S=!1;return{BuiltInForwardRenderer:{renderMeshInstance:function(t,e,i,s,n){var r=this.device,a=s.material,o=s.mesh,h=(s._shaderDefs&pc.SHADERDEF_LM)>0;if(A=i,a&&0!==s.mesh.primitive.count){a.getPass(pc.SHADER_PASS_ALWAYS,_),a.getPass(pc.SHADER_PASS_FORWARD_BASE,f),a.getPass(pc.SHADER_PASS_FORWARD_ADD,m),a.getPass(pc.SHADER_PASS_VERTEX,g),a.getPass(pc.SHADER_PASS_VERTEX_LM,y),a.getPass(pc.SHADER_PASS_GRAB_PASS,E);var c=f.length>0||m.length,l=g.length>0;if(0!=_.length||!c||!l){for(var p=0;p<E.length;p++){var d=E[p];b[d.grabPassTextureName]=d,S=!0}h&&s.configureLightmap(),u[0]=this.device.sx,u[1]=this.device.sy,u[2]=this.device.sw,u[3]=this.device.sh,r.setVertexBuffer(s.morphInstance&&s.morphInstance._vertexBuffer?s.morphInstance._vertexBuffer:o.vertexBuffer,0),r.setIndexBuffer(o.indexBuffer[0]),this.setSkinning(r,s,a),this.setMaterial(r,a),this.pushUniforms(r,s.parameters),this.setDrawCall(r,s),r.setDepthRange((s._shaderDefs&pc.SHADERDEF_RENDERTYPE_BACKGROUND)>0?1:0,1),t.merge(a.keywords),h&&t.enableKeywordId(pc.Keywords.LIGHTMAP_ON),(s._shaderDefs&pc.SHADERDEF_DIRLM)>0&&t.enableKeywordId(pc.Keywords.DIRLIGHTMAP_COMBINED);for(p=0;p<_.length;p++){var v=_[p];this.renderMeshInstancePass(v,t,s)}if(!c&&!l)return this.popUniforms(r,s.parameters),void this.setDrawCall(r,null);c?this.drawForwardPasses(f,m,s,n,t,h,e,i):this.drawVertexPasses(g,y,s,n,t,h,e,i),this.restoreScissorTest(),this.popUniforms(r,s.parameters),this.setDrawCall(r,null)}}},drawForwardPasses:function(s,n,r,a,o,h,c,l){pc.RenderingUtils.getLightsData(r,a,t),e.copy(o),!h&&c?i.copy(c):i.clear(),t.addOtherLights(i),this.dispatchLightProbe(i,e,h),this.dispatchVertexLights(t.vertexLights,e),this.dispatchMainLight(l,t.mainLight,e),this.renderMeshInstancePasses(s,e,r);for(var p=0;p<t.pixelLights.length;p++){var u=t.pixelLights[p];e.copy(o),this.dispatchMainLight(l,u,e),this.renderMeshInstancePasses(n,e,r)}},drawVertexPasses:function(i,s,n,r,a,o,h,c){pc.RenderingUtils.getLightsData(n,r,t),e.copy(a),this.dispatchVertexLights(t.allLights,e);var l=o?s:i;this.renderMeshInstancePasses(l,e,n)},renderMeshInstancePasses:function(t,e,i){for(var s=0;s<t.length;s++){var n=t[s];this.renderMeshInstancePass(n,e,i)}},renderGrabPass:function(t,e){var i=this.device,s=e.grabPassTextureName,n=this.initializeGrabPassTexture(t,s);i.setTexture(n,0),i.gl.copyTexSubImage2D(i.gl.TEXTURE_2D,0,0,0,0,0,n._width,n._height),i.scope.resolve(s).setValue(n)},initializeGrabPassTexture:function(t,e){var i=v[e],s=t?t._screenParams:[this.device.width,this.device.height];if(!i||i._width!==s[0]||i._height!==s[1]){i=new pc.Texture(this,{format:pc.PIXELFORMAT_R8_G8_B8,autoMipmap:!0,mipmaps:!1,width:s[0],height:s[1],minFilter:pc.FILTER_LINEAR,magFilter:pc.FILTER_LINEAR,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE,levels:[null]});this.device.initializeTexture(i),v[e]=i}return i},restoreScissorTest:function(){this.device.setScissor(u[0],u[1],u[2],u[3])},dispatchMainLight:function(t,e,i){e?(s.set(e._finalColor),e._type===pc.LIGHTTYPE_DIRECTIONAL?(n[0]=e._directionToLight.x,n[1]=e._directionToLight.y,n[2]=e._directionToLight.z,n[3]=0):(n[0]=e._position.x,n[1]=e._position.y,n[2]=e._position.z,n[3]=1),this.lightIds.matrix.setValue(e._worldToLightMatrix.data)):(s[0]=0,s[1]=0,s[2]=0,s[3]=0,n[0]=0,n[1]=0,n[2]=0,n[3]=0),this.lightIds.color.setValue(s),this.lightIds.position.setValue(n),e&&e._type===pc.LIGHTTYPE_POINT?e._cookie?(i.enableKeywordId(pc.Keywords.POINT_COOKIE),this.lightIds.attenuationTexture.setValue(e._cookie||UnityEngine.Texture2D.spotTexture.handle),this.lightIds.fallOffTexture.setValue(UnityEngine.Texture2D.attenuationTexture.handle)):(i.enableKeywordId(pc.Keywords.POINT),this.lightIds.attenuationTexture.setValue(UnityEngine.Texture2D.attenuationTexture.handle)):e&&e._type===pc.LIGHTTYPE_SPOT?(i.enableKeywordId(pc.Keywords.SPOT),this.lightIds.attenuationTexture.setValue(e._cookie||UnityEngine.Texture2D.spotTexture.handle),this.lightIds.fallOffTexture.setValue(UnityEngine.Texture2D.attenuationTexture.handle)):e&&e._cookie?(i.enableKeywordId(pc.Keywords.DIRECTIONAL_COOKIE),this.lightIds.attenuationTexture.setValue(e._cookie)):i.enableKeywordId(pc.Keywords.DIRECTIONAL)},dispatchVertexLights:function(t,e){if(0===t.length)e.disableKeywordId(pc.Keywords.VERTEXLIGHT_ON);else{e.enableKeywordId(pc.Keywords.VERTEXLIGHT_ON);for(var i=0;i<4;i++)if(i<t.length){var s=t[i],n=s._type===pc.LIGHTTYPE_DIRECTIONAL?s._directionToLight:s._position,p=s._finalColor,u=s._range;r[i]=n.x,a[i]=n.y,o[i]=n.z,c[4*i+0]=p[0],c[4*i+1]=p[1],c[4*i+2]=p[2],c[4*i+3]=p[3],l[4*i+0]=n.x,l[4*i+1]=n.y,l[4*i+2]=-n.z,l[4*i+3]=s._type===pc.LIGHTTYPE_DIRECTIONAL?0:1,h[i]=25/(u*u)}else r[i]=0,a[i]=0,o[i]=0,c[4*i+0]=0,c[4*i+1]=0,c[4*i+2]=0,c[4*i+3]=0,l[4*i+0]=0,l[4*i+1]=0,l[4*i+2]=0,l[4*i+3]=0,h[i]=0;this.lightIds.vertexX.setValue(r),this.lightIds.vertexY.setValue(a),this.lightIds.vertexZ.setValue(o),this.lightIds.vertexAttenuation.setValue(h),this.lightIds.vertexLightColors.setValue(c),this.lightIds.vertexLightPositions.setValue(l)}},dispatchLightProbe:function(t,e,i){if(i)e.disableKeywordId(pc.Keywords.LIGHTPROBE_SH);else{e.enableKeywordId(pc.Keywords.LIGHTPROBE_SH),t.updateUniforms();for(var s=0;s<this.unityIds.lightProbeIds.length;s++)this.unityIds.lightProbeIds[s].setValue(t.uniforms[s]._data)}},renderMeshInstancePass:function(t,e,i){var s=this.device,n=i.material,r=i.mesh;if(r&&r.indexBuffer[0]){if(window.spector&&i.node){var a=(u=i.node._unityComponents)&&u.canvasRenderer&&u.canvasRenderer[0]?u.canvasRenderer[0]._parentCanvas.entity.name:"",o=""==a?i.node.name:a+" - "+i.node.name;window.spector.setMarker(o+": "+pc.LIGHT_MODE_NAMES[t.lightMode])}t.updateRenderState(n),this.updateRenderState(i,t,e);var h=t.getVariant(e);if(h||(h=t.applyMissingVariant(e)),shader=h.getShader(i._shaderDefs),!s.setShader(shader))return shader=h.applyMissingShader(i._shaderDefs),s.setShader(shader);if(S)for(var c=0;c<shader.samplers.length;c++){var l=shader.samplers[c].scopeId.name,p=b[l];!p||"_GrabTexture"!=l&&T[l]||(this.renderGrabPass(A,p),T[l]=!0)}if(window.spector){enabledKeywords=h.keywords.getEnabledKeywords().join(" ");var u,d=(u=i.node._unityComponents)&&u.canvasRenderer&&u.canvasRenderer[0]?u.canvasRenderer[0]._parentCanvas.entity.fullname:"";shader._glProgram.__SPECTOR_Metadata={Material:"["+i.material.$id+"] "+i.material.name,Shader:"["+t.sourceShader.$id+"] "+t.sourceShader.name,RenderType:pc.RENDER_TYPE_NAMES[t.renderType],LightMode:pc.LIGHT_MODE_NAMES[t.lightMode],Keywords:0===h.keywords.cardinality?"<none>":enabledKeywords,RenderQueue:i.material.renderQueue,SortingLayerIndex:i.sortingLayerIndex,SortingOrder:i.sortingOrder,DrawOrder:i.drawOrder,ZDist:i.zdist,ParentCanvas:d}}this.drawInstance(s,i,r,0,!0)}},setMaterial:function(t,e,i){this._material&&(i||this._material!==e)&&this.popUniforms(t,this._material.parameters),(this._material!==e||i)&&this.pushUniforms(t,e.parameters),this._material=e},pushUniforms:function(t,e){for(var i in e){var s=e[i];s.scopeId||(s.scopeId=t.scope.resolve(i)),s.scopeId.pushValue(s.data)}t.scope.resolve("_ClipRect").setValue([Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY])},popUniforms:function(t,e){for(var i in e){e[i].scopeId.popValue()}},setDrawCall:function(t,e){null!==e&&(p[3]=e._flipFaces?-1:1,this.unityIds.worldTransformParamsId.setValue(p))},setPass:function(t,e){e.updateRenderState(t);var i=this.device,s=e,n=pc.RenderingUtils.unityCullModeToPlaycanvas(0|s.culling.val);i.setCullMode(n);var r=pc.RenderingUtils.unityCompareFunctionToPlaycanvas(0|s.zTest.val),a=r>=0&&r<=7,o=s.zWrite.val>0;i.setBlending(!0),i.setDepthTest(a),i.setDepthWrite(o);var h=s.offsetUnits.val,c=s.offsetFactor.val;h||c?(i.setDepthBias(!0),i.setDepthBiasValues(h,c)):i.setDepthBias(!1),this.setBlendFunctionAndEquation(s),a&&i.setDepthFunc(r);var l=s.colorWriteMask.val,p=(8&l)>0,u=(4&l)>0,_=(2&l)>0,f=(1&l)>0;i.setColorWrite(p,u,_,f);var m=this.device;d.copy(this.keywords),d.merge(t.keywords);var g=e.getVariant(d);g||(g=e.applyMissingVariant(d));var y=g.getShader(0);if(!m.setShader(y))return y=g.applyMissingShader(drawCall._shaderDefs),m.setShader(y);this.setMaterial(m,t,!0)},renderForward:function(t,e,i,s,n){var r=this.device,a=pc.now();r._enableAutoInstancing&&this.prepareAutoInstancing(e,i),T={},b={},S=!1;for(var o=0;o<i;o++){var h=e[o],c=h._lightProbe||this._ambientProbe;d.copy(this.keywords),h.isCanvas?h.render(d,c,t,h,s):this.renderMeshInstance(d,c,t,h,s)}r.updateEnd(),this._forwardTime+=pc.now()-a}}}}()),Object.assign(pc,function(){for(var t=[],e=0;e<8;e++)t.push(new pc.Vec3);var i,s,n,r=new pc.Mat4,a=new pc.Mat4,o=new pc.Mat4,h=new pc.Mat4,c=new pc.Mat4,l=new pc.Mat4,p=new pc.Mat4,u=new pc.Mat4,d=new pc.Mat4,_=[0,0,0,0],f=new Float32Array(4),m=new pc.Mat4,g=new pc.Mat4,y=[0,0],E=new Float32Array(24),v=pc.Mat4.IDENTITY.clone(),T=["unity_SHAr","unity_SHAg","unity_SHAb","unity_SHBr","unity_SHBg","unity_SHBb","unity_SHC"],b=["unity_SpecCube0","unity_SpecCube0_BoxMin","unity_SpecCube0_BoxMax","unity_SpecCube0_ProbePosition","unity_SpecCube1","unity_SpecCube1_BoxMin","unity_SpecCube1_BoxMax","unity_SpecCube1_ProbePosition"],A={min0:[-1/0,-1/0,-1/0,0],max0:[1/0,1/0,1/0,1],position0:[0,0,0,0],min1:[-1/0,-1/0,-1/0,1],max1:[1/0,1/0,1/0,1],position1:[0,0,0,0]},S=null,R=null,I=new pc.SphericalHarmonicsL2(null),C=new pc.BoundingBox,M=function(t){return!(0===t.comp.val||8===t.comp.val&&0===t.pass.val&&0===t.fail.val&&0===t.zFail.val)},O=pc.RenderingUtils.unityCompareFunctionToPlaycanvas,P=pc.RenderingUtils.unityStencilOpToPlaycanvas,x=pc.RenderingUtils.unityBlendModeToPlaycanvas,w=pc.RenderingUtils.unityCullModeToPlaycanvas,L=pc.RenderingUtils.unityBlendOpToPlaycanvas;function F(t,e){return e?"hlslcc_mtx4x4"+t+"[0]":t}function D(t){this.device=t;var e=this.device;R=new pc.StencilParameters({}),S=new pc.StencilParameters({}),this._shadowDrawCalls=0,this._forwardDrawCalls=0,this._skinDrawCalls=0,this._camerasRendered=0,this._materialSwitches=0,this._shadowMapUpdates=0,this._shadowMapTime=0,this._depthMapTime=0,this._forwardTime=0,this._cullTime=0,this._sortTime=0,this._skinTime=0,this._morphTime=0,this._instancingTime=0,this.clearMaskStencil=new pc.StencilParameters({});var i=e.getProgramLibrary();this.library=i;var s=e.scope;this.viewProjId=s.resolve("matrix_viewProjection"),this.viewInvId=s.resolve("matrix_viewInverse"),this.modelMatrixId=s.resolve("matrix_model"),this.poseMatrixId=s.resolve("matrix_pose[0]"),this.boneTextureId=s.resolve("texture_poseMap"),this.boneTextureSizeId=s.resolve("texture_poseMapSize"),this.normalMatrixId=s.resolve("matrix_normal");var n=UnityEngine.UnityVersion.IsOrNewer("2018.3");this.needsMatrixVectorization=n,this.unityIds={modelViewProjId:s.resolve(F("unity_MatrixMVP",n)),modelViewId:s.resolve(F("unity_MatrixMV",n)),viewProjId:s.resolve(F("unity_MatrixVP",n)),viewId:s.resolve(F("unity_MatrixV",n)),invViewId:s.resolve(F("unity_MatrixInvV",n)),legacyProjId:s.resolve(F("glstate_matrix_projection",n)),transposeModelViewId:s.resolve(F("unity_MatrixTMV",n)),inverseTransposeModelViewId:s.resolve(F("unity_MatrixITMV",n)),modelMatrixId:s.resolve(F("unity_ObjectToWorld",n)),modelMatrixInvId:s.resolve(F("unity_WorldToObject",n)),cameraProjectionId:s.resolve(F("unity_CameraProjection",n)),cameraInvProjectionId:s.resolve(F("unity_CameraInvProjection",n)),worldSpaceCameraPos:s.resolve("_WorldSpaceCameraPos"),projectionParamsId:s.resolve("_ProjectionParams"),screenParamsId:s.resolve("_ScreenParams"),zbufferParams:s.resolve("_ZBufferParams"),cameraOrthoParamsId:s.resolve("unity_OrthoParams"),cameraWorldClipPlanesId:s.resolve("unity_CameraWorldClipPlanes[0]"),time:s.resolve("_Time"),sinTime:s.resolve("_SinTime"),cosTime:s.resolve("_CosTime"),deltaTime:s.resolve("unity_DeltaTime"),ambientSky:s.resolve("unity_AmbientSky"),ambientEquator:s.resolve("unity_AmbientEquator"),ambientGround:s.resolve("unity_AmbientGround"),glstateLightModelAmbient:s.resolve("glstate_lightmodel_ambient"),fogParamsId:s.resolve("unity_FogParams"),fogColorId:s.resolve("unity_FogColor"),indirectSpecularId:s.resolve("unity_IndirectSpecColor"),lightProbeIds:new Array(T.length),reflectionProbeIds:new Array(b.length),worldTransformParamsId:s.resolve("unity_WorldTransformParams"),roughness:s.resolve("unity_NHxRoughness")},this.lightIds={color:s.resolve("_LightColor0"),position:s.resolve("_WorldSpaceLightPos0"),vertexX:s.resolve("unity_4LightPosX0"),vertexY:s.resolve("unity_4LightPosY0"),vertexZ:s.resolve("unity_4LightPosZ0"),vertexAttenuation:s.resolve("unity_4LightAtten0"),vertexLightColors:s.resolve("unity_LightColor[0]"),vertexLightPositions:s.resolve("unity_LightPosition[0]"),attenuationTexture:s.resolve("_LightTexture0"),fallOffTexture:s.resolve("_LightTextureB0"),matrix:s.resolve(F("unity_WorldToLight",n))};for(var r=0;r<T.length;r++)this.unityIds.lightProbeIds[r]=s.resolve(T[r]);for(r=0;r<b.length;r++)this.unityIds.reflectionProbeIds[r]=s.resolve(b[r]);this.ambientId=s.resolve("light_globalAmbient"),this.exposureId=s.resolve("exposure"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowMatrixVsId=[],this.lightShadowParamsVsId=[],this.lightDirVs=[],this.lightDirVsId=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightPosVsId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]");var a=pc.shaderChunks;this.blurVsmShaderCode=[a.blurVSMPS,"#define GAUSS\n"+a.blurVSMPS];this.blurPackedVsmShaderCode=["#define PACKED\n"+this.blurVsmShaderCode[0],"#define PACKED\n"+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.polygonOffsetId=s.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.fogColor=new Float32Array(4),this.fogParams=new Float32Array(4),this.ambientSky=new Float32Array(4),this.lightmodel_ambient=new Float32Array(4),this.removeShadows=!1,this.keywords=new pc.KeywordSet,Object.assign(this,pc.BuiltInForwardRenderer)}return Object.assign(D.prototype,{updateRenderState:function(t,e,i){var s=this.device,n=w(0|e.culling.val);t._flipFaces&&(n===pc.CULLFACE_BACK?n=pc.CULLFACE_FRONT:n===pc.CULLFACE_FRONT&&(n=pc.CULLFACE_BACK)),s.setCullMode(n);var r=O(0|e.zTest.val),a=r>=0&&r<=7,o=e.zWrite.val>0;s.setBlending(!0),s.setDepthTest(a),a&&s.setDepthFunc(r),s.setDepthWrite(o);var h=e.offsetUnits.val,c=e.offsetFactor.val;if(h||c?(s.setDepthBias(!0),s.setDepthBiasValues(h,c)):s.setDepthBias(!1),this.setBlendFunctionAndEquation(e),(t._shaderDefs&pc.SHADERDEF_REVERT_STENCIL)>0){var l=t.stencilFront.ref,p=1==l;this.clearMaskStencil.func=p?pc.FUNC_ALWAYS:pc.FUNC_EQUAL,this.clearMaskStencil.zpass=p?pc.STENCILOP_ZERO:pc.STENCILOP_REPLACE,this.clearMaskStencil.ref=l>>1,this.clearMaskStencil.readMask=p?255:l>>1,this.clearMaskStencil.writeMask=p?255:l,s.applyStencilState(this.clearMaskStencil,this.clearMaskStencil,!0)}else{var u=this.isUiStencil(t),d=M(e.stencilOp),_=M(e.stencilOpFront)||M(e.stencilOpBack);u&&t.stencilFront&&t.stencilBack?(t.node.element&&(this._materialToStencilState(t.material,t.stencilFront),this._materialToStencilState(t.material,t.stencilBack)),s.applyStencilState(t.stencilFront,t.stencilBack,!0)):d?(this._renderStateToStencilState(e,e.stencilOp,S),t.stencilFront&&(S=t.stencilFront),s.applyStencilState(S,S,!0)):_?(this._renderStateToStencilState(e,e.stencilOpFront,S),this._renderStateToStencilState(e,e.stencilOpBack,R),s.applyStencilState(S,R,!0)):s.applyStencilState(null,null,!0)}var f=t.parameters.hasOwnProperty("_ColorMask")?t.parameters._ColorMask.data:e.colorWriteMask.val;(t._shaderDefs&pc.SHADERDEF_REVERT_STENCIL)>0&&(f=0);var m=(8&f)>0,g=(4&f)>0,y=(2&f)>0,E=(1&f)>0;s.setColorWrite(m,g,y,E),t.parameters.hasOwnProperty("UNITY_UI_ALPHACLIP")&&0!=t.parameters.UNITY_UI_ALPHACLIP.data&&i.enableKeyword("UNITY_UI_ALPHACLIP")},setBlendFunctionAndEquation(t){var e=x(0|t.blending.src.val),i=x(0|t.blending.dst.val),s=L(0|t.blending.op.val),n=x(0|t.alphaBlending.src.val),r=x(0|t.alphaBlending.dst.val),a=L(0|t.alphaBlending.op.val);this.device.setBlendFunctionSeparate(e,i,n,r),this.device.setBlendEquationSeparate(s,a)},isUiStencil:function(t){return!!(t.material.parameters._Stencil&&t.material.parameters._StencilOp&&t.material.parameters._StencilComp&&t.material.parameters._StencilReadMask&&t.material.parameters._StencilWriteMask&&t.material.parameters._ColorMask)},_renderStateToStencilState:function(t,e,i){i.func=O(0|e.comp.val),i.ref=0|t.stencilRef.val,i.readMask=0|t.stencilReadMask.val,i.writeMask=0|t.stencilWriteMask.val,i.fail=P(0|e.fail.val),i.zfail=P(0|e.zFail.val),i.zpass=P(0|e.pass.val)},_materialToStencilState:function(t,e){e.func=O(0|t.parameters._StencilComp.data),e.ref=0|t.parameters._Stencil.data,e.readMask=0|t.parameters._StencilReadMask.data,e.writeMask=0|t.parameters._StencilWriteMask.data,e.fail=P(0|t.parameters._StencilZFail),e.zfail=P(0|t.parameters._StencilZPass),e.zpass=P(0|t.parameters._StencilOp.data)},updateCameraFrustum:function(t){t.updateVP(),t.frustum.update(t._projMat,t._viewMat)},setCamera:function(t,e,i,s){var n=UnityEngine.Object.FromHandle(UnityEngine.Camera,t._component);UnityEngine.Camera.TriggerOnPreRender(n),UnityEngine.Canvas.TriggerWillRenderCanvases(),t.updateVP(),a.copy(t._viewMat),r.copy(t._viewInvMat),h.copy(t._projMat),c.copy(t._projInvMat),o.copy(t._viewProjMat),this.viewInvId.setValue(r.data),this.unityIds.invViewId.setValue(r.data),this.unityIds.viewId.setValue(a.data),this.unityIds.viewProjId.setValue(o.data),this.unityIds.legacyProjId.setValue(h.data),this.unityIds.cameraProjectionId.setValue(h.data),this.unityIds.cameraInvProjectionId.setValue(c.data);for(var l=t.projection==pc.PROJECTION_ORTHOGRAPHIC?t.frustum.unityPlanesOrthographic:t.frustum.unityPlanesPerspective,p=0,u=0;p<l.length;p++,u+=4)E[u]=l[p][0],E[u+1]=l[p][1],E[u+2]=l[p][2],E[u+3]=l[p][3];this.unityIds.cameraWorldClipPlanesId.setValue(E);var d=t._node.getPosition();f[0]=d.x,f[1]=d.y,f[2]=d.z,f[3]=0,t._screenParams[0]=t.renderTarget?t.renderTarget.width:this.device.width,t._screenParams[1]=t.renderTarget?t.renderTarget.height:this.device.height,t._screenParams[2]=1+1/t._screenParams[0],t._screenParams[3]=1+1/t._screenParams[1],this.unityIds.worldSpaceCameraPos.setValue(f),this.unityIds.projectionParamsId.setValue(t._projectionParams),this.unityIds.cameraOrthoParamsId.setValue(t._orthoParams),this.unityIds.screenParamsId.setValue(t._screenParams),this.unityIds.zbufferParams.setValue(t._zbufferParams),t.frustum.update(h,a);var _=this.device;_.setRenderTarget(e),_.updateBegin();var m=t.getRect(),g=e?e.width:_.width,y=e?e.height:_.height,v=Math.floor(m.x*g),T=Math.floor(m.y*y),b=Math.floor(m.width*g),A=Math.floor(m.height*y);_.setViewport(v,T,b,A),_.setScissor(v,T,b,A),i&&_.clear(t._clearOptions),m=t._scissorRect,v=Math.floor(m.x*g),T=Math.floor(m.y*y),b=Math.floor(m.width*g),A=Math.floor(m.height*y),_.setScissor(v,T,b,A),s&&_.setScissor(1,1,g-2,y-2),this.viewProjId.setValue(o.data),UnityEngine.Camera.TriggerOnPostRender(n)},dispatchGlobalLights:function(t){if(this.ambientSky=UnityEngine.RenderSettings.ambientSkyColor.data,this.lightmodel_ambient[0]=this.ambientSky[0]/2,this.lightmodel_ambient[1]=this.ambientSky[1]/2,this.lightmodel_ambient[2]=this.ambientSky[2]/2,this.lightmodel_ambient[3]=this.ambientSky[3]/2,this.unityIds.glstateLightModelAmbient.setValue(this.lightmodel_ambient),this.unityIds.ambientSky.setValue(this.ambientSky),this.unityIds.ambientEquator.setValue(UnityEngine.RenderSettings.ambientEquatorColor.data),this.unityIds.ambientGround.setValue(UnityEngine.RenderSettings.ambientGroundColor.data),t.skyboxHelper){var e=t.skyboxHelper.indirectSpecular;this.unityIds.indirectSpecularId.setValue(e.data)}this._ambientProbe=UnityEngine.RenderSettings.ambientProbe||I;var i=UnityEngine.LightmapSettings.reflectionProbes,s=i&&i.environmentProbe?i.environmentProbe:null;null!=s?(this.unityIds.reflectionProbeIds[0].setValue(s.cubemap),this.unityIds.reflectionProbeIds[1].setValue(A.min0),this.unityIds.reflectionProbeIds[2].setValue(A.max0),this.unityIds.reflectionProbeIds[3].setValue(A.position0),this.unityIds.reflectionProbeIds[4].setValue(s.cubemap),this.unityIds.reflectionProbeIds[5].setValue(A.min1),this.unityIds.reflectionProbeIds[6].setValue(A.max1),this.unityIds.reflectionProbeIds[7].setValue(A.position1)):(this.unityIds.reflectionProbeIds[0].setValue(null),this.unityIds.reflectionProbeIds[1].setValue(pc.Vec4.ZERO.data),this.unityIds.reflectionProbeIds[2].setValue(pc.Vec4.ZERO.data),this.unityIds.reflectionProbeIds[3].setValue(pc.Vec4.ZERO.data),this.unityIds.reflectionProbeIds[4].setValue(null),this.unityIds.reflectionProbeIds[5].setValue(pc.Vec4.ZERO.data),this.unityIds.reflectionProbeIds[6].setValue(pc.Vec4.ZERO.data),this.unityIds.reflectionProbeIds[7].setValue(pc.Vec4.ZERO.data))},updateCpuSkinMatrices:function(t,e){if(0!==e){var i,s,n,r=pc.now();for(i=0;i<e;i++)if(n=t[i].skinInstance){n._dirty=!1;for(var a=0;a<n.bones.length&&(s=n.bones[a],n._dirty=s._aabbVer!=n.bonesAabbVersions[a],!n._dirty);a++);if(n._dirty){for(a=0;a<n.bones.length;a++)n.bonesAabbVersions[a]=n.bones[a];n.updateMatrices(t[i].node)}}this._skinTime+=pc.now()-r}},updateGpuSkinMatrices:function(t,e,i){var s,n,r,a,o,h=pc.now(),c=!1;for(s=0;s<e;s++)if(c=!1,(a=(r=t[s]).skinInstance)&&a._dirty){if((o=a.skin).updateWhenOffscreen)c=!0;else{var l=a.skin.rootBone?a.skin.rootBone.getWorldTransform():r.node.getWorldTransform();for(n=0;n<i.length;n++)C.center=l.transformPoint(o.localBounds.center,C.center),l.getScale(C.halfExtents),C.halfExtents.mul(o.localBounds.halfExtents),c=c||!!pc.Culling.isAABBVisibleInFrustum(i[n].frustum,C)}c&&(a.updateMatrixPalette(),a._dirty=!1)}this._skinTime+=pc.now()-h},updateMorphedBounds:function(t,e){var i,s,n=pc.now();for(i=0;i<e;i++)(s=t[i].morphInstance)&&s._dirty&&s.updateBounds(t[i].mesh);this._morphTime+=pc.now()-n},updateMorphing:function(t,e){var i,s,n=pc.now();for(i=0;i<e;i++)t[i].visibleThisFrame&&(s=t[i].morphInstance)&&s._dirty&&(s.update(t[i].mesh),s._dirty=!1);this._morphTime+=pc.now()-n},setSkinning:function(t,e){e.skinInstance&&(this._skinDrawCalls++,t.supportsBoneTextures?(i=e.skinInstance.boneTexture,this.boneTextureId.setValue(i),y[0]=i.width,y[1]=i.height,this.boneTextureSizeId.setValue(y)):this.poseMatrixId.setValue(e.skinInstance.matrixPalette))},setMatrix:function(t,e){this.device.scope.resolve(F(t,this.needsMatrixVectorization)).setValue(e)},drawInstance:function(t,e,i,r,o){var c=t.shader.uniformsUsage,_=e.node.worldTransform,f=e.node.worldTransformInverse;return e.parameters.localToWorldMatrix&&(_=m.set(e.parameters.localToWorldMatrix.data),0!=(c&pc.UNIFORMS_USAGE_MAP.unity_WorldToObject)&&(f=e.parameters.worldToLocalMatrix?g.set(e.parameters.worldToLocalMatrix.data):g.copy(_).invert())),this.modelMatrixId.setValue(_.data),this.unityIds.modelMatrixId.setValue(_.data),this.unityIds.modelMatrixInvId.setValue(f.data),0!=(c&pc.UNIFORMS_USAGE_MAP.unity_MatrixMVP)&&(l.copy(h),l.mul2(l,a),l.mul2(l,_),this.unityIds.modelViewProjId.setValue(l.data)),0!=(c&pc.UNIFORMS_USAGE_MAP.unity_MatrixMV)&&(p.copy(a),p.mul2(p,_),this.unityIds.modelViewId.setValue(p.data)),0!=(c&pc.UNIFORMS_USAGE_MAP.unity_MatrixTMV)&&(u.copy(p),u.transpose(),this.unityIds.transposeModelViewId.setValue(u.data)),0!=(c&pc.UNIFORMS_USAGE_MAP.unity_MatrixITMV)&&(0==(c&pc.UNIFORMS_USAGE_MAP.unity_MatrixTMV)&&(u.copy(p),u.transpose()),d.copy(u),d.invert(),this.unityIds.inverseTransposeModelViewId.setValue(d.data)),(s=e.instancingData)?(this._instancedDrawCalls++,this._removedByInstancing+=s.count,t.setVertexBuffer(s._buffer,1,s.offset),t.draw(i.primitive[r],s.count,e.material._shader.defaultParameters,e.constAttributes),s._buffer===pc._autoInstanceBuffer?(e.instancingData=null,s.count-1):0):(o&&(n=e.node.normalMatrix,e.node._dirtyNormal&&(_.invertTo3x3(n),n.transpose(),e.node._dirtyNormal=!1),this.normalMatrixId.setValue(n.data)),t.draw(i.primitive[r],null,e.material._shader.defaultParameters,e.constAttributes,e),0)},prepareAutoInstancing:function(t,e){var i=pc.time.now();pc._autoInstanceBuffer||this.setupInstancing(this.device);for(var s=0,n=0,r=pc._autoInstanceBufferData,a=0;a<e;a++){var o=a,h=t[a],c=h.material,l=h.mesh;if(c&&l&&c.enableAutoInstancing&&null===h.instancingData){for(endIndex=a+1;endIndex<e;endIndex++){var p=t[endIndex],u=p.material,d=p.mesh;if(u!==c||d!==l)break}if(endIndex-o>1){for(h.instancingData={count:endIndex-o,offset:4*s,_buffer:pc._autoInstanceBuffer},h._shaderDefs|=pc.SHADERDEF_INSTANCING,n=o;n<endIndex;n++){var _=t[n].node.getWorldTransform().data;r.set(_,s),s+=16}a=endIndex-1}else a=o,h._shaderDefs&=~pc.SHADERDEF_INSTANCING,h.instancingData=null}}this._instancingTime+=(pc.time.now()-i)/1e3,pc._autoInstanceBuffer.unlock()},switchRenderingToScreenSpace:function(t){if(t!==this.renderingAsScreenSpace)if(this.renderingAsScreenSpace=t,t){var e=pc.Mat4.IDENTITY.data,i=this.device;v.setOrtho(0,i._width,0,i._height,-1e3,1e3),this.unityIds.viewId.pushValue(e),this.unityIds.legacyProjId.pushValue(v.data),this.viewProjId.pushValue(v.data),this.unityIds.viewProjId.pushValue(v.data)}else this.unityIds.viewId.popValue(),this.unityIds.legacyProjId.popValue(),this.viewProjId.popValue(),this.unityIds.viewProjId.popValue()},setupInstancing:function(t){if(!pc._instanceVertexFormat){var e=[{semantic:pc.SEMANTIC_TEXCOORD2,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD3,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD4,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD5,components:4,type:pc.TYPE_FLOAT32}];pc._instanceVertexFormat=new pc.VertexFormat(t,e)}pc._autoInstanceBuffer||(pc._autoInstanceBuffer=new pc.VertexBuffer(t,pc._instanceVertexFormat,t.autoInstancingMaxObjects,pc.BUFFER_DYNAMIC),pc._autoInstanceBufferData=new Float32Array(pc._autoInstanceBuffer.lock()))},clearTarget:function(t,e){window.spector&&window.spector.setMarker("Clear RT");var i=this.device,s=i.renderTarget;i.setRenderTarget(t),i.updateBegin(),i.setColorWrite(!0,!0,!0,!0),i.setDepthWrite(!0),this.setupViewport({x:0,y:0,width:1,height:1},t.width,t.height),this.device.clear(e),i.setRenderTarget(s)},clearView:function(t,e){window.spector&&window.spector.setMarker("Clear");var i=t.camera,s=i.renderTarget,n=this.device;n.setRenderTarget(s),n.updateBegin(),n.setColorWrite(!0,!0,!0,!0),n.setDepthWrite(!0);var r=i.getRect(),a=s?s.width:n.width,o=s?s.height:n.height;this.setupViewport(r,a,o),n.clear(e||i._clearOptions)},setupViewport:function(t,e,i){var s=this.device,n=Math.floor(t.x*e),r=Math.floor(t.y*i),a=Math.floor(t.width*e),o=Math.floor(t.height*i);s.setViewport(n,r,a,o),s.setScissor(n,r,a,o)},setSceneConstants:function(){var t=this.device,e=this.scene;this.keywords.copy(pc.UnityShader.globalKeywords),this.dispatchGlobalLights(e);var i=UnityEngine.RenderSettings;i.fog&&(_[2]=0,_[3]=0,i.fogMode===UnityEngine.FogMode.Exponential?this.keywords.enableKeywordId(pc.Keywords.FOG_EXP):i.fogMode===UnityEngine.FogMode.ExponentialSquared?this.keywords.enableKeywordId(pc.Keywords.FOG_EXP2):(this.keywords.enableKeywordId(pc.Keywords.FOG_LINEAR),_[2]=-1/(i.fogEnd-i.fogStart),_[3]=i.fogEnd/(i.fogEnd-i.fogStart)),_[0]=i.fogDensity/Math.sqrt(Math.log(2)),_[1]=i.fogDensity/Math.log(2),this.unityIds.fogColorId.setValue(i.fogColor.data),this.unityIds.fogParamsId.setValue(_));var s=UnityEngine.Time.time,n=UnityEngine.Time.deltaTime,r=UnityEngine.Time.smoothDeltaTime;for(var a in this.unityIds.time.setValue([s/20,s,2*s,3*s]),this.unityIds.sinTime.setValue([Math.sin(s/8),Math.sin(s/4),Math.sin(s/2),Math.sin(s)]),this.unityIds.cosTime.setValue([Math.cos(s/8),Math.cos(s/4),Math.cos(s/2),Math.cos(s)]),this.unityIds.deltaTime.setValue([n,1/n,r,1/r]),UnityEngine.Texture2D.nhxRoughnessTexture&&this.unityIds.roughness.setValue(UnityEngine.Texture2D.nhxRoughnessTexture.handle),pc.UnityShader.globalUniforms)if(pc.UnityShader.globalUniforms.hasOwnProperty(a)){var o=pc.UnityShader.globalUniforms[a];o.scopeId=o.scopeId||t.scope.resolve(a),o.scopeId.setValue(o.value)}},renderComposition:function(){window.spector&&window.spector.clearMarker();var t=this.device,e=this.scene.getMeshInstances(),i=this.scene.meshInstancesCount;this.updateCpuSkinMatrices(e,i),this.updateMorphedBounds(e,i),this.setSceneConstants(),pc.Culling.reset(this.scene._meshInstances._list);var s=this.scene._cameras;s.sort(pc.SortUtils.cameraCompare),this.updateGpuSkinMatrices(e,i,s._list),this.updateMorphing(e,i);for(var n=0;n<s._list.length;n++)this.renderCamera(s._list[n]);var r=this.scene.overlayScreens;if(r.length>0){t.setRenderTarget(null),t.updateBegin();var a=[this.device.width,this.device.height,1+1/this.device.width,1+1/this.device.height];for(this.unityIds.screenParamsId.setValue(a),this.setupViewport({x:0,y:0,width:1,height:1},t.width,t.height),t.clear({flags:pc.CLEARFLAG_STENCIL}),this.switchRenderingToScreenSpace(!0),n=0;n<r.length;n++){r[n].canvasMeshInstance.render(this.keywords,null,null,null,null)}this.switchRenderingToScreenSpace(!1)}},updateLights:function(t,e){for(var i=[],s=0;s<e.length;s++){var n=e[s];n.update(t)&&i.push(n)}return i},setupWorldScreensVisibility:function(t,e){for(var i=t._worldScreens.list(),s=0;s<i.length;s++){var n=i[s];n.screenType==pc.SCREEN_TYPE_CAMERA?n.canvasMeshInstance.visible=n.camera===e:n.canvasMeshInstance.visible=!0}},renderCamera:function(t){var e=t.camera,i=t.camera.renderTarget,s=pc.Application.getApplication();t.frameBegin(i),this.updateCameraFrustum(t.camera);var n=[];this.scene.skyboxHelper.updateSkyDrawCall(e),this.scene.skyboxHelper.setSkyboxEnabled((e._clearOptions.flags&pc.CLEARFLAG_USE_SKYBOX)>0),UnityEngine.Camera.TriggerOnPreCull(UnityEngine.Object.FromHandle(UnityEngine.Camera,e._component)),this.setupWorldScreensVisibility(this.scene,e);const r=this.scene.getMeshInstancesCached(),a=this.scene.meshInstancesCount;pc.Culling.cull(e,r,a,n),pc.SortUtils.calculateSortDistances(n,e._node.getPosition(),e._node.forward),n.sort(pc.SortUtils.genericSort);var o=this.scene._lights._list;o=this.updateLights(e,o),this.clearView(t),this.setCamera(e,e.renderTarget),s.counters.recordDrawCalls(n.length),this.renderForward(e,n,n.length,o),t.frameEnd()}}),{ForwardRenderer:D,lightProbeUniforms:T,reflectionProbeUniforms:b}}()),Object.assign(pc,function(){var t,e,i,s,n,r=new pc.Mat4,a=new pc.Vec3,o=new pc.Quat,h=new pc.Quat,c=new pc.Vec3,l=new pc.Vec3,p=new pc.Mat4,u=function(t){this.name="string"==typeof t?t:"Untitled",this.tags=new pc.Tags(this),this._labels={},this.localPosition=new pc.Vec3(0,0,0),this.localRotation=new pc.Quat(0,0,0,1),this.localScale=new pc.Vec3(1,1,1),this.localEulerAngles=new pc.Vec3(0,0,0),this.cachedLossyScale=new pc.Vec3(1,1,1),this.position=new pc.Vec3(0,0,0),this.rotation=new pc.Quat(0,0,0,1),this.eulerAngles=new pc.Vec3(0,0,0),this.localTransform=new pc.Mat4,this._dirtyLocal=!1,this._aabbVer=0,this.worldTransform=new pc.Mat4,this.worldTransformInverse=new pc.Mat4,this._dirtyWorld=!1,this.normalMatrix=new pc.Mat3,this._dirtyNormal=!0,this._rigidbody=null,this._right=null,this._up=null,this._forward=null,this._static=!1,this._staticVersion=0,this._parent=null,this._children=[],this._graphDepth=0,this._cullingLayer=0,this.layerMask=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1,this.hasChanged=!0,this._layoutElements=[],this._layoutControllers=[],this._layoutSelfControllers=[],this._dimensionListeners=[],this._aspectRatioFitters=[],this._canvasElements=[],this._canvasGroups=[],this._meshModifiers=[],this._dirtyRect=!1,this.element=null};return Object.defineProperty(u.prototype,"static",{get:function(){return this._static},set:function(t){this._static=t}}),Object.defineProperty(u.prototype,"right",{get:function(){return this._right||(this._right=new pc.Vec3),this.getWorldTransform().getX(this._right).normalize()}}),Object.defineProperty(u.prototype,"up",{get:function(){return this._up||(this._up=new pc.Vec3),this.getWorldTransform().getY(this._up).normalize()}}),Object.defineProperty(u.prototype,"forward",{get:function(){return this._forward||(this._forward=new pc.Vec3),this.getWorldTransform().getZ(this._forward).normalize().scale(-1)},configurable:!0}),Object.defineProperty(u.prototype,"enabled",{get:function(){return this._enabled&&this._enabledInHierarchy},set:function(t){this._enabled!==t&&(this._enabled=t,this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,t))}}),Object.defineProperty(u.prototype,"parent",{get:function(){return this._parent}}),Object.defineProperty(u.prototype,"root",{get:function(){var t=this._parent;if(!t)return this;for(;t._parent;)t=t._parent;return t}}),Object.defineProperty(u.prototype,"children",{get:function(){return this._children}}),Object.defineProperty(u.prototype,"graphDepth",{get:function(){return this._graphDepth}}),Object.defineProperty(u.prototype,"cullingLayer",{get:function(){return this._cullingLayer},set:function(t){this._cullingLayer=t,this.layerMask=1<<t},configurable:!0}),Object.assign(u.prototype,{_notifyHierarchyStateChanged:function(t,e){t._onHierarchyStateChanged(e);for(var i=t._children,s=0,n=i.length;s<n;s++)i[s]._enabled&&this._notifyHierarchyStateChanged(i[s],e)},_elementDimesionsChange:function(){},_onHierarchyStateChanged:function(t){this._enabledInHierarchy=t},_cloneInternal:function(t){t.name=this.name;for(var e=this.tags._list,i=0;i<e.length;i++)t.tags.add(e[i]);t._labels=Object.assign({},this._labels),t.localPosition.copy(this.localPosition),t.localRotation.copy(this.localRotation),t.localScale.copy(this.localScale),t.localEulerAngles.copy(this.localEulerAngles),t.position.copy(this.position),t.rotation.copy(this.rotation),t.eulerAngles.copy(this.eulerAngles),t.localTransform.copy(this.localTransform),t._dirtyLocal=this._dirtyLocal,t.worldTransform.copy(this.worldTransform),t._dirtyWorld=this._dirtyWorld,t._dirtyNormal=this._dirtyNormal,t._aabbVer=this._aabbVer+1,t._enabled=this._enabled,t.scaleCompensation=this.scaleCompensation,t._enabledInHierarchy=!1},clone:function(){var t=new pc.GraphNode;return this._cloneInternal(t),t},find:function(t,e){var i,s,n=[],r=this._children.length;if(t instanceof Function){var a=t;for(i=0;i<r;i++)a(this._children[i])&&n.push(this._children[i]),(s=this._children[i].find(a)).length&&(n=n.concat(s))}else{for(this[t]&&(this[t]instanceof Function?this[t]():this[t])===e&&n.push(this),i=0;i<r;++i)(s=this._children[i].find(t,e)).length&&(n=n.concat(s))}return n},findOne:function(t,e){var i,s=this._children.length,n=null;if(t instanceof Function){var r=t;if(n=r(this))return this;for(i=0;i<s;i++)if(n=this._children[i].findOne(r))return this._children[i]}else{if(this[t]&&(this[t]instanceof Function?this[t]():this[t])===e)return this;for(i=0;i<s;i++)if(null!==(n=this._children[i].findOne(t,e)))return n}return null},findByTag:function(){var t=this.tags._processArguments(arguments);return this._findByTag(t)},_findByTag:function(t){var e,i,s=[],n=this._children.length;for(e=0;e<n;e++){var r=this._children[e];r._enabledInHierarchy&&(r.tags._has(t)&&s.push(r),(i=r._findByTag(t)).length&&(s=s.concat(i)))}return s},findByName:function(t){if(this.name===t)return this;for(var e=0;e<this._children.length;e++){var i=this._children[e].findByName(t);if(null!==i)return i}return null},findByPath:function(t){for(var e=t.split("/"),i=this,s=null,n=0,r=e.length;n<r&&i;n++){var a=e[n];s=null;for(var o=i._children,h=0,c=o.length;h<c;h++)if(o[h].name==a){s=o[h];break}i=s}return s},getPath:function(){var t=this._parent;if(t){for(var e=this.name;t&&t._parent;)e=pc.string.format("{0}/{1}",t.name,e),t=t._parent;return e}return""},getRoot:function(){var t=this._parent;if(!t)return this;for(;t._parent;)t=t._parent;return t},getParent:function(){return this._parent},isDescendantOf:function(t){for(var e=this._parent;e;){if(e===t)return!0;e=e._parent}return!1},isAncestorOf:function(t){return t.isDescendantOf(this)},getChildren:function(){return this._children},getEulerAngles:function(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles},getLocalEulerAngles:function(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles},getLocalPosition:function(){return this.localPosition},getLocalRotation:function(){return this.localRotation},getLocalScale:function(){return this.localScale},getLocalTransform:function(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform},getName:function(){return this.name},getPosition:function(){return this.getWorldTransform().getTranslation(this.position),this.position},getRotation:function(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation},getWorldTransform:function(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform},getWorldTransformInverse:function(){return this.getWorldTransform(),this.worldTransformInverse},reparent:function(t,e){this.notifyBeforeTransformParentChanged();var i=this._parent;if(this.element&&this.element._nearestScreen&&(this.element._nearestScreen.canvasMeshInstance.renderersDirty=!0),i)if(i!=t)i.removeChild(this,!0),i.notifyTransformChildrenChanged();else if(t)return void t.moveChildIndex(this,e);t&&(e>=0?t.insertChild(this,e):t.addChild(this))},setLocalEulerAngles:function(t,e,i){t instanceof pc.Vec3?this.localRotation.setFromEulerAngles(t.x,t.y,t.z):this.localRotation.setFromEulerAngles(t,e,i),this._dirtifyLocal()},setLocalPosition:function(t,e,i){if(t instanceof pc.Vec3){if(t.x==this.localPosition.x&&t.y==this.localPosition.y&&t.z==this.localPosition.z)return;this.localPosition.copy(t)}else this.localPosition.set(t,e,i);this._dirtifyLocal()},setLocalRotation:function(t,e,i,s){if(t instanceof pc.Quat){if(t.x==this.localRotation.x&&t.y==this.localRotation.y&&t.z==this.localRotation.z&&t.w==this.localRotation.w)return;this.localRotation.copy(t)}else this.localRotation.set(t,e,i,s);this._dirtifyLocal()},setLocalScale:function(t,e,i){t instanceof pc.Vec3?this.localScale.copy(t):this.localScale.set(t,e,i),this._dirtifyLocal()},setName:function(t){this.name=t},_dirtifyLocal:function(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtifyWorld()),this._onModifyTransform()},_dirtifyWorld:function(t){if(t=!!t,!this._dirtyWorld){this._dirtyWorld=!0,t||this._app.scene.addDirty(this);for(var e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorld(!0)}this._dirtyNormal=!0,this._aabbVer++},setPosition:(n=new pc.Vec3,function(t,e,i){t instanceof pc.Vec3?n.copy(t):n.set(t,e,i),null!==this.parent&&(p.copy(this._parent.getWorldTransform()).invert(),p.transformPoint(n,n)),this.setLocalPosition(n),this.getWorldTransform().getTranslation(this.position)}),setRotation:(i=new pc.Quat,s=new pc.Quat,function(t,e,n,r){if(t instanceof pc.Quat?i.copy(t):i.set(t,e,n,r),null===this._parent)this.localRotation.copy(i);else{var a=this._parent.getRotation();s.copy(a).invert(),this.localRotation.copy(s).mul(i)}this._dirtifyLocal()}),setEulerAngles:function(){var t=new pc.Quat;return function(e,i,s){if(e instanceof pc.Vec3?this.localRotation.setFromEulerAngles(e.x,e.y,e.z):this.localRotation.setFromEulerAngles(e,i,s),null!==this._parent){var n=this._parent.getRotation();t.copy(n).invert(),this.localRotation.mul2(t,this.localRotation)}this._dirtifyLocal()}}(),addChild:function(t){if(null!==t._parent)throw new Error("GraphNode is already parented");this._children.push(t),this._onInsertChild(t)},addChildAndSaveTransform:function(t){var e=t.getPosition(),i=t.getRotation(),s=t._parent;s&&s.removeChild(t),void 0===this.tmpMat4&&(this.tmpMat4=new pc.Mat4,this.tmpQuat=new pc.Quat),t.setPosition(this.tmpMat4.copy(this.worldTransform).invert().transformPoint(e)),t.setRotation(this.tmpQuat.copy(this.getRotation()).invert().mul(i)),this._children.push(t),this._onInsertChild(t)},insertChild:function(t,e){if(null!==t._parent)throw new Error("GraphNode is already parented");this._children.splice(e,0,t),this._onInsertChild(t)},moveChildIndex:function(t,e){if(e<0){let e=this._children.indexOf(t);this._children.push(this._children.splice(e,1)[0])}else{let i=this._children.indexOf(t);this._children.splice(i,1),this._children.splice(e,0,t)}t._dirtifyWorld(),this.element&&this.element.triggerOnElementDimesionsChange(!0,!0)},setupCanvasGroups:function(t){for(var e=t.parent;e&&e.element&&0==t._parent.element._canvasGroups.length;)e=e.parent;e&&e.element&&t._parent.element._canvasGroups.length>0&&(t.element._canvasGroups=t._parent.element._canvasGroups.slice()),this.setupCanvasGroupsInChildren(t,t.element._canvasGroups)},setupCanvasGroupsInChildren(t,e){if(t.element){t.element._canvasGroups=e.slice();for(var i=0;i<t._canvasGroups.length;i++)t.element._canvasGroups.unshift(t._canvasGroups[i]);for(i=0;i<t.children.length;i++)this.setupCanvasGroupsInChildren(t.children[i],t.element._canvasGroups)}},notifyScreenHierarchyChanged:function(){var t=pc.UIUtils.findParentScreen(this.parent);this.notifyScreenChanged(t),this.tryReparentScreen(t,this.children)},tryReparentScreen(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.screen?s.screen.setParentScreen(t,!0):s.tryReparentScreen(t,s.children)}},_onInsertChild:function(t){t._parent=this,t.element&&(this.setupCanvasGroups(t),t.notifyCanvasGroupChanged(t)),t.notifyScreenHierarchyChanged();var e=t._enabled&&this.enabled;if(t._enabledInHierarchy!==e&&(t._enabledInHierarchy=e,t._notifyHierarchyStateChanged(t,e)),t._updateGraphDepth(),t._dirtifyWorld(),t.fire&&t.fire("insert",this),this.fire&&this.fire("childinsert",t),!t.element)for(var i=0;i<t._children.length;i++){var s=t._children[i].element;s&&s._onInsert(t)}this.notifyTransformChildrenChanged(),t.notifyTransformParentChanged()},_onModifyTransform:function(){},_updateGraphDepth:function(){this._parent?this._graphDepth=this._parent._graphDepth+1:this._graphDepth=0;for(var t=0,e=this._children.length;t<e;t++)this._children[t]._updateGraphDepth()},removeChild:function(t,e){var i,s=this._children.length;for(t.notifyScreenHierarchyChanged(),e||t._notifyHierarchyStateChanged(t,!1),i=0;i<s;++i)if(this._children[i]===t)return this._children.splice(i,1),t._parent=null,this.fire&&this.fire("childremove",t),void t.notifyScreenHierarchyChanged()},addLabel:function(t){this._labels[t]=!0},getLabels:function(){return Object.keys(this._labels)},hasLabel:function(t){return!!this._labels[t]},removeLabel:function(t){delete this._labels[t]},findByLabel:function(t,e){var i,s=this._children.length;for(e=e||[],this.hasLabel(t)&&e.push(this),i=0;i<s;++i)e=this._children[i].findByLabel(t,e);return e},_sync:function(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var t,e=this._parent,i=this.localScale,s=e;if(s){for(;s&&s.scaleCompensation;)s=s._parent;s&&(s=s._parent)&&(t=s.worldTransform.getScale(),c.mul2(t,this.localScale),i=c)}h.setFromMat4(e.worldTransform),o.mul2(h,this.localRotation);var n=e.worldTransform;e.scaleCompensation&&(l.mul2(t,e.getLocalScale()),r.setTRS(e.worldTransform.getTranslation(a),h,l),n=r),n.transformPoint(this.localPosition,a),this.worldTransform.setTRS(a,o,i)}else this.worldTransform.mul2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1,this.calculateLossyScale(this.cachedLossyScale)}},syncHierarchy:function(){if(this.enabled){this._sync();for(var t=this._children,e=0,i=t.length;e<i;e++)t[e].syncHierarchy()}},lookAt:function(){var t=new pc.Mat4,e=new pc.Vec3,i=new pc.Vec3,s=new pc.Quat;return function(n,r,a,o,h,c){if(n instanceof pc.Vec3)e.copy(n),r instanceof pc.Vec3?i.copy(r):i.copy(pc.Vec3.UP);else{if(void 0===a)return;e.set(n,r,a),void 0!==o?i.set(o,h,c):i.copy(pc.Vec3.UP)}t.setLookAt(this.getPosition(),e,i),s.setFromMat4(t),this.setRotation(s)}}(),translate:(e=new pc.Vec3,function(t,i,s){t instanceof pc.Vec3?e.copy(t):e.set(t,i,s),e.add(this.getPosition()),this.setPosition(e)}),translateLocal:function(){var t=new pc.Vec3;return function(e,i,s){e instanceof pc.Vec3?t.copy(e):t.set(e,i,s),this.localRotation.transformVector(t,t),this.localPosition.add(t),this._dirtifyLocal()}}(),rotate:function(){var t=new pc.Quat,e=new pc.Quat;return function(i,s,n){if(i instanceof pc.Vec3?t.setFromEulerAngles(i.x,i.y,i.z):t.setFromEulerAngles(i,s,n),null===this._parent)this.localRotation.mul2(t,this.localRotation);else{var r=this.getRotation(),a=this._parent.getRotation();e.copy(a).invert(),t.mul2(e,t),this.localRotation.mul2(t,r)}this._dirtifyLocal()}}(),rotateLocal:(t=new pc.Quat,function(e,i,s){e instanceof pc.Vec3?t.setFromEulerAngles(e.x,e.y,e.z):t.setFromEulerAngles(e,i,s),this.localRotation.mul(t),this._dirtifyLocal()})}),u.prototype.notifyCanvasGroupChanged=function(t){if(!this.isPrefab){for(var e=t._unityComponents.monoBehaviour,i=t._unityComponents.canvasRenderer[0],s=0;s<e.length;s++){e[s].onCanvasGroupChanged()}i&&i.onCanvasGroupChanged();var n=t.children;for(s=0;s<n.length;s++)this.notifyCanvasGroupChanged(n[s])}},u.prototype.notifyScreenChanged=function(t){if(!this.isPrefab){this.screen&&(t=this.screen);var e=this._unityComponents.canvasRenderer[0];e&&e.onScreenChanged(t);for(var i=this.children,s=0;s<i.length;s++)i[s].notifyScreenChanged(t)}},u.prototype.notifyBeforeTransformParentChanged=function(){if(!this.isPrefab)for(var t=this._unityComponents.monoBehaviour,e=0;e<t.length;e++){t[e].onBeforeTransformParentChanged()}},u.prototype.notifyTransformParentChanged=function(){if(!this.isPrefab)for(var t=this._unityComponents.monoBehaviour,e=0;e<t.length;e++){t[e].onTransformParentChanged()}},u.prototype.notifyTransformChildrenChanged=function(){if(!this.isPrefab)for(var t=this._unityComponents.monoBehaviour,e=0;e<t.length;e++){t[e].onTransformChildrenChanged()}},Object.defineProperty(u.prototype,"fullname",{get:function(){return this.parents().map(t=>t.name).reverse().splice(1).join("/")+"/"+this.name}}),{GraphNode:u}}()),Object.assign(pc,function(){var t=new pc.Vec3,e=new pc.Vec3,i=new pc.Vec3,s=new pc.Vec3,n=function(){this._projection=pc.PROJECTION_PERSPECTIVE,this._nearClip=.1,this._farClip=1e4,this._fov=45,this._orthoHeight=10,this._aspect=16/9,this._aspectRatioMode=pc.ASPECT_AUTO,this._horizontalFov=!1,this.frustumCulling=!1,this.cullingMask=4294967295,this._renderDepthRequests=0,this._projMatDirty=!0,this._vpDirty=!0,this._vMatrixVersion=-1,this._projMat=new pc.Mat4,this._projInvMat=new pc.Mat4,this._viewMat=new pc.Mat4,this._viewInvMat=new pc.Mat4,this._viewProjMat=new pc.Mat4,this._invViewProjMat=new pc.Mat4,this._projMatOverride=null,this.vrDisplay=null,this._rect={x:0,y:0,width:1,height:1},this._scissorRect={x:0,y:0,width:1,height:1},this.frustum=new pc.Frustum(this._projMat,this._viewMat),this.renderTarget=null,this._depthTarget=null,this._clearOptions={color:[.5,.5,.5,1],depth:1,stencil:0,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH|pc.CLEARFLAG_STENCIL|pc.CLEARFLAG_USE_SKYBOX},this._node=null,this.calculateTransform=null,this.overrideCalculateTransform=!1,this.calculateProjection=null,this.overrideCalculateProjection=!1,this._cullFaces=!0,this._component=null,this._shaderParams=new Float32Array(4),this._zbufferParams=new Float32Array(4),this._screenParams=new Float32Array(4),this._orthoParams=new Float32Array(4),this._projectionParams=new Float32Array(4)};return n.CameraDefaults={frustumCulling:!0},Object.assign(n.prototype,{clone:function(){var t=new pc.Camera;return t.projection=this._projection,t.nearClip=this._nearClip,t.farClip=this._farClip,t._shaderParams=this._shaderParams.slice(),t.fov=this._fov,t.aspectRatio=this._aspect,t._aspectRatioMode=this._aspectRatioMode,t.renderTarget=this.renderTarget,t.setClearOptions(this.getClearOptions()),t.frustumCulling=this.frustumCulling,t.cullingMask=this.cullingMask,t},worldToScreen:function(t,e,i,n){return void 0===n&&(n=new pc.Vec3),this.updateVP(),this._viewProjMat.multiplyPoint(t,n),n.x=.5*(n.x+1)*e,n.y=.5*(n.y+1)*i,s.sub2(t,this._node.getPosition()),n.z=s.dot(this._node.forward),n},screenToWorld:function(s,n,r,a,o,h){void 0===h&&(h=new pc.Vec3),this.updateVP();var c=this._node.getPosition();if(this._projection===pc.PROJECTION_PERSPECTIVE){e.set(s/a*2-1,n/o*2-1,1),this._invViewProjMat.transformPoint(e,i);var l=e.x*this._invViewProjMat.data[3]+e.y*this._invViewProjMat.data[7]+e.z*this._invViewProjMat.data[11]+this._invViewProjMat.data[15];i.scale(1/l);var p=r/this._farClip;h.lerp(c,i,p)}else{var u=this._farClip-this._nearClip;t.set(s/a,n/o,(r-this._nearClip)/u),t.scale(2),t.sub(pc.Vec3.ONE),this._invViewProjMat.transformPoint(t,h)}return h},getClearOptions:function(){return this._clearOptions},getProjectionMatrix:function(){return this._projMatDirty&&this.resetProjectionMatrix(),this._projMat},getRect:function(){return this._rect},setClearOptions:function(t){this._clearOptions.color[0]=t.color[0],this._clearOptions.color[1]=t.color[1],this._clearOptions.color[2]=t.color[2],this._clearOptions.color[3]=t.color[3],this._clearOptions.depth=t.depth,this._clearOptions.stencil=t.stencil,this._clearOptions.flags=t.flags},setRect:function(t,e,i,s){this._rect.x=t,this._rect.y=e,this._rect.width=i,this._rect.height=s,this._projMatDirty=!0,this._vpDirty=!0},setScissorRect:function(t,e,i,s){this._scissorRect.x=t,this._scissorRect.y=e,this._scissorRect.width=i,this._scissorRect.height=s},requestDepthMap:function(){this._renderDepthRequests++},releaseDepthMap:function(){this._renderDepthRequests--},resetProjectionMatrix:function(){if(this._projection===pc.PROJECTION_PERSPECTIVE)this._projMat.setPerspective(this._fov,this._aspect,this._nearClip,this._farClip,this._horizontalFov);else{var t=this._orthoHeight,e=t*this._aspect;this._projMat.setOrtho(-e,e,-t,t,this._nearClip,this._farClip)}var i=this._nearClip,s=this._farClip;this._shaderParams[0]=1/s,this._shaderParams[1]=s,this._shaderParams[2]=(1-s/i)/2,this._shaderParams[3]=(1+s/i)/2,this._projMatOverride=null,this._projMatDirty=!1,this._vpDirty=!0},updateVP:function(){var t=this._node;if(this._vMatrixVersion=t.aabbVersion,this._vpDirty=!1,this.overrideCalculateTransform)this.calculateTransform(this._viewInvMat,pc.VIEW_CENTER);else{var e=t.getPosition(),i=t.getRotation();this._viewInvMat.setTRS(e,i,pc.Vec3.REVERSED_Z)}this._viewMat.copy(this._viewInvMat).invert(),this.overrideCalculateProjection?this.calculateProjection(this._projMat,pc.VIEW_CENTER):this.getProjectionMatrix(),this._projInvMat.copy(this._projMat).invert(),this._viewProjMat.mul2(this._projMat,this._viewMat),this._invViewProjMat.copy(this._viewProjMat).invert();var s=t.getLossyScale();0!==s.x&&0!==s.y&&0!==s.z||console.warn("Camera world transform matrix has 0 scale. That leads to losing rotation data")}}),Object.defineProperty(n.prototype,"aspectRatio",{get:function(){return this._aspect},set:function(t){this._aspect!==t&&(this._aspect=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"projection",{get:function(){return this._projection},set:function(t){this._projection!==t&&(this._projection=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"nearClip",{get:function(){return this._nearClip},set:function(t){this._nearClip!==t&&(this._nearClip=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"farClip",{get:function(){return this._farClip},set:function(t){this._farClip!==t&&(this._farClip=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"fov",{get:function(){return this._fov},set:function(t){this._fov!==t&&(this._fov=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"horizontalFov",{get:function(){return this._horizontalFov},set:function(t){this._horizontalFov!==t&&(this._horizontalFov=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"orthoHeight",{get:function(){return this._orthoHeight},set:function(t){this._orthoHeight!==t&&(this._orthoHeight=t,this._projMatDirty=!0)}}),Object.defineProperty(n.prototype,"clearColor",{get:function(){return this._clearOptions.color},set:function(t){this._clearOptions.color[0]=t[0],this._clearOptions.color[1]=t[1],this._clearOptions.color[2]=t[2],this._clearOptions.color[3]=t[3]}}),Object.defineProperty(n.prototype,"clearDepth",{get:function(){return this._clearOptions.depth},set:function(t){this._clearOptions.depth=t}}),Object.defineProperty(n.prototype,"clearSkybox",{get:function(){return this._clearOptions.skybox},set:function(t){this._clearOptions.skybox=t}}),Object.defineProperty(n.prototype,"clearStencil",{get:function(){return this._clearOptions.stencil},set:function(t){this._clearOptions.stencil=t}}),Object.defineProperty(n.prototype,"clearFlags",{get:function(){return this._clearOptions.flags},set:function(t){this._clearOptions.flags=t}}),{Camera:n}}()),Object.assign(pc,function(){var t=new pc.Vec3,e=new pc.Vec3,i=new pc.Vec3,s=new pc.Mat4,n=new pc.Mat4,r=new pc.Mat4,a=(new pc.Mat4).setTRS(new pc.Vec3(-.5,-.5,0),pc.Quat.IDENTITY,pc.Vec3.ONE),o={r:0,g:1,b:2,a:3},h=0,c=function(){this.id=h++,this._type=pc.LIGHTTYPE_DIRECTIONAL,this._color=new pc.Color(.8,.8,.8),this._intensity=1,this._castShadows=!1,this._enabled=!1,this._mask=1,this._cullingMask=-1,this._renderMode=0,this._nodeAabbVer=0,this.isStatic=!1,this.key=0,this.bakeDir=!0,this._aabb=new pc.BoundingBox,this._cameraAABB=new pc.BoundingBox,this._scissor=new Float32Array(4),this._scissorSize=new pc.Vec3,this.attenuationStart=10,this._attenuationEnd=10,this._falloffMode=0,this._shadowType=pc.SHADOW_PCF3,this._vsmBlurSize=11,this.vsmBlurMode=pc.BLUR_GAUSSIAN,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._cookieScale=new pc.Vec2(1,1),this._innerConeAngle=40,this._outerConeAngle=45,this._finalColor=new Float32Array([.8,.8,.8,1]);var t=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([t,t,t,t]),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180),this._shadowCamera=null,this._shadowMatrix=new pc.Mat4,this._worldToLightMatrix=new pc.Mat4,this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this._normalOffsetBias=0,this.shadowUpdateMode=pc.SHADOWUPDATE_REALTIME,this._scene=null,this._node=null,this._rendererParams=[],this._isVsm=!1,this._isPcf=!0,this._cacheShadowMap=!1,this._isCachedShadowMap=!1,this._luminance=0,this._effectiveIntensity=0,this._priority=0,this._directionToLight=new pc.Vec3,this._position=new pc.Vec3,this._visibleLength=[0],this._visibleList=[[]],this._visibleCameraSettings=[]};return c.LightDefaults={type:"point",color:new pc.Color(1,1,1,1),cookieScale:pc.Vec2.ONE,intensity:1,range:10,cullingMask:-1},Object.assign(c.prototype,{destroy:function(){this._destroyShadowMap()},update:function(t){if(!this._node)return!1;if(this._nodeAabbVer===this._node.aabbVersion)return pc.Culling.isAABBVisibleInFrustum(t.frustum,this._aabb);var e=this._node.worldTransformInverse,o=1/this._attenuationEnd;return this._position.copy(this._node.getPosition()),this._type===pc.LIGHTTYPE_POINT?(this._worldToLightMatrix.copy(e).scale(o),this._worldToLightMatrix.data[15]=1):this._type===pc.LIGHTTYPE_SPOT?(s.setIdentity(),s.data[11]=2*Math.tan(pc.math.DEG_TO_RAD*this._outerConeAngle*.5),s.data[15]=0,n.setScale(o,o,o),n.data[15]=o,this._worldToLightMatrix.mul2(n,s),this._worldToLightMatrix.mul2(this._worldToLightMatrix,e)):(i.set(this._cookieScale.x,this._cookieScale.x,this._cookieScale.x),r.setTRS(this._node.getPosition(),this._node.getRotation(),i),this._worldToLightMatrix.mul2(r,a).invert(),this._worldToLightMatrix.data[2]=0,this._worldToLightMatrix.data[6]=0,this._worldToLightMatrix.data[10]=0,this._worldToLightMatrix.data[14]=0,this._directionToLight.copy(this._node.forward).scale(-1)),this._nodeAabbVer=this._node.aabbVersion,this.getBoundingBox(this._aabb),pc.Culling.isAABBVisibleInFrustum(t.frustum,this._aabb)},clone:function(){var t=new pc.Light;return t.type=this._type,t.setColor(this._color),t.intensity=this._intensity,t.castShadows=this.castShadows,t.enabled=this._enabled,t.attenuationStart=this.attenuationStart,t.attenuationEnd=this.attenuationEnd,t.falloffMode=this._falloffMode,t.shadowType=this._shadowType,t.vsmBlurSize=this._vsmBlurSize,t.vsmBlurMode=this.vsmBlurMode,t.vsmBias=this.vsmBias,t.shadowUpdateMode=this.shadowUpdateMode,t.mask=this._mask,t.innerConeAngle=this._innerConeAngle,t.outerConeAngle=this._outerConeAngle,t.shadowBias=this.shadowBias,t.normalOffsetBias=this._normalOffsetBias,t.shadowResolution=this._shadowResolution,t.shadowDistance=this.shadowDistance,t.cullingMask=this.cullingMask,t.cookie=this._cookie,t},getColor:function(){return this._color},getBoundingSphere:function(s){if(this._type===pc.LIGHTTYPE_SPOT){var n=this.attenuationEnd,r=this._outerConeAngle,a=Math.cos(r*pc.math.DEG_TO_RAD),o=this._node;t.copy(o.up),t.scale(.5*-n*a),t.add(o.getPosition()),s.center=t,e.copy(o.up),e.scale(-n),i.copy(o.right),i.scale(Math.sin(r*pc.math.DEG_TO_RAD)*n),e.add(i),s.radius=.5*e.length()}else this._type===pc.LIGHTTYPE_POINT?(s.center=this._node.getPosition(),s.radius=this.attenuationEnd):this._type===pc.LIGHTTYPE_DIRECTIONAL&&(s.center=this._node.getPosition(),s.radius=1/0)},getBoundingBox:function(t){if(this._type===pc.LIGHTTYPE_SPOT){var e=this.attenuationEnd,i=this._outerConeAngle,s=this._node,n=Math.abs(Math.tan(i*pc.math.DEG_TO_RAD*.5)*e);t.center.set(0,0,.5*e),t.halfExtents.set(n,n,.5*e),t.setFromTransformedAabb(t,s.getWorldTransform())}else this._type===pc.LIGHTTYPE_POINT?(t.center.copy(this._node.getPosition()),t.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd)):this._type===pc.LIGHTTYPE_DIRECTIONAL&&(t.center.copy(this._node.getPosition()),t.halfExtents.set(1/0,1/0,1/0))},_updateFinalColor:function(){var t=this._color,e=t.r,i=t.g,s=t.b,n=t.a,r=this._intensity,a=this._finalColor,o=this._linearFinalColor;a[0]=e*r,a[1]=i*r,a[2]=s*r,a[3]=n*r,r>=1?(o[0]=Math.pow(e,2.2)*r,o[1]=Math.pow(i,2.2)*r,o[2]=Math.pow(s,2.2)*r,o[3]=Math.pow(n,2.2)*r):(o[0]=Math.pow(a[0],2.2),o[1]=Math.pow(a[1],2.2),o[2]=Math.pow(a[2],2.2),o[3]=Math.pow(a[3],2.2)),this._luminance=(.3*e+.59*i+.11*s)*r},setColor:function(){var t,e,i;1===arguments.length?(t=arguments[0].r,e=arguments[0].g,i=arguments[0].b):3===arguments.length&&(t=arguments[0],e=arguments[1],i=arguments[2]),this._color.set(t,e,i),this._updateFinalColor()},_destroyShadowMap:function(){if(this._shadowCamera){if(!this._isCachedShadowMap){var t,e=this._shadowCamera.renderTarget;if(e)if(e.length)for(t=0;t<e.length;t++)e[t].colorBuffer&&e[t].colorBuffer.destroy(),e[t].destroy();else e.colorBuffer&&e.colorBuffer.destroy(),e.depthBuffer&&e.depthBuffer.destroy(),e.destroy()}this._shadowCamera.renderTarget=null,this._shadowCamera=null,this._shadowCubeMap=null,this.shadowUpdateMode===pc.SHADOWUPDATE_NONE&&(this.shadowUpdateMode=pc.SHADOWUPDATE_THISFRAME)}},updateShadow:function(){this.shadowUpdateMode!==pc.SHADOWUPDATE_REALTIME&&(this.shadowUpdateMode=pc.SHADOWUPDATE_THISFRAME)},updateKey:function(){var t=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|o[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12;3===this._cookieChannel.length&&(t|=o[this._cookieChannel.charAt(1)]<<16,t|=o[this._cookieChannel.charAt(2)]<<14),this.key=t}}),Object.defineProperty(c.prototype,"enabled",{get:function(){return this._type},set:function(t){this._type!==t&&(this._enabled=t)}}),Object.defineProperty(c.prototype,"type",{get:function(){return this._type},set:function(t){if(this._type!==t){this._type=t,this._destroyShadowMap(),this.updateKey();var e=this._shadowType;this._shadowType=null,this.shadowType=e}}}),Object.defineProperty(c.prototype,"mask",{get:function(){return this._mask},set:function(t){this._mask!==t&&(this._mask=t)}}),Object.defineProperty(c.prototype,"renderMode",{get:function(){return this._renderMode},set:function(t){this._renderMode!==t&&(this._renderMode=t)}}),Object.defineProperty(c.prototype,"cullingMask",{get:function(){return this._cullingMask},set:function(t){this._cullingMask!==t&&(this._cullingMask=t)}}),Object.defineProperty(c.prototype,"shadowType",{get:function(){return this._shadowType},set:function(t){if(this._shadowType!==t){var e=pc.Application.getApplication().graphicsDevice;this._type===pc.LIGHTTYPE_POINT&&(t=pc.SHADOW_PCF3),t!==pc.SHADOW_PCF5||e.webgl2||(t=pc.SHADOW_PCF3),t!==pc.SHADOW_VSM32||e.textureFloatRenderable||(t=pc.SHADOW_VSM16),t!==pc.SHADOW_VSM16||e.textureHalfFloatRenderable||(t=pc.SHADOW_VSM8),this._isVsm=t>=pc.SHADOW_VSM8&&t<=pc.SHADOW_VSM32,this._isPcf=t===pc.SHADOW_PCF5||t===pc.SHADOW_PCF3,this._shadowType=t,this._destroyShadowMap(),this.updateKey()}}}),Object.defineProperty(c.prototype,"castShadows",{get:function(){return this._castShadows&&this._mask!==pc.MASK_LIGHTMAP&&0!==this._mask},set:function(t){this._castShadows!==t&&(this._castShadows=t,this.updateKey())}}),Object.defineProperty(c.prototype,"shadowResolution",{get:function(){return this._shadowResolution},set:function(t){if(this._shadowResolution!==t){var e=pc.Application.getApplication().graphicsDevice;t=this._type===pc.LIGHTTYPE_POINT?Math.min(t,e.maxCubeMapSize):Math.min(t,e.maxTextureSize),this._shadowResolution=t}}}),Object.defineProperty(c.prototype,"vsmBlurSize",{get:function(){return this._vsmBlurSize},set:function(t){this._vsmBlurSize!==t&&(t%2==0&&t++,this._vsmBlurSize=t)}}),Object.defineProperty(c.prototype,"normalOffsetBias",{get:function(){return this._normalOffsetBias},set:function(t){this._normalOffsetBias!==t&&((!this._normalOffsetBias&&t||this._normalOffsetBias&&!t)&&this.updateKey(),this._normalOffsetBias=t)}}),Object.defineProperty(c.prototype,"falloffMode",{get:function(){return this._falloffMode},set:function(t){this._falloffMode!==t&&(this._falloffMode=t,this.updateKey())}}),Object.defineProperty(c.prototype,"innerConeAngle",{get:function(){return this._innerConeAngle},set:function(t){this._innerConeAngle!==t&&(this._innerConeAngle=t,this._innerConeAngleCos=Math.cos(t*Math.PI/180))}}),Object.defineProperty(c.prototype,"outerConeAngle",{get:function(){return this._outerConeAngle},set:function(t){this._outerConeAngle!==t&&(this._outerConeAngle=t,this._outerConeAngleCos=Math.cos(t*Math.PI/180),this._nodeAabbVer=-1)}}),Object.defineProperty(c.prototype,"intensity",{get:function(){return this._intensity},set:function(t){this._intensity!==t&&(this._intensity=t,this._updateFinalColor())}}),Object.defineProperty(c.prototype,"cookie",{get:function(){return this._cookie},set:function(t){this._cookie!==t&&(this._cookie=t,this.updateKey())}}),Object.defineProperty(c.prototype,"cookieScale",{get:function(){return this._cookieScale},set:function(t){this._cookieScale=t,this._nodeAabbVer=-1}}),Object.defineProperty(c.prototype,"attenuationEnd",{get:function(){return this._attenuationEnd},set:function(t){this._attenuationEnd=t,this._nodeAabbVer=-1}}),Object.defineProperty(c.prototype,"cookieFalloff",{get:function(){return this._cookieFalloff},set:function(t){this._cookieFalloff!==t&&(this._cookieFalloff=t,this.updateKey())}}),Object.defineProperty(c.prototype,"cookieChannel",{get:function(){return this._cookieChannel},set:function(t){if(this._cookieChannel!==t){if(t.length<3)for(var e=t.charAt(t.length-1),i=3-t.length,s=0;s<i;s++)t+=e;this._cookieChannel=t,this.updateKey()}}}),Object.defineProperty(c.prototype,"cookieTransform",{get:function(){return this._cookieTransform},set:function(t){this._cookieTransform!==t&&(this._cookieTransform=t,this._cookieTransformSet=!!t,t&&!this._cookieOffset&&(this.cookieOffset=new pc.Vec2,this._cookieOffsetSet=!1),this.updateKey())}}),Object.defineProperty(c.prototype,"cookieOffset",{get:function(){return this._cookieOffset},set:function(t){this._cookieOffset!==t&&(!(!this._cookieTransformSet&&!t)&&!t&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=t,this._cookieOffsetSet=!!t,t&&!this._cookieTransform&&(this.cookieTransform=new pc.Vec4(1,1,0,0),this._cookieTransformSet=!1),this.updateKey())}}),{Light:c}}()),Object.assign(pc,function(){var t=0,e=function(){this.name="Untitled",this.id=t++,this._shader=null,this.parameters={},this.meshInstances=[],this._shaderVersion=0,this._scene=null,this._dirtyBlend=!1,this.dirty=!0,this.enableAutoInstancing=!1};Object.defineProperty(e.prototype,"shader",{get:function(){return this._shader},set:function(t){this._shader&&this._shader._refCount--,this._shader=t,t&&t._refCount++}}),e.prototype._cloneInternal=function(t){t.name=this.name,t.shader=this.shader;var e={};for(var i in this.parameters)e[i]=Object.assign({},this.parameters[i]);t.parameters=e},e.prototype.clone=function(){var t=new pc.Material;return this._cloneInternal(t),t},e.prototype._updateMeshInstanceKeys=function(){var t,e=this.meshInstances;for(t=0;t<e.length;t++)e[t].updateKey()},e.prototype.updateUniforms=function(){},e.prototype.updateShader=function(t,e,i){},e.prototype.update=function(){this.dirty=!0},e.prototype.clearParameters=function(){this.parameters={}},e.prototype.getParameters=function(){return this.parameters},e.prototype.getParameter=function(t){var e=this.parameters[t];return e?e.data:null};var i=function(t,e,i){this.scopeId=t,this.data=e,this.passFlags=i};return e.prototype.setParameter=function(t,e,s){if(void 0===s&&(s=-524285),void 0===e&&"object"==typeof t){var n=t;if(n.length){for(var r=0;r<n.length;r++)this.setParameter(n[r]);return}t=n.name,e=n.value}var a=this.parameters[t];a?(a.data=e,a.passFlags=s):this.parameters[t]=new i(null,e,s)},e.prototype.deleteParameter=function(t){this.parameters[t]&&delete this.parameters[t]},e.prototype.setParameters=function(){for(var t in this.parameters){var e=this.parameters[t];e.scopeId.setValue(e.data)}},e.prototype.update=function(){},e.prototype.init=function(t){throw Error("Not Implemented in base class")},e.prototype.getName=function(){return this.name},e.prototype.setName=function(t){this.name=t},e.prototype.getShader=function(){return this.shader},e.prototype.setShader=function(t){this._shader&&this._shader._refCount--,this._shader=t,t&&t._refCount++},e.prototype.destroy=function(){var t,e,i;for(var s in this.shader&&(this.shader._refCount--,this.shader._refCount<1&&this.shader.destroy()),this.variants)if(this.variants.hasOwnProperty(s)){if((t=this.variants[s])===this.shader)continue;t._refCount--,t._refCount<1&&t.destroy()}this.variants={},this.shader=null;for(var n=0;n<this.meshInstances.length;n++){for(e=this.meshInstances[n],i=0;i<e._shader.length;i++)e._shader[i]=null;e._material=null;var r=pc.getDefaultMaterial();this!==r&&(e.material=r)}},{Material:e}}()),Object.assign(pc,function(){var t=new pc.BoundingBox,e=function(t){this.name="",this._refCount=0,this.id=e.id++,this.vertexBuffer=t?null:this.defaultVertexBuffer(this.defaultStreams,0,new Float32Array),this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this.skin=null,this.morph=null,this.meshInstance=null,this._aabb=new pc.BoundingBox,this.bindposes=[],this.subMeshes=[],this.boneAabb=null,this.version=0};e.id=0,Object.defineProperty(e.prototype,"aabb",{get:function(){return this.morph?this.morph.aabb:this._aabb},set:function(t){this.morph?(this._aabb=this.morph._baseAabb=t,this.morph._calculateAabb()):this._aabb=t,this.version++}});var i=function(t,i,s){this._key=[0,0],this._shader=[null,null,null],this.id=e.id++,this.isStatic=!1,this._staticLightList=null,this._staticSource=null,this.node=t,this._mesh=i,i._refCount++,i.meshInstance=this,this.material=s,this._shaderDefs=0,this._shaderDefs|=i.vertexBuffer.format.hasUv0?pc.SHADERDEF_UV0:0,this._shaderDefs|=i.vertexBuffer.format.hasUv1?pc.SHADERDEF_UV1:0,this._shaderDefs|=i.vertexBuffer.format.hasColor?pc.SHADERDEF_VCOLOR:0,this._shaderDefs|=i.vertexBuffer.format.hasTangents?pc.SHADERDEF_TANGENTS:0,this._lightHash=0,this.visible=!0,this.layer=pc.LAYER_WORLD,this.renderStyle=pc.RENDERSTYLE_SOLID,this.castShadow=!1,this._receiveShadow=!0,this._screenSpace=!1,this._noDepthDrawGl1=!1,this.cull=!0,this.pick=!0,this.drawOrder=0,this.sortingLayerIndex=0,this.sortingOrder=0,this._updateAabb=!0,this._updateAabbFunc=null,this.updateKey(),this._skinInstance=null,this.morphInstance=null,this.instancingData=null,this.aabb=new pc.BoundingBox,this._boneAabb=null,this._aabbVer=-1,this.drawOrder=0,this.visibleThisFrame=0,this.isVisibleFunc=null,this.parameters={},this._lightProbe=null,this.stencilFront=null,this.stencilBack=null,this.lightmapIndex=-1,this.lightmapSceneIndex=-1,this.isCanvas=!1};Object.defineProperty(i.prototype,"mesh",{get:function(){return this._mesh},set:function(t){this._mesh&&this._mesh._refCount--,this._mesh=t,t&&t._refCount++}}),Object.defineProperty(i.prototype,"aabb",{get:function(){if(this.worldAabbOverride)return this.worldAabbOverride;var e;if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);if(this.skinInstance){var i,s,n=this.mesh.skin.boneNames.length+5;if(!this.mesh.boneAabb){this.mesh.boneAabb=[],this.mesh.boneUsed=[];var r,a,o,h,c,l,p,u=this.mesh.vertexBuffer.format.elements,d=this.mesh.vertexBuffer.numVertices,_=this.mesh.vertexBuffer.format.size;for(s=0;s<u.length;s++)u[s].name===pc.SEMANTIC_POSITION?a=u[s].offset:u[s].name===pc.SEMANTIC_BLENDINDICES?o=u[s].offset:u[s].name===pc.SEMANTIC_BLENDWEIGHT&&(h=u[s].offset);var f,m,g,y,E,v=new Float32Array(this.mesh.vertexBuffer.storage),T=new Float32Array(this.mesh.vertexBuffer.storage),b=a/4,A=h/4,S=o/4,R=_/4,I=[],C=[];for(i=this.mesh.boneUsed,s=0;s<n;s++)I[s]=new pc.Vec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),C[s]=new pc.Vec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(c=0;c<d;c++)for(l=0;l<4;l++)T[c*R+A+l]>0&&(r=v[c*R+S+l],g=T[c*R+b],y=T[c*R+b+1],E=T[c*R+b+2],f=C[r],(m=I[r]).x>g&&(m.x=g),m.y>y&&(m.y=y),m.z>E&&(m.z=E),f.x<g&&(f.x=g),f.y<y&&(f.y=y),f.z<E&&(f.z=E),i[r]=!0);if(this.morphInstance){var M,O,P,x,w,L,F,D,N=this.morphInstance.morph._targets,B=new Float32Array(3*d),k=new Float32Array(3*d);for(c=0;c<d;c++)B[3*c]=k[3*c]=T[c*R+b],B[3*c+1]=k[3*c+1]=T[c*R+b+1],B[3*c+2]=k[3*c+2]=T[c*R+b+2];for(p=0;p<N.length;p++){w=N[p];for(var U=0;U<w.frames.length;U++)for(F=(L=w.frames[U].indices).length,D=w.frames[U].deltaPositions,l=0;l<F;l++)M=L[l],O=D[3*l],P=D[3*l+1],x=D[3*l+2],O<0?B[3*M]+=O:k[3*M]+=O,P<0?B[3*M+1]+=P:k[3*M+1]+=P,x<0?B[3*M+2]+=x:k[3*M+2]+=x}}for(s=0;s<n;s++)(e=new pc.BoundingBox).setMinMax(I[s],C[s]),this.mesh.boneAabb.push(e)}if(!this._boneAabb)for(this._boneAabb=[],s=0;s<this.mesh.boneAabb.length;s++)this._boneAabb[s]=new pc.BoundingBox;for(i=this.mesh.boneUsed,s=0;s<this.mesh.boneAabb.length;s++)i[s]&&this._boneAabb[s].setFromTransformedAabb(this.mesh.boneAabb[s],this.skinInstance.matrices[s]);var V=this.node.getWorldTransform(),z=!0;for(s=0;s<this.mesh.boneAabb.length;s++)i[s]&&(z?(t.center.copy(this._boneAabb[s].center),t.halfExtents.copy(this._boneAabb[s].halfExtents),z=!1):t.add(this._boneAabb[s]));this._aabb.setFromTransformedAabb(t,V)}else this.node._aabbVer!==this._aabbVer&&(e=this.mesh?this.mesh.aabb:this._aabb,this.mesh||(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this._aabb.setFromTransformedAabb(e,this.parameters.localToWorldMatrix||this.node.getWorldTransform()),this._aabbVer=this.node._aabbVer);return this._aabb},set:function(t){this._aabb=t}}),Object.defineProperty(i.prototype,"worldAabbOverride",{get:function(){return this._worldAabbOverride},set:function(t){this._worldAabbOverride=t}}),Object.defineProperty(i.prototype,"material",{get:function(){return this._material},set:function(t){if(t!=this._material){var e;for(e=0;e<this._shader.length;e++)this._shader[e]=null;var i=!!this._material&&this._material.blendType!==pc.BLEND_NONE,s=this._material;if(this._material=t,t&&t.blendType!==pc.BLEND_NONE!==i){var n=t._scene;!n&&s&&s._scene&&(n=s._scene),n?n.layers._dirtyBlend=!0:t._dirtyBlend=!0}}}}),Object.defineProperty(i.prototype,"layer",{get:function(){return this._layer},set:function(t){this._layer=t,this.updateKey()}}),Object.defineProperty(i.prototype,"receiveShadow",{get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t,this._shaderDefs=t?this._shaderDefs&~pc.SHADERDEF_NOSHADOW:this._shaderDefs|pc.SHADERDEF_NOSHADOW,this._shader[pc.SHADER_FORWARD]=null,this._shader[pc.SHADER_FORWARDHDR]=null}}),Object.defineProperty(i.prototype,"skinInstance",{get:function(){return this._skinInstance},set:function(t){this._skinInstance=t,this._shaderDefs=t?this._shaderDefs|pc.SHADERDEF_SKIN:this._shaderDefs&~pc.SHADERDEF_SKIN;for(var e=0;e<this._shader.length;e++)this._shader[e]=null}}),Object.defineProperty(i.prototype,"morphInstance",{get:function(){return this._morphInstance},set:function(t){this._morphInstance=t}}),Object.defineProperty(i.prototype,"screenSpace",{get:function(){return this._screenSpace},set:function(t){this._screenSpace=t,this._shaderDefs=t?this._shaderDefs|pc.SHADERDEF_SCREENSPACE:this._shaderDefs&~pc.SHADERDEF_SCREENSPACE,this._shader[pc.SHADER_FORWARD]=null}}),Object.defineProperty(i.prototype,"key",{get:function(){return this._key[pc.SORTKEY_FORWARD]},set:function(t){this._key[pc.SORTKEY_FORWARD]=t}}),Object.assign(i.prototype,{syncAabb:function(){},updateKey:function(){var t=this.material;this._key[pc.SORTKEY_FORWARD]=r(this.layer,t.alphaToCoverage||t.alphaTest?pc.BLEND_NORMAL:t.blendType,!1,t.id)},setParameter:pc.Material.prototype.setParameter,setParameters:pc.Material.prototype.setParameters,deleteParameter:pc.Material.prototype.deleteParameter,getParameter:pc.Material.prototype.getParameter,getParameters:pc.Material.prototype.getParameters,clearParameters:pc.Material.prototype.clearParameters});var s=function(t,e,i){this._key=[],this._key[pc.SORTKEY_FORWARD]=r(t,e,!0,0),this.command=i};Object.defineProperty(s.prototype,"key",{get:function(){return this._key[pc.SORTKEY_FORWARD]},set:function(t){this._key[pc.SORTKEY_FORWARD]=t}});var n=function(t,e,i){i=i||16,this.buffer=new Float32Array(t*i),this.count=t,this.offset=0,this.usage=e?pc.BUFFER_DYNAMIC:pc.BUFFER_STATIC,this._buffer=null};function r(t,e,i,s){return(15&t)<<27|(e===pc.BLEND_NONE?1:0)<<26|(i?1:0)<<25|(33554431&s)<<0}return Object.assign(n.prototype,{update:function(){this._buffer&&this._buffer.setData(this.buffer)}}),{Command:s,Mesh:e,MeshInstance:i,InstancingData:n,_getDrawcallSortKey:r}}()),Object.assign(pc,function(){var t=new pc.Mat4,e=function(t){this.skin=t,this._dirty=!0,this.bones=[];var e,i=t.inverseBindPose.length,s=t.device;s.supportsBoneTextures?(e=i>256?64:i>64?32:i>16?16:8,this.boneTexture=new pc.Texture(s,{width:e,height:e,format:pc.PIXELFORMAT_RGBA32F,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST}),this.matrixPalette=this.boneTexture.lock()):this.matrixPalette=new Float32Array(16*i);this.matrices=[],this.bonesAabbVersions=[];for(var n=0;n<i;n++)this.matrices[n]=new pc.Mat4,this.bonesAabbVersions[n]=-1};return Object.assign(e.prototype,{updateMatrices:function(e){t.copy(e.getWorldTransform()).invert();for(var i=this.bones.length-1;i>=0;i--)this.matrices[i].mul2(t,this.bones[i].getWorldTransform()),this.matrices[i].mul2(this.matrices[i],this.skin.inverseBindPose[i])},updateMatrixPalette:function(){for(var t,e,i=this.matrixPalette,s=this.bones.length-1;s>=0;s--)t=this.matrices[s].data,i[e=16*s]=t[0],i[e+1]=t[1],i[e+2]=t[2],i[e+3]=t[3],i[e+4]=t[4],i[e+5]=t[5],i[e+6]=t[6],i[e+7]=t[7],i[e+8]=t[8],i[e+9]=t[9],i[e+10]=t[10],i[e+11]=t[11],i[e+12]=t[12],i[e+13]=t[13],i[e+14]=t[14],i[e+15]=t[15];this.skin.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}}),{Skin:function(t,e,i){this.device=t,this.inverseBindPose=e,this.boneNames=i},SkinInstance:e}}()),Object.assign(pc,function(){function t(){this.index=0,this.boneIndices=[0,0,0,0]}function e(){this.partition=0,this.vertexStart=0,this.vertexCount=0,this.indexStart=0,this.indexCount=0,this.boneIndices=[],this.vertices=[],this.indices=[],this.indexMap={}}return Object.assign(e.prototype,{addVertex:function(t,e,i){var s=-1;if(void 0!==this.indexMap[e])s=this.indexMap[e],this.indices.push(s);else{for(var n=0;n<4;n++)if(0!==i.blendWeight.data[4*e+n]){var r=i.blendIndices.data[4*t.index+n];t.boneIndices[n]=this.getBoneRemap(r)}s=this.vertices.length,this.indices.push(s),this.vertices.push(t),this.indexMap[e]=s}},addPrimitive:function(t,e,i,s){var n,r,a=[],o=0,h=t.length;for(n=0;n<h;n++)for(var c=t[n].index,l=0;l<4;l++)if(i.blendWeight.data[4*c+l]>0){var p=i.blendIndices.data[4*c+l],u=!0;for(r=0;r<o;r++)if(a[r]==p){u=!1;break}if(u)a[o]=p,o+=-1===this.getBoneRemap(p)?1:0}if(this.boneIndices.length+o>s)return!1;for(n=0;n<o;n++)this.boneIndices.push(a[n]);for(n=0;n<h;n++)this.addVertex(t[n],e[n],i);return!0},getBoneRemap:function(t){for(var e=0;e<this.boneIndices.length;e++)if(this.boneIndices[e]===t)return e;return-1}}),{partitionSkin:function(i,s,n){var r,a,o,h;!function(t){var e,i=t.vertices,s=t.skins,n=t.meshes,r=t.meshInstances;for(e=0;e<n.length;e++)n[e].vertices=i[n[e].vertices],void 0!==n[e].skin&&(n[e].skin=s[n[e].skin]);for(e=0;e<r.length;e++)r[e].mesh=n[r[e].mesh]}(i);var c,l=i.vertices,p=i.skins,u=i.meshes,d=i.meshInstances,_=function(e){var i=new t;return i.index=e,i};for(r=p.length-1;r>=0;r--)if(p[r].boneNames.length>n){var f=p.splice(r,1)[0],m=[];for(a=0;a<u.length;a++)u[a].skin===f&&m.push(u[a]);for(a=0;a<m.length;a++)-1!==(h=u.indexOf(m[a]))&&u.splice(h,1);if(0===m.length)throw new Error("partitionSkin: There should be at least one mesh that references a skin");var g,y=m[0].vertices;for(a=1;a<m.length;a++)if(m[a].vertices!==y)throw new Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var E=[],v=[],T=[],b=0;for(a=0;a<m.length;a++){for(var A=(c=m[a]).indices,S=c.base;S<c.base+c.count;){h=A[S++],v[0]=_(h),T[0]=h,h=A[S++],v[1]=_(h),T[1]=h,h=A[S++],v[2]=_(h),T[2]=h;for(var R=!1,I=b;I<E.length;I++)if((g=E[I]).addPrimitive(v,T,y,n)){R=!0;break}R||((g=new e).originalMesh=c,g.addPrimitive(v,T,y,n),E.push(g))}b=E.length}var C=[],M=[];for(a=0;a<E.length;a++)if((g=E[a]).vertices.length&&g.indices.length){var O,P,x=C.length,w=g.vertices.length,L=M.length,F=g.indices.length;for(g.partition=a,g.vertexStart=x,g.vertexCount=w,g.indexStart=L,g.indexCount=F,O=0,P=x;O<w;)C[P++]=g.vertices[O++];for(O=0,P=L;O<F;)M[P++]=g.indices[O++]+x}var D,N,B,k,U=[];for(a=0;a<E.length;a++){g=E[a];var V=[],z=[];for(o=0;o<g.boneIndices.length;o++)V.push(f.inverseBindMatrices[g.boneIndices[o]]),z.push(f.boneNames[g.boneIndices[o]]);var j={inverseBindMatrices:V,boneNames:z};U.push(j),p.push(j)}var G={};for(N in y)G[N]={components:y[N].components,data:[],type:y[N].type};for(N in y)if("blendIndices"===N){var H=G[N].data;for(a=0;a<C.length;a++){var Y=C[a].boneIndices;H.push(Y[0],Y[1],Y[2],Y[3])}}else for(B=(D=y[N]).data,k=D.components,a=0;a<C.length;a++)for(h=C[a].index,o=0;o<k;o++)G[N].data.push(B[h*k+o]);for(l[l.indexOf(y)]=G,a=0;a<E.length;a++)for(g=E[a],c={aabb:{min:[0,0,0],max:[0,0,0]},vertices:G,skin:U[a],indices:M.splice(0,g.indexCount),type:"triangles",base:0,count:g.indexCount},u.push(c),o=d.length-1;o>=0;o--)d[o].mesh===g.originalMesh&&(d.push({mesh:c,node:d[o].node}),s&&s.push({material:s[o].material,path:s[o].path}));for(a=0;a<E.length;a++)for(g=E[a],o=d.length-1;o>=0;o--)d[o].mesh===g.originalMesh&&(d.splice(o,1),s&&s.splice(o,1))}!function(t){var e,i=t.vertices,s=t.skins,n=t.meshes,r=t.meshInstances;for(e=0;e<n.length;e++)n[e].vertices=i.indexOf(n[e].vertices),void 0!==n[e].skin&&(n[e].skin=s.indexOf(n[e].skin));for(e=0;e<r.length;e++)r[e].mesh=n.indexOf(r[e].mesh)}(i)}}}()),Object.assign(pc,function(){var t=new pc.Vec3,e=new pc.Vec3;var i=function(t){this.frames=t?t.frames:[],this.name=t?t.name:"",this.aabb=t?t.aabb:void 0};i.prototype=new i,Object.defineProperty(i.prototype,"indices",{get:function(){return this.frames[0].indices}});var s=function(t){this.aabb=new pc.BoundingBox,this._baseBuffer=null,this._baseAabb=null,this._targets=t,this._dirty=!0,this._aabbDirty=!0,this._baseData=null,this._offsetPF=0,this._offsetNF=0,this._offsetTF=0,this._vertSizeF=0};Object.assign(s.prototype,{_setBaseMesh:function(t){this._baseBuffer=t.vertexBuffer,this._baseAabb=t._aabb,this._baseData=new Float32Array(this._baseBuffer.storage);for(var e=-1,i=-1,s=-1,n=this._baseBuffer.format.elements,r=this._baseBuffer.format.size,a=0;a<n.length;a++)n[a].name===pc.SEMANTIC_POSITION?e=n[a].offset:n[a].name===pc.SEMANTIC_NORMAL?i=n[a].offset:n[a].name===pc.SEMANTIC_TANGENT&&(s=n[a].offset);this._offsetPF=e/4,this._offsetNF=i/4,this._offsetTF=s/4,this._vertSizeF=r/4,this._dirty=!0},_calculateAabb:function(){if(this._baseBuffer){var i,s,n,r,a,o,h,c;this.aabb.copy(this._baseAabb);var l=this._vertSizeF,p=this._offsetPF,u=this._baseData;for(s=0;s<this._targets.length;s++){if(!(r=this._targets[s]).aabb&&r.indices.length>0){for(r.aabb=this.aabb.clone(),t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i=r.indices.length,frameIndex=0;frameIndex<r.frames.length;frameIndex++){var d=r.frames[frameIndex];for(n=0;n<i;n++)o=u[a=r.indices[n]*l+p]+d[3*n],h=u[a+1]+d[3*n+1],c=u[a+2]+d[3*n+2],t.x>o&&(t.x=o),t.y>h&&(t.y=h),t.z>c&&(t.z=c),e.x<o&&(e.x=o),e.y<h&&(e.y=h),e.z<c&&(e.z=c)}r.aabb.setMinMax(t,e)}r.aabb&&this.aabb.add(r.aabb)}this._aabbDirty=!1}},addTarget:function(t){this._targets.push(t),this._aabbDirty=!0},removeTarget:function(t){var e=this._targets.indexOf(t);-1!==e&&(this._targets.splice(e,1),this._aabbDirty=!0)},getTarget:function(t){return this._targets[t]}});var n=function(t){this.morph=t,this._vertexBuffer=null,this._vertexData=null,this._weights=[],this._dirty=!0};return Object.assign(n.prototype,{_setBaseMesh:function(t){this.destroy(),this._vertexBuffer=new pc.VertexBuffer(this.morph._baseBuffer.device,this.morph._baseBuffer.format,this.morph._baseBuffer.numVertices,pc.BUFFER_DYNAMIC,this.morph._baseBuffer.storage.slice(0)),this._vertexData=new Float32Array(this._vertexBuffer.storage),this._weights=[],this._weights.length=this.morph._targets.length;for(var e=0;e<this.morph._targets.length;e++)this._weights[e]=0;this._dirty=!0},destroy:function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._vertexBuffer=null)},getWeight:function(t){return this._weights[t]},setWeight:function(t,e){this._weights[t]=e,this._dirty=!0},updateBounds:function(t){this.morph._baseBuffer!==t.vertexBuffer&&this.morph._setBaseMesh(t),this._vertexData||this._setBaseMesh(t),this.morph._aabbDirty&&this.morph._calculateAabb()},update:function(t){this.morph._baseBuffer!==t.vertexBuffer&&this.morph._setBaseMesh(t),this._vertexData||this._setBaseMesh(t);var e,i,s=this.morph._targets,n=this._weights;this._vertexData.set(this.morph._baseData);for(var r=0;r<s.length;r++)if(0!==(i=n[r])){var a=(e=s[r]).frames;if(1==a.length&&this._applyFrame(a[0],i,e),a.length>1){if(i<a[0].weight){var o=i/(h=a[0]).weight;this._applyFrame(h,o,e);continue}if(i>a[a.length-1].weight){var h;o=i/(h=a[a.length-1]).weight;this._applyFrame(h,o,e);continue}if(2==a.length){var c=a[0],l=a[1];this._applyFrame(c,1,e);var p=(i-c.weight)/(l.weight-c.weight);this._applyFrame(l,p,e);continue}var u,d;for(frameIndex=0;frameIndex<a.length-1&&(u=frameIndex,d=frameIndex+1,!(a[u].weight<i&&i<a[d].weight));frameIndex++);p=(i-a[u].weight)/(a[d].weight-a[u].weight);this._applyFrame(a[u],1-p,e),this._applyFrame(a[d],p,e)}}this._vertexBuffer.unlock()},_applyFrame:function(t,e,i){var s=t.indices.length,n=this.morph._vertSizeF,r=this.morph._offsetPF,a=this.morph._offsetNF,o=this.morph._offsetTF,h=this._vertexData;for(j=0;j<s;j++){var c=t.deltaPositions;j3=3*j,index=i.indices[j],id=index*n+r,h[id]+=c[j3]*e,h[id+1]+=c[j3+1]*e,h[id+2]+=c[j3+2]*e}if(t.deltaNormals){var l=t.deltaNormals;for(j=0;j<s;j++)j3=3*j,index=i.indices[j],id=index*n+a,h[id]+=l[j3]*e,h[id+1]+=l[j3+1]*e,h[id+2]+=l[j3+2]*e}if(t.deltaTangents){var p=t.deltaTangents;for(j=0;j<s;j++)j3=3*j,index=i.indices[j],j4=4*j,id=index*n+o,h[id]+=p[j4]*e,h[id+1]+=p[j4+1]*e,h[id+2]+=p[j4+2]*e,h[id+3]+=p[j4+3]*e,h[id+3]=h[id+3]>0?1:-1}}}),{MorphTarget:i,MorphTargetFrame:function(t){if(t.indices)this.indices=t.indices;else{var e=t.deltaPositions;this.indices=[],this.indices.length=e.length;for(var i=0;i<e.length;i++)this.indices[i]=i}this.deltaPositions=t.deltaPositions,this.deltaNormals=t.deltaNormals,this.deltaTangents=t.deltaTangents,this.weight=t.weight},Morph:s,MorphInstance:n}}()),Object.assign(pc,function(){var t=function(){this.meshInstances=[],this.skinInstances=[],this.morphInstance=null,this._materials=[],this._mesh=null,this._skin=null,this._bones=null,this._sortingLayerIndex=0,this._sortingOrder=0,this._cullingLayer=0,this._entity=null,this.cameras=[],this.lights=[],this._shadersVersion=0};return Object.assign(t.prototype,{getGraph:function(){return this.graph},setGraph:function(t){},getCameras:function(){return this.cameras},setCameras:function(t){this.cameras=t},getLights:function(){return this.lights},setLights:function(t){this.lights=t},getMaterials:function(){var t;this.update();var e=[];for(t=0;t<this.meshInstances.length;t++){var i=this.meshInstances[t];-1===e.indexOf(i.material)&&e.push(i.material)}return e},clone:function(){var t,e;this.update();var i=[],s=[],n=function(t){var e=t.clone();i.push(t),s.push(e);for(var r=0;r<t._children.length;r++)e.addChild(n(t._children[r]));return e},r=n(this.graph),a=[],o=[],h=null;for(t=0;t<this.skinInstances.length;t++){var c=this.skinInstances[t].skin,l=new pc.SkinInstance(c),p=[];for(e=0;e<c.boneNames.length;e++){var u=c.boneNames[e],d=r.findByName(u);p.push(d)}l.bones=p,o.push(l)}var _=this.morphInstances.morph;for(h=h=new pc.MorphInstance(_),t=0;t<this.meshInstances.length;t++){var f=this.meshInstances[t],m=i.indexOf(f.node),g=new pc.MeshInstance(s[m],f.mesh,f.material);if(f.skinInstance){var y=this.skinInstances.indexOf(f.skinInstance);g.skinInstance=o[y]}f.morphInstance&&(g.morphInstance=h),a.push(g)}var E=new pc.Model;return E.meshInstances=a,E.skinInstances=o,E.morphInstance=cloneMorphInstances,E.getGraph().syncHierarchy(),E},destroy:function(){for(var t,e,i,s,n,r,a,o,h=this.meshInstances,c=0;c<h.length;c++){if((e=(t=h[c]).mesh)&&(e._refCount--,e._refCount<1)){for(e.vertexBuffer&&(o=o||e.vertexBuffer.device,e.vertexBuffer.destroy(),e.vertexBuffer=null),a=0;a<e.indexBuffer.length;a++)o=o||e.indexBuffer.device,(n=e.indexBuffer[a])&&n.destroy();e.indexBuffer.length=0}(i=t.skinInstance)&&(r=i.boneTexture)&&r.destroy(),t.skinInstance=null,(s=t.morphInstance)&&s.destroy(),t.morphInstance=null,t.material=null}},generateWireframe:function(){var t,e,i,s,n,r,a,o,h,c,l,p=[];for(t=0;t<this.meshInstances.length;t++)r=this.meshInstances[t].mesh,-1===p.indexOf(r)&&p.push(r);var u=[[0,1],[1,2],[2,0]];for(t=0;t<p.length;t++){a=(r=p[t]).primitive[pc.RENDERSTYLE_SOLID].base,o=r.primitive[pc.RENDERSTYLE_SOLID].count,h=r.indexBuffer[pc.RENDERSTYLE_SOLID],l=new Uint16Array(h.lock());var d={},_=[];for(e=a;e<a+o;e+=3)for(i=0;i<3;i++){var f=(s=l[e+u[i][0]])>(n=l[e+u[i][1]])?n<<16|s:s<<16|n;void 0===d[f]&&(d[f]=0,_.push(s,n))}h.unlock(),c=new pc.IndexBuffer(h.device,pc.INDEXFORMAT_UINT16,_.length),new Uint16Array(c.lock()).set(_),c.unlock(),r.primitive[pc.RENDERSTYLE_WIREFRAME]={type:pc.PRIMITIVE_LINES,base:0,count:_.length,indexed:!0},r.indexBuffer[pc.RENDERSTYLE_WIREFRAME]=c}}}),{Model:t}}());var primitiveUv1Padding=4/64,primitiveUv1PaddingScale=1-2*primitiveUv1Padding;pc.calculateNormals=function(t,e){var i,s,n,r,a=e.length/3,o=t.length/3,h=new pc.Vec3,c=new pc.Vec3,l=new pc.Vec3,p=new pc.Vec3,u=new pc.Vec3,d=new pc.Vec3,_=[];for(r=0;r<t.length;r++)_[r]=0;for(r=0;r<a;r++)i=e[3*r],s=e[3*r+1],n=e[3*r+2],h.set(t[3*i],t[3*i+1],t[3*i+2]),c.set(t[3*s],t[3*s+1],t[3*s+2]),l.set(t[3*n],t[3*n+1],t[3*n+2]),p.sub2(c,h),u.sub2(l,h),d.cross(p,u).normalize(),_[3*i]+=d.x,_[3*i+1]+=d.y,_[3*i+2]+=d.z,_[3*s]+=d.x,_[3*s+1]+=d.y,_[3*s+2]+=d.z,_[3*n]+=d.x,_[3*n+1]+=d.y,_[3*n+2]+=d.z;for(r=0;r<o;r++){var f=_[3*r],m=_[3*r+1],g=_[3*r+2],y=1/Math.sqrt(f*f+m*m+g*g);_[3*r]*=y,_[3*r+1]*=y,_[3*r+2]*=y}return _},pc.calculateTangents=function(t,e,i,s){var n,r,a,o,h,c,l,p,u,d,_,f,m,g,y,E=s.length/3,v=t.length/3,T=new pc.Vec3,b=new pc.Vec3,A=new pc.Vec3,S=new pc.Vec3,R=new pc.Vec3,I=new pc.Vec2,C=new pc.Vec2,M=new pc.Vec2,O=new Float32Array(3*v),P=new Float32Array(3*v),x=[],w=0;for(y=0;y<E;y++)n=s[3*y],r=s[3*y+1],a=s[3*y+2],A.set(t[3*n],t[3*n+1],t[3*n+2]),S.set(t[3*r],t[3*r+1],t[3*r+2]),R.set(t[3*a],t[3*a+1],t[3*a+2]),I.set(i[2*n],i[2*n+1]),C.set(i[2*r],i[2*r+1]),M.set(i[2*a],i[2*a+1]),o=S.x-A.x,h=R.x-A.x,c=S.y-A.y,l=R.y-A.y,p=S.z-A.z,u=R.z-A.z,d=C.x-I.x,_=M.x-I.x,f=C.y-I.y,0==(w=d*(m=M.y-I.y)-_*f)?(T.set(0,1,0),b.set(1,0,0)):(g=1/w,T.set((m*o-f*h)*g,(m*c-f*l)*g,(m*p-f*u)*g),b.set((d*h-_*o)*g,(d*l-_*c)*g,(d*u-_*p)*g)),O[3*n+0]+=T.x,O[3*n+1]+=T.y,O[3*n+2]+=T.z,O[3*r+0]+=T.x,O[3*r+1]+=T.y,O[3*r+2]+=T.z,O[3*a+0]+=T.x,O[3*a+1]+=T.y,O[3*a+2]+=T.z,P[3*n+0]+=b.x,P[3*n+1]+=b.y,P[3*n+2]+=b.z,P[3*r+0]+=b.x,P[3*r+1]+=b.y,P[3*r+2]+=b.z,P[3*a+0]+=b.x,P[3*a+1]+=b.y,P[3*a+2]+=b.z;f=new pc.Vec3,m=new pc.Vec3;var L=new pc.Vec3,F=new pc.Vec3;for(y=0;y<v;y++){L.set(e[3*y],e[3*y+1],e[3*y+2]),f.set(O[3*y],O[3*y+1],O[3*y+2]),m.set(P[3*y],P[3*y+1],P[3*y+2]);var D=L.dot(f);F.copy(L).scale(D),F.sub2(f,F).normalize(),x[4*y]=F.x,x[4*y+1]=F.y,x[4*y+2]=F.z,F.cross(L,f),x[4*y+3]=F.dot(m)<0?-1:1}return x},pc.createMesh=function(t,e,i){var s=i&&void 0!==i.normals?i.normals:null,n=i&&void 0!==i.tangents?i.tangents:null,r=i&&void 0!==i.colors?i.colors:null,a=i&&void 0!==i.uvs?i.uvs:null,o=i&&void 0!==i.uvs1?i.uvs1:null,h=i&&void 0!==i.indices?i.indices:null,c=i&&void 0!==i.blendIndices?i.blendIndices:null,l=i&&void 0!==i.blendWeights?i.blendWeights:null,p=[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32}];null!==s&&p.push({semantic:pc.SEMANTIC_NORMAL,components:3,type:pc.TYPE_FLOAT32}),null!==n&&p.push({semantic:pc.SEMANTIC_TANGENT,components:4,type:pc.TYPE_FLOAT32}),null!==r&&p.push({semantic:pc.SEMANTIC_COLOR,components:4,type:pc.TYPE_UINT8,normalize:!0}),null!==a&&p.push({semantic:pc.SEMANTIC_TEXCOORD0,components:2,type:pc.TYPE_FLOAT32}),null!==o&&p.push({semantic:pc.SEMANTIC_TEXCOORD1,components:2,type:pc.TYPE_FLOAT32}),null!==c&&p.push({semantic:pc.SEMANTIC_BLENDINDICES,components:2,type:pc.TYPE_UINT8}),null!==l&&p.push({semantic:pc.SEMANTIC_BLENDWEIGHT,components:2,type:pc.TYPE_FLOAT32});for(var u=new pc.VertexFormat(t,p),d=e.length/3,_=new pc.VertexBuffer(t,u,d),f=new pc.VertexIterator(_),m=0;m<d;m++)f.element[pc.SEMANTIC_POSITION].set(e[3*m],e[3*m+1],e[3*m+2]),null!==s&&f.element[pc.SEMANTIC_NORMAL].set(s[3*m],s[3*m+1],s[3*m+2]),null!==n&&f.element[pc.SEMANTIC_TANGENT].set(n[4*m],n[4*m+1],n[4*m+2],n[4*m+3]),null!==r&&f.element[pc.SEMANTIC_COLOR].set(r[4*m],r[4*m+1],r[4*m+2],r[4*m+3]),null!==a&&f.element[pc.SEMANTIC_TEXCOORD0].set(a[2*m],a[2*m+1]),null!==o&&f.element[pc.SEMANTIC_TEXCOORD1].set(o[2*m],o[2*m+1]),null!==c&&f.element[pc.SEMANTIC_BLENDINDICES].set(c[2*m],c[2*m+1]),null!==l&&f.element[pc.SEMANTIC_BLENDWEIGHT].set(l[2*m],l[2*m+1]),f.next();f.end();var g=null,y=null!==h;y&&(g=new pc.IndexBuffer(t,pc.INDEXFORMAT_UINT16,h.length),new Uint16Array(g.lock()).set(h),g.unlock());var E=new pc.BoundingBox;E.compute(e);var v=new pc.Mesh;return v.vertexBuffer=_,v.indexBuffer[0]=g,v.primitive[0].type=pc.PRIMITIVE_TRIANGLES,v.primitive[0].base=0,v.primitive[0].count=y?h.length:d,v.primitive[0].indexed=y,v.aabb=E,v},pc.createTorus=function(t,e){var i,s,n,r,a,o,h,c,l,p,u=e&&void 0!==e.tubeRadius?e.tubeRadius:.2,d=e&&void 0!==e.ringRadius?e.ringRadius:.3,_=e&&void 0!==e.segments?e.segments:30,f=e&&void 0!==e.sides?e.sides:20,m=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,g=[],y=[],E=[],v=[];for(i=0;i<=f;i++)for(s=0;s<=_;s++){var T,b,A,S;if(n=Math.cos(2*Math.PI*s/_)*(d+u*Math.cos(2*Math.PI*i/f)),r=Math.sin(2*Math.PI*i/f)*u,a=Math.sin(2*Math.PI*s/_)*(d+u*Math.cos(2*Math.PI*i/f)),o=Math.cos(2*Math.PI*s/_)*Math.cos(2*Math.PI*i/f),h=Math.sin(2*Math.PI*i/f),c=Math.sin(2*Math.PI*s/_)*Math.cos(2*Math.PI*i/f),l=i/f,p=1-s/_,g.push(n,r,a),y.push(o,h,c),E.push(l,p),i<f&&s<_)T=i*(_+1)+s,b=(i+1)*(_+1)+s,A=i*(_+1)+(s+1),S=(i+1)*(_+1)+(s+1),v.push(T,b,A),v.push(b,S,A)}var R={normals:y,uvs:E,indices:v};return m&&(R.tangents=pc.calculateTangents(g,y,E,v)),pc.createMesh(t,g,R)},pc._createConeData=function(t,e,i,s,n,r){var a,o,h,c,l,p,u,d,_,f,m,g,y,E,v,T,b,A,S,R,I=new pc.Vec3,C=new pc.Vec3,M=new pc.Vec3,O=[],P=[],x=[],w=[],L=[];if(i>0)for(a=0;a<=s;a++)for(o=0;o<=n;o++){m=o/n*2*Math.PI-Math.PI,y=Math.sin(m),g=Math.cos(m),_=new pc.Vec3(y*t,-i/2,g*t),d=new pc.Vec3(y*e,i/2,g*e),I.lerp(_,d,a/s),C.sub2(d,_).normalize(),f=new pc.Vec3(g,0,-y),M.cross(f,C).normalize(),O.push(I.x,I.y,I.z),P.push(M.x,M.y,M.z),p=o/n,u=a/s,x.push(p,u);var F=u;u=p,p=F,p=(p/=3)*primitiveUv1PaddingScale+primitiveUv1Padding,u=u*primitiveUv1PaddingScale+primitiveUv1Padding,w.push(p,u),a<s&&o<n&&(T=a*(n+1)+o,b=a*(n+1)+(o+1),A=(a+1)*(n+1)+o,S=(a+1)*(n+1)+(o+1),L.push(T,b,A),L.push(b,S,A))}if(r){var D,N,B=Math.floor(n/2),k=n,U=i/2;for(D=0;D<=B;D++)for(m=D*Math.PI*.5/B,y=Math.sin(m),g=Math.cos(m),N=0;N<=k;N++)E=2*N*Math.PI/k-Math.PI/2,v=Math.sin(E),h=Math.cos(E)*y,c=g,l=v*y,p=1-N/k,u=1-D/B,O.push(h*e,c*e+U,l*e),P.push(h,c,l),x.push(p,u),p=(p/=3)*primitiveUv1PaddingScale+primitiveUv1Padding,u=(u/=3)*primitiveUv1PaddingScale+primitiveUv1Padding,p+=1/3,w.push(p,u);for(R=(s+1)*(n+1),D=0;D<B;++D)for(N=0;N<k;++N)b=(T=D*(k+1)+N)+k+1,L.push(R+T+1,R+b,R+T),L.push(R+T+1,R+b+1,R+b);for(D=0;D<=B;D++)for(m=.5*Math.PI+D*Math.PI*.5/B,y=Math.sin(m),g=Math.cos(m),N=0;N<=k;N++)E=2*N*Math.PI/k-Math.PI/2,v=Math.sin(E),h=Math.cos(E)*y,c=g,l=v*y,p=1-N/k,u=1-D/B,O.push(h*e,c*e-U,l*e),P.push(h,c,l),x.push(p,u),p=(p/=3)*primitiveUv1PaddingScale+primitiveUv1Padding,u=(u/=3)*primitiveUv1PaddingScale+primitiveUv1Padding,p+=2/3,w.push(p,u);for(R=(s+1)*(n+1)+(k+1)*(B+1),D=0;D<B;++D)for(N=0;N<k;++N)b=(T=D*(k+1)+N)+k+1,L.push(R+T+1,R+b,R+T),L.push(R+T+1,R+b+1,R+b)}else{if(R=(s+1)*(n+1),t>0)for(a=0;a<n;a++)m=a/n*2*Math.PI,c=-i/2,p=1-((h=Math.sin(m))+1)/2,u=((l=Math.cos(m))+1)/2,O.push(h*t,c,l*t),P.push(0,-1,0),x.push(p,u),p=(p/=3)*primitiveUv1PaddingScale+primitiveUv1Padding,u=(u/=3)*primitiveUv1PaddingScale+primitiveUv1Padding,p+=1/3,w.push(p,u),a>1&&L.push(R,R+a,R+a-1);if(R+=n,e>0)for(a=0;a<n;a++)m=a/n*2*Math.PI,c=i/2,p=1-((h=Math.sin(m))+1)/2,u=((l=Math.cos(m))+1)/2,O.push(h*e,c,l*e),P.push(0,1,0),x.push(p,u),p=(p/=3)*primitiveUv1PaddingScale+primitiveUv1Padding,u=(u/=3)*primitiveUv1PaddingScale+primitiveUv1Padding,p+=2/3,w.push(p,u),a>1&&L.push(R,R+a-1,R+a)}return{positions:O,normals:P,uvs:x,uvs1:w,indices:L}},pc.createCylinder=function(t,e){e&&e.hasOwnProperty("baseRadius")&&!e.hasOwnProperty("radius")&&console.warn('DEPRECATED: "baseRadius" in arguments, use "radius" instead');var i=e&&(e.radius||e.baseRadius);i=void 0!==i?i:.5;var s=e&&void 0!==e.height?e.height:1,n=e&&void 0!==e.heightSegments?e.heightSegments:5,r=e&&void 0!==e.capSegments?e.capSegments:20,a=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,o=pc._createConeData(i,i,s,n,r,!1);return a&&(o.tangents=pc.calculateTangents(o.positions,o.normals,o.uvs,o.indices)),pc.createMesh(t,o.positions,o)},pc.createCapsule=function(t,e){var i=e&&void 0!==e.radius?e.radius:.3,s=e&&void 0!==e.height?e.height:1,n=e&&void 0!==e.heightSegments?e.heightSegments:1,r=e&&void 0!==e.sides?e.sides:20,a=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,o=pc._createConeData(i,i,s-2*i,n,r,!0);return a&&(o.tangents=pc.calculateTangents(o.positions,o.normals,o.uvs,o.indices)),pc.createMesh(t,o.positions,o)},pc.createCone=function(t,e){var i=e&&void 0!==e.baseRadius?e.baseRadius:.5,s=e&&void 0!==e.peakRadius?e.peakRadius:0,n=e&&void 0!==e.height?e.height:1,r=e&&void 0!==e.heightSegments?e.heightSegments:5,a=e&&void 0!==e.capSegments?e.capSegments:18,o=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,h=pc._createConeData(i,s,n,r,a,!1);return o&&(h.tangents=pc.calculateTangents(h.positions,h.normals,h.uvs,h.indices)),pc.createMesh(t,h.positions,h)},pc.createSphere=function(t,e){var i,s,n,r,a,o,h,c,l,p,u,d,_,f,m=e&&void 0!==e.radius?e.radius:.5,g=e&&void 0!==e.latitudeBands?e.latitudeBands:16,y=e&&void 0!==e.longitudeBands?e.longitudeBands:16,E=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,v=[],T=[],b=[],A=[];for(s=0;s<=g;s++)for(n=s*Math.PI/g,r=Math.sin(n),a=Math.cos(n),i=0;i<=y;i++)o=2*i*Math.PI/y-Math.PI/2,h=Math.sin(o),p=Math.cos(o)*r,u=a,d=h*r,_=1-i/y,f=1-s/g,v.push(p*m,u*m,d*m),T.push(p,u,d),b.push(_,f);for(s=0;s<g;++s)for(i=0;i<y;++i)l=(c=s*(y+1)+i)+y+1,A.push(c+1,l,c),A.push(c+1,l+1,l);var S={normals:T,uvs:b,uvs1:b,indices:A};return E&&(S.tangents=pc.calculateTangents(v,T,b,A)),pc.createMesh(t,v,S)},pc.createPlane=function(t,e){var i,s,n,r,a,o,h=e&&void 0!==e.halfExtents?e.halfExtents:new pc.Vec2(.5,.5),c=e&&void 0!==e.widthSegments?e.widthSegments:5,l=e&&void 0!==e.lengthSegments?e.lengthSegments:5,p=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,u=[],d=[],_=[],f=[],m=0;for(i=0;i<=c;i++)for(s=0;s<=l;s++)n=-h.x+2*h.x*i/c,0,r=-(-h.y+2*h.y*s/l),a=i/c,o=s/l,u.push(n,0,r),d.push(0,1,0),_.push(a,o),i<c&&s<l&&(f.push(m+l+1,m+1,m),f.push(m+l+1,m+l+2,m+1)),m++;var g={normals:d,uvs:_,uvs1:_,indices:f};return p&&(g.tangents=pc.calculateTangents(u,d,_,f)),pc.createMesh(t,u,g)},pc.createBox=function(t,e){var i=e&&void 0!==e.halfExtents?e.halfExtents:new pc.Vec3(.5,.5,.5),s=e&&void 0!==e.widthSegments?e.widthSegments:1,n=e&&void 0!==e.lengthSegments?e.lengthSegments:1,r=e&&void 0!==e.heightSegments?e.heightSegments:1,a=!(!e||void 0===e.calculateTangents)&&e.calculateTangents,o=[new pc.Vec3(-i.x,-i.y,i.z),new pc.Vec3(i.x,-i.y,i.z),new pc.Vec3(i.x,i.y,i.z),new pc.Vec3(-i.x,i.y,i.z),new pc.Vec3(i.x,-i.y,-i.z),new pc.Vec3(-i.x,-i.y,-i.z),new pc.Vec3(-i.x,i.y,-i.z),new pc.Vec3(i.x,i.y,-i.z)],h=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],c=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],l=1,p=2,u=3,d=4,_=5,f=[],m=[],g=[],y=[],E=[],v=0,T=function(t,e,i){var s,n,r,a;for(r=0;r<=e;r++)for(a=0;a<=i;a++){var l=new pc.Vec3,p=new pc.Vec3,u=new pc.Vec3,d=new pc.Vec3;l.lerp(o[h[t][0]],o[h[t][1]],r/e),p.lerp(o[h[t][0]],o[h[t][2]],a/i),u.sub2(p,o[h[t][0]]),d.add2(l,u),s=r/e,n=a/i,f.push(d.x,d.y,d.z),m.push(c[t][0],c[t][1],c[t][2]),g.push(s,n),s=(s/=3)*primitiveUv1PaddingScale+primitiveUv1Padding,n=(n/=3)*primitiveUv1PaddingScale+primitiveUv1Padding,s+=t%3/3,n+=Math.floor(t/3)/3,y.push(s,n),r<e&&a<i&&(E.push(v+i+1,v+1,v),E.push(v+i+1,v+i+2,v+1)),v++}};T(0,s,r),T(l,s,r),T(p,s,n),T(u,s,n),T(d,n,r),T(_,n,r);var b={normals:m,uvs:g,uvs1:y,indices:E};return a&&(b.tangents=pc.calculateTangents(f,m,g,E)),pc.createMesh(t,f,b)},pc.getDefaultMaterial=function(){return pc.Application.getApplication().scene.defaultMaterial},Object.assign(pc,function(){var t=function(t){this.func=void 0===t.func?pc.FUNC_ALWAYS:t.func,this.ref=t.ref||0,this.readMask=void 0===t.readMask?255:t.readMask,this.writeMask=void 0===t.writeMask?255:t.writeMask,this.fail=t.fail||pc.STENCILOP_KEEP,this.zfail=t.zfail||pc.STENCILOP_KEEP,this.zpass=t.zpass||pc.STENCILOP_KEEP};return t.prototype.clone=function(){return new pc.StencilParameters({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})},{StencilParameters:t}}()),Object.assign(pc,function(){var t=function(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}};return t.prototype.getDuration=function(){return this.duration},t.prototype.getName=function(){return this.name},t.prototype.getNode=function(t){return this._nodeDict[t]},Object.defineProperty(t.prototype,"nodes",{get:function(){return this._nodes}}),t.prototype.getNodes=function(){return this._nodes},t.prototype.setDuration=function(t){this.duration=t},t.prototype.setName=function(t){this.name=t},t.prototype.addNode=function(t){this._nodes.push(t),this._nodeDict[t._name]=t},{Animation:t,Key:function(t,e,i,s){this.time=t,this.position=e,this.rotation=i,this.scale=s},Node:function(){this._name="",this._keys=[]}}}()),Object.assign(pc,function(){function t(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new pc.Quat,this._pos=new pc.Vec3,this._scale=new pc.Vec3,this._targetNode=null}Object.assign(t.prototype,{getTarget:function(){return this._targetNode},setTarget:function(t){this._targetNode=t}});var e=function(e){this._animation=null,this._time=0,this.looping=!0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={};var i=this;!function e(s){var n=new t;n._name=s.name,i._interpolatedKeys.push(n),i._interpolatedKeyDict[s.name]=n,i._currKeyIndices[s.name]=0;for(var r=0;r<s._children.length;r++)e(s._children[r])}(e)};return e.prototype.addTime=function(t){if(null!==this._animation){var e,i,s,n,r,a,o,h,c=this._animation._nodes,l=this._animation.duration;if(this._time===l&&!this.looping)return;if(this._time+=t,this._time>l)for(this._time=this.looping?0:l,e=0;e<c.length;e++)s=(i=c[e])._name,this._currKeyIndices[s]=0;else if(this._time<0)for(this._time=this.looping?l:0,e=0;e<c.length;e++)s=(i=c[e])._name,this._currKeyIndices[s]=i._keys.length-2;var p,u=t>=0?1:-1;for(e=0;e<c.length;e++){if(s=(i=c[e])._name,n=i._keys,r=this._interpolatedKeyDict[s],p=!1,1!==n.length)for(var d=this._currKeyIndices[s];d<n.length-1&&d>=0;d+=u)if(a=n[d],o=n[d+1],a.time<=this._time&&o.time>=this._time){h=(this._time-a.time)/(o.time-a.time),r._pos.lerp(a.position,o.position,h),r._quat.slerp(a.rotation,o.rotation,h),r._scale.lerp(a.scale,o.scale,h),r._written=!0,this._currKeyIndices[s]=d,p=!0;break}(1===n.length||!p&&0===this._time&&this.looping)&&(r._pos.copy(n[0].position),r._quat.copy(n[0].rotation),r._scale.copy(n[0].scale),r._written=!0)}}},e.prototype.blend=function(t,e,i){for(var s=this._interpolatedKeys.length,n=0;n<s;n++){var r=t._interpolatedKeys[n],a=e._interpolatedKeys[n],o=this._interpolatedKeys[n];r._written&&a._written?(o._quat.slerp(r._quat,e._interpolatedKeys[n]._quat,i),o._pos.lerp(r._pos,e._interpolatedKeys[n]._pos,i),o._scale.lerp(r._scale,a._scale,i),o._written=!0):r._written?(o._quat.copy(r._quat),o._pos.copy(r._pos),o._scale.copy(r._scale),o._written=!0):a._written&&(o._quat.copy(a._quat),o._pos.copy(a._pos),o._scale.copy(a._scale),o._written=!0)}},Object.defineProperty(e.prototype,"animation",{get:function(){return this._animation},set:function(t){this._animation=t,this.currentTime=0}}),e.prototype.getAnimation=function(){return this._animation},Object.defineProperty(e.prototype,"currentTime",{get:function(){return this._time},set:function(t){this._time=t;for(var e=this._interpolatedKeys.length,i=0;i<e;i++){var s=this._interpolatedKeys[i]._name;this._currKeyIndices[s]=0}this.addTime(0),this.updateGraph()}}),e.prototype.getCurrentTime=function(){return this._time},e.prototype.setCurrentTime=function(t){this.currentTime=t},Object.defineProperty(e.prototype,"numNodes",{get:function(){return this._interpolatedKeys.length}}),e.prototype.getNumNodes=function(){return this._interpolatedKeys.length},e.prototype.setAnimation=function(t){this.animation=t},e.prototype.setGraph=function(t){var e;if(t)for(e=0;e<this._interpolatedKeys.length;e++){var i=this._interpolatedKeys[e],s=t.findByName(i._name);this._interpolatedKeys[e].setTarget(s)}else for(e=0;e<this._interpolatedKeys.length;e++)this._interpolatedKeys[e].setTarget(null)},e.prototype.updateGraph=function(){if(this.graph)for(var t=0;t<this._interpolatedKeys.length;t++){var e=this._interpolatedKeys[t];if(e._written){var i=e.getTarget();i.localPosition.copy(e._pos),i.localRotation.copy(e._quat),i.localScale.copy(e._scale),i._dirtifyLocal(),e._written=!1}}},e.prototype.setLooping=function(t){this.looping=t},e.prototype.getLooping=function(){return this.looping},{Skeleton:e}}()),Object.assign(pc,function(){"use strict";function t(){return"undefined"!=typeof Audio}function e(){return!("undefined"==typeof AudioContext&&"undefined"==typeof webkitAudioContext)}var i=function(i){if(e()||i.forceWebAudioApi){if("undefined"!=typeof AudioContext?this.context=new AudioContext:"undefined"!=typeof webkitAudioContext&&(this.context=new webkitAudioContext),this.context){var s=this.context;if(this.resumeContext=function(){this.context.resume(),window.removeEventListener("mousedown",this.resumeContext),window.removeEventListener("touchend",this.resumeContext)}.bind(this),window.addEventListener("mousedown",this.resumeContext),window.addEventListener("touchend",this.resumeContext),pc.platform.ios){var n=function(){var t=s.createBuffer(1,1,44100),e=s.createBufferSource();e.buffer=t,e.connect(s.destination),e.start(0),e.disconnect(),i.canvas.removeEventListener("touchstart",n)};i.canvas.addEventListener("touchstart",n)}}}else console.warn("No support for 3D audio found");t()||console.warn("No support for 2D audio found"),this.listener=new pc.Listener(this),this._volume=1,this.suspended=!1,pc.events.attach(this)};return i.hasAudio=t,i.hasAudioContext=e,Object.assign(i.prototype,{suspend:function(){this.suspended=!0,this.fire("suspend")},resume:function(){this.suspended=!1,this.fire("resume")},destroy:function(){window.removeEventListener("mousedown",this.resumeContext),window.removeEventListener("touchend",this.resumeContext),this.fire("destroy"),this.context&&this.context.close&&(this.context.close(),this.context=null)},getListener:function(){return console.warn('DEPRECATED: getListener is deprecated. Get the "listener" field instead.'),this.listener},getVolume:function(){return console.warn('DEPRECATED: getVolume is deprecated. Get the "volume" property instead.'),this.volume},setVolume:function(t){console.warn('DEPRECATED: setVolume is deprecated. Set the "volume" property instead.'),this.volume=t},playSound:function(t,e){e=e||{};var i=null;return pc.Channel&&(i=new pc.Channel(this,t,e)).play(),i},playSound3d:function(t,e,i){i=i||{};var s=null;return pc.Channel3d&&((s=new pc.Channel3d(this,t,i)).setPosition(e),i.volume&&s.setVolume(i.volume),i.loop&&s.setLoop(i.loop),i.maxDistance&&s.setMaxDistance(i.maxDistance),i.minDistance&&s.setMinDistance(i.minDistance),i.rollOffFactor&&s.setRollOffFactor(i.rollOffFactor),i.distanceModel&&s.setDistanceModel(i.distanceModel),s.play()),s}}),Object.defineProperty(i.prototype,"volume",{get:function(){return this._volume},set:function(t){t=pc.math.clamp(t,0,1),this._volume=t,this.fire("volumechange",t)}}),pc.AudioManager=i,{SoundManager:i}}()),Object.assign(pc,function(){"use strict";var t=function(t){t instanceof Audio?this.audio=t:this.buffer=t};return Object.defineProperty(t.prototype,"duration",{get:function(){var t=0;return this.buffer?t=this.buffer.duration:this.audio&&(t=this.audio.duration),t||0}}),{Sound:t}}()),Object.assign(pc,function(){"use strict";var t=function(t){this.position=new pc.Vec3,this.velocity=new pc.Vec3,this.orientation=new pc.Mat4,pc.AudioManager.hasAudioContext()&&(this.listener=t.context.listener)};return Object.assign(t.prototype,{getPosition:function(){return this.position},setPosition:function(t){this.position.copy(t),this.listener&&this.listener.setPosition(t.x,t.y,t.z)},getVelocity:function(){return this.velocity},setVelocity:function(t){this.velocity.copy(t),this.listener&&this.listener.setPosition(t.x,t.y,t.z)},setOrientation:function(t){this.orientation.copy(t),this.listener&&this.listener.setOrientation(-t.data[8],-t.data[9],-t.data[10],t.data[4],t.data[5],t.data[6])},getOrientation:function(){return this.orientation}}),{Listener:t}}()),Object.assign(pc,function(){"use strict";var t,e=function(t,e){return t%e||0};return pc.SoundManager.hasAudioContext()?(t=function(t,e,i){pc.events.attach(this),i=i||{},this._volume=void 0!==i.volume?pc.math.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._sound=e,this._state=2,this._suspended=!1,this._suspendEndEvent=!1,this._suspendInstanceEvents=!1,this._startTime=Math.max(0,Number(i.startTime)||0),this._duration=Math.max(0,Number(i.duration)||0),this._startedAt=0,this._startOffset=null,this._currentTime=0,this._currentOffset=0,this._playWhenLoaded=!0,this._manager=t,this._inputNode=null,this._connectorNode=null,this._firstNode=null,this._lastNode=null,this._initializeNodes(),this._onPlayCallback=i.onPlay,this._onPauseCallback=i.onPause,this._onResumeCallback=i.onResume,this._onStopCallback=i.onStop,this._onEndCallback=i.onEnd,this._endedHandler=this._onEnded.bind(this),this.source=null},Object.assign(t.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain(),this._inputNode=this.gain,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)},play:function(){"running"!=this._manager.context.state&&this._manager.context.resume(),2!==this._state&&this.stop(),this.source||this._createSource();var t=e(this._startOffset,this.duration);return t=e(this._startTime+t,this._sound.duration),this._startOffset=null,this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=t,this._state=0,this._playWhenLoaded=!1,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0},pause:function(){return!(0!==this._state||!this.source)&&(this._updateCurrentTime(),this._state=1,this._suspendEndEvent=!0,this.source.stop(0),this.source=null,this._playWhenLoaded=!1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){if(1!==this._state)return!1;this.source||this._createSource();var t=this.currentTime;return null!==this._startOffset&&(t=e(this._startOffset,this.duration),t=e(this._startTime+t,this._sound.duration),this._startOffset=null),this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._state=0,this._startedAt=this._manager.context.currentTime,this._currentOffset=t,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume(),!0},stop:function(){return!(2===this._state||!this.source)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._startedAt=0,this._currentTime=0,this._currentOffset=0,this._startOffset=null,this._playWhenLoaded=!1,this._suspendEndEvent=!0,0===this._state&&this.source.stop(0),this.source.removeEventListener("ended",this._endedHandler),this.source=null,this._state=2,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(t,e){if(t){e||(e=t);var i=this._manager.context.destination;this._firstNode!==t&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(i),this._firstNode=t,this._connectorNode.connect(t)),this._lastNode!==e&&(this._lastNode&&this._lastNode.disconnect(i),this._lastNode=e,this._lastNode.connect(i))}else console.error("The firstNode must be a valid Audio Node")},clearExternalNodes:function(){var t=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(t),this._lastNode=null),this._connectorNode.connect(t)},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_createSource:function(){if(!this._sound)return null;var t=this._manager.context;return this._sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.addEventListener("ended",this._endedHandler),this.source.loopStart=e(this._startTime,this.source.buffer.duration),this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,e(this._startTime+this._duration,this.source.buffer.duration)))),this.source},_updateCurrentTime:function(){this._currentTime=e((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)},_onManagerDestroy:function(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}),Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(t){t=pc.math.clamp(t,0,1),this._volume=t,this.gain&&(this.gain.gain.value=t*this._manager.volume)}}),Object.defineProperty(t.prototype,"pitch",{get:function(){return this._pitch},set:function(t){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(t)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(t.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=!!t,this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(t.prototype,"sound",{get:function(){return this._sound},set:function(t){this._sound=t,2!==this._state?this.stop():this._createSource()}}),Object.defineProperty(t.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0},set:function(t){if(!(t<0))if(0===this._state){this.stop();var e=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this._startOffset=t,this.play(),this._suspendInstanceEvents=e}else this._startOffset=t,this._currentTime=t}})):pc.SoundManager.hasAudio()?(t=function(t,e,i){pc.events.attach(this),i=i||{},this._volume=void 0!==i.volume?pc.math.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._sound=e,this._state=2,this._suspended=!1,this._suspendEndEvent=!1,this._suspendInstanceEvents=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(i.startTime)||0),this._duration=Math.max(0,Number(i.duration)||0),this._startOffset=null,this._isReady=!1,this._manager=t,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._onPlayCallback=i.onPlay,this._onPauseCallback=i.onPause,this._onResumeCallback=i.onResume,this._onStopCallback=i.onStop,this._onEndCallback=i.onEnd,this.source=null,this._createSource()},Object.assign(t.prototype,{play:function(){return 2!==this._state&&this.stop(),!(!this.source&&!this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!(!this.source||0!==this._state)&&(this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!(!this.source||1!==this._state)&&(this._state=0,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!(!this.source||2===this._state)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;var t=e(this._startOffset,this.duration);t=e(this._startTime+t,this._sound.duration),this._startOffset=null,this.source.currentTime=t},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>e(this._startTime+this._duration,this.source.duration)&&(this.loop?this.source.currentTime=e(this._startTime,this.source.duration):(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(t){t=pc.math.clamp(t,0,1),this._volume=t,this.source&&(this.source.volume=t*this._manager.volume)}}),Object.defineProperty(t.prototype,"pitch",{get:function(){return this._pitch},set:function(t){this._pitch=Math.max(Number(t)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(t.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=!!t,this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(t.prototype,"sound",{get:function(){return this._sound},set:function(t){this.stop(),this._sound=t}}),Object.defineProperty(t.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(t){t<0||(this._startOffset=t,this.source&&this._isReady&&(this.source.currentTime=e(this._startTime+e(t,this.duration),this._sound.duration),this._startOffset=null))}})):t=function(){},Object.assign(t.prototype,{_onPlay:function(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)},_onPause:function(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)},_onResume:function(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)},_onStop:function(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)},_onEnded:function(){pc.SoundInstance.doNotSuspendEndEvent||!this._suspendEndEvent?(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop()):this._suspendEndEvent=!1},_onManagerVolumeChange:function(){this.volume=this._volume},_onManagerSuspend:function(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())},_onManagerResume:function(){this._suspended&&(this._suspended=!1,this.resume())}}),Object.defineProperty(t.prototype,"startTime",{get:function(){return this._startTime},set:function(t){this._startTime=Math.max(0,Number(t)||0);var e=0===this._state;this.stop(),e&&this.play()}}),Object.defineProperty(t.prototype,"duration",{get:function(){return this._sound?this._duration?e(this._duration,this._sound.duration):this._sound.duration:0},set:function(t){this._duration=Math.max(0,Number(t)||0);var e=0===this._state;this.stop(),e&&this.play()}}),Object.defineProperty(t.prototype,"isPlaying",{get:function(){return 0===this._state}}),Object.defineProperty(t.prototype,"isPaused",{get:function(){return 1===this._state}}),Object.defineProperty(t.prototype,"isStopped",{get:function(){return 2===this._state}}),Object.defineProperty(t.prototype,"isSuspended",{get:function(){return this._suspended}}),{SoundInstance:t}}()),Object.assign(pc,function(){"use strict";var t;if(pc.SoundManager.hasAudioContext())(t=function(t,e,i){pc.SoundInstance.call(this,t,e,i),i=i||{},this._position=new pc.Vec3,i.position&&(this.position=i.position),this._velocity=new pc.Vec3,i.velocity&&(this.velocity=i.velocity),this.maxDistance=void 0!==i.maxDistance?Number(i.maxDistance):1e4,this.refDistance=void 0!==i.refDistance?Number(i.refDistance):1,this.rollOffFactor=void 0!==i.rollOffFactor?Number(i.rollOffFactor):1,this.distanceModel=void 0!==i.distanceModel?i.distanceModel:pc.DISTANCE_LINEAR}).prototype=Object.create(pc.SoundInstance.prototype),t.prototype.constructor=t,Object.assign(t.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position.copy(t),this.panner.setPosition(t.x,t.y,t.z)}}),Object.defineProperty(t.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity.copy(t),this.panner.setVelocity(t.x,t.y,t.z)}}),Object.defineProperty(t.prototype,"maxDistance",{get:function(){return this.panner.maxDistance},set:function(t){this.panner.maxDistance=t}}),Object.defineProperty(t.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(t){this.panner.refDistance=t}}),Object.defineProperty(t.prototype,"rollOffFactor",{get:function(){return this.panner.rolloffFactor},set:function(t){this.panner.rolloffFactor=t}}),Object.defineProperty(t.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},set:function(t){this.panner.distanceModel=t}});else if(pc.SoundManager.hasAudio()){var e=new pc.Vec3;(t=function(t,e,i){pc.SoundInstance.call(this,t,e,i),i=i||{},this._position=new pc.Vec3,i.position&&(this.position=i.position),this._velocity=new pc.Vec3,i.velocity&&(this.velocity=i.velocity),this._maxDistance=void 0!==i.maxDistance?Number(i.maxDistance):1e4,this._refDistance=void 0!==i.refDistance?Number(i.refDistance):1,this._rollOffFactor=void 0!==i.rollOffFactor?Number(i.rollOffFactor):1,this._distanceModel=void 0!==i.distanceModel?i.distanceModel:pc.DISTANCE_LINEAR}).prototype=Object.create(pc.SoundInstance.prototype),t.prototype.constructor=t,Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){if(this._position.copy(t),this.source){var i=function(t,i,s,n,r,a){var o=(e=e.sub2(t,i)).length();if(o<s)return 1;if(o>n)return 0;var h=0;return a===pc.DISTANCE_LINEAR?h=1-r*(o-s)/(n-s):a===pc.DISTANCE_INVERSE?h=s/(s+r*(o-s)):a===pc.DISTANCE_EXPONENTIAL&&(h=Math.pow(o/s,-r)),pc.math.clamp(h,0,1)}(this._manager.listener.getPosition(),this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),s=this.volume;this.source.volume=s*i*this._manager.volume}}}),Object.defineProperty(t.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity.copy(t)}}),Object.defineProperty(t.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){this._maxDistance=t}}),Object.defineProperty(t.prototype,"refDistance",{get:function(){return this._refDistance},set:function(t){this._refDistance=t}}),Object.defineProperty(t.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t}}),Object.defineProperty(t.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(t){this._distanceModel=t}})}else t=function(){};return{SoundInstance3d:t}}()),Object.assign(pc,function(){"use strict";var t;return pc.AudioManager.hasAudioContext()?(t=function(t,e,i){i=i||{},this.volume=void 0===i.volume?1:i.volume,this.loop=void 0!==i.loop&&i.loop,this.pitch=void 0===i.pitch?1:i.pitch,this.sound=e,this.paused=!1,this.suspended=!1,this.startTime=0,this.startOffset=0,this.manager=t,this.source=null;var s=t.context;this.gain=s.createGain()},Object.assign(t.prototype,{play:function(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend())},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function(){!this.source&&this.paused?(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1)):console.warn("Call pause() before unpausing.")},stop:function(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setLoop:function(t){this.loop=t,this.source&&(this.source.loop=t)},setVolume:function(t){t=pc.math.clamp(t,0,1),this.volume=t,this.gain&&(this.gain.gain.value=t*this.manager.volume)},setPitch:function(t){this.pitch=t,this.source&&(this.source.playbackRate.value=t)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:0},_createSource:function(){var t=this.manager.context;this.sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this)))}})):pc.AudioManager.hasAudio()?(t=function(t,e,i){this.volume=i.volume||1,this.loop=i.loop||!1,this.sound=e,this.pitch=void 0!==i.pitch?i.pitch:1,this.paused=!1,this.suspended=!1,this.manager=t,e.audio&&(this.source=e.audio.cloneNode(!1),this.source.pause())},Object.assign(t.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(t){t=pc.math.clamp(t,0,1),this.volume=t,this.source&&(this.source.volume=t*this.manager.volume)},setLoop:function(t){this.loop=t,this.source&&(this.source.loop=t)},setPitch:function(t){this.pitch=t,this.source&&(this.source.playbackRate=t)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}})):t=function(){},Object.assign(t.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},onManagerResume:function(){this.suspended&&(this.suspended=!1,this.unpause())}}),{Channel:t}}()),Object.assign(pc,function(){"use strict";var t;if(pc.AudioManager.hasAudioContext())(t=function(t,e,i){pc.Channel.call(this,t,e,i),this.position=new pc.Vec3,this.velocity=new pc.Vec3;var s=t.context;this.panner=s.createPanner()}).prototype=Object.create(pc.Channel.prototype),t.prototype.constructor=t,Object.assign(t.prototype,{getPosition:function(){return this.position},setPosition:function(t){this.position.copy(t),this.panner.setPosition(t.x,t.y,t.z)},getVelocity:function(){return this.velocity},setVelocity:function(t){this.velocity.copy(t),this.panner.setVelocity(t.x,t.y,t.z)},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(t){this.panner.maxDistance=t},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(t){this.panner.refDistance=t},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(t){this.panner.rolloffFactor=t},getDistanceModel:function(){return this.pannel.distanceModel},setDistanceModel:function(t){this.panner.distanceModel=t},_createSource:function(){var t=this.manager.context;this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this))}});else if(pc.AudioManager.hasAudio()){var e=new pc.Vec3;(t=function(t,e){pc.Channel.call(this,t,e),this.position=new pc.Vec3,this.velocity=new pc.Vec3,this.maxDistance=1e4,this.minDistance=1,this.rollOffFactor=1,this.distanceModel=pc.DISTANCE_INVERSE}).prototype=Object.create(pc.Channel.prototype),t.prototype.constructor=t,Object.assign(t.prototype,{getPosition:function(){return this.position},setPosition:function(t){if(this.position.copy(t),this.source){var i=function(t,i,s,n,r,a){var o=(e=e.sub2(t,i)).length();if(o<s)return 1;if(o>n)return 0;var h=0;return a===pc.DISTANCE_LINEAR?h=1-r*(o-s)/(n-s):a===pc.DISTANCE_INVERSE?h=s/(s+r*(o-s)):a===pc.DISTANCE_EXPONENTIAL&&(h=Math.pow(o/s,-r)),pc.math.clamp(h,0,1)}(this.manager.listener.getPosition(),this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel),s=this.getVolume();this.source.volume=s*i}},getVelocity:function(){return this.velocity},setVelocity:function(t){this.velocity.copy(t)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(t){this.maxDistance=t},getMinDistance:function(){return this.minDistance},setMinDistance:function(t){this.minDistance=t},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(t){this.rollOffFactor=t},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(t){this.distanceModel=t}})}else t=function(){};return{Channel3d:t}}()),function(){var t={ACTION_MOUSE:"mouse",ACTION_KEYBOARD:"keyboard",ACTION_GAMEPAD:"gamepad",AXIS_MOUSE_X:"mousex",AXIS_MOUSE_Y:"mousey",AXIS_PAD_L_X:"padlx",AXIS_PAD_L_Y:"padly",AXIS_PAD_R_X:"padrx",AXIS_PAD_R_Y:"padry",AXIS_KEY:"key",EVENT_KEYDOWN:"keydown",EVENT_KEYUP:"keyup",EVENT_MOUSEDOWN:"mousedown",EVENT_MOUSEMOVE:"mousemove",EVENT_MOUSEUP:"mouseup",EVENT_MOUSEWHEEL:"mousewheel",EVENT_TOUCHSTART:"touchstart",EVENT_TOUCHEND:"touchend",EVENT_TOUCHMOVE:"touchmove",EVENT_TOUCHCANCEL:"touchcancel",KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ENTER:13,KEY_SHIFT:16,KEY_CONTROL:17,KEY_ALT:18,KEY_PAUSE:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_SPACE:32,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINT_SCREEN:44,KEY_INSERT:45,KEY_DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_SEMICOLON:59,KEY_EQUAL:61,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_WINDOWS:91,KEY_CONTEXT_MENU:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SEPARATOR:108,KEY_SUBTRACT:109,KEY_DECIMAL:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_COMMA:188,KEY_PERIOD:190,KEY_SLASH:191,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_META:224,MOUSEBUTTON_NONE:-1,MOUSEBUTTON_LEFT:0,MOUSEBUTTON_MIDDLE:1,MOUSEBUTTON_RIGHT:2,PAD_1:0,PAD_2:1,PAD_3:2,PAD_4:3,PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3};Object.assign(pc,t),pc.input={},Object.assign(pc.input,t)}(),Object.assign(pc,function(){var t=function(t,e){e?(this.key=e.keyCode,this.element=e.target,this.event=e):(this.key=null,this.element=null,this.event=null)},e=new t;function i(t){return e.key=t.keyCode,e.element=t.target,e.event=t,e}function s(t){return"string"==typeof t?t.toUpperCase().charCodeAt(0):t}var n={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},r=function(t,e){e=e||{},this._element=null,this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),pc.events.attach(this),this._keymap={},this._lastmap={},t&&this.attach(t),this.preventDefault=e.preventDefault||!1,this.stopPropagation=e.stopPropagation||!1};return r.prototype.attach=function(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1)},r.prototype.detach=function(){this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null},r.prototype.toKeyIdentifier=function(t){var e,i,r;t=s(t);var a=n[t.toString()];if(a)return a;for(r=(i=t.toString(16).toUpperCase()).length,e=0;e<4-r;e++)i="0"+i;return"U+"+i},r.prototype._handleKeyDown=function(t){var e=t.keyCode||t.charCode;if(void 0!==e){var s=this.toKeyIdentifier(e);this._keymap[s]=!0,this.fire("keydown",i(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}},r.prototype._handleKeyUp=function(t){var e=t.keyCode||t.charCode;if(void 0!==e){var s=this.toKeyIdentifier(e);delete this._keymap[s],this.fire("keyup",i(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}},r.prototype._handleKeyPress=function(t){this.fire("keypress",i(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()},r.prototype.update=function(){var t;for(t in this._lastmap)delete this._lastmap[t];for(t in this._keymap)this._keymap.hasOwnProperty(t)&&(this._lastmap[t]=this._keymap[t])},r.prototype.isPressed=function(t){var e=s(t),i=this.toKeyIdentifier(e);return!!this._keymap[i]},r.prototype.wasPressed=function(t){var e=s(t),i=this.toKeyIdentifier(e);return!!this._keymap[i]&&!this._lastmap[i]},r.prototype.wasReleased=function(t){var e=s(t),i=this.toKeyIdentifier(e);return!this._keymap[i]&&!!this._lastmap[i]},r.prototype.anyKey=function(){return Object.keys(this._keymap).length>0},r.prototype.anyKeyDown=function(){for(let t in this._keymap)if(this._keymap.hasOwnProperty(t)&&!this._lastmap.hasOwnProperty(t))return!0;return!1},{Keyboard:r,KeyboardEvent:t}}()),Object.assign(pc,function(){var t=function(e,i){var s={x:0,y:0};if(i){if(i instanceof t)throw Error("Expected MouseEvent");s=e._getTargetCoords(i)}else i={};if(s)this.x=s.x,this.y=s.y;else{if(!pc.Mouse.isPointerLocked())return;this.x=0,this.y=0}i.detail?this.wheel=-1*i.detail:i.wheelDelta?this.wheel=i.wheelDelta/120:this.wheel=0,pc.Mouse.isPointerLocked()?(this.dx=i.movementX||i.webkitMovementX||i.mozMovementX||0,this.dy=i.movementY||i.webkitMovementY||i.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),"mousedown"===i.type||"mouseup"===i.type?this.button=i.button:this.button=pc.MOUSEBUTTON_NONE,this.buttons=e._buttons.slice(0),this.element=i.target,this.ctrlKey=i.ctrlKey||!1,this.altKey=i.altKey||!1,this.shiftKey=i.shiftKey||!1,this.metaKey=i.metaKey||!1,this.event=i},e=function(t){this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=function(t){t.preventDefault()},this._target=null,this._attached=!1,this.attach(t),pc.events.attach(this)};return e.isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)},Object.assign(e.prototype,{attach:function(t){this._target=t,this._attached||(this._attached=!0,window.addEventListener("mouseup",this._upHandler,!1),window.addEventListener("mousedown",this._downHandler,!1),window.addEventListener("mousemove",this._moveHandler,!1),window.addEventListener("mousewheel",this._wheelHandler,!1),window.addEventListener("DOMMouseScroll",this._wheelHandler,!1))},detach:function(){this._attached&&(this._attached=!1,this._target=null,window.removeEventListener("mouseup",this._upHandler),window.removeEventListener("mousedown",this._downHandler),window.removeEventListener("mousemove",this._moveHandler),window.removeEventListener("mousewheel",this._wheelHandler),window.removeEventListener("DOMMouseScroll",this._wheelHandler))},disableContextMenu:function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},enablePointerLock:function(t,e){if(document.body.requestPointerLock){var i=function(){t(),document.removeEventListener("pointerlockchange",i)},s=function(){e(),document.removeEventListener("pointerlockerror",s)};t&&document.addEventListener("pointerlockchange",i,!1),e&&document.addEventListener("pointerlockerror",s,!1),document.body.requestPointerLock()}else e&&e()},disablePointerLock:function(t){if(document.exitPointerLock){var e=function(){t(),document.removeEventListener("pointerlockchange",e)};t&&document.addEventListener("pointerlockchange",e,!1),document.exitPointerLock()}},update:function(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]},isPressed:function(t){return this._buttons[t]},wasPressed:function(t){return this._buttons[t]&&!this._lastbuttons[t]},wasReleased:function(t){return!this._buttons[t]&&this._lastbuttons[t]},_handleUp:function(e){this._buttons[e.button]=!1;var i=new t(this,e);i.event&&this.fire(pc.EVENT_MOUSEUP,i)},_handleDown:function(e){this._buttons[e.button]=!0;var i=new t(this,e);i.event&&this.fire(pc.EVENT_MOUSEDOWN,i)},_handleMove:function(e){var i=new t(this,e);i.event&&(this.fire(pc.EVENT_MOUSEMOVE,i),this._lastX=i.x,this._lastY=i.y)},_handleWheel:function(e){var i=new t(this,e);i.event&&this.fire(pc.EVENT_MOUSEWHEEL,i)},_getTargetCoords:function(t){var e=this._target.getBoundingClientRect(),i=Math.floor(e.left),s=Math.floor(e.top);return t.clientX<i||t.clientX>=i+this._target.clientWidth||t.clientY<s||t.clientY>=s+this._target.clientHeight?null:{x:t.clientX-i,y:t.clientY-s}}}),{Mouse:e,MouseEvent:t}}()),Object.assign(pc,function(){var t=function(t,e){var i=pc.getTouchTargetCoords(t,e);this.id=t.identifier,this.x=i.x,this.y=i.y,this.target=e||t.target,this.touch=t},e=function(e,i,s){if(this.element=s||i.target,this.event=i,this.touches=[],this.changedTouches=[],i){var n,r=i.touches.length;for(n=0;n<r;n++)this.touches.push(new t(i.touches[n],this.element));for(r=i.changedTouches.length,n=0;n<r;n++)this.changedTouches.push(new t(i.changedTouches[n],this.element))}};Object.assign(e.prototype,{getTouchById:function(t,e){var i,s=e.length;for(i=0;i<s;i++)if(e[i].id===t)return e[i];return null}});var i=function(t){this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(t),pc.events.attach(this)};return Object.assign(i.prototype,{attach:function(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null},_handleTouchStart:function(t){this.fire("touchstart",new e(this,t))},_handleTouchEnd:function(t){this.fire("touchend",new e(this,t))},_handleTouchMove:function(t){t.preventDefault(),this.fire("touchmove",new e(this,t))},_handleTouchCancel:function(t){this.fire("touchcancel",new e(this,t))}}),{getTouchTargetCoords:function(t,e){var i=0,s=0;for(e=e||t.target;!(e instanceof HTMLElement);)e=e.parentNode;var n=e;do{i+=n.offsetLeft-n.scrollLeft,s+=n.offsetTop-n.scrollTop,n=n.offsetParent}while(n);return{x:t.pageX-i,y:t.pageY-s}},TouchDevice:i,TouchEvent:e}}()),Object.assign(pc,function(){var t=function(){};return t.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream"},t.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document"},t.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds"],Object.assign(t.prototype,{ContentType:t.ContentType,ResponseType:t.ResponseType,binaryExtensions:t.binaryExtensions,get:function(t,e,i){return"function"==typeof e&&(i=e,e={}),this.request("GET",t,e,i)},post:function(t,e,i,s){return"function"==typeof i&&(s=i,i={}),i.postdata=e,this.request("POST",t,i,s)},put:function(t,e,i,s){return"function"==typeof i&&(s=i,i={}),i.postdata=e,this.request("PUT",t,i,s)},del:function(t,e,i){return"function"==typeof e&&(i=e,e={}),this.request("DELETE",t,e,i)},request:function(e,i,s,n){var r,a,o,h,c,l=!1;if("function"==typeof s&&(n=s,s={}),s.callback=n,null==s.async&&(s.async=!0),null==s.headers&&(s.headers={}),null!=s.postdata)if(s.postdata instanceof Document)h=s.postdata;else if(s.postdata instanceof FormData)h=s.postdata;else if(s.postdata instanceof Object){var p=s.headers["Content-Type"];switch(void 0===p&&(s.headers["Content-Type"]=t.ContentType.FORM_URLENCODED,p=s.headers["Content-Type"]),p){case t.ContentType.FORM_URLENCODED:h="";var u=!0;for(var d in s.postdata)s.postdata.hasOwnProperty(d)&&(u?u=!1:h+="&",h+=escape(d)+"="+escape(s.postdata[d]));break;default:case t.ContentType.JSON:null==p&&(s.headers["Content-Type"]=t.ContentType.JSON),h=JSON.stringify(s.postdata)}}else h=s.postdata;for(var _ in c||(c=new XMLHttpRequest),!1===s.cache&&(o=pc.time.now(),(r=new pc.URI(i)).query?r.query=r.query+"&ts="+o:r.query="ts="+o,i=r.toString()),s.query&&(r=new pc.URI(i),a=pc.extend(r.getQuery(),s.query),r.setQuery(a),i=r.toString()),c.open(e,i,s.async),c.withCredentials=void 0!==s.withCredentials&&s.withCredentials,c.responseType=s.responseType||this._guessResponseType(i),s.headers)s.headers.hasOwnProperty(_)&&c.setRequestHeader(_,s.headers[_]);c.onreadystatechange=function(){this._onReadyStateChange(e,i,s,c)}.bind(this),c.onerror=function(){this._onError(e,i,s,c),l=!0}.bind(this);try{c.send(h)}catch(t){l||s.error(c.status,c,t)}return c},_guessResponseType:function(e){var i=new pc.URI(e),s=pc.path.getExtension(i.path);return t.binaryExtensions.indexOf(s)>=0?t.ResponseType.ARRAY_BUFFER:".xml"===s?t.ResponseType.DOCUMENT:t.ResponseType.TEXT},_isBinaryContentType:function(e){return[t.ContentType.MP4,t.ContentType.WAV,t.ContentType.OGG,t.ContentType.MP3,t.ContentType.BIN,t.ContentType.DDS].indexOf(e)>=0},_onReadyStateChange:function(t,e,i,s){if(4===s.readyState)switch(s.status){case 0:"/"!=e[0]&&this._onSuccess(t,e,i,s);break;case 200:case 201:case 206:case 304:this._onSuccess(t,e,i,s);break;default:this._onError(t,e,i,s)}},_onSuccess:function(e,i,s,n){var r,a,o;(a=n.getResponseHeader("Content-Type"))&&(o=a.split(";")[0].trim()),o===this.ContentType.JSON||i.split("?")[0].endsWith(".json")?r=JSON.parse(n.responseText):this._isBinaryContentType(o)?r=n.response:n.responseType===t.ResponseType.ARRAY_BUFFER?(logWARNING(pc.string.format("responseType: {0} being served with Content-Type: {1}",t.ResponseType.ARRAY_BUFFER,o)),r=n.response):r=n.responseType===t.ResponseType.DOCUMENT||o===this.ContentType.XML?n.responseXML:n.responseText,s.callback(null,r)},_onError:function(t,e,i,s){i.callback(s.status,null)}}),{Http:t,http:new t}}()),Object.assign(pc,function(){var t=function(e,i){i=i||{},pc.log.open(),pc.events.attach(this),t._applications[e.id]=this,t._currentApplication=this,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=!1,this._librariesLoaded=!1,this._fillMode=pc.FILLMODE_KEEP_ASPECT,this._resolutionMode=pc.RESOLUTION_FIXED,this._allowResize=!0,this.context=this,this.paused=!1,this.graphicsDevice=new pc.GraphicsDevice(e,i.graphicsDeviceOptions),this.counters=new pc.Counters(this.graphicsDevice),i.canvas=e,this._audioManager=new pc.SoundManager(i),this._entityIndex={},this.scene=new pc.Scene,this.root=new pc.Entity(this),this.root._enabledInHierarchy=!0,this._enableList=[],this._enableList.size=0,this._sceneRegistry=new pc.SceneRegistry(this);this.renderer=new pc.ForwardRenderer(this.graphicsDevice),this.renderer.scene=this.scene,this.keyboard=i.keyboard||null,this.mouse=i.mouse||null,this.touch=i.touch||null,this.gamepads=i.gamepads||null,this.elementInput=i.elementInput||null,this.elementInput&&(this.elementInput.app=this),this.vr=null,i.vr&&this._onVrChange(i.vr),this._inTools=!1,this._targetAspect=null,this._skyboxLast=0,this._scriptPrefix=i.scriptPrefix||"",this.systems=new pc.ComponentSystemRegistry;for(var n=[{class:pc.AnimationComponentSystem,args:[this]},{class:pc.CameraComponentSystem,args:[this]},{class:pc.LightComponentSystem,args:[this]},{class:pc.AudioSourceComponentSystem,args:[this,this._audioManager]},{class:pc.SoundComponentSystem,args:[this,this._audioManager]},{class:pc.AudioListenerComponentSystem,args:[this,this._audioManager]},{class:pc.ScreenComponentSystem,args:[this]},{class:pc.ElementComponentSystem,args:[this]},{class:pc.UnityComponentSystemManagerSystem,args:[this]},{class:pc.UnityComponentSystem,args:[this]},{class:pc.MeshFilterComponentSystem,args:[this]},{class:pc.RendererComponentSystem,args:[this]},{class:pc.AudioSourceUnitySystem,args:[this]},{class:pc.MonoBehaviourSystem,args:[this]},{class:pc.PhysicsSystem,args:[this]},{class:pc.RigidbodySystem,args:[this]},{class:pc.ColliderSystem,args:[this]},{class:pc.JointSystem,args:[this]},{class:pc.Physics2DSystem,args:[this]},{class:pc.Rigidbody2DSystem,args:[this]},{class:pc.Collider2DSystem,args:[this]},{class:pc.Joint2DSystem,args:[this]},{class:pc.ParticleSystemSystem,args:[this]},{class:pc.ParticleSystemRendererSystem,args:[this]},{class:pc.AnimatorSystem,args:[this]},{class:pc.ReflectionProbeSystem,args:[this]},{class:pc.AnimationSystem,args:[this]},{class:pc.VideoPlayerSystem,args:[this]},{class:pc.CanvasRendererSystem,args:[this]}],r=0;r<n.length;r++){var a=n[r].class;if(a){var o=n[r].args;this.systems.add(new a(o[0],o[1]))}}this._visibilityChangeHandler=this.onVisibilityChange.bind(this),void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this.tick=s(this)};t._currentApplication=null,t._applications={},t.getApplication=function(e){return e?t._applications[e]:t._currentApplication};var e=function(t){this.length=t,this.count=0,this.inc=function(){this.count++},this.done=function(){return this.count===this.length}};Object.assign(t.prototype,{configure:function(t,e){var i=this;pc.http.get(t,(function(t,s){if(t)e(t);else{var n=s.application_properties,r=s.scenes,a=s.assets;i._parseApplicationProperties(n,(function(t){i._onVrChange(n.vr),i._parseScenes(r),i._parseAssets(a),e(t||null)}))}}))},preload:function(t){var i=this;i.fire("preload:start");var s,n=this.assets.list({preload:!0}),r=new e(n.length),a=!1,o=function(){i.graphicsDevice&&!a&&r.done()&&(a=!0,i.fire("preload:end"),t())},h=n.length,c=function(){return r.count};if(r.length){var l=function(t){r.inc(),i.fire("preload:progress",c()/h),r.done()&&o()},p=function(t,e){r.inc(),i.fire("preload:progress",c()/h),r.done()&&o()};for(s=0;s<n.length;s++)n[s].loaded?(r.inc(),i.fire("preload:progress",c()/h),r.done()&&o()):(n[s].once("load",l),n[s].once("error",p),this.assets.load(n[s]))}else o()},getSceneUrl:function(t){var e=this._sceneRegistry.find(t);return e?e.url:null},loadSceneHierarchy:function(t,e){this._sceneRegistry.loadSceneHierarchy(t,e)},loadSceneSettings:function(t,e){this._sceneRegistry.loadSceneSettings(t,e)},loadScene:function(t,e){this._sceneRegistry.loadScene(t,e)},_preloadScripts:function(t,e){e()},_parseApplicationProperties:function(t,e){t.useDevicePixelRatio||(t.useDevicePixelRatio=t.use_device_pixel_ratio),t.resolutionMode||(t.resolutionMode=t.resolution_mode),t.fillMode||(t.fillMode=t.fill_mode),t.vrPolyfillUrl||(t.vrPolyfillUrl=t.vr_polyfill_url),this._width=t.width,this._height=t.height,t.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(t.resolutionMode,this._width,this._height),this.setCanvasFillMode(t.fillMode,this._width,this._height),t.vr&&t.vrPolyfillUrl&&(pc.VrManager.isSupported&&!pc.platform.android||t.libraries.push(t.vrPolyfillUrl)),e()},_parseScenes:function(t){if(t)for(var e=0;e<t.length;e++)this._sceneRegistry.add(t[e].name,t[e].url)},_parseAssets:function(t){var e,i,s=[],n={};for(e=0;e<this.scriptsOrder.length;e++)t[i=this.scriptsOrder[e]]&&(n[i]=!0,s.push(t[i]));for(i in t)n[i]||s.push(t[i]);for(e=0;e<s.length;e++){var r=s[e],a=new pc.Asset(r.name,r.type,r.file,r.data);a.id=parseInt(r.id,10),a.preload=!!r.preload&&r.preload,a.tags.add(r.tags),this.assets.add(a)}},_getScriptReferences:function(t){var e,i,s=[];t.settings.priority_scripts&&(s=t.settings.priority_scripts);var n=[],r={};for(e=0;e<s.length;e++)n.push(s[e]),r[s[e]]=!0;var a=t.entities;for(i in a)if(a[i].components.script){var o=a[i].components.script.scripts;for(e=0;e<o.length;e++)r[o[e].url]||(n.push(o[e].url),r[o[e].url]=!0)}return n},start:function(){this.frame=0,this.fire("start",{timestamp:pc.now(),target:this}),pc.ComponentSystem.initialize(this.root),this.fire("initialize"),pc.ComponentSystem.postInitialize(this.root),this.fire("postinitialize"),this.tick()},update:function(t){this.frame++,this.graphicsDevice.updateClientRect(),this.vr&&this.vr.poll(),pc.ComponentSystem.update(t,this._inTools),pc.ComponentSystem.postUpdate(t,this._inTools),this.fire("update",t),this.controller&&this.controller.update(t),this.mouse&&this.mouse.update(t),this.keyboard&&this.keyboard.update(t),this.gamepads&&this.gamepads.update(t),UnityEngine.Input.Update(),UnityEngine.SceneManagement.SceneManager.ProcessAsync()},render:function(){this.fire("prerender"),this.scene.syncHierarchy(this.root),pc._skipRenderCounter=0,this.renderer.renderComposition(),this.fire("postrender")},syncHierarchy:function(){this.scene.syncHierarchy(this.root)},setCanvasFillMode:function(t,e,i){this._fillMode=t;var s=this.resizeCanvas(e,i);this.graphicsDevice.resizeCanvas(s.width,s.height)},setCanvasResolution:function(t,e,i){this._resolutionMode=t,t===pc.RESOLUTION_AUTO&&void 0===e&&(e=this.graphicsDevice.canvas.clientWidth,i=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(e,i)},isFullscreen:function(){return!!document.fullscreenElement},enableFullscreen:function(t,e,i){t=t||this.graphicsDevice.canvas;var s=function(){e(),document.removeEventListener("fullscreenchange",s)},n=function(){i(),document.removeEventListener("fullscreenerror",n)};e&&document.addEventListener("fullscreenchange",s,!1),i&&document.addEventListener("fullscreenerror",n,!1),t.requestFullscreen?t.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):i()},disableFullscreen:function(t){var e=function(){t(),document.removeEventListener("fullscreenchange",e)};t&&document.addEventListener("fullscreenchange",e,!1),document.exitFullscreen()},isHidden:function(){return document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?this._audioManager.suspend():this._audioManager.resume()},resizeCanvas:function(t,e){if(this._allowResize){var i=window.innerWidth,s=window.innerHeight;if(navigator.isCocoonJS)t=i,e=s,this.graphicsDevice.resizeCanvas(t,e);else{if(this._fillMode===pc.FILLMODE_KEEP_ASPECT){var n=this._targetAspect||this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;n>i/s?e=(t=i)/n:t=(e=s)*n,this.minimumResolution&&(t<this.minimumResolution.x||e<this.minimumResolution.y)&&(t=this.minimumResolution.x,e=this.minimumResolution.y)}else this._fillMode===pc.FILLMODE_FILL_WINDOW&&(t=i,e=s);this.graphicsDevice.canvas.style.width=t+"px",this.graphicsDevice.canvas.style.height=e+"px",this._resolutionMode===pc.RESOLUTION_AUTO&&this.setCanvasResolution(pc.RESOLUTION_AUTO)}return{width:t,height:e}}},applySceneSettings:function(t){var e;this.scene.applySettings(t),t.render.hasOwnProperty("skybox")&&(t.render.skybox?(e=this.assets.get(t.render.skybox))?this.setSkybox(e):this.assets.once("add:"+t.render.skybox,this.setSkybox,this):this.setSkybox(null))},setSkybox:function(t){if(t){if(this._skyboxLast===t.id)return void(0!==this.scene.skyboxMip||t.loadFaces?this._onSkyboxChange(t):this._skyboxLoad(t));this._skyboxLast&&(this.assets.off("add:"+this._skyboxLast,this.setSkybox,this),this.assets.off("load:"+this._skyboxLast,this._onSkyboxChange,this),this.assets.off("remove:"+this._skyboxLast,this._skyboxRemove,this)),this._skyboxLast=t.id,this.assets.on("load:"+t.id,this._onSkyboxChange,this),this.assets.once("remove:"+t.id,this._skyboxRemove,this),t.resource&&this.scene.setSkybox(t.resources),this._skyboxLoad(t)}else{if(!this._skyboxLast)return;this._skyboxRemove({id:this._skyboxLast})}},_onVrChange:function(t){t?this.vr||(this.vr=new pc.VrManager(this)):this.vr&&(this.vr.destroy(),this.vr=null)},_onSkyboxChange:function(t){this.scene.setSkybox(t.resources)},_skyboxLoad:function(t){0===this.scene.skyboxMip&&(t.loadFaces=!0),this.assets.load(t),this._onSkyboxChange(t)},_skyboxRemove:function(t){this._skyboxLast&&(this.assets.off("add:"+t.id,this.setSkybox,this),this.assets.off("load:"+t.id,this._onSkyboxChange,this),this.assets.off("remove:"+t.id,this._skyboxRemove,this),this.scene.setSkybox(null),this._skyboxLast=null)},destroy:function(){var e,i;t._applications[this.graphicsDevice.canvas.id]=null,t._currentApplication===this&&(t._currentApplication=null),this.off("librariesloaded"),document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1),this._visibilityChangeHandler=null,this.onVisibilityChange=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.controller&&(this.controller=null);var s=this.systems.list;for(e=0,i=s.length;e<i;e++)s[e].destroy();pc.ComponentSystem.destroy();var n=this.assets.list();for(e=0;e<n.length;e++)n[e].unload(),n[e].off();for(var r in this.assets.off(),this.loader.getHandler("script")._cache){var a=this.loader.getHandler("script")._cache[r],o=a.parentNode;o&&o.removeChild(a)}this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=[],this.context=null,this.scripts.destroy(),this.scripts=null,this._sceneRegistry.destroy(),this._sceneRegistry=null,this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,pc.destroyPostEffectQuad(),this.graphicsDevice.destroy(),this.graphicsDevice=null,this.renderer=null,this.tick=null,this.off(),this._audioManager&&(this._audioManager.destroy(),this._audioManager=null),pc.http=new pc.Http,pc.script.app=null,pc.ParticleEmitter.DEFAULT_PARAM_TEXTURE=null}}),Object.defineProperty(t.prototype,"targetAspect",{get:function(){return this._targetAspect},set:function(t){this._targetAspect=t,this.setCanvasFillMode(this._fillMode,window.innerWidth,window.innerHeight)}});var i={},s=function(e){var s=e;return function(e){if(s.graphicsDevice){t._currentApplication=s,pc.app=s;var n=pc.now(),r=(n-(s._time||n))/1e3;r=pc.math.clamp(r,0,s.maxDeltaTime),r*=s.timeScale,s._time=n,UnityEngine.Time.Update(r),window.requestAnimationFrame(s.tick),s.graphicsDevice.contextLost||s.paused||(s.counters.startSection(pc.Counters.FRAME),s.update(r),s.counters.startSection(pc.Counters.RENDER),(s.autoRender||s.renderNextFrame)&&(s.render(),s.renderNextFrame=!1),s.counters.endSection(pc.Counters.RENDER),i.timestamp=pc.now(),i.target=s,s.fire("frameend",i),s.fire("frameEnd",i),s.vr&&s.vr.display&&s.vr.display.presenting&&s.vr.display.submitFrame(),s.counters.endSection(pc.Counters.FRAME),s.counters.tick())}}};return{FILLMODE_NONE:"NONE",FILLMODE_FILL_WINDOW:"FILL_WINDOW",FILLMODE_KEEP_ASPECT:"KEEP_ASPECT",RESOLUTION_AUTO:"AUTO",RESOLUTION_FIXED:"FIXED",Application:t}}()),pc.extend(pc,function(){var t=function(){this.scriptsTimestamp=0,this.animationsTimestamp=0,this.animatorsTimestamp=0,this.physics2dTimestamp=0,this.physicsTimestamp=0,this.renderTimestamp=0,this.frameTimestamp=0,this.scriptsTime=0,this.animationsTime=0,this.animatorsTime=0,this.physics2dTime=0,this.physicsTime=0,this.renderTime=0,this.frameTime=0,this.drawCalls=0,this.frames=0};t.prototype.reset=function(){this.scriptsTime=0,this.animationsTime=0,this.animatorsTime=0,this.physics2dTime=0,this.physicsTime=0,this.renderTime=0,this.frameTime=0,this.drawCalls=0,this.frames=0};var e=function(e){this.sample=new t,this.current=new t,this.webglVersion=window.WebGL2RenderingContext?2:1,this.webglExtensions=e.gl.getSupportedExtensions()};return e.SCRIPTS="scripts",e.ANIMATIONS="animations",e.ANIMATORS="animators",e.PHYSICS2D="physics2d",e.PHYSICS="physics",e.RENDER="render",e.FRAME="frame",e.prototype.getSnapshot=function(){var t=this.sample,e=Math.max(1,t.frames),i={scriptsTime:t.scriptsTime/e,animationsTime:t.animationsTime/e,animatorsTime:t.animatorsTime/e,physics2dTime:t.physics2dTime/e,physicsTime:t.physicsTime/e,renderTime:t.renderTime/e,frameTime:t.frameTime/e,drawCalls:t.drawCalls/e,webglVersion:this.webglVersion,webglExtensions:this.webglExtensions};return t.reset(),i},e.prototype.tick=function(){this.sample.frames++,this.sample.scriptsTime+=this.current.scriptsTime,this.sample.animationsTime+=this.current.animationsTime,this.sample.animatorsTime+=this.current.animatorsTime,this.sample.physics2dTime+=this.current.physics2dTime,this.sample.physicsTime+=this.current.physicsTime,this.sample.renderTime+=this.current.renderTime,this.sample.frameTime+=this.current.frameTime,this.sample.drawCalls+=this.current.drawCalls,this.current.reset()},e.prototype.recordDrawCalls=function(t){this.current.drawCalls+=t},e.prototype.startSection=function(t){this.current[t+"Timestamp"]=pc.time.now()},e.prototype.endSection=function(t){this.current[t+"Time"]+=pc.time.now()-this.current[t+"Timestamp"]},{Counters:e}}()),Object.assign(pc,function(){var t=function(t){this._app=t,this._list=[],this._index={},this._urlIndex={}};return t.prototype.destroy=function(){this._app=null},t.prototype.list=function(){return this._list},t.prototype.add=function(t,e){if(this._index.hasOwnProperty(t))return console.warn("pc.SceneRegistry: trying to add more than one scene called: "+t),!1;var i=new pc.SceneRegistryItem(t,e),s=this._list.push(i);return this._index[i.name]=s-1,this._urlIndex[i.url]=s-1,!0},t.prototype.find=function(t){return this._index.hasOwnProperty(t)?this._list[this._index[t]]:null},t.prototype.findByUrl=function(t){return this._urlIndex.hasOwnProperty(t)?this._list[this._urlIndex[t]]:null},t.prototype.remove=function(t){if(this._index.hasOwnProperty(t)){var e=this._index[t],i=this._list[e];for(delete this._urlIndex[i.url],delete this._index[t],this._list.splice(e,1),e=0;e<this._list.length;e++)i=this._list[e],this._index[i.name]=e,this._urlIndex[i.url]=e}},t.prototype.loadSceneHierarchy=function(t,e){var i=this,s=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&!pc.ABSOLUTE_URL.test(t)&&(t=pc.path.join(this._app.assets.prefix,t)),s.load(t,(function(n,r){if(n)e&&e(n);else{i._app._preloadScripts(r,(function(){i._app.systems.script.preloading=!0;var a=s.open(t,r);i._app.systems.script.preloading=!1,i._app.loader.clearCache(t,"hierarchy"),i._app.root.addChild(a),pc.ComponentSystem.initialize(a),pc.ComponentSystem.postInitialize(a),e&&e(n,a)}))}}))},t.prototype.loadSceneSettings=function(t,e){var i=this;this._app.assets&&this._app.assets.prefix&&!pc.ABSOLUTE_URL.test(t)&&(t=pc.path.join(this._app.assets.prefix,t)),this._app.loader.load(t,"scenesettings",(function(t,s){t?e&&e(t):(i._app.applySceneSettings(s),e&&e(null))}))},t.prototype.loadScene=function(t,e){var i=this,s=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!pc.ABSOLUTE_URL.test(t)&&(t=pc.path.join(this._app.assets.prefix,t)),s.load(t,(function(n,r){if(n)e&&e(n);else{i._app._preloadScripts(r,(function(){i._app.systems.script.preloading=!0;var n=s.open(t,r);i._app.systems.script.preloading=!1,i._app.loader.clearCache(t,"scene"),i._app.loader.patch({resource:n,type:"scene"},i._app.assets),i._app.root.addChild(n.root),i._app.systems.rigidbody&&"undefined"!=typeof Ammo&&i._app.systems.rigidbody.setGravity(n._gravity.x,n._gravity.y,n._gravity.z),e&&e(null,n)}))}}))},{SceneRegistry:t,SceneRegistryItem:function(t,e){this.name=t,this.url=e}}}()),Object.assign(pc,function(){var t=function(){this.list=[]};return Object.assign(t.prototype,{add:function(t){var e=t.id;if(this[e])throw new Error(pc.string.format("ComponentSystem name '{0}' already registered or not allowed",e));this[e]=t,this.list.push(t)},remove:function(t){var e=t.id;if(!this[e])throw new Error(pc.string.format("No ComponentSystem named '{0}' registered",e));delete this[e];var i=this.list.indexOf(this[e]);-1!==i&&this.list.splice(i,1)}}),{ComponentSystemRegistry:t}}()),Object.assign(pc,function(){var t=function(t){this.app=t,this.store={},this.schema=[],pc.events.attach(this)};function e(t,e){if(!t)return t;switch(t=t&&t.data?t.data:t,e){case"rgb":return new pc.Color(t[0],t[1],t[2]);case"rgba":return new pc.Color(t[0],t[1],t[2],t[3]);case"vec2":return new pc.Vec2(t[0],t[1]);case"vec3":return new pc.Vec3(t[0],t[1],t[2]);case"vec4":return new pc.Vec4(t[0],t[1],t[2],t[3]);case"boolean":case"number":case"string":case"entity":return t;default:throw new Error("Could not convert unhandled type: "+e)}}return Object.assign(t,{initialize:function(e){t.fire("initialize",e)},postInitialize:function(e){t.fire("postInitialize",e)},update:function(e,i){t.fire(i?"toolsUpdate":"update",e)},fixedUpdate:function(e,i){t.fire("fixedUpdate",e)},postUpdate:function(e,i){t.fire("postUpdate",e)}}),t.prototype={addComponent:function(t,e){var i=new this.ComponentType(this,t);return e=e||{},this.store[t.getGuid()]={entity:t,data:i.data},t[this.id]=i,t.c[this.id]=i,t.$prefab&&"element"!=this.id||this.initializeComponentData(i,e,[]),this.fire("add",t,i),i},removeComponent:function(t){var e=this.store[t.getGuid()],i=t.c[this.id];this.fire("beforeremove",t,i),delete this.store[t.getGuid()],delete t[this.id],delete t.c[this.id],this.fire("remove",t,e.data)},cloneComponent:function(t,e){var i=t[this.id];return this.addComponent(e,i.data)},initializeComponentData:function(t,i,s){var n,r,a,o;i=i||{};for(var h=0,c=s.length;h<c;h++)"object"==typeof(n=s[h])?(r=n.name,a=n.type):(r=n,a=void 0),void 0!==(o=i[r])&&(void 0!==a&&(o=e(o,a)),t[r]=o);t.enabled&&t.entity.enabled&&t.onEnable()},getPropertiesOfType:function(t){var e=[];return(this.schema||[]).forEach((function(i){i&&"object"==typeof i&&i.type===t&&e.push(i)})),e},destroy:function(){this.off()},findComponentsOnActiveEntities:function(t,e){let i=t?null:[];for(const s in this.store){let n=this.store[s].entity;if(!n.enabled)continue;let r=n.c[this.id];if(!e||e(r)){if(t)return r;i.push(r)}}return t?null:i}},pc.events.attach(t),t.destroy=function(){t.off("initialize"),t.off("postInitialize"),t.off("toolsUpdate"),t.off("update"),t.off("fixedUpdate"),t.off("postUpdate")},{ComponentSystem:t}}()),Object.assign(pc,function(){var t=0,e=function(e,i){this.id=t++,this.system=e,this.entity=i,this.data=new e.DataType,pc.events.attach(this),this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",(function(t,e,i){this.fire("set_"+t,t,e,i)})),this.on("set_enabled",this.onSetEnabled,this)};return e._buildAccessors=function(t,e){e.forEach((function(e){var i="object"==typeof e?e.name:e;Object.defineProperty(t,i,{get:function(){return this.data[i]},set:function(t){var e=this.data,s=e[i];e[i]=t,this.fire("set",i,s,t)},configurable:!0})})),t._accessorsBuilt=!0},e.prototype={buildAccessors:function(t){e._buildAccessors(this,t)},onSetEnabled:function(t,e,i){e!==i&&this.entity.enabled&&(i?this.onEnable():this.onDisable())},onEnable:function(){},onDisable:function(){},destroy:function(){this.system&&this.entity&&this.system.removeComponent(this.entity)},onPostStateChange:function(){},toUnityObject:function(){return this.unityClass?UnityEngine.Object.FromHandle(this.unityClass,this):null}},{Component:e}}()),Object.assign(pc,{ComponentData:function(){}}),Object.assign(pc,function(){var t=new pc.Vec4(0,0,1,1),e=new pc.Vec2,i=function(t,e){pc.Component.call(this,t,e),this.on("set_aspectRatioMode",this.onSetAspectRatioMode,this),this.on("set_aspectRatio",this.onSetAspectRatio,this),this.on("set_camera",this.onSetCamera,this),this.on("set_clearColor",this.onSetClearColor,this),this.on("set_fov",this.onSetFov,this),this.on("set_orthoHeight",this.onSetOrthoHeight,this),this.on("set_nearClip",this.onSetNearClip,this),this.on("set_farClip",this.onSetFarClip,this),this.on("set_projection",this.onSetProjection,this),this.on("set_clearColorBuffer",this.updateClearFlags,this),this.on("set_clearDepthBuffer",this.updateClearFlags,this),this.on("set_clearStencilBuffer",this.updateClearFlags,this),this.on("set_clearSkybox",this.updateClearFlags,this),this.on("set_renderTarget",this.onSetRenderTarget,this),this.on("set_rect",this.onSetRect,this),this.on("set_scissorRect",this.onSetScissorRect,this),this.on("set_horizontalFov",this.onSetHorizontalFov,this),this.on("set_frustumCulling",this.onSetFrustumCulling,this),this.on("set_calculateTransform",this.onSetCalculateTransform,this),this.on("set_calculateProjection",this.onSetCalculateProjection,this),this.on("set_cullFaces",this.onSetCullFaces,this),this.on("set_cullingMask",this.onSetCullingMask,this),this.device=pc.Application.getApplication().graphicsDevice};return(i.prototype=Object.create(pc.Component.prototype)).constructor=i,Object.defineProperty(i.prototype,"projectionMatrix",{get:function(){return this.data.camera.getProjectionMatrix()},set:function(t){this.data.camera.setProjectionMatrix(t)}}),Object.defineProperty(i.prototype,"viewMatrix",{get:function(){return this.data.camera._node.getWorldTransform().clone().invert()}}),Object.defineProperty(i.prototype,"frustum",{get:function(){return this.data.camera.frustum}}),Object.defineProperty(i.prototype,"vrDisplay",{get:function(){return this.data.camera.vrDisplay},set:function(t){this.data.camera.vrDisplay=t,t&&(t._camera=this.data.camera)}}),Object.defineProperty(i.prototype,"node",{get:function(){return this.data.camera._node}}),Object.assign(i.prototype,{screenToWorld:function(t,e,i,s){var n=this.system.app.graphicsDevice;return this.data.camera.screenToWorld(t,e,i,n.clientRect.width,n.clientRect.height,s)},worldToScreen:function(t,e){var i=this.system.app.graphicsDevice;return this.data.camera.worldToScreen(t,i.clientRect.width,i.clientRect.height,e)},onSetAspectRatioMode:function(t,e,i){this.data.camera.aspectRatioMode=i},onSetAspectRatio:function(t,e,i){this.data.camera.aspectRatio=i},onSetCamera:function(t,e,i){e&&(e._node=null),i._node=this.entity},onSetClearColor:function(t,e,i){var s=this.data.camera.clearColor;s[0]=i.r,s[1]=i.g,s[2]=i.b,s[3]=i.a},onSetFov:function(t,e,i){this.data.camera.fov=i},onSetCullingMask:function(t,e,i){this.data.camera.cullingMask=i},onSetOrthoHeight:function(t,e,i){this.data.camera.orthoHeight=i},onSetNearClip:function(t,e,i){this.data.camera.nearClip=i},onSetFarClip:function(t,e,i){this.data.camera.farClip=i},onSetHorizontalFov:function(t,e,i){this.data.camera.horizontalFov=i},onSetFrustumCulling:function(t,e,i){this.data.camera.frustumCulling=i},onSetCalculateTransform:function(t,e,i){this._calculateTransform=i,this.camera._vpDirty=this.camera.overrideCalculateTransform!=!!i,this.camera.overrideCalculateTransform=!!i},onSetCalculateProjection:function(t,e,i){this._calculateProjection=i,this.camera._projMatDirty=!0,this.camera.overrideCalculateProjection=!!i,this.camera._vpDirty=this.camera.overrideCalculateProjection!=!!i},onSetCullFaces:function(t,e,i){this.camera._cullFaces=i},onSetProjection:function(t,e,i){this.data.camera.projection=i},addCameraToScene:function(){this.system.app.scene.addCamera(this)},removeCameraFromScene:function(){this.system.app.scene.removeCamera(this)},updateClearFlags:function(){var t=0;this.clearColorBuffer&&(t|=pc.CLEARFLAG_COLOR),this.clearDepthBuffer&&(t|=pc.CLEARFLAG_DEPTH),this.clearStencilBuffer&&(t|=pc.CLEARFLAG_STENCIL),this.clearSkybox&&(t|=pc.CLEARFLAG_USE_SKYBOX),this.data.camera.clearFlags=t},onSetRenderTarget:function(t,e,i){this.data.camera.renderTarget=i},onSetRect:function(t,e,i){this.data.camera.setRect(i.x,i.y,i.z,i.w)},onSetScissorRect:function(t,e,i){this.data.camera.setScissorRect(i.x,i.y,i.z,i.w)},onEnable:function(){this.system.addCamera(this),this.enabled&&this.entity.enabled&&this.addCameraToScene(),this.postEffects.enable()},onDisable:function(){this.postEffects.disable(),this.removeCameraFromScene(),this.system.removeCamera(this)},calculateAspectRatio:function(t){var e=t||this.system.app.graphicsDevice,i=this.rect;return e.width*i.z/(e.height*i.w)},frameBegin:function(t){this.aspectRatioMode===pc.ASPECT_AUTO&&(this.aspectRatio=this.calculateAspectRatio(t)),this.data.isRendering=!0},frameEnd:function(){this.data.isRendering=!1},resetProjectionMatrix:function(){this.camera.resetProjectionMatrix()},changeAspectRatio:function(t){this.aspectRatioMode=pc.ASPECT_MANUAL,this.aspectRatio=t},resetAspect:function(){this.aspectRatioMode=pc.ASPECT_AUTO}}),Object.defineProperty(i.prototype,"unityRect",{get:function(){return this.rect},set:function(t){this.rect=t}}),Object.defineProperty(i.prototype,"unityPixelRect",{get:function(){var i=this.renderTarget;return i?(e.x=i.width,e.y=i.height):(e.x=this.device.width,e.y=this.device.height),t.copy(this.rect),t.x*=e.x,t.y*=e.y,t.z*=e.x,t.w*=e.y,t},set:function(t){var i=this.renderTarget;i?(e.x=i.width,e.y=i.height):(e.x=this.device.width,e.y=this.device.height),this.rect=new pc.Vec4(t.x/e.x,t.y/e.y,t.z/e.x,t.w/e.y)}}),{CameraComponent:i}}()),Object.assign(pc,function(){var t=["enabled","clearColorBuffer","clearColor","clearDepthBuffer","clearSkybox","clearStencilBuffer","frustumCulling","projection","fov","orthoHeight","nearClip","farClip","priority","rect","scissorRect","camera","aspectRatio","aspectRatioMode","horizontalFov","model","renderTarget","calculateTransform","calculateProjection","cullFaces","flipFaces","layers","cullingMask"],e=function(e){pc.ComponentSystem.call(this,e),this.id="camera",this.description="Renders the scene from the location of the Entity.",this.ComponentType=pc.CameraComponent,this.DataType=pc.CameraComponentData,this.schema=t,this.cameras=[],this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this),pc.ComponentSystem.on("update",this.onUpdate,this)};return(e.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=e,pc.Component._buildAccessors(pc.CameraComponent.prototype,t),Object.assign(e.prototype,{initializeComponentData:function(t,e,i){for(var s={},n=0,r=(i=["postEffects","enabled","model","camera","aspectRatio","aspectRatioMode","horizontalFov","renderTarget","clearColor","fov","orthoHeight","nearClip","farClip","projection","priority","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","clearSkybox","frustumCulling","rect","scissorRect","calculateTransform","calculateProjection","cullFaces","flipFaces","layers","cullingMask"]).length;n<r;n++){var a=i[n];s[a]=e[a]}if(s.layers&&"array"===pc.type(s.layers)&&(s.layers=s.layers.slice(0)),s.clearColor&&"array"===pc.type(s.clearColor)){var o=s.clearColor;s.clearColor=new pc.Color(o[0],o[1],o[2],o[3])}if(s.rect&&"array"===pc.type(s.rect)){var h=s.rect;s.rect=new pc.Vec4(h[0],h[1],h[2],h[3])}if(s.scissorRect&&"array"===pc.type(s.scissorRect)){var c=s.scissorRect;s.scissorRect=new pc.Vec4(c[0],c[1],c[2],c[3])}s.activate&&(console.warn("WARNING: activate: Property is deprecated. Set enabled property instead."),s.enabled=s.activate),s.camera=new pc.Camera,s._node=t.entity,s.camera._component=t;var l=t;s.camera.calculateTransform=function(t,e){return l._calculateTransform?l._calculateTransform(t,e):null},s.camera.calculateProjection=function(t,e){return l._calculateProjection?l._calculateProjection(t,e):null},s.postEffects=new pc.PostEffectQueue(this.app,t),pc.ComponentSystem.prototype.initializeComponentData.call(this,t,s,i)},onBeforeRemove:function(t,e){this.removeCamera(e)},onRemove:function(t,e){e.camera=null},onUpdate:function(t){var e,i,s,n,r=this.store;if(this.app.vr)for(var a in r)n=(s=(i=(e=r[a]).data).camera).vrDisplay,i.enabled&&e.entity.enabled&&n&&(n.setClipPlanes(s._nearClip,s._farClip),s._node&&(s._node.localTransform.copy(n.combinedViewInv),s._node._dirtyLocal=!1,s._node._dirtifyWorld()))},addCamera:function(t){this.cameras.push(t),this.sortCamerasByPriority()},removeCamera:function(t){var e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),this.sortCamerasByPriority())},sortCamerasByPriority:function(){this.cameras.sort((function(t,e){return t.priority-e.priority}))}}),{CameraComponentSystem:e}}()),Object.assign(pc,{CameraComponentData:function(){this.clearColor=new pc.Color(.722,.722,.722,1),this.clearColorBuffer=!0,this.clearDepthBuffer=!0,this.clearStencilBuffer=!0,this.clearSkybox=!0,this.nearClip=.1,this.farClip=1e3,this.fov=45,this.orthoHeight=100,this.projection=pc.PROJECTION_PERSPECTIVE,this.priority=0,this.rect=new pc.Vec4(0,0,1,1),this.scissorRect=new pc.Vec4(0,0,1,1),this.enabled=!0,this.frustumCulling=!1,this.cullFaces=!0,this.flipFaces=!1,this.layers=[pc.LAYERID_WORLD,pc.LAYERID_DEPTH,pc.LAYERID_SKYBOX,pc.LAYERID_UI,pc.LAYERID_IMMEDIATE],this.camera=null,this.aspectRatio=16/9,this.aspectRatioMode=pc.ASPECT_AUTO,this.renderTarget=null,this.postEffects=null,this.isRendering=!1,this.calculateTransform=null,this.calculateProjection=null}}),Object.assign(pc,function(){function t(t,e){var i=this;this.app=t,this.camera=e,this.effects=[],this.enabled=!1,this.depthTarget=null,this.renderTargetScale=1,this.resizeTimeout=null,this.resizeLast=0,this._resizeTimeoutCallback=function(){i.resizeRenderTargets()},e.on("set_rect",this.onCameraRectChanged,this),this._origOverrideClear=!1,this._origClearColorBuffer=!1,this._origDepthColorBuffer=!1,this._origStencilColorBuffer=!1}return Object.assign(t.prototype,{_createOffscreenTarget:function(t,e){var i=this.camera.rect,s=Math.floor(i.z*this.app.graphicsDevice.width*this.renderTargetScale),n=Math.floor(i.w*this.app.graphicsDevice.height*this.renderTargetScale),r=this.app.graphicsDevice,a=e?r.getHdrFormat():pc.PIXELFORMAT_R8_G8_B8_A8,o=new pc.Texture(r,{format:a,width:s,height:n});return o.minFilter=pc.FILTER_NEAREST,o.magFilter=pc.FILTER_NEAREST,o.addressU=pc.ADDRESS_CLAMP_TO_EDGE,o.addressV=pc.ADDRESS_CLAMP_TO_EDGE,new pc.RenderTarget(this.app.graphicsDevice,o,{depth:t})},_resizeOffscreenTarget:function(t){var e=this.camera.rect,i=Math.floor(e.z*this.app.graphicsDevice.width*this.renderTargetScale),s=Math.floor(e.w*this.app.graphicsDevice.height*this.renderTargetScale),n=this.app.graphicsDevice,r=t.colorBuffer.format;t._colorBuffer.destroy();var a=new pc.Texture(n,{format:r,width:i,height:s});a.minFilter=pc.FILTER_NEAREST,a.magFilter=pc.FILTER_NEAREST,a.addressU=pc.ADDRESS_CLAMP_TO_EDGE,a.addressV=pc.ADDRESS_CLAMP_TO_EDGE,t._colorBuffer=a,t.destroy()},setRenderTargetScale:function(t){this.renderTargetScale=t,this.resizeRenderTargets()},addEffect:function(t){var e=0===this.effects.length,i=this.effects,s={effect:t,inputTarget:this._createOffscreenTarget(e,t.hdr),outputTarget:null};if(!this.layer){this.layer=new pc.Layer({opaqueSortMode:pc.SORTMODE_NONE,transparentSortMode:pc.SORTMODE_NONE,passThrough:!0,name:"PostEffectQueue",renderTarget:this.camera.renderTarget,clear:!1,onPostRender:function(){for(var t=0;t<this._commandList.length;t++)this._commandList[t]()}});var n,r=this.app.scene.layers.layerList,a=0,o=r.length-1;for(n=o;n>=0;n--)if(r[n].id===pc.LAYERID_UI){o=n-1,this._origOverrideClear=r[n].overrideClear,this._origClearColorBuffer=r[n].clearColorBuffer,this._origDepthColorBuffer=r[n].clearDepthBuffer,this._origStencilColorBuffer=r[n].clearStencilBuffer,r[n].overrideClear=!0,r[n].clearColorBuffer=!1,r[n].clearDepthBuffer=this.camera.clearDepthBuffer,r[n].clearStencilBuffer=this.camera.clearStencilBuffer;break}for(n=o;n>=0;n--)r[n].cameras.indexOf(this.camera)>=0&&(0===a&&(a=n+1),r[n].renderTarget=s.inputTarget);this.app.scene.layers.insertOpaque(this.layer,a),this.layer._commandList=[],this.layer.isPostEffect=!0}i.push(s);var h=i.length;h>1&&(i[h-2].outputTarget=s.inputTarget),this.enable()},removeEffect:function(t){for(var e=-1,i=0,s=this.effects.length;i<s;i++)if(this.effects[i].effect===t){e=i;break}e>=0&&(e>0?this.effects[e-1].outputTarget=e+1<this.effects.length?this.effects[e+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this.effects[1].inputTarget.destroy(),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr)),this.camera.renderTarget=this.effects[1].inputTarget),this.effects[e].inputTarget.destroy(),this.effects.splice(e,1)),this.enabled&&t.needsDepthBuffer&&this.camera.releaseDepthMap(),0===this.effects.length&&this.disable()},requestDepthMap:function(){for(var t=0,e=this.effects.length;t<e;t++){this.effects[t].effect.needsDepthBuffer&&this.camera.camera.requestDepthMap()}},releaseDepthMap:function(){for(var t=0,e=this.effects.length;t<e;t++){this.effects[t].effect.needsDepthBuffer&&this.camera.releaseDepthMap()}},destroy:function(){for(var t=0,e=this.effects.length;t<e;t++)this.effects[t].inputTarget.destroy();this.effects.length=0,this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var t=this;this.requestDepthMap(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.command=function(){if(t.enabled){var e=null,i=t.effects.length;if(i){t.layer.renderTarget=t.effects[0].inputTarget;for(var s=0;s<i;s++){var n=t.effects[s];s===i-1&&(e=t.camera.rect),n.effect.render(n.inputTarget,n.outputTarget,e)}}}},this.layer._commandList.push(this.command)}},disable:function(){if(this.enabled){this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this.camera.renderTarget=null,this.releaseDepthMap();var t=this.layer._commandList.indexOf(this.command);t>=0&&this.layer._commandList.splice(t,1);var e=this.app.scene.layers.layerList,i=e.length-1;for(t=0;t<=e.length;t++)if(e[t].id===pc.LAYERID_UI){i=t-1,e[t].overrideClear=this._origOverrideClear,e[t].clearColorBuffer=this._origClearColorBuffer,e[t].clearDepthBuffer=this._origDepthColorBuffer,e[t].clearStencilBuffer=this._origStencilColorBuffer;break}for(t=i;t>=0;t--)e[t].cameras.indexOf(this.camera)>=0&&(e[t].renderTarget=void 0);this.app.scene.layers.removeOpaque(this.layer),this.layer=null}},_onCanvasResized:function(t,e){var i=this.camera.rect,s=this.app.graphicsDevice;this.camera.camera.aspectRatio=s.width*i.z/(s.height*i.w),this.resizeTimeout||(pc.now()-this.resizeLast>100?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))},resizeRenderTargets:function(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.resizeLast=pc.now();for(var t=this.camera.rect,e=Math.floor(t.z*this.app.graphicsDevice.width*this.renderTargetScale),i=Math.floor(t.w*this.app.graphicsDevice.height*this.renderTargetScale),s=this.effects,n=0,r=s.length;n<r;n++){var a=s[n];a.inputTarget.width===e&&a.inputTarget.height===i||this._resizeOffscreenTarget(a.inputTarget)}},onCameraRectChanged:function(t,e,i){this.enabled&&this.resizeRenderTargets()}}),{PostEffectQueue:t}}()),Object.assign(pc,function(){var t,e=[null,null],i=null,s=new pc.Vec4,n=new Float32Array(4),r=[],a=!1,o=!1,h=!1,c=/uniform[ \t\n\r]+\S+[ \t\n\r]+\S+[ \t\n\r]*\;/g,l=/\S+[ \t\n\r]*\;/,p=/[ \t\n\r]*\;/,u=/(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^\;]+[ \t\n\r]*\,*)+\;/g,d=/(float|int|bool|vec2|vec3|vec4|struct|\,|\;|\{|\})/g,_=/(uniform|varying|in|out)[ \t\n\r]+(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^\;]+[ \t\n\r]*\,*)+\;/g,f=/(float|int|bool|vec2|vec3|vec4|struct|uniform|varying|in|out|\,|\;|\{|\})/g,m=/#version/g,g=/out highp vec4 pc_fragColor;/g,y=/#define gl_FragColor/g,E=/gl_FragColor/g,v=/uniform[ \t\n\r]+sampler2D[ \t\n\r]+uColorBuffer;/g,T=/(varying|in)[ \t\n\r]+vec2[ \t\n\r]+vUv0;/g,b=/(texture2D|texture)[ \t\n\r]*\([ \t\n\r]*uColorBuffer/g,A=/void[ \t\n\r]+main/g,S=function(t,i,s){var n=new pc.Texture(i,{format:s,width:i.width,height:i.height});n.minFilter=pc.FILTER_NEAREST,n.magFilter=pc.FILTER_NEAREST,n.addressU=pc.ADDRESS_CLAMP_TO_EDGE,n.addressV=pc.ADDRESS_CLAMP_TO_EDGE,e[t]._colorBuffer=n},R=function(t){e[t].colorBuffer.destroy(),e[t].destroy()},I=function(t){for(var e,i,s,n=t.match(c)||[],r=[],a=0;a<n.length;a++)e=n[a].search(l),i=n[a].search(p),"uColorBuffer"!==(s=n[a].substr(e,i-e))&&r.push(s);return r},C=function(t,e,i,s){var n,r,a,o,h,c=I(s.definition.fshader);if(0===c.length)return!1;for(n=0;n<i;n++)for(r=0;r<c.length;r++)for(h=c[r],o=I(t[e[n]].shader.definition.fshader),a=0;a<o.length;a++)if(o[a]===h)return!0;return!1},M=function(t,e){var i,s,n,r=t.length,a=0,o=0,h=0,c=0,l="";for(s=0;s<r;s++)"{"===(i=t.charAt(s))?(0===h&&(a=s),h++):"}"===i&&(1===h&&(o=s,l+=t.substr(c,a-c+1),c=o),h--);var p,m,g=null,y=(l+=t.substr(c,t.length-c+1)).match(u)||[];for(s=0;s<y.length;s++)for(p=y[s].split(","),n=0;n<p.length;n++)m=p[n].replace(d,"").trim(),e.indexOf(m)>=0?(g||(g=[]),g.push(m)):e.push(m);var E,v=l.match(_)||[];for(s=0;s<v.length;s++)for(p=v[s].split(","),n=0;n<p.length;n++)m=p[n].replace(f,"").trim(),(E=e.indexOf(m))>=0&&e.splice(E,1);return g};function O(c,l){this.app=c,this.srcRenderTarget=l.srcRenderTarget,this.hdr=l.hdr,this.blending=l.blending,this.shader=l.shader,this.setup=l.setup;var p=this,u=c.graphicsDevice;if(this.layer=new pc.Layer({opaqueSortMode:pc.SORTMODE_NONE,transparentSortMode:pc.SORTMODE_NONE,passThrough:!0,name:l.name,onPostRender:function(){if(p.srcRenderTarget?(s.x=p.srcRenderTarget.width,s.y=p.srcRenderTarget.height,s.z=1/p.srcRenderTarget.width,s.w=1/p.srcRenderTarget.height):(s.x=u.width,s.y=u.height,s.z=1/u.width,s.w=1/u.height),n[0]=s.x,n[1]=s.y,n[2]=s.z,n[3]=s.w,t.setValue(n),this._postEffectCombined&&this._postEffectCombined<0)p.setup&&p.setup(u,p,s,null,this.renderTarget);else{var r;(r=this._postEffectCombinedSrc?this._postEffectCombinedSrc:p.srcRenderTarget?p.srcRenderTarget:e[this._backbufferRtId])._samples>1&&r.resolve(!0,!1);var a=r._colorBuffer;a.magFilter=(this._postEffectCombinedShader?this._postEffectCombinedBilinear:this.postEffectBilinear)?pc.FILTER_LINEAR:pc.FILTER_NEAREST,i.setValue(a),p.setup&&p.setup(u,p,s,r,this.renderTarget);var o=this._postEffectCombinedShader?this._postEffectCombinedShader:this.shader;if(o&&pc.drawQuadWithShader(u,this.renderTarget,o,null,null,p.blending),!p.srcRenderTarget)for(var h=c.scene.layers.layerList,l=0;l<h.length&&h[l]!==p.layer;l++)h[l].renderTarget!==e[0]&&h[l].renderTarget!==e[1]||(h[l].renderTarget=null)}}}),this.layer._generateCameraHash(),this.layer.isPostEffect=!0,this.layer.unmodifiedUvs=l.unmodifiedUvs,this.layer.postEffectBilinear=l.bilinear,this.layer.postEffect=this,this.layer.shader=l.shader,this.layer.renderTarget=l.destRenderTarget,!i){i=u.scope.resolve("uColorBuffer"),t=u.scope.resolve("uScreenSize");for(var d=u.supportsMsaa?4:1,_=0;_<2;_++)e[_]=new pc.RenderTarget({depth:!0,stencil:u.supportsStencil,samples:d,autoResolve:!1}),e[_].name="backbuffer"+_;c.on("prerender",(function(){var t,i,s=c.scene.layers.layerList,n=0,l=0;a=!1,o=!1,h=!1;var p=pc.PIXELFORMAT_R8_G8_B8_A8;if(c.scene.layers._dirty){console.log("Trying to combine shaders...");var d,_,f=0,I=!1;for(t=0;t<s.length;t++)if(I=!1,s[t].isPostEffect&&(0===f||s[t].unmodifiedUvs&&s[t].shader&&!C(s,r,f,s[t].shader))?(r[f]=t,f++,t===s.length-1&&(I=!0)):f>0&&(I=!0),I){if(f>1){var O,P="post_";for(i=0;i<f;i++)P+=(O=s[r[i]]).name?O.name:O.id,i<f-1&&(P+="_");var x=u.programLib._cache[P];if(!x){var w,L="vec4 shaderOutput;\n",F="void main() {\n",D=[];for(i=0;i<f;i++){if(w=(w=s[r[i]].shader.definition.fshader+"\n").replace(m,"//").replace(g,"//").replace(y,"//").replace(E,"shaderOutput"),i>0&&(w=w.replace(v,"//").replace(T,"//").replace(b,"shaderOutput;//")),w=w.replace(A,"void main"+i),d=M(w,D))for(_=0;_<d.length;_++)w=w.replace(new RegExp("\\b"+d[_]+"\\b","g"),d[_]+"NNNN"+i);L+=w,F+="main"+i+"();\n"}F+="gl_FragColor = shaderOutput;\n}\n",x=pc.shaderChunks.createShaderFromCode(u,pc.shaderChunks.fullscreenQuadVS,L+F,P),console.log("Combined "+P)}for(i=0;i<f;i++)s[r[i]]._postEffectCombined=i===f-1?1:-1;s[r[f-1]]._postEffectCombinedShader=x,s[r[f-1]]._postEffectCombinedBilinear=s[r[0]].postEffectBilinear,s[r[f-1]]._postEffectCombinedSrc=s[r[0]].postEffect.srcRenderTarget}r[0]=t,f=1}}for(t=0;t<s.length;t++){if(s[t].isPostEffect&&(!s[t].postEffect.srcRenderTarget&&!s[t]._postEffectCombined||!s[t].postEffect._postEffectCombinedSrc&&s[t]._postEffectCombined>=0)){for(i=t-1;i>=n;i--)s[i].renderTarget||(s[i].renderTarget=e[l]);s[t]._backbufferRtId=l,n=t,a=!0,1===l&&(o=!0),s[t].postEffect.hdr&&(p=u.webgl2&&u.textureFloatRenderable?pc.PIXELFORMAT_111110F:u.extTextureHalfFloatLinear&&u.textureHalfFloatRenderable?pc.PIXELFORMAT_RGBA16F:pc.PIXELFORMAT_R8_G8_B8_A8),s[t].postEffect.shader&&!s[t].renderTarget&&(l=1-l)}else s[t].isPostEffect||s[t].renderTarget||!a||(s[t].renderTarget=e[l]);s[t].isPostEffect&&!s[t].renderTarget&&(h=!0)}a&&(e[0].colorBuffer?e[0].width===u.width&&e[0].height===u.height&&e[0]._colorBuffer._format===p||(R(0),S(0,u,p)):S(0,u,p)),o&&(e[1].colorBuffer?e[1].width===u.width&&e[1].height===u.height&&e[1]._colorBuffer._format===p||(R(1),S(1,u,p)):S(1,u,p))}),this),c.on("postrender",(function(){var t=c.graphicsDevice;if(a&&!h){for(var i,s=c.scene.layers.layerList,n=s.length-1;n>=0&&((i=s[n].renderTarget)!==e[0]&&i!==e[1]);n--);i&&(i._samples>1&&i.resolve(!0,!1),t.copyRenderTarget(i,null,!0,!1))}}),this)}}return O.prototype.addToComposition=function(t){this.app.scene.layers.insertTransparent(this.layer,t)},{PostEffectPass:O}}()),Object.assign(pc,function(){var t=function(t,e){pc.Component.call(this,t,e),this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null};(t.prototype=Object.create(pc.Component.prototype)).constructor=t;var e=[],i=[],s=function(s,n,r,a){var o=t.prototype;e.push(s),i.push(n),Object.defineProperty(o,s,{get:function(){return this.data[s]},set:function(t){var e=this.data,i=e[s];(a||i!==t)&&(e[s]=t,r&&r.call(this,t,i))},configurable:!0})};return s("enabled",!0,(function(t,e){this.onSetEnabled(null,e,t)})),s("light",null),s("type","directional",(function(t,e){this.system.changeType(this,e,t),this.refreshProperties()})),s("color",new pc.Color(1,1,1),(function(t,e){this.light.setColor(t)}),!0),s("intensity",1,(function(t,e){this.light.intensity=t})),s("castShadows",!1,(function(t,e){this.light.castShadows=t})),s("shadowDistance",40,(function(t,e){this.light.shadowDistance=t})),s("shadowResolution",1024,(function(t,e){this.light.shadowResolution=t})),s("shadowBias",.05,(function(t,e){this.light.shadowBias=-.01*t})),s("normalOffsetBias",0,(function(t,e){this.light.normalOffsetBias=t})),s("range",10,(function(t,e){this.light.attenuationEnd=t})),s("innerConeAngle",40,(function(t,e){this.light.innerConeAngle=t})),s("outerConeAngle",45,(function(t,e){this.light.outerConeAngle=t})),s("falloffMode",pc.LIGHTFALLOFF_LINEAR,(function(t,e){this.light.falloffMode=t})),s("shadowType",pc.SHADOW_PCF3,(function(t,e){this.light.shadowType=t})),s("vsmBlurSize",11,(function(t,e){this.light.vsmBlurSize=t})),s("vsmBlurMode",pc.BLUR_GAUSSIAN,(function(t,e){this.light.vsmBlurMode=t})),s("vsmBias",.0025,(function(t,e){this.light.vsmBias=t})),s("cookieAsset",null,(function(t,e){if(!this._cookieAssetId||!(t instanceof pc.Asset&&t.id===this._cookieAssetId||t===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,t instanceof pc.Asset)this.data.cookieAsset=t.id,this._cookieAssetId=t.id,this.onCookieAssetAdd(t);else if("number"==typeof t){this._cookieAssetId=t;var i=this.system.app.assets.get(t);i?this.onCookieAssetAdd(i):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}})),s("cookie",null,(function(t,e){t&&(t.minFilter=pc.FILTER_LINEAR),this.light.cookie=t})),s("cookieIntensity",1,(function(t,e){this.light.cookieIntensity=t})),s("cookieFalloff",!0,(function(t,e){this.light.cookieFalloff=t})),s("cookieChannel","rgb",(function(t,e){this.light.cookieChannel=t})),s("cookieAngle",0,(function(t,e){if(0!==t||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new pc.Vec4);var i=1,s=1;this.cookieScale&&(i=this.cookieScale.x,s=this.cookieScale.y);var n=Math.cos(t*pc.math.DEG_TO_RAD),r=Math.sin(t*pc.math.DEG_TO_RAD);this._cookieMatrix.set(n/i,-r/i,r/s,n/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})),s("cookieScale",null,(function(t,e){if(null!==t||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new pc.Vec4);var i=t.x,s=t.y,n=Math.cos(this.cookieAngle*pc.math.DEG_TO_RAD),r=Math.sin(this.cookieAngle*pc.math.DEG_TO_RAD);this._cookieMatrix.set(n/i,-r/i,r/s,n/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null;this.light.cookieScale=t}),!0),s("cookieOffset",null,(function(t,e){this.light.cookieOffset=t}),!0),s("shadowUpdateMode",pc.SHADOWUPDATE_REALTIME,(function(t,e){this.light.shadowUpdateMode=t})),s("mask",1,(function(t,e){this.light.mask=t})),s("cullingMask",1,(function(t,e){this.light.cullingMask=t})),s("affectDynamic",!0,(function(t,e){t?this.light.mask|=pc.MASK_DYNAMIC:this.light.mask&=~pc.MASK_DYNAMIC,this.light.mask=this.light._mask})),s("affectLightmapped",!1,(function(t,e){t?(this.light.mask|=pc.MASK_BAKED,this.bake&&(this.light.mask&=~pc.MASK_LIGHTMAP)):(this.light.mask&=~pc.MASK_BAKED,this.bake&&(this.light.mask|=pc.MASK_LIGHTMAP)),this.light.mask=this.light._mask})),s("bake",!1,(function(t,e){t?(this.light.mask|=pc.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask&=~pc.MASK_BAKED)):(this.light.mask&=~pc.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask|=pc.MASK_BAKED)),this.light.mask=this.light._mask})),s("bakeDir",!0,(function(t,e){this.light.bakeDir=t})),s("isStatic",!1,(function(t,e){this.light.isStatic=t})),s("layers",[pc.LAYERID_WORLD],(function(t,e){console.warn(".layers property does nothing!")})),s("renderMode",0,(function(t,e){this.light.renderMode=t})),Object.defineProperty(t.prototype,"enable",{get:function(){return console.warn("WARNING: enable: Property is deprecated. Query enabled property instead."),this.enabled},set:function(t){console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),this.enabled=t}}),Object.assign(t.prototype,{addLightToScene:function(){this.system.app.scene.addLight(this.light)},removeLightFromScene:function(){this.system.app.scene.removeLight(this.light)},refreshProperties:function(){for(var t,i=0;i<e.length;i++)this[t=e[i]]=this[t];this.enabled&&this.entity.enabled&&this.onEnable()},updateShadow:function(){this.light.updateShadow()},onCookieAssetSet:function(){var t=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,t=!0),this._cookieAsset.resource&&!t||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()},onCookieAssetAdd:function(t){this._cookieAssetId===t.id&&(this._cookieAsset=t,this.light._enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))},onCookieAssetLoad:function(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)},onCookieAssetRemove:function(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)},onEnable:function(){this.light.enabled=!0,this.enabled&&this.entity.enabled&&this.addLightToScene(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()},onDisable:function(){this.light.enabled=!1,this.removeLightFromScene()}}),{LightComponent:t,_lightProps:e,_lightPropsDefault:i}}()),Object.assign(pc,function(){var t={directional:pc.LIGHTTYPE_DIRECTIONAL,point:pc.LIGHTTYPE_POINT,spot:pc.LIGHTTYPE_SPOT},e=function(t){pc.ComponentSystem.call(this,t),this.id="light",this.description="Enables the Entity to emit light.",this.ComponentType=pc.LightComponent,this.DataType=pc.LightComponentData};return(e.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=e,Object.assign(e.prototype,{initializeComponentData:function(e,i){for(var s=pc._lightProps,n={},r=0,a=s.length;r<a;r++){var o=s[r];n[o]=i[o]}n.type||(n.type=e.data.type),e.data.type=n.type,n.layers&&"array"===pc.type(n.layers)&&(n.layers=n.layers.slice(0)),n.color&&"array"===pc.type(n.color)&&(n.color=new pc.Color(n.color[0],n.color[1],n.color[2])),n.cookieOffset&&n.cookieOffset instanceof Array&&(n.cookieOffset=new pc.Vec2(n.cookieOffset[0],n.cookieOffset[1])),n.cookieScale&&n.cookieScale instanceof Array&&(n.cookieScale=new pc.Vec2(n.cookieScale[0],n.cookieScale[1])),n.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),n.enabled=n.enable);var h=new pc.Light;h.type=t[n.type],h._node=e.entity,h._scene=this.app.scene,e.data.light=h,h.renderMode=i.renderMode,h.range=i.range,pc.ComponentSystem.prototype.initializeComponentData.call(this,e,n,s)},removeComponent:function(t){t.light.data.light.destroy(),pc.ComponentSystem.prototype.removeComponent.call(this,t)},cloneComponent:function(t,e){for(var i,s=t.light,n=[],r=pc._lightProps,a=0;a<r.length;a++)"light"!==(i=r[a])&&(s[i]&&s[i].clone?n[i]=s[i].clone():n[i]=s[i]);this.addComponent(e,n)},changeType:function(e,i,s){i!==s&&(e.light.type=t[s])}}),{LightComponentSystem:e}}()),Object.assign(pc,{LightComponentData:function(){for(var t,e=pc._lightProps,i=pc._lightPropsDefault,s=0;s<e.length;s++)(t=i[s])&&t.clone?this[e[s]]=t.clone():this[e[s]]=t}}),Object.assign(pc,{DISTANCE_LINEAR:"linear",DISTANCE_INVERSE:"inverse",DISTANCE_EXPONENTIAL:"exponential"}),Object.assign(pc,function(){"use strict";var t={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new pc.Vec3,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null},e=function(t,e,i){i=i||{},this._component=t,this._assets=t.system.app.assets,this._manager=t.system.manager,this._name=e||"Untitled",this._volume=void 0!==i.volume?pc.math.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._duration=i.duration>0?i.duration:null,this._startTime=Math.max(0,Number(i.startTime)||0),this._overlap=!!i.overlap,this._autoPlay=!!i.autoPlay,this._firstNode=null,this._lastNode=null,this._asset=i.asset,this._asset instanceof pc.Asset&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this),this.instances=[],pc.events.attach(this)};return Object.assign(e.prototype,{play:function(){this.overlap||!this.isPlaying&&!this.isPaused||this.stop();var t=this._createInstance();if(this.instances.push(t),this.isLoaded)t.play();else{var e=function(e){var i=t._playWhenLoaded;t.sound=e,i&&t.play()};this.off("load",e),this.once("load",e),this.load()}return t},pause:function(){for(var t=!1,e=this.instances,i=0,s=e.length;i<s;i++)e[i].pause()&&(t=!0);return t},resume:function(){for(var t=!1,e=this.instances,i=0,s=e.length;i<s;i++)e[i].resume()&&(t=!0);return t},stop:function(){for(var t=!1,e=this.instances,i=0,s=e.length;i<s;i++)e[i].stop()&&(t=!0);return e.length=0,t},load:function(){if(this._hasAsset()){var t=this._assets.get(this._asset);if(!t)return this._assets.off("add:"+this._asset,this._onAssetAdd,this),void this._assets.once("add:"+this._asset,this._onAssetAdd,this);if(t.off("remove",this._onAssetRemoved,this),t.on("remove",this._onAssetRemoved,this),!t.resource)return t.off("load",this._onAssetLoad,this),t.once("load",this._onAssetLoad,this),void this._assets.load(t);this.fire("load",t.resource)}},setExternalNodes:function(t,e){if(t){if(e||(e=t),this._firstNode=t,this._lastNode=e,!this._overlap)for(var i=this.instances,s=0,n=i.length;s<n;s++)i[s].setExternalNodes(t,e)}else console.error("The firstNode must have a valid AudioNode")},clearExternalNodes:function(){if(this._firstNode=null,this._lastNode=null,!this._overlap)for(var t=this.instances,e=0,i=t.length;e<i;e++)t[e].clearExternalNodes()},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_hasAsset:function(){return null!=this._asset},_createInstance:function(){var e=null,i=this._component,s=null;if(this._hasAsset()){var n=this._assets.get(this._asset);n&&(s=n.resource)}var r=t;return r.volume=this._volume*i.volume,r.pitch=this._pitch*i.pitch,r.loop=this._loop,r.startTime=this._startTime,r.duration=this._duration,r.onPlay=this._onInstancePlayHandler,r.onPause=this._onInstancePauseHandler,r.onResume=this._onInstanceResumeHandler,r.onStop=this._onInstanceStopHandler,r.onEnd=this._onInstanceEndHandler,i.positional?(r.position.copy(i.entity.getPosition()),r.maxDistance=i.maxDistance,r.refDistance=i.refDistance,r.rollOffFactor=i.rollOffFactor,r.distanceModel=i.distanceModel,e=new pc.SoundInstance3d(this._manager,s,r)):e=new pc.SoundInstance(this._manager,s,r),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e},_onInstancePlay:function(t){this.fire("play",t),this._component.fire("play",this,t)},_onInstancePause:function(t){this.fire("pause",t),this._component.fire("pause",this,t)},_onInstanceResume:function(t){this.fire("resume",t),this._component.fire("resume",this,t)},_onInstanceStop:function(t){this.fire("stop",t),this._component.fire("stop",this,t)},_onInstanceEnd:function(t){var e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1),this.fire("end",t),this._component.fire("end",this,t)},_onAssetAdd:function(t){this.load()},_onAssetLoad:function(t){this.load()},_onAssetRemoved:function(t){t.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+t.id,this._onAssetAdd,this),this.stop()},updatePosition:function(t){for(var e=this.instances,i=0,s=e.length;i<s;i++)e[i].position=t}}),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},set:function(t){this._name=t}}),Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume},set:function(t){if(this._volume=pc.math.clamp(Number(t)||0,0,1),!this._overlap)for(var e=this.instances,i=0,s=e.length;i<s;i++)e[i].volume=this._volume*this._component.volume}}),Object.defineProperty(e.prototype,"pitch",{get:function(){return this._pitch},set:function(t){if(this._pitch=Math.max(Number(t)||0,.01),!this._overlap)for(var e=this.instances,i=0,s=e.length;i<s;i++)e[i].pitch=this.pitch*this._component.pitch}}),Object.defineProperty(e.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=!!t;for(var e=this.instances,i=0,s=e.length;i<s;i++)e[i].loop=this._loop}}),Object.defineProperty(e.prototype,"autoPlay",{get:function(){return this._autoPlay},set:function(t){this._autoPlay=!!t}}),Object.defineProperty(e.prototype,"overlap",{get:function(){return this._overlap},set:function(t){this._overlap=!!t}}),Object.defineProperty(e.prototype,"startTime",{get:function(){return this._startTime},set:function(t){if(this._startTime=Math.max(0,Number(t)||0),!this._overlap)for(var e=this.instances,i=0,s=e.length;i<s;i++)e[i].startTime=this._startTime}}),Object.defineProperty(e.prototype,"duration",{get:function(){var t=0;if(this._hasAsset()){var e=this._assets.get(this._asset);t=e.resource?e.resource.duration:0}return null!=this._duration?this._duration%(t||1):t},set:function(t){if(this._duration=Math.max(0,Number(t)||0)||null,!this._overlap)for(var e=this.instances,i=0,s=e.length;i<s;i++)e[i].duration=this._duration}}),Object.defineProperty(e.prototype,"asset",{get:function(){return this._asset},set:function(t){var e=this._asset;if(e){this._assets.off("add:"+e,this._onAssetAdd,this);var i=this._assets.get(e);i&&i.off("remove",this._onAssetRemoved,this)}this._asset=t,this._asset instanceof pc.Asset&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}}),Object.defineProperty(e.prototype,"isLoaded",{get:function(){if(this._hasAsset()){var t=this._assets.get(this._asset);if(t)return!!t.resource}return!1}}),Object.defineProperty(e.prototype,"isPlaying",{get:function(){for(var t=this.instances,e=0,i=t.length;e<i;e++)if(t[e].isPlaying)return!0;return!1}}),Object.defineProperty(e.prototype,"isPaused",{get:function(){var t=this.instances,e=t.length;if(0===e)return!1;for(var i=0;i<e;i++)if(!t[i].isPaused)return!1;return!0}}),Object.defineProperty(e.prototype,"isStopped",{get:function(){for(var t=this.instances,e=0,i=t.length;e<i;e++)if(!t[e].isStopped)return!1;return!0}}),{SoundSlot:e}}()),Object.assign(pc,function(){var t=function(t,e){pc.Component.call(this,t,e),this.on("set_slots",this.onSetSlots,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_refDistance",this.onSetRefDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_positional",this.onSetPositional,this)};return(t.prototype=Object.create(pc.Component.prototype)).constructor=t,Object.assign(t.prototype,{onSetSlots:function(t,e,i){var s;if(e)for(s in e)e[s].stop();var n={};for(s in i)i[s]instanceof pc.SoundSlot?n[i[s].name]=i[s]:i[s].name&&(n[i[s].name]=new pc.SoundSlot(this,i[s].name,i[s]));this.data.slots=n,this.enabled&&this.entity.enabled&&this.onEnable()},onSetVolume:function(t,e,i){var s=this.data.slots;for(var n in s){var r=s[n];if(!r.overlap)for(var a=r.instances,o=0,h=a.length;o<h;o++)a[o].volume=r.volume*i}},onSetPitch:function(t,e,i){var s=this.data.slots;for(var n in s){var r=s[n];if(!r.overlap)for(var a=r.instances,o=0,h=a.length;o<h;o++)a[o].pitch=r.pitch*i}},onSetRefDistance:function(t,e,i){var s=this.data.slots;for(var n in s){var r=s[n];if(!r.overlap)for(var a=r.instances,o=0,h=a.length;o<h;o++)a[o].refDistance=i}},onSetMaxDistance:function(t,e,i){var s=this.data.slots;for(var n in s){var r=s[n];if(!r.overlap)for(var a=r.instances,o=0,h=a.length;o<h;o++)a[o].maxDistance=i}},onSetRollOffFactor:function(t,e,i){var s=this.data.slots;for(var n in s){var r=s[n];if(!r.overlap)for(var a=r.instances,o=0,h=a.length;o<h;o++)a[o].rollOffFactor=i}},onSetDistanceModel:function(t,e,i){var s=this.data.slots;for(var n in s){var r=s[n];if(!r.overlap)for(var a=r.instances,o=0,h=a.length;o<h;o++)a[o].distanceModel=i}},onSetPositional:function(t,e,i){var s=this.data.slots;for(var n in s){var r=s[n];if(!r.overlap)for(var a=r.instances,o=0,h=a.length;o<h;o++){var c=a[o].isPlaying||a[o].isSuspended,l=a[o].currentTime;c&&a[o].stop(),a[o]=r._createInstance(),c&&(a[o].play(),a[o].currentTime=l)}}},onEnable:function(){if(!this.system._inTools){var t=this.data.slots,e=this.data.playingBeforeDisable;for(var i in t){var s=t[i];s.autoPlay&&s.isStopped?s.play():e[i]?s.resume():s.isLoaded||s.load()}}},onDisable:function(){var t=this.data.slots,e={};for(var i in t)t[i].overlap||t[i].isPlaying&&(t[i].pause(),e[i]=!0);this.data.playingBeforeDisable=e},addSlot:function(t,e){var i=this.data.slots;if(i[t])return logWARNING("A sound slot with name "+t+" already exists on Entity "+this.entity.getPath()),null;var s=new pc.SoundSlot(this,t,e);return i[t]=s,s.autoPlay&&this.enabled&&this.entity.enabled&&s.play(),s},removeSlot:function(t){var e=this.data.slots;e[t]&&(e[t].stop(),delete e[t])},slot:function(t){return this.data.slots[t]},play:function(t){if(!this.enabled||!this.entity.enabled)return null;var e=this.slots[t];return e?e.play():(logWARNING("Trying to play sound slot with name "+t+" which does not exist"),null)},pause:function(t){var e,i=this.data.slots;if(t){if(!(e=i[t]))return void logWARNING("Trying to pause sound slot with name "+t+" which does not exist");e.pause()}else for(var s in i)i[s].pause()},resume:function(t){var e,i=this.data.slots;if(t){if(!(e=i[t]))return void logWARNING("Trying to resume sound slot with name "+t+" which does not exist");e.isPaused&&e.resume()}else for(var s in i)i[s].resume()},stop:function(t){var e,i=this.data.slots;if(t){if(!(e=i[t]))return void logWARNING("Trying to stop sound slot with name "+t+" which does not exist");e.stop()}else for(var s in i)i[s].stop()}}),{SoundComponent:t}}()),Object.assign(pc,function(){var t=["enabled","volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"],e=function(e,i){pc.ComponentSystem.call(this,e),this.id="sound",this.description="Allows an Entity to play sounds",this.ComponentType=pc.SoundComponent,this.DataType=pc.SoundComponentData,this.schema=t,this.manager=i,pc.ComponentSystem.on("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)};return(e.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=e,pc.Component._buildAccessors(pc.SoundComponent.prototype,t),Object.assign(e.prototype,{initializeComponentData:function(t,e,i){i=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots","enabled"],pc.ComponentSystem.prototype.initializeComponentData.call(this,t,e,i)},cloneComponent:function(t,e){var i,s=t.sound.data,n={};for(i in s)s.hasOwnProperty(i)&&(n[i]=s[i]);for(i in n.slots={},s.slots){var r=s.slots[i];r instanceof pc.SoundSlot?n.slots[i]={name:r.name,volume:r.volume,pitch:r.pitch,loop:r.loop,duration:r.duration,startTime:r.startTime,overlap:r.overlap,autoPlay:r.autoPlay,asset:r.asset}:n.slots[i]=r}return n.playingBeforeDisable={},this.addComponent(e,n)},onUpdate:function(t){var e=this.store;for(var i in e)if(e.hasOwnProperty(i)){var s=e[i],n=s.entity,r=s.data;if(r.enabled&&n.enabled&&r.positional){var a=n.getPosition(),o=r.slots;for(var h in o)o[h].updatePosition(a)}}},onBeforeRemove:function(t,e){var i=e.slots;for(var s in i)i[s].overlap||i[s].stop()}}),Object.defineProperty(e.prototype,"volume",{get:function(){return this.manager.volume},set:function(t){this.manager.volume=t}}),Object.defineProperty(e.prototype,"context",{get:function(){return pc.SoundManager.hasAudioContext()?this.manager.context:(console.warn("WARNING: Audio context is not supported on this browser"),null)}}),{SoundComponentSystem:e}}()),pc.SoundComponentData=function(){this.enabled=!0,this.volume=1,this.pitch=1,this.positional=!0,this.refDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=pc.DISTANCE_LINEAR,this.slots={},this.playingBeforeDisable={}},Object.assign(pc,function(){var t=function(t,e){pc.Component.call(this,t,e),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_minDistance",this.onSetMinDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_3d",this.onSet3d,this)};return(t.prototype=Object.create(pc.Component.prototype)).constructor=t,Object.assign(t.prototype,{play:function(t){if(this.enabled&&this.entity.enabled){var e;this.channel&&this.stop();var i=this.data;if(i.sources[t])if(i["3d"]){var s=this.entity.getPosition();e=this.system.manager.playSound3d(i.sources[t],s,i),i.currentSource=t,i.channel=e}else e=this.system.manager.playSound(i.sources[t],i),i.currentSource=t,i.channel=e}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&(this.channel.stop(),this.channel=null)},onSetAssets:function(t,e,i){var s,n=[],r=i.length;if(e&&e.length)for(s=0;s<e.length;s++)if(e[s]){var a=this.system.app.assets.get(e[s]);a&&(a.off("change",this.onAssetChanged,this),a.off("remove",this.onAssetRemoved,this),this.currentSource===a.name&&this.stop())}if(r)for(s=0;s<r;s++)e.indexOf(i[s])<0&&(i[s]instanceof pc.Asset?n.push(i[s].id):n.push(i[s]));!this.system._inTools&&n.length&&this.loadAudioSourceAssets(n)},onAssetChanged:function(t,e,i,s){"resource"===e&&(this.data.sources&&(this.data.sources[t.name]=i,this.data.currentSource===t.name&&this.channel&&(this.channel.paused?(this.play(t.name),this.pause()):this.play(t.name))))},onAssetRemoved:function(t){t.off("remove",this.onAssetRemoved,this),this.data.sources[t.name]&&(delete this.data.sources[t.name],this.data.currentSource===t.name&&(this.stop(),this.data.currentSource=null))},onSetLoop:function(t,e,i){e!=i&&this.channel&&this.channel.setLoop(i)},onSetVolume:function(t,e,i){e!=i&&this.channel&&this.channel.setVolume(i)},onSetPitch:function(t,e,i){e!=i&&this.channel&&this.channel.setPitch(i)},onSetMaxDistance:function(t,e,i){e!=i&&this.channel instanceof pc.Channel3d&&this.channel.setMaxDistance(i)},onSetMinDistance:function(t,e,i){e!=i&&this.channel instanceof pc.Channel3d&&this.channel.setMinDistance(i)},onSetRollOffFactor:function(t,e,i){e!=i&&this.channel instanceof pc.Channel3d&&this.channel.setRollOffFactor(i)},onSetDistanceModel:function(t,e,i){e!==i&&this.channel instanceof pc.Channel3d&&this.channel.setDistanceModel(i)},onSet3d:function(t,e,i){if(e!==i&&this.system.initialized&&this.currentSource){var s=!1,n=!1;this.channel&&(s=this.channel.paused,n=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=s,this.channel.suspended=n)}},onEnable:function(){var t=this.data.assets;if(t)for(var e=this.system.app.assets,i=0,s=t.length;i<s;i++){var n=t[i];n instanceof pc.Asset||(n=e.get(n)),n&&!n.resource&&e.load(n)}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())},onDisable:function(){this.pause()},loadAudioSourceAssets:function(t){var e=this,i=t.map((function(t){return this.system.app.assets.get(t)}),this),s={},n=null,r=i.length,a=function(t){r--},o=function(){this.data.sources=s,this.data.currentSource=n,this.enabled&&this.activate&&n&&this.onEnable()}.bind(this);i.forEach((function(i,h){i?(n=n||i.name,i.off("change",this.onAssetChanged,this),i.on("change",this.onAssetChanged,this),i.off("remove",this.onAssetRemoved,this),i.on("remove",this.onAssetRemoved,this),i.off("error",a,this),i.on("error",a,this),i.ready((function(t){s[t.name]=t.resource,0===--r&&o()})),!i.resource&&e.enabled&&e.entity.enabled&&this.system.app.assets.load(i)):(0===--r&&o(),this.system.app.assets.on("add:"+t[h],(function(t){t.ready((function(t){e.data.sources[t.name]=t.resource})),t.resource||e.system.app.assets.load(t)})))}),this)}}),{AudioSourceComponent:t}}()),Object.assign(pc,function(){var t=["enabled","assets","volume","pitch","loop","activate","3d","minDistance","maxDistance","rollOffFactor","distanceModel","sources","currentSource","channel"],e=function(e,i){pc.ComponentSystem.call(this,e),this.id="audiosource",this.description="Specifies audio assets that can be played at the position of the Entity.",this.ComponentType=pc.AudioSourceComponent,this.DataType=pc.AudioSourceComponentData,this.schema=t,this.manager=i,this.initialized=!1,pc.ComponentSystem.on("initialize",this.onInitialize,this),pc.ComponentSystem.on("update",this.onUpdate,this),this.on("remove",this.onRemove,this)};return(e.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=e,pc.Component._buildAccessors(pc.AudioSourceComponent.prototype,t),Object.assign(e.prototype,{initializeComponentData:function(t,e,i){i=["activate","volume","pitch","loop","3d","minDistance","maxDistance","rollOffFactor","distanceModel","enabled","assets"],pc.ComponentSystem.prototype.initializeComponentData.call(this,t,e,i),t.paused=!(t.enabled&&t.activate)},onInitialize:function(t){t.audiosource&&t.enabled&&t.audiosource.enabled&&t.audiosource.activate&&t.audiosource.play(t.audiosource.currentSource);var e,i=t._children,s=i.length;for(e=0;e<s;e++)i[e]instanceof pc.Entity&&this.onInitialize(i[e]);this.initialized=!0},onUpdate:function(t){var e=this.store;for(var i in e)if(e.hasOwnProperty(i)){var s=e[i],n=s.entity,r=s.data;if(r.enabled&&n.enabled&&r.channel instanceof pc.Channel3d){var a=n.getPosition();r.channel.setPosition(a)}}},onRemove:function(t,e){e.channel&&(e.channel.stop(),e.channel=null)},setVolume:function(t){this.manager.setVolume(t)}}),{AudioSourceComponentSystem:e}}()),pc.AudioSourceComponentData=function(){this.enabled=!0,this.assets=[],this.activate=!0,this.volume=1,this.pitch=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=pc.DISTANCE_INVERSE,this.paused=!0,this.sources={},this.currentSource=null,this.channel=null},Object.assign(pc,function(){var t=function(t,e){pc.Component.call(this,t,e)};return(t.prototype=Object.create(pc.Component.prototype)).constructor=t,Object.assign(t.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var t=this.system.current.getPosition();this.system.manager.listener.setPosition(t)}},onEnable:function(){this.setCurrentListener()},onDisable:function(){this.system.current===this.entity&&(this.system.current=null)}}),{AudioListenerComponent:t}}()),Object.assign(pc,function(){var t=["enabled"],e=function(e,i){pc.ComponentSystem.call(this,e),this.id="audiolistener",this.description="Specifies the location of the listener for 3D audio playback.",this.ComponentType=pc.AudioListenerComponent,this.DataType=pc.AudioListenerComponentData,this.schema=t,this.manager=i,this.current=null,pc.ComponentSystem.on("update",this.onUpdate,this)};return(e.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=e,pc.Component._buildAccessors(pc.AudioListenerComponent.prototype,t),Object.assign(e.prototype,{initializeComponentData:function(t,e,i){i=["enabled"],pc.ComponentSystem.prototype.initializeComponentData.call(this,t,e,i)},onUpdate:function(t){if(this.current){var e=this.current.getPosition();this.manager.listener.setPosition(e);var i=this.current.getWorldTransform();this.manager.listener.setOrientation(i)}}}),{AudioListenerComponentSystem:e}}()),Object.assign(pc,{AudioListenerComponentData:function(){this.enabled=!0}}),pc.extend(pc,function(){var t=function(t,e){pc.Component.call(this,t,e),this._resolution=new pc.Vec2(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this._referenceResolution=new pc.Vec2(640,320),this._offset=new pc.Vec2(0,0),this._scaleMode=pc.ScreenComponent.SCALEMODE_NONE,this.scale=1,this._scaleBlend=.5,this._scaleFactor=1,this._planeHeight=0,this._screenType=pc.SCREEN_TYPE_SCREEN,this._screenDistance=1,this.parentScreen=null,this.childrenScreen=new pc.IndexedList,this._isFallbackOverlay=!1,this.canvasMeshInstance=new pc.CanvasMeshInstance(this),this.registered=!1,this.meshInstances=[this.canvasMeshInstance]};return(t.prototype=Object.create(pc.Component.prototype)).constructor=t,t.SCALEMODE_NONE="none",t.SCALEMODE_BLEND="blend",t.SCALEMODE_EXPAND="expand",t.SCALEMODE_SHRINK="shrink",pc.extend(t.prototype,{_updateScreenInChildren:function(){for(var t=0;t<this.entity._children.length;t++){var e=this.entity._children[t].element;e&&e._updateScreen(e._findScreen(),!0)}this.syncDrawOrder()},syncDrawOrder:function(){var t=pc.Application.getApplication().systems.screen;t&&(t._dirtyOrder=!0)},_calcProjectionMatrix:function(){var t=this._screenType,e=this.camera;t==pc.SCREEN_TYPE_CAMERA&&(e.projection==pc.PROJECTION_PERSPECTIVE?this._planeHeight=Math.tan(e.fov/2*Math.PI/180)*Math.abs(2*this._screenDistance):this._planeHeight=2*e.orthoHeight),this.entity._dirtyLocal=!0,this.entity._dirtifyWorld()},_findParentScreen:function(){return pc.UIUtils.findParentScreen(this.entity.parent)},onRemove:function(){this.reparentChildrenToNewCanvas()},reparentChildrenToNewCanvas:function(){for(var t=pc.UIUtils.findParentScreen(this.entity.parent),e=this.canvasMeshInstance.renderers._list,i=0;i<e.length;i++){e[i].reparentCanvas(t)}},_updateScale:function(){this.scale=this._calcScale(this._resolution,this.referenceResolution)},_calcScale:function(e,i){if(this._scaleMode===t.SCALEMODE_NONE)return this.scaleFactor;if(this._scaleMode===t.SCALEMODE_EXPAND)return Math.min(e.x/i.x,e.y/i.y);if(this._scaleMode===t.SCALEMODE_SHRINK)return Math.max(e.x/i.x,e.y/i.y);var s=Math.log2(e.x/i.x),n=Math.log2(e.y/i.y),r=pc.math.lerp(s,n,this.scaleBlend);return Math.pow(2,r)},_onResize:function(t,e){var i=this.camera;i&&i.renderTarget&&(t=i.renderTarget.width,e=i.renderTarget.height),this._screenType!=pc.SCREEN_TYPE_WORLD&&(this._resolution.set(t,e),this.resolution=this._resolution),this.entity.element&&this.entity.element.triggerOnElementDimesionsChange(!0,!0)},_updateStencilRecursive:function(t,e){var i=t.element,s=!!i,n=s&&(i._image&&i._image.masksChildren||i._text&&i._text.masksChildren);s&&(i._masked=e.maskingDepth>0,n&&(i._topMostMask=0==e.maskingDepth,e.maskingDepth++,e.ref=(1<<e.maskingDepth)-1),i.stencilLayer=e.ref);for(var r=0;r<t._children.length;r++)this._updateStencilRecursive(t._children[r],e);s&&n&&(e.maskingDepth--,e.ref=(1<<e.maskingDepth)-1)},_updateStencilParameters:function(){if(this.entity){this._updateStencilRecursive(this.entity,{ref:0,maskingDepth:0})}},addScreenToScene:function(){this.screenType!==pc.SCREEN_TYPE_SCREEN&&this.system.app.scene.addRenderer(this),this.system.app.graphicsDevice.on("resizecanvas",this._onResize,this),this.system.app.scene.addScreen(this)},removeScreenFromScene:function(){this.screenType!==pc.SCREEN_TYPE_SCREEN&&this.system.app.scene.removeRenderer(this),this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.system.app.scene.removeScreen(this)},onEnable:function(){this.registered=!0;var t=pc.UIUtils.findParentScreen(this.entity.parent);this.setParentScreen(t,!0),this._onResize(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height)},onDisable:function(){this.setParentScreen(null,!1),this.registered=!1},onDestroy:function(){this.reparentChildrenToNewCanvas()},getMeshInstancesForRender:function(){return this.meshInstances},setParentScreen(t,e){e=!!e,this.registered&&(this.parentScreen?(this.parentScreen.childrenScreen.remove(this),this.parentScreen.canvasMeshInstance.removeRenderer(this.canvasMeshInstance)):this.removeScreenFromScene()),this.parentScreen=t,this.registered&&e&&(this.parentScreen?(this.parentScreen.childrenScreen.push(this),this.parentScreen.canvasMeshInstance.addRenderer(this.canvasMeshInstance)):this.addScreenToScene())},getMeshInstancesForRender:function(){return this.meshInstances}}),Object.defineProperty(t.prototype,"resolution",{set:function(t){var e=this.camera;e&&e.renderTarget||(this._screenType!=pc.SCREEN_TYPE_SCREEN?0!=t.x&&0!=t.y&&this._resolution.set(t.x,t.y):e&&e.renderTarget||this._resolution.set(this.system.app.graphicsDevice._width,this.system.app.graphicsDevice._height),this._scaleMode===pc.ScreenComponent.SCALEMODE_NONE&&this.referenceResolution.copy(this._resolution),this._updateScale(),this._calcProjectionMatrix(),this.fire("set:resolution",this._resolution))},get:function(){return this._resolution}}),Object.defineProperty(t.prototype,"offset",{set:function(t){this._offset.set(t.x,t.y),this._calcProjectionMatrix()},get:function(){return this._offset}}),Object.defineProperty(t.prototype,"referenceResolution",{set:function(t){this._referenceResolution.set(t.x,t.y),this._updateScale(),this._calcProjectionMatrix(),this.fire("set:referenceresolution",this._resolution)},get:function(){return this._scaleMode===pc.ScreenComponent.SCALEMODE_NONE?this._resolution:this._referenceResolution}}),Object.defineProperty(t.prototype,"screenType",{set:function(t){if(this._screenType!=t){this.registered&&this.enabled&&this.removeScreenFromScene(),this._screenType=t;var e=this.screenType;if(this._isFallbackOverlay=!1,e==pc.SCREEN_TYPE_CAMERA)if(this._camera){var i=this._camera._node.getPosition();this.entity.element.anchoredPosition.set(i.x,i.y)}else this._isFallbackOverlay=!0,this._screenType=pc.SCREEN_TYPE_SCREEN;e==pc.SCREEN_TYPE_SCREEN&&(this.canvasMeshInstance.visible=!0),this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.fire("set:screentype",e),this.registered&&this.enabled&&this.addScreenToScene()}},get:function(){return this.parentScreen?this.parentScreen.screenType:this._screenType}}),Object.defineProperty(t.prototype,"screenDistance",{set:function(t){this._screenDistance=t,this._calcProjectionMatrix()},get:function(){return this._screenDistance}}),Object.defineProperty(t.prototype,"scaleMode",{set:function(t){t!==pc.ScreenComponent.SCALEMODE_NONE&&t!==pc.ScreenComponent.SCALEMODE_BLEND&&t!==pc.ScreenComponent.SCALEMODE_EXPAND&&t!==pc.ScreenComponent.SCALEMODE_SHRINK&&(t=pc.ScreenComponent.SCALEMODE_NONE),this._screenType==pc.SCREEN_TYPE_WORLD&&t!==pc.ScreenComponent.SCALEMODE_NONE&&(t=pc.ScreenComponent.SCALEMODE_NONE),this._scaleMode=t,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)},get:function(){return this._scaleMode}}),Object.defineProperty(t.prototype,"scaleBlend",{set:function(t){this._scaleBlend=t,this._updateScale(),this._calcProjectionMatrix(),this.fire("set:scaleblend",this._scaleBlend)},get:function(){return this._scaleBlend}}),Object.defineProperty(t.prototype,"camera",{set:function(t){this._camera=t,this._camera||this.screenType!=pc.SCREEN_TYPE_CAMERA||(this.screenType=pc.SCREEN_TYPE_SCREEN),this._camera&&this._isFallbackOverlay&&(this.screenType=pc.SCREEN_TYPE_CAMERA),t&&null!=t.renderTarget&&this._resolution.set(t.renderTarget.width,t.renderTarget.height),this._calcProjectionMatrix()},get:function(){return this._camera}}),Object.defineProperty(t.prototype,"meshInstances",{get:function(){return[this.canvasMeshInstance]}}),{ScreenComponent:t,SCREEN_TYPE_WORLD:"world",SCREEN_TYPE_CAMERA:"camera",SCREEN_TYPE_SCREEN:"screen"}}()),Object.assign(pc,function(){var t=["enabled"],e=function(t,i){var s=t.element;if(s){var n=t._unityComponents.canvasRenderer[0];n&&(n._absoluteDepth=i),s.drawOrder=i++}for(var r=t._children,a=0;a<r.length;a++)i=e(r[a],i);return i},i=function(e){pc.ComponentSystem.call(this,e),this.id="screen",this.app=e,this.ComponentType=pc.ScreenComponent,this.DataType=pc.ScreenComponentData,this.schema=t,this.windowResolution=new pc.Vec2,this._drawOrderSyncQueue=new pc.IndexedList,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),pc.ComponentSystem.on("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)};return(i.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=i,pc.Component._buildAccessors(pc.ScreenComponent.prototype,t),Object.assign(i.prototype,{initializeComponentData:function(t,e,i){void 0!==e.priority&&(t.priority=e.priority),void 0!==e.screenSpace&&(t.screenSpace=e.screenSpace),t.cull=t.screenSpace,void 0!==e.screenType&&(t.screenType=e.screenType),void 0!==e.scaleMode&&(t.scaleMode=e.scaleMode),void 0!==e.scaleBlend&&(t.scaleBlend=e.scaleBlend),void 0!==e.screenDistance&&(t.screenDistance=e.screenDistance),void 0!==e.layer&&(t.layer=e.layer),void 0!==e.drawOrder&&(t.drawOrder=e.drawOrder),void 0!==e.resolution&&(e.resolution instanceof pc.Vec2?t._resolution.copy(e.resolution):t._resolution.set(e.resolution[0],e.resolution[1]),t.resolution=t._resolution),void 0!==e.referenceResolution&&(e.referenceResolution instanceof pc.Vec2?t._referenceResolution.copy(e.referenceResolution):t._referenceResolution.set(e.referenceResolution[0],e.referenceResolution[1]),t.referenceResolution=t._referenceResolution),t.syncDrawOrder(),pc.ComponentSystem.prototype.initializeComponentData.call(this,t,e,i),t._updateScreenInChildren()},destroy:function(){this.off(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this)},_syncDrawOrder:function(){e(pc.Application.getApplication().root,0)},_onUpdate:function(t){var e=this.store;for(var i in this._dirtyOrder&&(this._syncDrawOrder(),this._dirtyOrder=!1),e)e[i].entity.screen.update&&e[i].entity.screen.update(t)},_onResize:function(t,e){this.windowResolution.x=t,this.windowResolution.y=e},cloneComponent:function(t,e){var i=t.screen;return this.addComponent(e,{enabled:i.enabled,screenType:i.screenType,scaleMode:i.scaleMode,resolution:i.resolution.clone(),referenceResolution:i.referenceResolution.clone()})},onRemoveComponent:function(t,e){e.onRemove()},onDestroy:function(t,e){e.onRemove()},processDrawOrderSyncQueue:function(){for(var t=this._drawOrderSyncQueue.list(),e=0;e<t.length;e++){var i=t[e];i.callback.call(i.scope)}this._drawOrderSyncQueue.clear()},queueDrawOrderSync:function(t,e,i){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(t)||this._drawOrderSyncQueue.push(t,{callback:e,scope:i})}}),{ScreenComponentSystem:i}}()),Object.assign(pc,{ScreenComponentData:function(){this.enabled=!0}}),Object.assign(pc,function(){var t=new pc.Vec3,e=new pc.Quat,i=new pc.Vec3;return{UIUtils:{findParentScreen:function(t){for(var e=t,i=null;e;){if(e.screen){i=e.screen;break}e=e.parent}return i},getCorrectedWorldMatrix:function(s,n){return n=n||new pc.Mat4,t.copy(s.getPosition()),e.copy(s.getRotation()),i.copy(s.getLossyScale()),i.x===i.y&&0==i.z&&(i.z=i.x,e.normalize()),n.setTRS(t,e,i),n}}}}()),pc.extend(pc,function(){pc.ELEMENTTYPE_GROUP="group",pc.ELEMENTTYPE_IMAGE="image",pc.ELEMENTTYPE_TEXT="text";var t=new pc.Mat4,e=new pc.Vec3,i=new pc.Vec4,s=(new pc.Vec3,new pc.Vec3),n=new pc.Quat.IDENTITY.clone,r=pc.Vec3.ONE.clone(),a=function(t,e){pc.Component.call(this,t,e),this._width=0,this._height=0,this._stencilLayer=255,this._anchors=new pc.Vec4,this._pivot=new pc.Vec2(.5,.5),this._sizeDelta=new pc.Vec2(0,0),this._anchoredPosition=new pc.Vec2(0,0),this.entity.on("insert",this._onInsert,this),this.screen=null,this._type=pc.ELEMENTTYPE_GROUP,this._pivotPoint=new pc.Vec3,this._image=null,this._text=null,this._group=null,this._canvasGroups=[],this.cachedRect=new UnityEngine.Rect};(a.prototype=Object.create(pc.Component.prototype)).constructor=a,pc.extend(a.prototype,{_getStencilParameters:function(){var t=this._masked?pc.FUNC_EQUAL:pc.FUNC_ALWAYS,e=this._image&&this._image.masksChildren||this._text&&this._text.masksChildren;return new pc.StencilParameters({func:t,ref:this._stencilLayer,writeMask:e?this._stencilLayer:0,readMask:e?this._stencilLayer>>1:this._stencilLayer,zfail:pc.STENCILOP_KEEP,zpass:pc.STENCILOP_REPLACE,fail:this._masked?pc.STENCILOP_KEEP:pc.STENCILOP_REPLACE})},_patch:function(){this.entity._dirtyLocal=!0,this.entity._sync=this._sync,this.entity.getLocalPosition=this.getLocalPosition,this.entity.setLocalPosition=this.setLocalPosition,this.entity.getWorldTransform=this.getWorldTransform},_unpatch:function(){this.entity._sync=pc.Entity.prototype._sync,this.entity.getLocalPosition=pc.Entity.prototype.getLocalPosition,this.entity.setLocalPosition=pc.Entity.prototype.setLocalPosition,this.entity.getWorldTransform=pc.GraphNode.prototype.getWorldTransform},getLocalPosition:function(){return this.element.getRect(),this.localPosition},setLocalPosition:function(t,i,s){e.copy(this.getLocalPosition()),t instanceof pc.Vec3?(e.sub2(t,e),this.localPosition.z=t.z):(e.x=t-e.x,e.y=i-e.y,this.localPosition.z=s),this.element._anchoredPosition.add(e),this._dirtifyRect()},getWorldTransform:function(){return this._dirtyLocal||this._dirtyWorld||this._dirtyRect?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform},getRect:function(){var t=this._findParentElement();return t&&t.element.getRect(),this.entity._dirtyRect&&this.entity._sync(),this.cachedRect.m_XMin=-this._pivotPoint.x,this.cachedRect.m_YMin=-this._pivotPoint.y,this.cachedRect.m_Width=this._width,this.cachedRect.m_Height=this._height,this.cachedRect.m_XMax=this.cachedRect.m_XMin+this._width,this.cachedRect.m_YMax=this.cachedRect.m_YMin+this._height,this.cachedRect},_sync:function(){var i=this.element;if(this._dirtyRect||this._dirtyLocal||this._dirtyLocalEulerAngles||this._dirtyWorld){this.hasChanged=!0,this._dirtyLocalEulerAngles&&(this.localRotation.setFromEulerAngles(this.localEulerAngles.x,this.localEulerAngles.y,this.localEulerAngles.z),this._dirtyLocal=!0,this._dirtyLocalEulerAngles=!1);var a=i._width,o=i._height,h=this._dirtyRect;if(this._dirtyRect||this._dirtyWorld){var c=i._findParentElement();if(c){var l=c.element;if(i._width=(i._anchors.z-i._anchors.x)*l._width+i._sizeDelta.x,i._height=(i._anchors.w-i._anchors.y)*l._height+i._sizeDelta.y,this._parent===c){var p=l._width*i._anchors.x,u=l._width*i._anchors.z,d=l._height*i._anchors.y,_=l._height*i._anchors.w;e.set(pc.math.lerp(p,u,i._pivot.x)+i._anchoredPosition.x,pc.math.lerp(d,_,i._pivot.y)+i._anchoredPosition.y),this.localPosition.x=e.x-l._pivotPoint.x,this.localPosition.y=e.y-l._pivotPoint.y}else this.localPosition.x=i._anchoredPosition.x,this.localPosition.y=i._anchoredPosition.y}else i._width=i._sizeDelta.x,i._height=i._sizeDelta.y,this.localPosition.x=i._anchoredPosition.x,this.localPosition.y=i._anchoredPosition.y;this._dirtyRect=!1,this._dirtyLocal=!0}if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1,this._dirtifyWorld(!0),this._aabbVer++),this._parent&&this._parent.getWorldTransform(),this._dirtyWorld){i._pivotPoint.set(i._width*i._pivot.x,i._height*i._pivot.y,0);var f=this.screen;if(f&&!f._findParentScreen()){var m=f.resolution;switch(s.copy(pc.Vec3.ZERO),n.copy(pc.Quat.IDENTITY),r.copy(pc.Vec3.ONE),f.screenType){case pc.SCREEN_TYPE_SCREEN:i._width=m.x/f.scale,i._height=m.y/f.scale,r.scale(f.scale),s.set(.5*m.x,.5*m.y,0),this.worldTransform.setTRS(s,n,r),this._parent?this.localTransform.mul2(this._parent.worldTransformInverse,this.worldTransform):this.localTransform.copy(this.worldTransform),this.localTransform.getTranslation(this.localPosition),this.localTransform.getTranslation(i._anchoredPosition),this.localTransform.getScale(this.localScale),i._pivotPoint.set(.5*i._width,.5*i._height,0);break;case pc.SCREEN_TYPE_CAMERA:i._width=m.x/f.scale,i._height=m.y/f.scale,i._sizeDelta.copy(m),r.scale(f._planeHeight/i._height),e.set(0,0,f._screenDistance);var g=f.camera._component.entity;this.worldTransform.copy(g.getWorldTransform()),t.setTRS(e,pc.Quat.IDENTITY,r),this.worldTransform.mul(t),this._parent?this.localTransform.mul2(this._parent.worldTransformInverse,this.worldTransform):this.localTransform.copy(this.worldTransform),this.localTransform.getTranslation(this.localPosition),this.localTransform.getTranslation(i._anchoredPosition),this.localTransform.getScale(this.localScale),i._pivotPoint.set(.5*i._width,.5*i._height,0);break;case pc.SCREEN_TYPE_WORLD:i._width=i._sizeDelta.x,i._height=i._sizeDelta.y,this.localPosition.set(i._anchoredPosition.x,i._anchoredPosition.y,this.localPosition.z),this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this.worldTransform.mul2(this._parent.worldTransform,this.localTransform)}i._sizeDelta.set(i._width,i._height)}else null===this._parent?this.worldTransform.copy(this.localTransform):this.worldTransform.mul2(this._parent.worldTransform,this.localTransform);this.worldTransformInverse.copy(this.worldTransform).invert(),this._dirtyWorld=!1,this.calculateLossyScale(this.cachedLossyScale);var y=i.cachedRect;y.m_XMin=-i._pivotPoint.x,y.m_YMin=-i._pivotPoint.y,y.m_Width=i._width,y.m_Height=i._height,y.m_XMax=y.m_XMin+y.m_Width,y.m_YMax=y.m_YMin+y.m_Height;for(var E=0,v=this._children.length;E<v;E++)this._children[E]._dirtifyWorld();i.fire("resize",i._width,i._height);var T=i._width!==a,b=i._height!==o;h||!T&&!b||i.triggerOnElementDimesionsChange(T,b)}}},setVerticesDirty:function(){this._image&&this._image.setVerticesDirty(),this._text&&this._text.setVerticesDirty()},_onInsert:function(t){var e=this._findScreen();this._updateScreen(e),e&&!this.entity.isPrefab&&this.entity.getScene()&&this.triggerOnElementDimesionsChange(!0,!0)},_updateScreen:function(t,e){this.screen=this._findScreen(),this._patch(),this.fire("set:screen",this.screen),this.entity._dirtifyRect(),this.entity._dirtifyWorld(),this._updateScreenForNonElement(this.entity,t,e),this.screen&&!e&&this.screen.screen.syncDrawOrder()},_updateScreenForNonElement:function(t,e,i){for(var s=t.getChildren(),n=0,r=s.length;n<r;n++)s[n].element?s[n].element._updateScreen(e,i):this._updateScreenForNonElement(s[n],e,i)},_findScreen:function(){var t=this.entity,e=this.screen;for(this._nearestScreen=null;t;)this._nearestScreen=this._nearestScreen||t.screen,e=t.screen||e,t=t._parent;return e?e.entity:null},_findParentElement:function(){for(var t=this.entity._parent;t&&!t.element;)t=t._parent;return t},_onScreenResize:function(t){this.entity._dirtifyRect(),this.fire("screen:set:resolution",t)},_onScreenTypeChange:function(){this.entity._dirtifyWorld(),this.fire("screen:set:screentype",this.screen.screen.screenType)},addCanvasGroup:function(t,e){null==e?e=0:this.entity._canvasGroups.length>0&&e++,this._canvasGroups.splice(e,0,t);for(var i=this.entity.children,s=0;s<i.length;s++){var n=i[s].element;n&&n.addCanvasGroup(t,e)}},removeCanvasGroup:function(t){var e=this._canvasGroups.indexOf(t);e>-1&&this._canvasGroups.splice(e,1);for(var i=this.entity.children,s=0;s<i.length;s++){var n=i[s].element;n&&n.removeCanvasGroup(t)}},onRemove:function(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy()},triggerOnElementDimesionsChange:function(t,e){this.entity._elementDimesionsChange();for(var i=this.entity.children,s=0;s<i.length;s++)if(i[s]._enabled){var n=i[s].element;if(n){var r=t&&n._anchors.x!==n._anchors.z,a=e&&n._anchors.y!==n._anchors.w;(r||a)&&n.triggerOnElementDimesionsChange(r,a)}}},setupParametersFromImage:function(t,e,i,s,n,r,a,o,h,c,l){var p=this._image;if(p){var u=p._updateMesh;p._updateMesh=function(){},this["UnityEngine.UI.Image"]=t,p.sprite=e,p.spriteType=i,p.fillMethod=s,p.fillOrigin=n,p.fillAmount=r,p.fillCenter=a,p.preserveAspect=o,p.ignoreMask=h,p.enabled=c,p.color=t.m_Color,p._updateMesh=u,p._updateMesh(),this.material=l}}}),Object.defineProperty(a.prototype,"type",{get:function(){return this._type},set:function(t){t!==this._type&&(this._type=t,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),t===pc.ELEMENTTYPE_IMAGE?this._image=new pc.ImageElement(this):t===pc.ELEMENTTYPE_TEXT&&(this._text=new pc.TextElement(this)))}}),Object.defineProperty(a.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(t){this._drawOrder!==t&&(this._drawOrder=t,this.fire("set:draworder",this._drawOrder))}}),Object.defineProperty(a.prototype,"width",{get:function(){return this._width}}),Object.defineProperty(a.prototype,"height",{get:function(){return this._height}}),Object.defineProperty(a.prototype,"pivot",{get:function(){return this._pivot},set:function(t){t instanceof pc.Vec2?this._pivot.set(t.x,t.y):this._pivot.set(t[0],t[1]),this.entity._dirtifyRect()}}),Object.defineProperty(a.prototype,"anchor",{get:function(){return this._anchors},set:function(t){var e=t;if(e instanceof pc.Vec4||(e=i).set(e[0],e[1],e[2],e[3]),!e.equals(this._anchors)){var s=this._anchors.z-this._anchors.x!=e.z-e.x,n=this._anchors.w-this._anchors.y!=e.w-e.y;this._anchors.copy(e),this.entity._dirtifyRect(),(s||n)&&this.triggerOnElementDimesionsChange(s,n)}}}),Object.defineProperty(a.prototype,"anchoredPosition",{get:function(){return this._anchoredPosition},set:function(t){this._anchoredPosition.copy(t),this.entity._dirtifyRect()}}),Object.defineProperty(a.prototype,"sizeDelta",{get:function(){return this._sizeDelta},set:function(t){var e=this._sizeDelta.x!==t.x,i=this._sizeDelta.y!==t.y;(e||i)&&(this._sizeDelta.copy(t),this.entity._dirtifyRect(),this.triggerOnElementDimesionsChange(e,i))}}),Object.defineProperty(a.prototype,"rect",{get:a.prototype.getRect}),Object.defineProperty(a.prototype,"stencilLayer",{get:function(){return this._stencilLayer},set:function(t){this._stencilLayer!==t&&(this._stencilLayer=t,this.fire("set:stencillayer",t))}});var o=function(t){Object.defineProperty(a.prototype,t,{get:function(){return this._text?this._text[t]:this._image?this._image[t]:null},set:function(e){this._text?this._text[t]=e:this._image&&(this._image[t]=e)}})};return o("fontSize"),o("color"),o("font"),o("fontAsset"),o("spacing"),o("lineHeight"),o("align"),o("verticalAlign"),o("text"),o("texture"),o("textureAsset"),o("material"),o("materialAsset"),o("opacity"),o("masksChildren"),o("showMaskGraphics"),o("alphaTest"),o("border"),{ElementComponent:a}}()),Object.assign(pc,function(){var t=["enabled"],e=function(e){pc.ComponentSystem.call(this,e),this.id="element",this.app=e,this.ComponentType=pc.ElementComponent,this.DataType=pc.ElementComponentData,this.schema=t,this._unicodeConverter=null,this._rtlReorder=null,this.on("beforeremove",this.onRemoveComponent,this)};return(e.prototype=Object.create(pc.ComponentSystem.prototype)).constructor=e,pc.Component._buildAccessors(pc.ElementComponent.prototype,t),Object.assign(e.prototype,{destroy:function(){this._defaultTexture.destroy()},initializeComponentData:function(t,e,i){var s;t._beingInitialized=!0,void 0!==e.anchor&&(e.anchor instanceof pc.Vec4?t._anchors.copy(e.anchor):t._anchors.set(e.anchor[0],e.anchor[1],e.anchor[2],e.anchor[3])),void 0!==e.pivot&&(e.pivot instanceof pc.Vec2?t._pivot.copy(e.pivot):t._pivot.set(e.pivot[0],e.pivot[1])),void 0!==e.sizeDelta&&(e.sizeDelta instanceof pc.Vec2?t._sizeDelta.copy(e.sizeDelta):t._sizeDelta.set(e.sizeDelta[0],e.sizeDelta[1])),void 0!==e.anchoredPosition&&(e.anchoredPosition instanceof pc.Vec2?t._anchoredPosition.copy(e.anchoredPosition):t._anchoredPosition.set(e.anchoredPosition[0],e.anchoredPosition[1])),void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.useInput&&(t.useInput=e.useInput),t.batchGroupId=void 0===e.batchGroupId||null===e.batchGroupId?-1:e.batchGroupId,e.layers&&"array"===pc.type(e.layers)&&(t.layers=e.layers.slice(0)),t.type=e.type,t.type===pc.ELEMENTTYPE_IMAGE?(void 0!==e.rect&&(t.rect=e.rect),void 0!==e.color&&((s=e.color)instanceof pc.Color||(s=new pc.Color(e.color[0],e.color[1],e.color[2])),t.color=s),void 0!==e.masksChildren&&(t.masksChildren=e.masksChildren),void 0!==e.alphaTest&&(t.alphaTest=e.alphaTest),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.textureAsset&&(t.textureAsset=e.textureAsset),e.texture&&(t.texture=e.texture),void 0!==e.spriteAsset&&(t.spriteAsset=e.spriteAsset),e.sprite&&(t.sprite=e.sprite),void 0!==e.spriteFrame&&(t.spriteFrame=e.spriteFrame),void 0!==e.pixelsPerUnit&&null!==e.pixelsPerUnit&&(t.pixelsPerUnit=e.pixelsPerUnit),void 0!==e.materialAsset&&(t.materialAsset=e.materialAsset),e.material&&(t.material=e.material),e.border&&(t.border=e.border),void 0!==e.mask&&(t.mask=e.mask)):t.type===pc.ELEMENTTYPE_TEXT&&(void 0!==e.align&&(t.align=e.align),void 0!==e.verticalAlign&&(t.verticalAlign=e.verticalAlign),void 0!==e.autoWidth&&(t.autoWidth=e.autoWidth),void 0!==e.autoHeight&&(t.autoHeight=e.autoHeight),void 0!==e.rtlReorder&&(t.rtlReorder=e.rtlReorder),void 0!==e.unicodeConverter&&(t.unicodeConverter=e.unicodeConverter),void 0!==e.text&&(t.text=e.text),void 0!==e.color&&((s=e.color)instanceof pc.Color||(s=new pc.Color(s[0],s[1],s[2])),t.color=s),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.spacing&&(t.spacing=e.spacing),void 0!==e.fontSize&&(t.fontSize=e.fontSize,e.lineHeight||(t.lineHeight=e.fontSize)),void 0!==e.lineHeight&&(t.lineHeight=e.lineHeight),void 0!==e.wrapLines&&(t.wrapLines=e.wrapLines),void 0!==e.fontAsset&&(t.fontAsset=e.fontAsset),void 0!==e.font&&(t.font=e.font),void 0!==e.alignment&&(t.alignment=e.alignment));var n=t._findScreen();n&&n.screen&&t._updateScreen(n.screen),pc.ComponentSystem.prototype.initializeComponentData.call(this,t,e,i),t._beingInitialized=!1,t.type===pc.ELEMENTTYPE_IMAGE&&t._image._meshDirty&&t._image._updateMesh(t._image.mesh)},onRemoveComponent:function(t,e){e.onRemove()},cloneComponent:function(t,e){var i=t.element;return this.addComponent(e,{enabled:i.enabled,width:i.width,height:i.height,anchor:i.anchor.clone(),pivot:i.pivot.clone(),margin:i.margin.clone(),alignment:i.alignment&&i.alignment.clone()||i.alignment,autoWidth:i.autoWidth,autoHeight:i.autoHeight,type:i.type,rect:i.rect&&i.rect.clone()||i.rect,rtlReorder:i.rtlReorder,unicodeConverter:i.unicodeConverter,materialAsset:i.materialAsset,material:i.material,color:i.color&&i.color.clone()||i.color,opacity:i.opacity,textureAsset:i.textureAsset,texture:i.texture,spriteAsset:i.spriteAsset,sprite:i.sprite,spriteFrame:i.spriteFrame,pixelsPerUnit:i.pixelsPerUnit,text:i.text,spacing:i.spacing,lineHeight:i.lineHeight,wrapLines:i.wrapLines,layers:i.layers,fontSize:i.fontSize,fontAsset:i.fontAsset,font:i.font,useInput:i.useInput,batchGroupId:i.batchGroupId,mask:i.mask})},registerUnicodeConverter:function(t){this._unicodeConverter=t},registerRtlReorder:function(t){this._rtlReorder=t},getUnicodeConverter:function(){return this._unicodeConverter},getRtlReorder:function(){return this._rtlReorder},_onUpdate:function(t){var e=this.store;for(var i in e)e[i].entity.element.update&&e[i].entity.element.update(t)}}),{ElementComponentSystem:e}}()),Object.assign(pc,{ElementComponentData:function(){this.enabled=!0}}),pc.extend(pc,function(){var t=[0,0,0,0],e=function(e){this._element=e,this._entity=e.entity,this._system=e.system,this._textureAsset=null,this._texture=null,this._materialAsset=null,this._material=null,this._masksChildren=!1,this._alphaTest=.01,this._ignoreMask=!1,this._showMaskGraphics=!0,this._enabled=!0,this._rect=new pc.Vec4(0,0,1,1),this._border=new pc.Vec4(0,0,0,0),this._color=new pc.Color(1,1,1,1),this._pivotPoint=new pc.Vec2,this._material=UnityEngine.Canvas.DefaultCanvasMaterial.handle,this._maskMaterial=UnityEngine.Canvas.DefaultCanvasMaterial.handle,this._positions=[],this._normals=[],this._uvs=[],this._indices=[],this._colors=[],this._canvasRenderer=this._entity._unityComponents.canvasRenderer[0],this._mesh=this._createMesh(),this._model=this._canvasRenderer.model,this._model.setParameter("_TextureSampleAdd",t),this._canvasRenderer.setMesh(this._mesh),this._canvasRenderer.setMaterial(this._material,0),this._drawOrder=0,this._fillCenter=!0,this._fillMethod=0,this._spriteType=0,this._element.on("resize",this._onParentResize,this)};return pc.extend(e.prototype,{destroy:function(){this._canvasRenderer.setMesh(null),this._element.off("resize",this._onParentResize,this),this._mesh&&(this._mesh.destroy(),this._mesh=null)},_onParentResize:function(){if(this._mesh){if(this._pivotPoint.equals(this._element._pivotPoint)&&this._width==this._element.width&&this._height==this._element.height)return;this._updateMesh(this._mesh),this._width=this._element.width,this._height=this._element.height,this._pivotPoint.copy(this._element._pivotPoint)}},setVerticesDirty:function(){this._mesh&&this._updateMesh(this._mesh)},_updateMaterial:function(){var t=this._material||UnityEngine.Canvas.DefaultCanvasMaterial.handle;this._canvasRenderer.setMaterial(t,0)},_createMesh:function(){var t=this._element.width,e=this._element.height;this._positions[0]=0,this._positions[1]=0,this._positions[2]=0,this._positions[3]=t,this._positions[4]=0,this._positions[5]=0,this._positions[6]=t,this._positions[7]=e,this._positions[8]=0,this._positions[9]=0,this._positions[10]=e,this._positions[11]=0;for(var i=0;i<12;i+=3)this._normals[i]=0,this._normals[i+1]=0,this._normals[i+2]=-1;this._uvs[0]=0,this._uvs[1]=0,this._uvs[2]=1,this._uvs[3]=0,this._uvs[4]=1,this._uvs[5]=1,this._uvs[6]=0,this._uvs[7]=1,this._indices[0]=0,this._indices[1]=1,this._indices[2]=3,this._indices[3]=2,this._indices[4]=3,this._indices[5]=1;var s=pc.createMesh(this._system.app.graphicsDevice,this._positions,{uvs:this._uvs,normals:this._normals,indices:this._indices});return this._updateMesh(s),s}}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(t){this._color.copy(t)}}),Object.defineProperty(e.prototype,"masksChildren",{get:function(){return this._masksChildren},set:function(t){this._masksChildren=t,this._canvasRenderer.model.masksChildren=t,this._element&&this._element.screen&&(this._element.screen.screen.canvasMeshInstance.renderersDirty=!0)}}),Object.defineProperty(e.prototype,"alphaTest",{get:function(){return this._alphaTest},set:function(t){this._alphaTest=t,this._updateMaterial()}}),Object.defineProperty(e.prototype,"opacity",{get:function(){return this._color.data[3]},set:function(t){this._color.a=t,this.color=this._color}}),Object.defineProperty(e.prototype,"rect",{get:function(){return this._rect},set:function(t){t instanceof pc.Vec4?this._rect.set(t.x,t.y,t.z,t.w):this._rect.set(t[0],t[1],t[2],t[3]),this._mesh&&this._updateMesh(this._mesh)}}),Object.defineProperty(e.prototype,"border",{get:function(){return this._border},set:function(t){t instanceof pc.Vec4?this._border.set(t.x,t.y,t.z,t.w):this._border.set(t[0],t[1],t[2],t[3]),this._mesh&&this._updateMesh(this._mesh)}}),Object.defineProperty(e.prototype,"material",{get:function(){return this._material},set:function(t){this._material=t,this._updateMaterial()}}),Object.defineProperty(e.prototype,"texture",{get:function(){return this._texture},set:function(t){this._texture=t,this._canvasRenderer.setTexture(this._texture),this._mesh&&this._updateMesh(this._mesh)}}),Object.defineProperty(e.prototype,"ignoreMask",{get:function(){return this._ignoreMask},set:function(t){this._ignoreMask=t,t&&(this.alphaTest=0),this._updateMaterial()}}),Object.defineProperty(e.prototype,"showMaskGraphics",{get:function(){return this._showMaskGraphics},set:function(t){this._showMaskGraphics=t,this._canvasRenderer.showMaskGraphics=t,this._updateMaterial()}}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(t){if(this._enabled!=t){this._enabled=t,this._canvasRenderer.enabled=t;var e=this._enabled?this._canvasRenderer.findParentCanvas():null;this._canvasRenderer.reparentCanvas(e)}}}),{ImageElement:e}}()),pc.extend(pc,function(){var t=[1,1,1,0],e=function(e){this._element=e,this._system=e.system,this._entity=e.entity,this._text="",this._enabled=!0,this._horizontalWrap=!1,this._verticalOverflow=!1,this._align=pc.TEXT_ALIGN_CENTER,this._veticalAlign=pc.TEXT_VERTICAL_ALIGN_MIDDLE,this._fontAsset=null,this._font=null,this._color=new pc.Color(1,1,1,1),this._spacing=1,this._fontSize=32,this._lineHeight=1,this._bestFit=!1,this._minFontSize=0,this._maxFontSize=1e3,this.width=0,this.height=0,this._material=null,this._canvasRenderer=this._entity._unityComponents.canvasRenderer?this._entity._unityComponents.canvasRenderer[0]:null,this._mesh=this._createMesh(""),this._model=this._canvasRenderer.model,this._model.setParameter("_TextureSampleAdd",t),this._canvasRenderer.setMesh(this._mesh),this._canvasRenderer.setMaterial(this._material,0),this._positions=[],this._normals=[],this._uvs=[],this._indices=[],this._spacings=new pc.Vec4(0,0,0,0),this._noResize=!1,this._masksChildren=!1};return pc.extend(e.prototype,{destroy:function(){this._canvasRenderer.setMesh(null),this._element.off("resize",this._onParentResize,this),this._mesh&&(this._mesh.destroy(),this._mesh=null)},_updateTextObsolete:function(t){if(this._font&&(!this._element||this._element._enabled)){if(void 0===t&&(t=this._text),this._mesh&&t.length===this._text.length)this._updateMesh(this._mesh,t);else{if(this._mesh){this._canvasRenderer.setMesh(null),this._mesh.vertexBuffer.destroy();for(var e=0;e<this._mesh.indexBuffer.length;e++)this._mesh.indexBuffer[e].destroy();this._model=null,this._mesh=null,this._meshInstance=null}this._updateMaterial(),this._mesh=this._createMesh(t),this._canvasRenderer.setMesh(this._mesh),this._onStencilLayerChange(),this._updateAligns()}this._canvasRenderer.setTexture(this._font.texture)}},_updateAligns:function(){var t=1;if(this._bestFit){var e=this._element.width/this.width,i=this._element.width/this.width,s=this._minFontSize/this._fontSize,n=this._maxFontSize/this._fontSize;t=Math.min(e,i),t=Math.min(n,Math.max(s,t)),this._node.setLocalScale(t,t,t)}this._element.width,this.width,this._element.height,this.height;if(this._align==pc.TEXT_ALIGN_CENTER&&.5,this._align==pc.TEXT_ALIGN_LEFT&&0,this._veticalAlign==pc.TEXT_VERTICAL_ALIGN_MIDDLE&&.5,this._veticalAlign==pc.TEXT_VERTICAL_ALIGN_BOTTOM&&0,this._mesh){var r=pc.Vec3.ZERO.clone();r.x+=this._spacings.x*t,r.y+=this._spacings.w*t}},_updateMaterial:function(){var t=this._material||UnityEngine.Canvas.DefaultCanvasMaterial.handle;this._canvasRenderer.setMaterial(t,0)},_createMeshObsolete:function(t){var e=t.length;0===e&&(e=1,t=" "),this._positions=new Array(3*e*4),this._normals=new Array(3*e*4),this._uvs=new Array(2*e*4),this._indices=new Array(3*e*2);for(var i=0;i<e;i++)this._indices.push(4*i,4*i+1,4*i+3),this._indices.push(4*i+2,4*i+3,4*i+1);var s=pc.createMesh(this._system.app.graphicsDevice,this._positions,{uvs:this._uvs,normals:this._normals,indices:this._indices});return this._updateMesh(s,t),s},setVerticesDirty:function(){this._mesh&&this._updateMesh(this._mesh,text)}}),Object.defineProperty(e.prototype,"text",{get:function(){return this._text},set:function(t){var e=(t||"").toString();this._text!=e&&(this._font&&this._updateText(e),this._text=e)}}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(t){this._color.copy(t)}}),Object.defineProperty(e.prototype,"opacity",{get:function(){return this._color.data[3]},set:function(t){this._color.a=t,this.color=this._color}}),Object.defineProperty(e.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(t){this._lineHeight=t}}),Object.defineProperty(e.prototype,"spacing",{get:function(){return this._spacing},set:function(t){this._spacing=t}}),Object.defineProperty(e.prototype,"align",{get:function(){return this._align},set:function(t){this._align=t}}),Object.defineProperty(e.prototype,"verticalAlign",{get:function(){return this._veticalAlign},set:function(t){this._veticalAlign=t}}),Object.defineProperty(e.prototype,"fontSize",{get:function(){return this._fontSize},set:function(t){this._fontSize;this._fontSize=t}}),Object.defineProperty(e.prototype,"horizontalWrap",{get:function(){return this._horizontalWrap},set:function(t){this._horizontalWrap=t}}),Object.defineProperty(e.prototype,"verticalOverflow",{get:function(){return this._verticalOverflow},set:function(t){this._verticalOverflow=t}}),Object.defineProperty(e.prototype,"font",{get:function(){return this._font},set:function(t){this._font=t}}),Object.defineProperty(e.prototype,"bestFit",{get:function(){return this._bestFit},set:function(t){this._bestFit=t}}),Object.defineProperty(e.prototype,"minFontSize",{get:function(){return this._minFontSize},set:function(t){this._minFontSize=t}}),Object.defineProperty(e.prototype,"maxFontSize",{get:function(){return this._maxFontSize},set:function(t){this._maxFontSize=t}}),Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(t){if(this._enabled!=t){this._enabled=t,this._canvasRenderer.enabled=t,!this._enabled&&this._textGenerator&&this._textGenerator._reset();var e=this._enabled?this._canvasRenderer.findParentCanvas():null;this._canvasRenderer.reparentCanvas(e)}}}),Object.defineProperty(e.prototype,"material",{get:function(){return this._material},set:function(t){this._material=t,this._updateMaterial()}}),Object.defineProperty(e.prototype,"masksChildren",{get:function(){return this._masksChildren},set:function(t){this._masksChildren=t;for(var e=this._canvasRenderer.model.meshInstances,i=0;i<e.length;i++){var s=e[i];t?s._shaderDefs|=pc.SHADERDEF_UI_MASK:s._shaderDefs&=~pc.SHADERDEF_UI_MASK}this._element&&this._element.screen&&(this._element.screen.screen.canvasMeshInstance.renderersDirty=!0)}}),{TextElement:e,TEXT_ALIGN_LEFT:"left",TEXT_ALIGN_RIGHT:"right",TEXT_ALIGN_CENTER:"center",TEXT_VERTICAL_ALIGN_TOP:"top",TEXT_VERTICAL_ALIGN_MIDDLE:"middle",TEXT_VERTICAL_ALIGN_BOTTOM:"bottom"}}()),pc.extend(pc,{POINTEREVENT_MOVE:"pointer:move",POINTEREVENT_UP:"pointer:up",POINTEREVENT_DOWN:"pointer:down",POINTEREVENT_CLICK:"pointer:click",POINTEREVENT_SCROLL:"pointer:scroll",POINTEREVENT_ENTER:"pointer:enter",POINTEREVENT_LEAVE:"pointer:leave"}),Object.assign(pc,function(){pc.FONT_MSDF="msdf",pc.FONT_BITMAP="bitmap";var t=function(t,e){this.type=t&&t.type||pc.FONT_MSDF,this.em=1,this.intensity=0,this._data=null,this.data=t,this._name=e.name||"",this._ascent=t.info.ascent||0,this._lineHeight=t.info.lineHeight||0,this._fontSize=t.info.fontSize||null,this._characterInfo=e.characterInfo||null,this._textures=e.texture||null};return Object.defineProperty(t.prototype,"name",{get:function(){return this._name}}),Object.defineProperty(t.prototype,"ascent",{get:function(){return this._ascent}}),Object.defineProperty(t.prototype,"lineHeight",{get:function(){return this._lineHeight}}),Object.defineProperty(t.prototype,"fontSize",{get:function(){return this._fontSize}}),Object.defineProperty(t.prototype,"characterInfo",{get:function(){return this._characterInfo}}),Object.defineProperty(t.prototype,"texture",{get:function(){return this._textures}}),Object.defineProperty(t.prototype,"data",{get:function(){return this._data},set:function(t){if(this._data=t,t&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||this._data.version<2)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(var e in this._data.chars)this._data.chars[e].map=0}}),{FONT_MSDF:pc.FONT_MSDF,Font:t}}()),Object.assign(pc,function(){var t=function(t,e){this.type="bitmap",this.app=t,this.intensity=0,e=e||{},this.fontWeight=e.fontWeight||"normal",this.fontSize=parseInt(e.fontSize,10),this.glyphSize=this.fontSize,this.fontName=e.fontName||"Arial",this.color=e.color||new pc.Color(1,1,1),this._customGetCharScale=e.getCharScale||null;var i=e.width>4096?4096:e.width||2048,s=e.height>4096?4096:e.height||2048,n=document.createElement("canvas");n.height=s,n.width=i;var r=new pc.Texture(this.app.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!0});r.setSource(n),r.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR,r.magFilter=pc.FILTER_LINEAR,r.addressU=pc.ADDRESS_CLAMP_TO_EDGE,r.addressV=pc.ADDRESS_CLAMP_TO_EDGE,this.textures=[r],this.chars="",this.data={}};return t.prototype.createTextures=function(t){var e=this._normalizeCharsSet(t);if(e.length===this.chars.length){for(var i=0;i<e.length;i++)if(e[i]!==this.chars[i])return void this._renderAtlas(e)}else this._renderAtlas(e)},t.prototype.updateTextures=function(t){for(var e=this._normalizeCharsSet(t),i=[],s=0;s<e.length;s++){var n=e[s];this.data.chars[n]||i.push(n)}i.length>0&&this._renderAtlas(this.chars.concat(i))},t.prototype.destroy=function(){for(var t=0;t<this.textures.length;t++)this.textures[t].destroy();this.chars=null,this.color=null,this.data=null,this.fontName=null,this.fontSize=null,this.glyphSize=null,this.intensity=null,this.textures=null,this.type=null,this.fontWeight=null},t.prototype._getAndClearContext=function(t,e){var i=t.width,s=t.height,n=t.getContext("2d",{alpha:!0});return n.clearRect(0,0,i,s),n.fillStyle=e,n.fillRect(0,0,i,s),n},t.prototype._colorToRgbString=function(t,e){var i=Math.round(255*t.r),s=Math.round(255*t.g),n=Math.round(255*t.b);return e?"rgba("+i+", "+s+", "+n+", "+t.a+")":"rgb("+i+", "+s+", "+n+")"},t.prototype.renderCharacter=function(t,e,i,s,n){t.fillStyle=n,t.fillText(e,i,s)},t.prototype._renderAtlas=function(t){this.chars=t;var e=1,i=this.textures[e-1].getSource(),s=i.width,n=i.height,r=this._colorToRgbString(this.color,!1),a=this.color.a;this.color.a=1/255;var o=this._colorToRgbString(this.color,!0);this.color.a=a;var h=this._getAndClearContext(i,o);h.font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName,h.textAlign="center",h.textBaseline="bottom",this.data=this._createJson(this.chars,this.fontName,s,n);var c,l=this.glyphSize,p=this.glyphSize,u=l/2,d=u,_=p,f=pc.string.getSymbols(this.chars.join("")),m=this.textures.length;for(c=0;c<f.length;c++){var g=f[c],y=pc.string.getCodePoint(f[c]),E=this._getCharScale(y)*this.fontSize;h.font=this.fontWeight+" "+E.toString()+"px "+this.fontName,h.textAlign="center",h.textBaseline="bottom",this.renderCharacter(h,g,d,_,r);var v=h.measureText(g).width,T=(l-v)/2,b=v;if(this._addChar(this.data,g,y,d-u,_-p,l,p,T,0,b,e-1,s,n),(d+=l)+u>s&&(d=u,(_+=p)>n))if(this.textures[e-1].upload(),_=p,++e>m){(i=document.createElement("canvas")).height=n,i.width=s,h=this._getAndClearContext(i,o);var A=new pc.Texture(this.app.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!0});A.setSource(i),A.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR,A.magFilter=pc.FILTER_LINEAR,A.addressU=pc.ADDRESS_CLAMP_TO_EDGE,A.addressV=pc.ADDRESS_CLAMP_TO_EDGE,this.textures.push(A)}else i=this.textures[e-1].getSource(),h=this._getAndClearContext(i,o)}if(this.textures[e-1].upload(),e<m){for(c=e;c<m;c++)this.textures[c].destroy();this.textures.splice(e)}},t.prototype._createJson=function(t,e,i,s){return{version:3,intensity:this.intensity,info:{face:e,width:i,height:s,maps:[{width:i,height:s}]},chars:{}}},t.prototype._getCharScale=function(t){if(this._customGetCharScale){var e=this._customGetCharScale(t);if(e>=0)return e}return t>=192&&t<=221?.875:t>=126976&&t<=129535?.8:t>=9728&&t<=9983?.8:t>=9984&&t<=10175?.8:10145===t||t>=11008&&t<=11023?.8:1},t.prototype._addChar=function(t,e,i,s,n,r,a,o,h,c,l,p,u){t.info.maps.length<l+1&&t.info.maps.push({width:p,height:u});var d=this._getCharScale(i)*this.fontSize/32;t.chars[e]={id:i,letter:e,x:s,y:n,width:r,height:a,xadvance:c/d,xoffset:o/d,yoffset:h/d,scale:d,range:1,map:l,bounds:[0,0,r/d,a/d]}},t.prototype._normalizeCharsSet=function(t){var e=this.app.systems.element.getUnicodeConverter();e&&(t=e(t));var i,s={},n=pc.string.getSymbols(t);for(i=0;i<n.length;i++){var r=n[i];s[r]||(s[r]=r)}return Object.keys(s).sort()},{CanvasFont:t}}()),Object.assign(pc,function(){var t=!1,e=function(t,e,i){if(pc.GraphNode.call(this,t),t instanceof pc.Application&&(e=t),this._batchHandle=null,this.c={},this._app=e,!e&&(this._app=pc.Application.getApplication(),!this._app))throw new Error("Couldn't find current application");this.$id=null,this.objectJson=null,this.isPrefab=!0===i,this.getGuid(),this["UnityEngine.Transform"]=null,this["UnityEngine.RectTransform"]=null,this["UnityEngine.GameObject"]=null,this._destroying=!1,pc.events.attach(this),this._cullingLayer=0,this._beingDestroyed=!1,this._destroyed=!1,this._unityComponents={rigidbody:[],collider:[],joint:[],rigidbody2D:[],collider2D:[],joint2D:[],uiBehaviour:[],monoBehaviour:[],animator:[],animation:[],particlesystem:[],particleSystemRenderer:[],reflectionprobe:[],videoPlayer:[],canvasRenderer:[],audiosourceunity:[],renderer:[],meshFilter:[]},this._magicMethods=null};return(e.prototype=Object.create(pc.GraphNode.prototype)).constructor=e,e.prototype.addComponent=function(t,e){var i=this._app.systems[t];return i?this.c[t]?(console.warn("addComponent: Entity already has "+t+" component. (Check for components duplicates, e.g. SkinnedMesh & MeshFilter are both 'Models')"),null):i.addComponent(this,e):(console.error("addComponent: System "+t+" doesn't exist"),null)},e.prototype.addUnityComponentFromDeserialization=function(t,e){this._app.systems[t].addComponent(this,e)},e.prototype.addUnityComponent=function(e,i){var s=[];if(LunaUnity.Application.Instance.app.systems.unitymanager.disableCallbacks(),this._app.systems[e].addComponent(this,i),s.push(i),!t){t=!0,pc.UnityComponent.addRequiredComponents(this,i.code,s),LunaUnity.Application.Instance.app.systems.unitymanager.enableCallbacks();for(var n=s.length-1;n>=0;n--){var r=s[n];r.configureForEntity&&r.configureForEntity(this),r.onAttached&&r.onAttached(),r.onInit&&r.onInit(),this.enabled&&r.enabled&&r._onEntityStateChanged&&r._onEntityStateChanged(!0)}t=!1}},e.prototype.removeComponent=function(t){var e=this._app.systems[t];e?this.c[t]?e.removeComponent(this):console.warn("removeComponent: Entity doesn't have "+t+" component"):console.error("removeComponent: System "+t+" doesn't exist")},e.prototype.getGuid=function(){return this._guid||this.setGuid(pc.guid.create()),this._guid},e.prototype.setGuid=function(t){var e=this._app._entityIndex;this._guid&&delete e[this._guid],this._guid=t,e[this._guid]=this},e.prototype._notifyHierarchyStateChanged=function(t,e){var i,s,n=!1;t===this&&0===this._app._enableList.length&&(n=!0),t._beingEnabled=!0,t._onHierarchyStateChanged(e),t._onHierarchyStatePostChanged&&this._app._enableList.push(t);var r=t._children;for(i=0,s=r.length;i<s;i++)r[i]._enabled&&this._notifyHierarchyStateChanged(r[i],e);if(t._beingEnabled=!1,n){for(i=0,s=this._app._enableList.length;i<s;i++)this._app._enableList[i]._onHierarchyStatePostChanged();this._app._enableList.length=0}},e.prototype._onHierarchyStateChanged=function(t){var e;pc.GraphNode.prototype._onHierarchyStateChanged.call(this,t),this.fire(t?"enable":"disable"),this._unityComponents&&this._app.systems.unity._onEntityHierarchyStateChanged(this,t);var i=this.c;for(var s in i)i.hasOwnProperty(s)&&(e=i[s]).enabled&&(t?e.onEnable():e.onDisable())},e.prototype._onHierarchyStatePostChanged=function(){var t=this.c;for(var e in t)t.hasOwnProperty(e)&&t[e].onPostStateChange()},e.prototype.setRequest=function(t){this._request=t},e.prototype.getRequest=function(){return this._request},e.prototype.findByGuid=function(t){if(this._guid===t)return this;var e=this._app._entityIndex[t];return e&&(e===this||e.isDescendantOf(this))?e:null},e.prototype.destroy=function(){var t;for(t in this._destroying=!0,this.c)this.c[t].enabled=!1;for(t in this.c)this.c[t].system.removeComponent(this);for(var e=0;e<pc.UNITY_SYSTEM_IDS.length;e++)for(var i=this._unityComponents[pc.UNITY_SYSTEM_IDS[e]],s=0;s<i.length;s++)i[s].destroy();this._parent&&this._parent.removeChild(this);for(var n=this._children,r=n.shift();r;)r instanceof pc.Entity&&r.destroy(),r._parent=null,r=n.shift();this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1,this._destroyed=!0,this._layoutElements=[],this._layoutControllers=[],this._layoutSelfControllers=[],this._dimensionListeners=[],this._canvasElements=[],this._canvasGroups=[],this._meshModifiers=[]},e.prototype.clone=function(){var t={},e=this._cloneRecursively(t);return t[this.getGuid()]=e,function t(e,i,s,n){var r,a;if(i instanceof pc.Entity){var o=i.c;for(var h in o){var c=o[h],l=c.system.getPropertiesOfType("entity");for(r=0,a=l.length;r<a;r++){var p=l[r].name,u=c[p];if(!!e.findByGuid(u)){var d=n[u].getGuid();d?s.c[h][p]=d:console.warn("Could not find corresponding entity id when resolving duplicated entity references")}}}o.script&&!s._app.useLegacyScriptAttributeCloning&&s.script.resolveDuplicatedEntityReferenceProperties(o.script,n);var _=i.children.filter((function(t){return t instanceof pc.Entity})),f=s.children.filter((function(t){return t instanceof pc.Entity}));for(r=0,a=_.length;r<a;r++)t(e,_[r],f[r],n)}}(this,this,e,t),e},e.prototype._cloneRecursively=function(t){var e,i=new pc.Entity(this._app);for(var s in pc.GraphNode.prototype._cloneInternal.call(this,i),this.c){this.c[s].system.cloneComponent(this,i)}for(e=0;e<this._children.length;e++){var n=this._children[e];if(n instanceof pc.Entity){var r=n._cloneRecursively(t);i.addChild(r),t[n.getGuid()]=r}}return i},{Entity:e}}()),Object.assign(pc,function(){function t(t,e,i){if(!(t&&t instanceof pc.Component))throw new Error("The parentComponent argument is required and must be a Component");if(!e||"string"!=typeof e)throw new Error("The propertyName argument is required and must be a string");if(i&&"object"!=typeof i)throw new Error("If provided, the eventConfig argument must be an object");this._parentComponent=t,this._entityPropertyName=e,this._entity=null,this._app=t.system.app,this._configureEventListeners(i||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}return Object.assign(t.prototype,{_configureEventListeners:function(t,e){var i=this._parseEventListenerConfig(t,"external",this._parentComponent),s=this._parseEventListenerConfig(e,"internal",this);this._eventListenerConfigs=i.concat(s),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}},_parseEventListenerConfig:function(t,e,i){return Object.keys(t).map((function(s,n){var r=s.split("#"),a=r[0],o=r[1],h=t[s];if(2!==r.length||"string"!=typeof a||0===a.length||"string"!=typeof o||0===o.length)throw new Error("Invalid event listener description: `"+s+"`");if("function"!=typeof h)throw new Error("Invalid or missing callback for event listener `"+s+"`");return{id:e+"_"+n+"_"+s,sourceName:a,eventName:o,callback:h,scope:i}}),this)},_toggleLifecycleListeners:function(t){this._parentComponent[t]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[t]("beforeremove",this._onParentComponentRemove,this),pc.ComponentSystem[t]("postInitialize",this._onPostInitialize,this),this._app.on("tools:sceneloaded",this._onSceneLoaded,this);for(var e=[],i=0;i<this._eventListenerConfigs.length;++i){var s=this._eventListenerConfigs[i],n=this._app.systems[s.sourceName];n&&(-1===e.indexOf(n)&&e.push(n),n&&"gain"===s.eventName&&(this._gainListeners[s.sourceName]=s),n&&"lose"===s.eventName&&(this._loseListeners[s.sourceName]=s))}for(var r=0;r<e.length;++r)e[r][t]("add",this._onComponentAdd,this),e[r][t]("beforeremove",this._onComponentRemove,this)},_onSetEntity:function(t,e,i){if(i instanceof pc.Entity)this._updateEntityReference();else{if(null!=i&&"string"!=typeof i)return void console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof i+"'");e!==i&&this._updateEntityReference()}},_onPostInitialize:function(){this._updateEntityReference()},onParentComponentEnable:function(){this._entity||this._updateEntityReference()},_onSceneLoaded:function(){this._updateEntityReference()},_updateEntityReference:function(){var t,e=this._parentComponent.data[this._entityPropertyName];if(e instanceof pc.Entity)e=(t=e).getGuid(),this._parentComponent.data[this._entityPropertyName]=e;else{var i=this._parentComponent.system.app.root;t=this._parentComponent.entity.isDescendantOf(i)&&e?i.findByGuid(e):null}this._entity!==t&&(this._entity&&this._onBeforeEntityChange(),this._entity=t,this._entity&&this._onAfterEntityChange())},_onBeforeEntityChange:function(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)},_onAfterEntityChange:function(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)},_onComponentAdd:function(t,e){var i=e.system.id;t===this._entity&&(this._callGainOrLoseListener(i,this._gainListeners),this._toggleComponentListeners("on",i))},_onComponentRemove:function(t,e){var i=e.system.id;t===this._entity&&(this._callGainOrLoseListener(i,this._loseListeners),this._toggleComponentListeners("off",i,!0))},_callAllGainOrLoseListeners:function(t){for(var e in this._entity.c)this._callGainOrLoseListener(e,t)},_callGainOrLoseListener:function(t,e){if(this._entity.c.hasOwnProperty(t)&&e[t]){var i=e[t];i.callback.call(i.scope)}},_toggleEntityListeners:function(t,e){if(this._entity)for(var i=0;i<this._eventListenerConfigs.length;++i)this._safeToggleListener(t,this._eventListenerConfigs[i],e)},_toggleComponentListeners:function(t,e,i){for(var s=0;s<this._eventListenerConfigs.length;++s){var n=this._eventListenerConfigs[s];n.sourceName===e&&this._safeToggleListener(t,n,i)}},_safeToggleListener:function(t,e,i){var s="on"===t;if(!s||!this._listenerStatusFlags[e.id]){var n=this._getEventSource(e.sourceName,i);n&&(n[t](e.eventName,e.callback,e.scope),this._listenerStatusFlags[e.id]=s)}},_getEventSource:function(t,e){if("entity"===t)return this._entity;var i=this._entity[t];return i||(e||console.warn("Entity has no component with name "+t),null)},_onEntityDestroy:function(t){this._entity===t&&(this._toggleEntityListeners("off",!0),this._entity=null)},_onParentComponentRemove:function(t,e){e===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))},hasComponent:function(t){return!(!this._entity||!this._entity.c)&&!!this._entity.c[t]}}),Object.defineProperty(t.prototype,"entity",{get:function(){return this._entity}}),{EntityReference:t}}()),Object.assign(pc,function(){"use strict";var t=function(t){this._sortBy=t.sortBy,this.items=[],this.length=0,this.loopIndex=-1,this._sortHandler=this._doSort.bind(this)};return t.prototype._binarySearch=function(t){for(var e,i,s=0,n=this.items.length-1,r=t[this._sortBy];s<=n;)e=Math.floor((s+n)/2),(i=this.items[e][this._sortBy])<=r?s=e+1:i>r&&(n=e-1);return s},t.prototype._doSort=function(t,e){var i=this._sortBy;return t[i]-e[i]},t.prototype.insert=function(t){var e=this._binarySearch(t);this.items.splice(e,0,t),this.length++,this.loopIndex>=e&&this.loopIndex++},t.prototype.append=function(t){this.items.push(t),this.length++},t.prototype.remove=function(t){var e=this.items.indexOf(t);e<0||(this.items.splice(e,1),this.length--,this.loopIndex>=e&&this.loopIndex--)},t.prototype.sort=function(){var t=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==t&&(this.loopIndex=this.items.indexOf(t))},{SortedLoopArray:t}}()),Object.assign(pc,function(){"use strict";var t=function(t){this._app=t,this._scripts={},this._cache={}};return t._types=[],t._push=function(e){pc.script.legacy&&t._types.length>0?console.assert("Script Ordering Error. Contact support@playcanvas.com"):t._types.push(e)},Object.assign(t.prototype,{load:function(e,i){var s=this;pc.script.app=this._app,this._loadScript(e,function(e,n,r){if(e)i(e);else if(pc.script.legacy){var a=null;t._types.length&&(a=t._types.pop()),a?this._scripts[n]=a:a=null,i(null,a,r)}else{for(var o={},h=0;h<t._types.length;h++)o[t._types[h].name]=t._types[h];t._types.length=0,i(null,o,r),delete s._loader._cache[n+"script"]}}.bind(this))},open:function(t,e){return e},patch:function(t,e){},_loadScript:function(t,e){var i=document.head,s=document.createElement("script");this._cache[t]=s,s.async=!1,s.addEventListener("error",(function(t){e(pc.string.format("Script: {0} failed to load",t.target.src))}),!1);var n=!1;s.onload=s.onreadystatechange=function(){n||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(n=!0,e(null,t,s))},s.src=t,i.appendChild(s)}}),{ScriptHandler:t}}()),Object.assign(pc,{inherits:function(t,e){var i=function(){},s=function(i,s,n,r,a,o,h,c){e.call(this,i,s,n,r,a,o,h,c),t.call(this,i,s,n,r,a,o,h,c)};return s._super=e.prototype,i.prototype=e.prototype,s.prototype=new i,s}}),pc.anim={Animation:pc.Animation,Key:pc.Key,Node:pc.Node,Skeleton:pc.Skeleton},pc.asset={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"},pc.audio={AudioManager:pc.SoundManager,Channel:pc.Channel,Channel3d:pc.Channel3d,Listener:pc.Listener,Sound:pc.Sound},pc.fw={Application:pc.Application,Component:pc.Component,ComponentData:pc.ComponentData,ComponentSystem:pc.ComponentSystem,Entity:pc.Entity,FillMode:{NONE:pc.FILLMODE_NONE,FILL_WINDOW:pc.FILLMODE_FILL_WINDOW,KEEP_ASPECT:pc.FILLMODE_KEEP_ASPECT},ResolutionMode:{AUTO:pc.RESOLUTION_AUTO,FIXED:pc.RESOLUTION_FIXED}},Object.assign(pc.gfx,{drawQuadWithShader:pc.drawQuadWithShader,programlib:pc.programlib,shaderChunks:pc.shaderChunks,ContextCreationError:pc.ContextCreationError,Device:pc.GraphicsDevice,IndexBuffer:pc.IndexBuffer,ProgramLibrary:pc.ProgramLibrary,RenderTarget:pc.RenderTarget,ScopeId:pc.ScopeId,Shader:pc.Shader,ShaderInput:pc.ShaderInput,Texture:pc.Texture,UnsupportedBrowserError:pc.UnsupportedBrowserError,VertexBuffer:pc.VertexBuffer,VertexFormat:pc.VertexFormat,VertexIterator:pc.VertexIterator}),function(){function t(t){this.name="UnsupportedBrowserError",this.message=t||""}function e(t){this.name="ContextCreationError",this.message=t||""}t.prototype=Error.prototype,e.prototype=Error.prototype,pc.ContextCreationError=e,pc.UnsupportedBrowserError=t}(),Object.assign(pc.input,{getTouchTargetCoords:pc.getTouchTargetCoords,Controller:pc.Controller,GamePads:pc.GamePads,Keyboard:pc.Keyboard,KeyboardEvent:pc.KeyboardEvent,Mouse:pc.Mouse,MouseEvent:pc.MouseEvent,Touch:pc.Touch,TouchDevice:pc.TouchDevice,TouchEvent:pc.TouchEvent}),pc.math.INV_LOG2=Math.LOG2E,pc.math.intToBytes=pc.math.intToBytes32,pc.math.bytesToInt=pc.math.bytesToInt32,pc.posteffect={createFullscreenQuad:pc.createFullscreenQuad,drawFullscreenQuad:pc.drawFullscreenQuad,PostEffect:pc.PostEffect,PostEffectQueue:pc.PostEffectQueue},Object.assign(pc.scene,{partitionSkin:pc.partitionSkin,procedural:{calculateTangents:pc.calculateTangents,createMesh:pc.createMesh,createTorus:pc.createTorus,createCylinder:pc.createCylinder,createCapsule:pc.createCapsule,createCone:pc.createCone,createSphere:pc.createSphere,createPlane:pc.createPlane,createBox:pc.createBox},BasicMaterial:pc.BasicMaterial,DepthMaterial:pc.DepthMaterial,ForwardRenderer:pc.ForwardRenderer,GraphNode:pc.GraphNode,Material:pc.Material,Command:pc.Command,Mesh:pc.Mesh,MeshInstance:pc.MeshInstance,Model:pc.Model,ParticleEmitter:pc.ParticleEmitter,PhongMaterial:pc.StandardMaterial,Picker:pc.Picker,PickMaterial:pc.PickMaterial,Projection:{ORTHOGRAPHIC:pc.PROJECTION_ORTHOGRAPHIC,PERSPECTIVE:pc.PROJECTION_PERSPECTIVE},Scene:pc.Scene,Skin:pc.Skin,SkinInstance:pc.SkinInstance}),pc.shape={Aabb:pc.BoundingBox,Sphere:pc.BoundingSphere,Plane:pc.Plane},pc.time=pc,pc.PhongMaterial=pc.StandardMaterial,pc.BoundingSphere.prototype.intersectRay=pc.BoundingSphere.prototype.intersectsRay,pc.ELEMENTTYPE_INT8=pc.TYPE_INT8,pc.ELEMENTTYPE_UINT8=pc.TYPE_UINT8,pc.ELEMENTTYPE_INT16=pc.TYPE_INT16,pc.ELEMENTTYPE_UINT16=pc.TYPE_UINT16,pc.ELEMENTTYPE_INT32=pc.TYPE_INT32,pc.ELEMENTTYPE_UINT32=pc.TYPE_UINT32,pc.ELEMENTTYPE_FLOAT32=pc.TYPE_FLOAT32,Object.defineProperty(pc.shaderChunks,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+pc.shaderChunks.transformVS}}),Object.defineProperty(pc.Vec2.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}}),Object.defineProperty(pc.Vec3.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}}),Object.defineProperty(pc.Vec4.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}}),Object.defineProperty(pc.Color.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}}),Object.defineProperty(pc.Color.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}}),pc.Material.prototype.getName=function(){return console.warn("DEPRECATED: pc.Material#getName is deprecated. Get the pc.Material#name property instead."),this.name},pc.Material.prototype.setName=function(t){console.warn("DEPRECATED: pc.Material#getName is deprecated. Set the pc.Material#name property instead."),this.name=t},pc.Material.prototype.getShader=function(){return console.warn("DEPRECATED: pc.Material#getShader is deprecated. Get the pc.Material#shader property instead."),this.shader},pc.Material.prototype.setShader=function(t){console.warn("DEPRECATED: pc.Material#setShader is deprecated. Set the pc.Material#shader property instead."),this.shader=t},pc.GraphNode.prototype._dirtify=function(t){console.warn("DEPRECATED: pc.GraphNode#_dirtify is deprecated. Use the pc.GraphNode#_dirtifyLocal or _dirtifyWorld respectively instead."),t?this._dirtifyLocal():this._dirtifyWorld()},Object.assign(pc.Application.prototype,function(){var t=new pc.GraphNode,e=new pc.GraphNode,i=[],s=!1,n=function(t){this.lineVertexFormat=new pc.VertexFormat(t,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_COLOR,components:4,type:pc.TYPE_UINT8,normalize:!0}]),this.lineBatches=[],this.layers=[],this.layerToBatch={},this.quadMesh=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.identityGraphNode=new pc.GraphNode};n.prototype.addLayer=function(t){this.layers.indexOf(t)<0&&this.layers.push(t)},n.prototype.getLayerIdx=function(t){return this.layerToBatch[t.id]},n.prototype.addLayerIdx=function(t,e){this.layerToBatch[e.id]=t};var r=function(){this.numLinesAllocated=128,this.vb=null,this.vbRam=null,this.mesh=null,this.linesUsed=0,this.material=null,this.meshInstance=null,this.layer=null};return Object.assign(r.prototype,{init:function(t,i,s,n){for(this.mesh||(this.mesh=new pc.Mesh,this.mesh.primitive[0].type=pc.PRIMITIVE_LINES,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=new pc.BasicMaterial,this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=pc.BLEND_NORMAL,this.material.update()),this.layer=s;this.linesUsed+n>this.numLinesAllocated;)this.vb&&(this.vb.destroy(),this.vb=null),this.numLinesAllocated*=2;this.vertexFormat=i,this.vb||(this.vb=new pc.VertexBuffer(t,i,2*this.numLinesAllocated,pc.BUFFER_DYNAMIC),this.mesh.vertexBuffer=this.vb,this.vbRam=new DataView(this.vb.lock()),this.meshInstance||(e.worldTransform=pc.Mat4.IDENTITY,e._dirtyWorld=e._dirtyNormal=!1,this.meshInstance=new pc.MeshInstance(e,this.mesh,this.material),this.meshInstance.cull=!1))},addLines:function(t,e){for(var i,s=!!e.length,n=2*this.linesUsed*this.vertexFormat.size,r=0;r<t.length;r++)this.vbRam.setFloat32(n,t[r].x,!0),n+=4,this.vbRam.setFloat32(n,t[r].y,!0),n+=4,this.vbRam.setFloat32(n,t[r].z,!0),n+=4,i=s?e[r]:e,this.vbRam.setUint8(n,255*i.r),n+=1,this.vbRam.setUint8(n,255*i.g),n+=1,this.vbRam.setUint8(n,255*i.b),n+=1,this.vbRam.setUint8(n,255*i.a),n+=1;this.linesUsed+=t.length/2},finalize:function(){this.linesUsed>0&&(this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,i[0]=this.meshInstance,this.layer.addMeshInstances(i,!0),this.linesUsed=0)}}),{renderMeshInstance:function(t,e){e||(e={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)}),this._initImmediate(),this._immediateData.addLayer(e.layer),i[0]=t,e.layer.addMeshInstances(i,!0)},renderMesh:function(e,s,n,r){r||(r={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)}),this._initImmediate(),t.worldTransform=n,t._dirtyWorld=t._dirtyNormal=!1;var a=new pc.MeshInstance(t,e,s);a.cull=!1,r.mask&&(a.mask=r.mask),this._immediateData.addLayer(r.layer),i[0]=a,r.layer.addMeshInstances(i,!0)},renderWiredMesh:function(t,e,i){for(var s=new pc.Vec3,n=new pc.Vec3,r=new pc.Vec3,a=new pc.Color(1,0,0,1),o={depthTest:!1},h=e.numIndices,c=t.format.size/4,l=0;l<h;l+=3){var p=e.storage[l]*c;s.x=t.storage[p],s.y=t.storage[p+1],s.z=t.storage[p+2],i.transformPoint(s,s),p=e.storage[l+1]*c,n.x=t.storage[p],n.y=t.storage[p+1],n.z=t.storage[p+2],i.transformPoint(n,n),p=e.storage[l+2]*c,r.x=t.storage[p],r.y=t.storage[p+1],r.z=t.storage[p+2],i.transformPoint(r,r),this.renderLine(s,n,a,o),this.renderLine(n,r,a,o),this.renderLine(r,s,a,o)}},renderLine:function(t,e,i){var n,r=i,a=arguments[3],o=arguments[4];a instanceof pc.Color?(r=a,"number"==typeof o?(s||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),s=!0),n=o===pc.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0}):n=o):"number"==typeof a?(s||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),s=!0),r=i,n=a===pc.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0}):n=a||{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0},this._addLines([t,e],[i,r],n)},renderLines:function(t,e,i){i?"number"==typeof i&&(s||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),s=!0),i=i===pc.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0}):i={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0},!e.length||t.length===e.length?t.length%2==0?this._addLines(t,e,i):pc.log.error("renderLines: array length is not divisible by 2"):pc.log.error("renderLines: position/color arrays have different lengths")},renderQuad:function(e,s,n){if(n||(n={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)}),this._initImmediate(),!this._immediateData.quadMesh){var r=new pc.VertexFormat(this.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32}]),a=new pc.VertexBuffer(this.graphicsDevice,r,4),o=new pc.VertexIterator(a);o.element[pc.SEMANTIC_POSITION].set(-.5,-.5,0),o.next(),o.element[pc.SEMANTIC_POSITION].set(.5,-.5,0),o.next(),o.element[pc.SEMANTIC_POSITION].set(-.5,.5,0),o.next(),o.element[pc.SEMANTIC_POSITION].set(.5,.5,0),o.end(),this._immediateData.quadMesh=new pc.Mesh,this._immediateData.quadMesh.vertexBuffer=a,this._immediateData.quadMesh.primitive[0].type=pc.PRIMITIVE_TRISTRIP,this._immediateData.quadMesh.primitive[0].base=0,this._immediateData.quadMesh.primitive[0].count=4,this._immediateData.quadMesh.primitive[0].indexed=!1}t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=!1;var h=new pc.MeshInstance(t,this._immediateData.quadMesh,s);h.cull=!1,i[0]=h,this._immediateData.addLayer(n.layer),n.layer.addMeshInstances(i,!0)},renderWireCube:function(t,e,i){var s;if(this._initImmediate(),!this._immediateData.cubeLocalPos){var n=.5;this._immediateData.cubeLocalPos=[new pc.Vec3(-n,-n,-n),new pc.Vec3(-n,n,-n),new pc.Vec3(n,n,-n),new pc.Vec3(n,-n,-n),new pc.Vec3(-n,-n,n),new pc.Vec3(-n,n,n),new pc.Vec3(n,n,n),new pc.Vec3(n,-n,n)],this._immediateData.cubeWorldPos=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3]}var r=this._immediateData.cubeLocalPos,a=this._immediateData.cubeWorldPos;for(s=0;s<8;s++)t.transformPoint(r[s],a[s]);this.renderLines([a[0],a[1],a[1],a[2],a[2],a[3],a[3],a[0],a[4],a[5],a[5],a[6],a[6],a[7],a[7],a[4],a[0],a[4],a[1],a[5],a[2],a[6],a[3],a[7]],e,i)},_addLines:function(t,e,i){void 0===(i=i||{}).layer&&(i.layer=this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)),void 0===i.depthTest&&(i.depthTest=!0),this._initImmediate();var s=i.layer;this._immediateData.addLayer(s);var n=this._immediateData.getLayerIdx(s);if(void 0===n){var a=new r;a.init(this.graphicsDevice,this._immediateData.lineVertexFormat,s,t.length/2),a.material.depthTest=i.depthTest,i.mask&&(a.meshInstance.mask=i.mask),n=this._immediateData.lineBatches.push(a)-1,this._immediateData.addLayerIdx(n,s)}else this._immediateData.lineBatches[n].init(this.graphicsDevice,this._immediateData.lineVertexFormat,s,t.length/2),this._immediateData.lineBatches[n].material.depthTest=i.depthTest,i.mask&&(this._immediateData.lineBatches[n].meshInstance.mask=i.mask);this._immediateData.lineBatches[n].addLines(t,e)},_initImmediate:function(){this._immediateData||(this._immediateData=new n(this.graphicsDevice),this.on("prerender",this._preRenderImmediate,this),this.on("postrender",this._postRenderImmediate,this))},_preRenderImmediate:function(){for(var t=0;t<this._immediateData.lineBatches.length;t++)this._immediateData.lineBatches[t]&&this._immediateData.lineBatches[t].finalize()},_postRenderImmediate:function(){for(var t=0;t<this._immediateData.layers.length;t++)this._immediateData.layers[t].clearMeshInstances(!0);this._immediateData.layers.length=0}}}()),Object.assign(pc,function(){pc.Vec3.ZERO.clone();var t=function(t){this.id=pc.Mesh.id++,this.entity=t.entity,this.parentScreen=t,this.renderers=new pc.IndexedList,this.device=pc.Application.getApplication().graphicsDevice,this.renderer=pc.Application.getApplication().renderer,this.renderersDirty=!1,this._aabb=new pc.BoundingBox,this.node=t.entity,this.visible=!0,this.cull=!0,this.isCanvas=!0,this._material=UnityEngine.Canvas.GetDefaultCanvasMaterial().handle,this._material.setParameter("unity_GUIZTestMode",pc.FUNC_ALWAYS+1);var e=this._material.parameters.unity_GUIZTestMode;e.scopeId||(e.scopeId=this.device.scope.resolve("unity_GUIZTestMode")),this._mesh={},this.scene=pc.Application.getApplication().scene,this.drawCalls=[],this.meshInstances=[]};return Object.assign(t.prototype,{uiElementsSort:function(t,e){return pc.SortUtils.uiElementsSort(t.model,e.model)},render:function(t,e,i,s,n){this.checkDirtyAndUpdateHierarchy(),this.drawCalls.length=0,this.meshInstances.length=0;for(var r=this.renderers.list(),a=[],o=0;o<r.length;o++){if((p=r[o]).isCanvas||0!==p._groupAlpha&&!p.cull){!p.isCanvas&&p.popMaterialCount>0&&a.push(p);for(var h=p.model.meshInstances,c=0;c<h.length;c++){var l=h[c];(l.isCanvas||0!==l._mesh.primitive[0].count)&&this.meshInstances.push(l)}}}i?pc.Culling.cullUi(i,this.meshInstances,this.drawCalls):this.drawCalls=this.meshInstances;for(c=0;c<a.length;c++){var p=a[c],u=this.getLastDrawChild(p.entity,this.drawCalls,0);if(u){var d=u.node._guid;this.scene.activeUiMasks[d]||(this.scene.activeUiMasks[d]=[]),this.scene.activeUiMasks[d].push(p)}}var _=this.parentScreen.screenType!==pc.SCREEN_TYPE_SCREEN?pc.FUNC_LESSEQUAL+1:pc.FUNC_ALWAYS+1;for(o=0;o<this.drawCalls.length;o++){var f=this.drawCalls[o];if(f.isCanvas)f.render(t,e,i,s,n);else{f.material.setParameter("unity_GUIZTestMode",_),this.renderer.renderMeshInstance(t,e,i,f,n);var m=this.scene.activeUiMasks[f.node._guid];if(m){for(c=0;c<m.length;c++){var g=m[c],y=g._popMaterials;if(s=g.model.meshInstances[0])for(var E=0;E<y.length;E++){var v=y[E].handle;this.clearMask(t,e,i,s,n,v)}}this.scene.activeUiMasks[f.node._guid]=null}}}if(!this.parentScreen.parentScreen)for(var T in this.scene.activeUiMasks)this.scene.activeUiMasks[T]=null},getLastDrawChild(t,e,i){for(var s=null,n=t.allChildren(),r=i+1;r<e.length;r++){var a=e[r],o=a.node;n.indexOf(o)>=0&&(s=a)}return s},clearMask(t,e,i,s,n,r){var a=s.material,o=s.parameters.hasOwnProperty("_ColorMask")?s.parameters._ColorMask.data:null;s.material=r,o&&(s.parameters._ColorMask.data=r.parameters._ColorMask.data),this.renderer.renderMeshInstance(t,e,i,s,n),s.material=a,o&&(s.parameters._ColorMask.data=o)},addRenderer:function(t){this.renderers.has(t)||(this.renderers.push(t),this.renderersDirty=!0)},removeRenderer:function(t){this.renderers.has(t)&&(this.renderers.remove(t),this.renderersDirty=!0)},checkDirtyAndUpdateHierarchy(){if(this.updateModel(),this.renderersDirty){this.parentScreen.system._syncDrawOrder(),this.parentScreen._updateStencilParameters(),this.renderers.sort(this.uiElementsSort),this._aabb.setMinMax(new pc.Vec3(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),new pc.Vec3(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY));for(var t=this.renderers.list(),e=0;e<t.length;e++)for(var i=t[e].model.meshInstances,s=0;s<i.length;s++)this._aabb.add(i[s].aabb);this.renderersDirty=!1}},updateModel:function(){var t=this.renderers.list();for(let i=0;i<t.length;i++){var e=t[i];e.isCanvas||e.model.update()}}}),Object.defineProperty(t.prototype,"aabb",{get:function(){return this.checkDirtyAndUpdateHierarchy(),this._aabb}}),Object.defineProperty(t.prototype,"mesh",{get:function(){return this._mesh}}),Object.defineProperty(t.prototype,"sortingLayerIndex",{get:function(){return this.parentScreen.sortingLayerIndex}}),Object.defineProperty(t.prototype,"sortingOrder",{get:function(){return this.parentScreen.sortingOrder}}),Object.defineProperty(t.prototype,"drawOrder",{get:function(){return this.parentScreen.drawOrder}}),Object.defineProperty(t.prototype,"material",{get:function(){return this._material},set:function(t){this._material=t}}),Object.defineProperty(t.prototype,"model",{get:function(){return this.parentScreen}}),{CanvasMeshInstance:t}}());